
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://digitalphonetics.github.io/adviser/api/services/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.13">
    
    
      
        <title>Services - Adviser</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e411adfe.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#services" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Adviser" class="md-header__button md-logo" aria-label="Adviser" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Adviser
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Services
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/DigitalPhonetics/adviser" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Adviser" class="md-nav__button md-logo" aria-label="Adviser" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Adviser
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DigitalPhonetics/adviser" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Services
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#adviser.services" class="md-nav__link">
    adviser.services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.backchannel" class="md-nav__link">
    backchannel
  </a>
  
    <nav class="md-nav" aria-label="backchannel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler" class="md-nav__link">
    PytorchAcousticBackchanneler
  </a>
  
    <nav class="md-nav" aria-label="PytorchAcousticBackchanneler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler" class="md-nav__link">
    PytorchAcousticBackchanneler
  </a>
  
    <nav class="md-nav" aria-label="PytorchAcousticBackchanneler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller" class="md-nav__link">
    acoustic_backchanneller
  </a>
  
    <nav class="md-nav" aria-label="acoustic_backchanneller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.gpu" class="md-nav__link">
    gpu
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller" class="md-nav__link">
    AcousticBackchanneller
  </a>
  
    <nav class="md-nav" aria-label="AcousticBackchanneller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.backchannel_prediction" class="md-nav__link">
    backchannel_prediction()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.load_model" class="md-nav__link">
    load_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.split_input_data" class="md-nav__link">
    split_input_data()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.bst" class="md-nav__link">
    bst
  </a>
  
    <nav class="md-nav" aria-label="bst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst" class="md-nav__link">
    bst
  </a>
  
    <nav class="md-nav" aria-label="bst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST" class="md-nav__link">
    HandcraftedBST
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedBST">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST.update_bst" class="md-nav__link">
    update_bst()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker" class="md-nav__link">
    domain_tracker
  </a>
  
    <nav class="md-nav" aria-label="domain_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker" class="md-nav__link">
    domain_tracker
  </a>
  
    <nav class="md-nav" aria-label="domain_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker" class="md-nav__link">
    DomainTracker
  </a>
  
    <nav class="md-nav" aria-label="DomainTracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.domains_to_str" class="md-nav__link">
    domains_to_str()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.select_domain" class="md-nav__link">
    select_domain()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.emotion" class="md-nav__link">
    emotion
  </a>
  
    <nav class="md-nav" aria-label="emotion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition" class="md-nav__link">
    EmotionRecognition
  </a>
  
    <nav class="md-nav" aria-label="EmotionRecognition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition" class="md-nav__link">
    EmotionRecognition
  </a>
  
    <nav class="md-nav" aria-label="EmotionRecognition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition.predict_from_audio" class="md-nav__link">
    predict_from_audio()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.engagement" class="md-nav__link">
    engagement
  </a>
  
    <nav class="md-nav" aria-label="engagement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker" class="md-nav__link">
    engagement_tracker
  </a>
  
    <nav class="md-nav" aria-label="engagement_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker" class="md-nav__link">
    EngagementTracker
  </a>
  
    <nav class="md-nav" aria-label="EngagementTracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_exit" class="md-nav__link">
    dialog_exit()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.publish_gaze_directions" class="md-nav__link">
    publish_gaze_directions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.yield_gaze_direction" class="md-nav__link">
    yield_gaze_direction()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.hci" class="md-nav__link">
    hci
  </a>
  
    <nav class="md-nav" aria-label="hci">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.__all__" class="md-nav__link">
    __all__
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console" class="md-nav__link">
    console
  </a>
  
    <nav class="md-nav" aria-label="console">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput" class="md-nav__link">
    ConsoleInput
  </a>
  
    <nav class="md-nav" aria-label="ConsoleInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput.get_user_input" class="md-nav__link">
    get_user_input()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleOutput" class="md-nav__link">
    ConsoleOutput
  </a>
  
    <nav class="md-nav" aria-label="ConsoleOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleOutput.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleOutput.print_sys_utterance" class="md-nav__link">
    print_sys_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui" class="md-nav__link">
    gui
  </a>
  
    <nav class="md-nav" aria-label="gui">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer" class="md-nav__link">
    GUIServer
  </a>
  
    <nav class="md-nav" aria-label="GUIServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.forward_message_to_react" class="md-nav__link">
    forward_message_to_react()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.forward_sys_utterance" class="md-nav__link">
    forward_sys_utterance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.user_utterance" class="md-nav__link">
    user_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech" class="md-nav__link">
    speech
  </a>
  
    <nav class="md-nav" aria-label="speech">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder" class="md-nav__link">
    SpeechInputDecoder
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputDecoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder" class="md-nav__link">
    SpeechInputDecoder
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputDecoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.features_to_text" class="md-nav__link">
    features_to_text()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor" class="md-nav__link">
    SpeechInputFeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputFeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor" class="md-nav__link">
    SpeechInputFeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputFeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_fbank" class="md-nav__link">
    speech_to_fbank()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_features" class="md-nav__link">
    speech_to_features()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_mfcc" class="md-nav__link">
    speech_to_mfcc()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator" class="md-nav__link">
    SpeechOutputGenerator
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator" class="md-nav__link">
    SpeechOutputGenerator
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.generate_speech" class="md-nav__link">
    generate_speech()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.preprocess_text_input" class="md-nav__link">
    preprocess_text_input()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer" class="md-nav__link">
    SpeechOutputPlayer
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputPlayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer" class="md-nav__link">
    SpeechOutputPlayer
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputPlayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.speak" class="md-nav__link">
    speak()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder" class="md-nav__link">
    SpeechRecorder
  </a>
  
    <nav class="md-nav" aria-label="SpeechRecorder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder" class="md-nav__link">
    SpeechRecorder
  </a>
  
    <nav class="md-nav" aria-label="SpeechRecorder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.record_user_utterance" class="md-nav__link">
    record_user_utterance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recorder" class="md-nav__link">
    start_recorder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recording" class="md-nav__link">
    start_recording()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.threshold_plotter_generator" class="md-nav__link">
    threshold_plotter_generator()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.voice_sanitizer" class="md-nav__link">
    voice_sanitizer()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners" class="md-nav__link">
    cleaners
  </a>
  
    <nav class="md-nav" aria-label="cleaners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.basic_cleaners" class="md-nav__link">
    basic_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.collapse_whitespace" class="md-nav__link">
    collapse_whitespace()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.convert_to_ascii" class="md-nav__link">
    convert_to_ascii()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.custom_english_cleaners" class="md-nav__link">
    custom_english_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.english_cleaners" class="md-nav__link">
    english_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_abbreviations" class="md-nav__link">
    expand_abbreviations()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_acronym" class="md-nav__link">
    expand_acronym()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_email" class="md-nav__link">
    expand_email()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_numbers" class="md-nav__link">
    expand_numbers()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_symbols" class="md-nav__link">
    expand_symbols()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.lowercase" class="md-nav__link">
    lowercase()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.normalize_numbers" class="md-nav__link">
    normalize_numbers()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.remove_unnecessary_symbols" class="md-nav__link">
    remove_unnecessary_symbols()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.transliteration_cleaners" class="md-nav__link">
    transliteration_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.uppercase" class="md-nav__link">
    uppercase()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.speech_utility" class="md-nav__link">
    speech_utility
  </a>
  
    <nav class="md-nav" aria-label="speech_utility">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.speech_utility.delete_file" class="md-nav__link">
    delete_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.speech_utility.sound_array_to_file" class="md-nav__link">
    sound_array_to_file()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video" class="md-nav__link">
    video
  </a>
  
    <nav class="md-nav" aria-label="video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor" class="md-nav__link">
    FeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="FeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor" class="md-nav__link">
    VideoFeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="VideoFeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.extract_fl_features" class="md-nav__link">
    extract_fl_features()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput" class="md-nav__link">
    VideoInput
  </a>
  
    <nav class="md-nav" aria-label="VideoInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput" class="md-nav__link">
    VideoInput
  </a>
  
    <nav class="md-nav" aria-label="VideoInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.capture" class="md-nav__link">
    capture()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.publish_img" class="md-nav__link">
    publish_img()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.nlg" class="md-nav__link">
    nlg
  </a>
  
    <nav class="md-nav" aria-label="nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.__all__" class="md-nav__link">
    __all__
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg" class="md-nav__link">
    affective_nlg
  </a>
  
    <nav class="md-nav" aria-label="affective_nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG" class="md-nav__link">
    HandcraftedEmotionNLG
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedEmotionNLG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.generate_system_utterance" class="md-nav__link">
    generate_system_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg" class="md-nav__link">
    bc_nlg
  </a>
  
    <nav class="md-nav" aria-label="bc_nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG" class="md-nav__link">
    BackchannelHandcraftedNLG
  </a>
  
    <nav class="md-nav" aria-label="BackchannelHandcraftedNLG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.publish_system_utterance" class="md-nav__link">
    publish_system_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg" class="md-nav__link">
    nlg
  </a>
  
    <nav class="md-nav" aria-label="nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG" class="md-nav__link">
    HandcraftedNLG
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedNLG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG.generate_system_utterance" class="md-nav__link">
    generate_system_utterance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG.publish_system_utterance" class="md-nav__link">
    publish_system_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates" class="md-nav__link">
    templates
  </a>
  
    <nav class="md-nav" aria-label="templates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions" class="md-nav__link">
    builtinfunctions
  </a>
  
    <nav class="md-nav" aria-label="builtinfunctions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction" class="md-nav__link">
    ForEntryFunction
  </a>
  
    <nav class="md-nav" aria-label="ForEntryFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction" class="md-nav__link">
    ForEntryListFunction
  </a>
  
    <nav class="md-nav" aria-label="ForEntryListFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction" class="md-nav__link">
    ForFunction
  </a>
  
    <nav class="md-nav" aria-label="ForFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction" class="md-nav__link">
    PythonFunction
  </a>
  
    <nav class="md-nav" aria-label="PythonFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing" class="md-nav__link">
    parsing
  </a>
  
    <nav class="md-nav" aria-label="parsing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.automaton" class="md-nav__link">
    automaton
  </a>
  
    <nav class="md-nav" aria-label="automaton">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton" class="md-nav__link">
    ModifiedPushdownAutomaton
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration" class="md-nav__link">
    configuration
  </a>
  
    <nav class="md-nav" aria-label="configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.Configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.DefaultTransition" class="md-nav__link">
    DefaultTransition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition" class="md-nav__link">
    SimpleForwardDefaultTransition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.State" class="md-nav__link">
    State
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.StateDescription" class="md-nav__link">
    StateDescription
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.Transition" class="md-nav__link">
    Transition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithAction" class="md-nav__link">
    TransitionWithAction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction" class="md-nav__link">
    TransitionWithoutAction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.exceptions" class="md-nav__link">
    exceptions
  </a>
  
    <nav class="md-nav" aria-label="exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.exceptions.ParsingError" class="md-nav__link">
    ParsingError
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.parsers" class="md-nav__link">
    parsers
  </a>
  
    <nav class="md-nav" aria-label="parsers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.parsers.messageparser" class="md-nav__link">
    messageparser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.stack" class="md-nav__link">
    stack
  </a>
  
    <nav class="md-nav" aria-label="stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack" class="md-nav__link">
    AutomatonStack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.preprocessing" class="md-nav__link">
    preprocessing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile" class="md-nav__link">
    templatefile
  </a>
  
    <nav class="md-nav" aria-label="templatefile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.KEYWORDS" class="md-nav__link">
    KEYWORDS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile" class="md-nav__link">
    TemplateFile
  </a>
  
    <nav class="md-nav" aria-label="TemplateFile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile.add_python_function" class="md-nav__link">
    add_python_function()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile.create_message" class="md-nav__link">
    create_message()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.nlu" class="md-nav__link">
    nlu
  </a>
  
    <nav class="md-nav" aria-label="nlu">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu" class="md-nav__link">
    nlu
  </a>
  
    <nav class="md-nav" aria-label="nlu">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU" class="md-nav__link">
    HandcraftedNLU
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedNLU">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU.extract_user_acts" class="md-nav__link">
    extract_user_acts()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.policy" class="md-nav__link">
    policy
  </a>
  
    <nav class="md-nav" aria-label="policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy" class="md-nav__link">
    affective_policy
  </a>
  
    <nav class="md-nav" aria-label="affective_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy" class="md-nav__link">
    EmotionPolicy
  </a>
  
    <nav class="md-nav" aria-label="EmotionPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy.choose_sys_emotion" class="md-nav__link">
    choose_sys_emotion()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api" class="md-nav__link">
    policy_api
  </a>
  
    <nav class="md-nav" aria-label="policy_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy" class="md-nav__link">
    HandcraftedPolicy
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy.choose_sys_act" class="md-nav__link">
    choose_sys_act()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted" class="md-nav__link">
    policy_handcrafted
  </a>
  
    <nav class="md-nav" aria-label="policy_handcrafted">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy" class="md-nav__link">
    HandcraftedPolicy
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.choose_sys_act" class="md-nav__link">
    choose_sys_act()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl" class="md-nav__link">
    rl
  </a>
  
    <nav class="md-nav" aria-label="rl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn" class="md-nav__link">
    dqn
  </a>
  
    <nav class="md-nav" aria-label="dqn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DQN" class="md-nav__link">
    DQN
  </a>
  
    <nav class="md-nav" aria-label="DQN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DQN.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DQN.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DuelingDQN" class="md-nav__link">
    DuelingDQN
  </a>
  
    <nav class="md-nav" aria-label="DuelingDQN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DuelingDQN.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DuelingDQN.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.NetArchitecture" class="md-nav__link">
    NetArchitecture
  </a>
  
    <nav class="md-nav" aria-label="NetArchitecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.NetArchitecture.DUELING" class="md-nav__link">
    DUELING
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.NetArchitecture.VANILLA" class="md-nav__link">
    VANILLA
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy" class="md-nav__link">
    dqnpolicy
  </a>
  
    <nav class="md-nav" aria-label="dqnpolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy" class="md-nav__link">
    DQNPolicy
  </a>
  
    <nav class="md-nav" aria-label="DQNPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.choose_sys_act" class="md-nav__link">
    choose_sys_act()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.end" class="md-nav__link">
    end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.eps_scheduler" class="md-nav__link">
    eps_scheduler()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.eval" class="md-nav__link">
    eval()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.loss" class="md-nav__link">
    loss()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.select_action_eps_greedy" class="md-nav__link">
    select_action_eps_greedy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.train_batch" class="md-nav__link">
    train_batch()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer" class="md-nav__link">
    experience_buffer
  </a>
  
    <nav class="md-nav" aria-label="experience_buffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer" class="md-nav__link">
    Buffer
  </a>
  
    <nav class="md-nav" aria-label="Buffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.print_contents" class="md-nav__link">
    print_contents()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.store" class="md-nav__link">
    store()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer" class="md-nav__link">
    NaivePrioritizedBuffer
  </a>
  
    <nav class="md-nav" aria-label="NaivePrioritizedBuffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.store" class="md-nav__link">
    store()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer" class="md-nav__link">
    UniformBuffer
  </a>
  
    <nav class="md-nav" aria-label="UniformBuffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl" class="md-nav__link">
    policy_rl
  </a>
  
    <nav class="md-nav" aria-label="policy_rl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy" class="md-nav__link">
    RLPolicy
  </a>
  
    <nav class="md-nav" aria-label="RLPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.action_idx" class="md-nav__link">
    action_idx()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.action_name" class="md-nav__link">
    action_name()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.beliefstate_dict_to_vector" class="md-nav__link">
    beliefstate_dict_to_vector()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.end_dialog" class="md-nav__link">
    end_dialog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.expand_system_action" class="md-nav__link">
    expand_system_action()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.turn_end" class="md-nav__link">
    turn_end()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy" class="md-nav__link">
    train_dqnpolicy
  </a>
  
    <nav class="md-nav" aria-label="train_dqnpolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--this-script-can-be-executed-to-train-a-dqn-policy" class="md-nav__link">
    This script can be executed to train a DQN policy.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--it-will-create-a-policy-model-file-ending-with-pt" class="md-nav__link">
    It will create a policy model (file ending with .pt).
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--you-need-to-execute-this-script-before-you-can-interact-with-the-rl-agent" class="md-nav__link">
    You need to execute this script before you can interact with the RL agent.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--_1" class="md-nav__link">
    
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.service" class="md-nav__link">
    service
  </a>
  
    <nav class="md-nav" aria-label="service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem" class="md-nav__link">
    DialogSystem
  </a>
  
    <nav class="md-nav" aria-label="DialogSystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.draw_system_graph" class="md-nav__link">
    draw_system_graph()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.is_error_free_messaging_pipeline" class="md-nav__link">
    is_error_free_messaging_pipeline()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.list_inconsistencies" class="md-nav__link">
    list_inconsistencies()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.list_published_topics" class="md-nav__link">
    list_published_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.list_subscribed_topics" class="md-nav__link">
    list_subscribed_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.print_inconsistencies" class="md-nav__link">
    print_inconsistencies()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.run_dialog" class="md-nav__link">
    run_dialog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.shutdown" class="md-nav__link">
    shutdown()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.stop" class="md-nav__link">
    stop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.terminating" class="md-nav__link">
    terminating()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.RemoteService" class="md-nav__link">
    RemoteService
  </a>
  
    <nav class="md-nav" aria-label="RemoteService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.RemoteService.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service" class="md-nav__link">
    Service
  </a>
  
    <nav class="md-nav" aria-label="Service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.dialog_exit" class="md-nav__link">
    dialog_exit()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.eval" class="md-nav__link">
    eval()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.get_all_published_topics" class="md-nav__link">
    get_all_published_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.get_all_subscribed_topics" class="md-nav__link">
    get_all_subscribed_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.run_standalone" class="md-nav__link">
    run_standalone()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.PublishSubscribe" class="md-nav__link">
    PublishSubscribe()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.simulator" class="md-nav__link">
    simulator
  </a>
  
    <nav class="md-nav" aria-label="simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator" class="md-nav__link">
    emotion_simulator
  </a>
  
    <nav class="md-nav" aria-label="emotion_simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator" class="md-nav__link">
    EmotionSimulator
  </a>
  
    <nav class="md-nav" aria-label="EmotionSimulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator.send_emotion" class="md-nav__link">
    send_emotion()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal" class="md-nav__link">
    goal
  </a>
  
    <nav class="md-nav" aria-label="goal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint" class="md-nav__link">
    Constraint
  </a>
  
    <nav class="md-nav" aria-label="Constraint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal" class="md-nav__link">
    Goal
  </a>
  
    <nav class="md-nav" aria-label="Goal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.fulfill_request" class="md-nav__link">
    fulfill_request()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.get_constraint" class="md-nav__link">
    get_constraint()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.init" class="md-nav__link">
    init()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.is_fulfilled" class="md-nav__link">
    is_fulfilled()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.is_inconsistent_constraint" class="md-nav__link">
    is_inconsistent_constraint()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.is_inconsistent_constraint_strict" class="md-nav__link">
    is_inconsistent_constraint_strict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.reset" class="md-nav__link">
    reset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.update_constraint" class="md-nav__link">
    update_constraint()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator" class="md-nav__link">
    simulator
  </a>
  
    <nav class="md-nav" aria-label="simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda" class="md-nav__link">
    Agenda
  </a>
  
    <nav class="md-nav" aria-label="Agenda">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__bool__" class="md-nav__link">
    __bool__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__contains__" class="md-nav__link">
    __contains__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__iter__" class="md-nav__link">
    __iter__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__str__" class="md-nav__link">
    __str__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.clean" class="md-nav__link">
    clean()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.clear" class="md-nav__link">
    clear()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.contains_action_of_type" class="md-nav__link">
    contains_action_of_type()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.fill_with_constraints" class="md-nav__link">
    fill_with_constraints()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.fill_with_requests" class="md-nav__link">
    fill_with_requests()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.get_actions" class="md-nav__link">
    get_actions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.get_actions_of_type" class="md-nav__link">
    get_actions_of_type()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.init" class="md-nav__link">
    init()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.is_empty" class="md-nav__link">
    is_empty()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.push" class="md-nav__link">
    push()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.remove_actions" class="md-nav__link">
    remove_actions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.remove_actions_of_type" class="md-nav__link">
    remove_actions_of_type()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator" class="md-nav__link">
    HandcraftedUserSimulator
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedUserSimulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.receive" class="md-nav__link">
    receive()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.respond" class="md-nav__link">
    respond()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.user_turn" class="md-nav__link">
    user_turn()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.stats" class="md-nav__link">
    stats
  </a>
  
    <nav class="md-nav" aria-label="stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation" class="md-nav__link">
    evaluation
  </a>
  
    <nav class="md-nav" aria-label="evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator" class="md-nav__link">
    ObjectiveReachedEvaluator
  </a>
  
    <nav class="md-nav" aria-label="ObjectiveReachedEvaluator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_final_reward" class="md-nav__link">
    get_final_reward()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_turn_reward" class="md-nav__link">
    get_turn_reward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator" class="md-nav__link">
    PolicyEvaluator
  </a>
  
    <nav class="md-nav" aria-label="PolicyEvaluator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.end_dialog" class="md-nav__link">
    end_dialog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.end_epoch" class="md-nav__link">
    end_epoch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.eval" class="md-nav__link">
    eval()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.evaluate_turn" class="md-nav__link">
    evaluate_turn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.start_epoch" class="md-nav__link">
    start_epoch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.ust" class="md-nav__link">
    ust
  </a>
  
    <nav class="md-nav" aria-label="ust">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust" class="md-nav__link">
    ust
  </a>
  
    <nav class="md-nav" aria-label="ust">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST" class="md-nav__link">
    HandcraftedUST
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedUST">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST.update_emotion" class="md-nav__link">
    update_emotion()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        Utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        Tools
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/services/" class="md-nav__link">
        Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/dialogsystem/" class="md-nav__link">
        Dialog System
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/advanced/" class="md-nav__link">
        Advanced
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#adviser.services" class="md-nav__link">
    adviser.services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.backchannel" class="md-nav__link">
    backchannel
  </a>
  
    <nav class="md-nav" aria-label="backchannel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler" class="md-nav__link">
    PytorchAcousticBackchanneler
  </a>
  
    <nav class="md-nav" aria-label="PytorchAcousticBackchanneler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler" class="md-nav__link">
    PytorchAcousticBackchanneler
  </a>
  
    <nav class="md-nav" aria-label="PytorchAcousticBackchanneler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller" class="md-nav__link">
    acoustic_backchanneller
  </a>
  
    <nav class="md-nav" aria-label="acoustic_backchanneller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.gpu" class="md-nav__link">
    gpu
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller" class="md-nav__link">
    AcousticBackchanneller
  </a>
  
    <nav class="md-nav" aria-label="AcousticBackchanneller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.backchannel_prediction" class="md-nav__link">
    backchannel_prediction()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.load_model" class="md-nav__link">
    load_model()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.split_input_data" class="md-nav__link">
    split_input_data()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.bst" class="md-nav__link">
    bst
  </a>
  
    <nav class="md-nav" aria-label="bst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst" class="md-nav__link">
    bst
  </a>
  
    <nav class="md-nav" aria-label="bst">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST" class="md-nav__link">
    HandcraftedBST
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedBST">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.bst.bst.HandcraftedBST.update_bst" class="md-nav__link">
    update_bst()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker" class="md-nav__link">
    domain_tracker
  </a>
  
    <nav class="md-nav" aria-label="domain_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker" class="md-nav__link">
    domain_tracker
  </a>
  
    <nav class="md-nav" aria-label="domain_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker" class="md-nav__link">
    DomainTracker
  </a>
  
    <nav class="md-nav" aria-label="DomainTracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.domains_to_str" class="md-nav__link">
    domains_to_str()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.select_domain" class="md-nav__link">
    select_domain()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.emotion" class="md-nav__link">
    emotion
  </a>
  
    <nav class="md-nav" aria-label="emotion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition" class="md-nav__link">
    EmotionRecognition
  </a>
  
    <nav class="md-nav" aria-label="EmotionRecognition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition" class="md-nav__link">
    EmotionRecognition
  </a>
  
    <nav class="md-nav" aria-label="EmotionRecognition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition.predict_from_audio" class="md-nav__link">
    predict_from_audio()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.engagement" class="md-nav__link">
    engagement
  </a>
  
    <nav class="md-nav" aria-label="engagement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker" class="md-nav__link">
    engagement_tracker
  </a>
  
    <nav class="md-nav" aria-label="engagement_tracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker" class="md-nav__link">
    EngagementTracker
  </a>
  
    <nav class="md-nav" aria-label="EngagementTracker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_exit" class="md-nav__link">
    dialog_exit()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.publish_gaze_directions" class="md-nav__link">
    publish_gaze_directions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.yield_gaze_direction" class="md-nav__link">
    yield_gaze_direction()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.engagement.engagement_tracker.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.hci" class="md-nav__link">
    hci
  </a>
  
    <nav class="md-nav" aria-label="hci">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.__all__" class="md-nav__link">
    __all__
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console" class="md-nav__link">
    console
  </a>
  
    <nav class="md-nav" aria-label="console">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput" class="md-nav__link">
    ConsoleInput
  </a>
  
    <nav class="md-nav" aria-label="ConsoleInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleInput.get_user_input" class="md-nav__link">
    get_user_input()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleOutput" class="md-nav__link">
    ConsoleOutput
  </a>
  
    <nav class="md-nav" aria-label="ConsoleOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleOutput.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.console.ConsoleOutput.print_sys_utterance" class="md-nav__link">
    print_sys_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui" class="md-nav__link">
    gui
  </a>
  
    <nav class="md-nav" aria-label="gui">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer" class="md-nav__link">
    GUIServer
  </a>
  
    <nav class="md-nav" aria-label="GUIServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.forward_message_to_react" class="md-nav__link">
    forward_message_to_react()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.forward_sys_utterance" class="md-nav__link">
    forward_sys_utterance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.gui.GUIServer.user_utterance" class="md-nav__link">
    user_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech" class="md-nav__link">
    speech
  </a>
  
    <nav class="md-nav" aria-label="speech">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder" class="md-nav__link">
    SpeechInputDecoder
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputDecoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder" class="md-nav__link">
    SpeechInputDecoder
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputDecoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.features_to_text" class="md-nav__link">
    features_to_text()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputDecoder.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor" class="md-nav__link">
    SpeechInputFeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputFeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor" class="md-nav__link">
    SpeechInputFeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="SpeechInputFeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_fbank" class="md-nav__link">
    speech_to_fbank()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_features" class="md-nav__link">
    speech_to_features()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_mfcc" class="md-nav__link">
    speech_to_mfcc()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator" class="md-nav__link">
    SpeechOutputGenerator
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator" class="md-nav__link">
    SpeechOutputGenerator
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.generate_speech" class="md-nav__link">
    generate_speech()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.preprocess_text_input" class="md-nav__link">
    preprocess_text_input()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputGenerator.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer" class="md-nav__link">
    SpeechOutputPlayer
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputPlayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer" class="md-nav__link">
    SpeechOutputPlayer
  </a>
  
    <nav class="md-nav" aria-label="SpeechOutputPlayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.speak" class="md-nav__link">
    speak()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder" class="md-nav__link">
    SpeechRecorder
  </a>
  
    <nav class="md-nav" aria-label="SpeechRecorder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder" class="md-nav__link">
    SpeechRecorder
  </a>
  
    <nav class="md-nav" aria-label="SpeechRecorder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.record_user_utterance" class="md-nav__link">
    record_user_utterance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recorder" class="md-nav__link">
    start_recorder()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recording" class="md-nav__link">
    start_recording()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.threshold_plotter_generator" class="md-nav__link">
    threshold_plotter_generator()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.SpeechRecorder.voice_sanitizer" class="md-nav__link">
    voice_sanitizer()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners" class="md-nav__link">
    cleaners
  </a>
  
    <nav class="md-nav" aria-label="cleaners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.basic_cleaners" class="md-nav__link">
    basic_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.collapse_whitespace" class="md-nav__link">
    collapse_whitespace()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.convert_to_ascii" class="md-nav__link">
    convert_to_ascii()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.custom_english_cleaners" class="md-nav__link">
    custom_english_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.english_cleaners" class="md-nav__link">
    english_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_abbreviations" class="md-nav__link">
    expand_abbreviations()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_acronym" class="md-nav__link">
    expand_acronym()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_email" class="md-nav__link">
    expand_email()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_numbers" class="md-nav__link">
    expand_numbers()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.expand_symbols" class="md-nav__link">
    expand_symbols()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.lowercase" class="md-nav__link">
    lowercase()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.normalize_numbers" class="md-nav__link">
    normalize_numbers()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.remove_unnecessary_symbols" class="md-nav__link">
    remove_unnecessary_symbols()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.transliteration_cleaners" class="md-nav__link">
    transliteration_cleaners()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.cleaners.uppercase" class="md-nav__link">
    uppercase()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.speech_utility" class="md-nav__link">
    speech_utility
  </a>
  
    <nav class="md-nav" aria-label="speech_utility">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.speech_utility.delete_file" class="md-nav__link">
    delete_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.speech.speech_utility.sound_array_to_file" class="md-nav__link">
    sound_array_to_file()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video" class="md-nav__link">
    video
  </a>
  
    <nav class="md-nav" aria-label="video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor" class="md-nav__link">
    FeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="FeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor" class="md-nav__link">
    VideoFeatureExtractor
  </a>
  
    <nav class="md-nav" aria-label="VideoFeatureExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.extract_fl_features" class="md-nav__link">
    extract_fl_features()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput" class="md-nav__link">
    VideoInput
  </a>
  
    <nav class="md-nav" aria-label="VideoInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput" class="md-nav__link">
    VideoInput
  </a>
  
    <nav class="md-nav" aria-label="VideoInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.capture" class="md-nav__link">
    capture()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.hci.video.VideoInput.VideoInput.publish_img" class="md-nav__link">
    publish_img()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.nlg" class="md-nav__link">
    nlg
  </a>
  
    <nav class="md-nav" aria-label="nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.__all__" class="md-nav__link">
    __all__
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg" class="md-nav__link">
    affective_nlg
  </a>
  
    <nav class="md-nav" aria-label="affective_nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG" class="md-nav__link">
    HandcraftedEmotionNLG
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedEmotionNLG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.generate_system_utterance" class="md-nav__link">
    generate_system_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg" class="md-nav__link">
    bc_nlg
  </a>
  
    <nav class="md-nav" aria-label="bc_nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG" class="md-nav__link">
    BackchannelHandcraftedNLG
  </a>
  
    <nav class="md-nav" aria-label="BackchannelHandcraftedNLG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.publish_system_utterance" class="md-nav__link">
    publish_system_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg" class="md-nav__link">
    nlg
  </a>
  
    <nav class="md-nav" aria-label="nlg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG" class="md-nav__link">
    HandcraftedNLG
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedNLG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG.generate_system_utterance" class="md-nav__link">
    generate_system_utterance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.nlg.HandcraftedNLG.publish_system_utterance" class="md-nav__link">
    publish_system_utterance()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates" class="md-nav__link">
    templates
  </a>
  
    <nav class="md-nav" aria-label="templates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions" class="md-nav__link">
    builtinfunctions
  </a>
  
    <nav class="md-nav" aria-label="builtinfunctions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction" class="md-nav__link">
    ForEntryFunction
  </a>
  
    <nav class="md-nav" aria-label="ForEntryFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction" class="md-nav__link">
    ForEntryListFunction
  </a>
  
    <nav class="md-nav" aria-label="ForEntryListFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction" class="md-nav__link">
    ForFunction
  </a>
  
    <nav class="md-nav" aria-label="ForFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction" class="md-nav__link">
    PythonFunction
  </a>
  
    <nav class="md-nav" aria-label="PythonFunction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.apply" class="md-nav__link">
    apply()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.is_applicable" class="md-nav__link">
    is_applicable()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing" class="md-nav__link">
    parsing
  </a>
  
    <nav class="md-nav" aria-label="parsing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.automaton" class="md-nav__link">
    automaton
  </a>
  
    <nav class="md-nav" aria-label="automaton">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton" class="md-nav__link">
    ModifiedPushdownAutomaton
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration" class="md-nav__link">
    configuration
  </a>
  
    <nav class="md-nav" aria-label="configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.Configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.DefaultTransition" class="md-nav__link">
    DefaultTransition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition" class="md-nav__link">
    SimpleForwardDefaultTransition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.State" class="md-nav__link">
    State
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.StateDescription" class="md-nav__link">
    StateDescription
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.Transition" class="md-nav__link">
    Transition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithAction" class="md-nav__link">
    TransitionWithAction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction" class="md-nav__link">
    TransitionWithoutAction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.exceptions" class="md-nav__link">
    exceptions
  </a>
  
    <nav class="md-nav" aria-label="exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.exceptions.ParsingError" class="md-nav__link">
    ParsingError
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.parsers" class="md-nav__link">
    parsers
  </a>
  
    <nav class="md-nav" aria-label="parsers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.parsers.messageparser" class="md-nav__link">
    messageparser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.stack" class="md-nav__link">
    stack
  </a>
  
    <nav class="md-nav" aria-label="stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack" class="md-nav__link">
    AutomatonStack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.preprocessing" class="md-nav__link">
    preprocessing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile" class="md-nav__link">
    templatefile
  </a>
  
    <nav class="md-nav" aria-label="templatefile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.KEYWORDS" class="md-nav__link">
    KEYWORDS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile" class="md-nav__link">
    TemplateFile
  </a>
  
    <nav class="md-nav" aria-label="TemplateFile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile.add_python_function" class="md-nav__link">
    add_python_function()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlg.templates.templatefile.TemplateFile.create_message" class="md-nav__link">
    create_message()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.nlu" class="md-nav__link">
    nlu
  </a>
  
    <nav class="md-nav" aria-label="nlu">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu" class="md-nav__link">
    nlu
  </a>
  
    <nav class="md-nav" aria-label="nlu">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU" class="md-nav__link">
    HandcraftedNLU
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedNLU">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.HandcraftedNLU.extract_user_acts" class="md-nav__link">
    extract_user_acts()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.nlu.nlu.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.policy" class="md-nav__link">
    policy
  </a>
  
    <nav class="md-nav" aria-label="policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy" class="md-nav__link">
    affective_policy
  </a>
  
    <nav class="md-nav" aria-label="affective_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy" class="md-nav__link">
    EmotionPolicy
  </a>
  
    <nav class="md-nav" aria-label="EmotionPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy.choose_sys_emotion" class="md-nav__link">
    choose_sys_emotion()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.affective_policy.EmotionPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api" class="md-nav__link">
    policy_api
  </a>
  
    <nav class="md-nav" aria-label="policy_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy" class="md-nav__link">
    HandcraftedPolicy
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy.choose_sys_act" class="md-nav__link">
    choose_sys_act()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_api.HandcraftedPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted" class="md-nav__link">
    policy_handcrafted
  </a>
  
    <nav class="md-nav" aria-label="policy_handcrafted">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy" class="md-nav__link">
    HandcraftedPolicy
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.choose_sys_act" class="md-nav__link">
    choose_sys_act()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl" class="md-nav__link">
    rl
  </a>
  
    <nav class="md-nav" aria-label="rl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn" class="md-nav__link">
    dqn
  </a>
  
    <nav class="md-nav" aria-label="dqn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DQN" class="md-nav__link">
    DQN
  </a>
  
    <nav class="md-nav" aria-label="DQN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DQN.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DQN.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DuelingDQN" class="md-nav__link">
    DuelingDQN
  </a>
  
    <nav class="md-nav" aria-label="DuelingDQN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DuelingDQN.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.DuelingDQN.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.NetArchitecture" class="md-nav__link">
    NetArchitecture
  </a>
  
    <nav class="md-nav" aria-label="NetArchitecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.NetArchitecture.DUELING" class="md-nav__link">
    DUELING
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqn.NetArchitecture.VANILLA" class="md-nav__link">
    VANILLA
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy" class="md-nav__link">
    dqnpolicy
  </a>
  
    <nav class="md-nav" aria-label="dqnpolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy" class="md-nav__link">
    DQNPolicy
  </a>
  
    <nav class="md-nav" aria-label="DQNPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.choose_sys_act" class="md-nav__link">
    choose_sys_act()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.end" class="md-nav__link">
    end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.eps_scheduler" class="md-nav__link">
    eps_scheduler()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.eval" class="md-nav__link">
    eval()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.load" class="md-nav__link">
    load()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.loss" class="md-nav__link">
    loss()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.select_action_eps_greedy" class="md-nav__link">
    select_action_eps_greedy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.train_batch" class="md-nav__link">
    train_batch()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer" class="md-nav__link">
    experience_buffer
  </a>
  
    <nav class="md-nav" aria-label="experience_buffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer" class="md-nav__link">
    Buffer
  </a>
  
    <nav class="md-nav" aria-label="Buffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.print_contents" class="md-nav__link">
    print_contents()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.Buffer.store" class="md-nav__link">
    store()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer" class="md-nav__link">
    NaivePrioritizedBuffer
  </a>
  
    <nav class="md-nav" aria-label="NaivePrioritizedBuffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.store" class="md-nav__link">
    store()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.update" class="md-nav__link">
    update()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer" class="md-nav__link">
    UniformBuffer
  </a>
  
    <nav class="md-nav" aria-label="UniformBuffer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer.sample" class="md-nav__link">
    sample()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl" class="md-nav__link">
    policy_rl
  </a>
  
    <nav class="md-nav" aria-label="policy_rl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy" class="md-nav__link">
    RLPolicy
  </a>
  
    <nav class="md-nav" aria-label="RLPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.action_idx" class="md-nav__link">
    action_idx()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.action_name" class="md-nav__link">
    action_name()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.beliefstate_dict_to_vector" class="md-nav__link">
    beliefstate_dict_to_vector()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.end_dialog" class="md-nav__link">
    end_dialog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.expand_system_action" class="md-nav__link">
    expand_system_action()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.policy_rl.RLPolicy.turn_end" class="md-nav__link">
    turn_end()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy" class="md-nav__link">
    train_dqnpolicy
  </a>
  
    <nav class="md-nav" aria-label="train_dqnpolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--this-script-can-be-executed-to-train-a-dqn-policy" class="md-nav__link">
    This script can be executed to train a DQN policy.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--it-will-create-a-policy-model-file-ending-with-pt" class="md-nav__link">
    It will create a policy model (file ending with .pt).
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--you-need-to-execute-this-script-before-you-can-interact-with-the-rl-agent" class="md-nav__link">
    You need to execute this script before you can interact with the RL agent.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy--_1" class="md-nav__link">
    
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy.get_root_dir" class="md-nav__link">
    get_root_dir()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.policy.rl.train_dqnpolicy.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.service" class="md-nav__link">
    service
  </a>
  
    <nav class="md-nav" aria-label="service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem" class="md-nav__link">
    DialogSystem
  </a>
  
    <nav class="md-nav" aria-label="DialogSystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.draw_system_graph" class="md-nav__link">
    draw_system_graph()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.is_error_free_messaging_pipeline" class="md-nav__link">
    is_error_free_messaging_pipeline()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.list_inconsistencies" class="md-nav__link">
    list_inconsistencies()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.list_published_topics" class="md-nav__link">
    list_published_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.list_subscribed_topics" class="md-nav__link">
    list_subscribed_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.print_inconsistencies" class="md-nav__link">
    print_inconsistencies()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.run_dialog" class="md-nav__link">
    run_dialog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.shutdown" class="md-nav__link">
    shutdown()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.stop" class="md-nav__link">
    stop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.DialogSystem.terminating" class="md-nav__link">
    terminating()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.RemoteService" class="md-nav__link">
    RemoteService
  </a>
  
    <nav class="md-nav" aria-label="RemoteService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.RemoteService.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service" class="md-nav__link">
    Service
  </a>
  
    <nav class="md-nav" aria-label="Service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.dialog_end" class="md-nav__link">
    dialog_end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.dialog_exit" class="md-nav__link">
    dialog_exit()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.eval" class="md-nav__link">
    eval()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.get_all_published_topics" class="md-nav__link">
    get_all_published_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.get_all_subscribed_topics" class="md-nav__link">
    get_all_subscribed_topics()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.run_standalone" class="md-nav__link">
    run_standalone()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.Service.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.service.PublishSubscribe" class="md-nav__link">
    PublishSubscribe()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.simulator" class="md-nav__link">
    simulator
  </a>
  
    <nav class="md-nav" aria-label="simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator" class="md-nav__link">
    emotion_simulator
  </a>
  
    <nav class="md-nav" aria-label="emotion_simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator" class="md-nav__link">
    EmotionSimulator
  </a>
  
    <nav class="md-nav" aria-label="EmotionSimulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator.send_emotion" class="md-nav__link">
    send_emotion()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal" class="md-nav__link">
    goal
  </a>
  
    <nav class="md-nav" aria-label="goal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint" class="md-nav__link">
    Constraint
  </a>
  
    <nav class="md-nav" aria-label="Constraint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Constraint.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal" class="md-nav__link">
    Goal
  </a>
  
    <nav class="md-nav" aria-label="Goal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.fulfill_request" class="md-nav__link">
    fulfill_request()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.get_constraint" class="md-nav__link">
    get_constraint()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.init" class="md-nav__link">
    init()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.is_fulfilled" class="md-nav__link">
    is_fulfilled()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.is_inconsistent_constraint" class="md-nav__link">
    is_inconsistent_constraint()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.is_inconsistent_constraint_strict" class="md-nav__link">
    is_inconsistent_constraint_strict()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.reset" class="md-nav__link">
    reset()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.goal.Goal.update_constraint" class="md-nav__link">
    update_constraint()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator" class="md-nav__link">
    simulator
  </a>
  
    <nav class="md-nav" aria-label="simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda" class="md-nav__link">
    Agenda
  </a>
  
    <nav class="md-nav" aria-label="Agenda">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__bool__" class="md-nav__link">
    __bool__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__contains__" class="md-nav__link">
    __contains__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__iter__" class="md-nav__link">
    __iter__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.__str__" class="md-nav__link">
    __str__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.clean" class="md-nav__link">
    clean()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.clear" class="md-nav__link">
    clear()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.contains_action_of_type" class="md-nav__link">
    contains_action_of_type()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.fill_with_constraints" class="md-nav__link">
    fill_with_constraints()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.fill_with_requests" class="md-nav__link">
    fill_with_requests()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.get_actions" class="md-nav__link">
    get_actions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.get_actions_of_type" class="md-nav__link">
    get_actions_of_type()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.init" class="md-nav__link">
    init()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.is_empty" class="md-nav__link">
    is_empty()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.push" class="md-nav__link">
    push()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.remove_actions" class="md-nav__link">
    remove_actions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.Agenda.remove_actions_of_type" class="md-nav__link">
    remove_actions_of_type()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator" class="md-nav__link">
    HandcraftedUserSimulator
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedUserSimulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.receive" class="md-nav__link">
    receive()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.respond" class="md-nav__link">
    respond()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.user_turn" class="md-nav__link">
    user_turn()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.stats" class="md-nav__link">
    stats
  </a>
  
    <nav class="md-nav" aria-label="stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation" class="md-nav__link">
    evaluation
  </a>
  
    <nav class="md-nav" aria-label="evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator" class="md-nav__link">
    ObjectiveReachedEvaluator
  </a>
  
    <nav class="md-nav" aria-label="ObjectiveReachedEvaluator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_final_reward" class="md-nav__link">
    get_final_reward()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_turn_reward" class="md-nav__link">
    get_turn_reward()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator" class="md-nav__link">
    PolicyEvaluator
  </a>
  
    <nav class="md-nav" aria-label="PolicyEvaluator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.end_dialog" class="md-nav__link">
    end_dialog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.end_epoch" class="md-nav__link">
    end_epoch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.eval" class="md-nav__link">
    eval()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.evaluate_turn" class="md-nav__link">
    evaluate_turn()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.start_epoch" class="md-nav__link">
    start_epoch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.stats.evaluation.PolicyEvaluator.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adviser.services.ust" class="md-nav__link">
    ust
  </a>
  
    <nav class="md-nav" aria-label="ust">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust" class="md-nav__link">
    ust
  </a>
  
    <nav class="md-nav" aria-label="ust">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST" class="md-nav__link">
    HandcraftedUST
  </a>
  
    <nav class="md-nav" aria-label="HandcraftedUST">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST.dialog_start" class="md-nav__link">
    dialog_start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adviser.services.ust.ust.HandcraftedUST.update_emotion" class="md-nav__link">
    update_emotion()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/DigitalPhonetics/adviser/edit/master/docs/api/services.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h1>


  <div class="doc doc-object doc-module">

<a id="adviser.services"></a>
    <div class="doc doc-contents first">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h2 id="adviser.services.backchannel" class="doc doc-heading">
        <code>backchannel</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.backchannel" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.backchannel.PytorchAcousticBackchanneler" class="doc doc-heading">
        <code>PytorchAcousticBackchanneler</code>



<a href="#adviser.services.backchannel.PytorchAcousticBackchanneler" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler" class="doc doc-heading">
        <code>
PytorchAcousticBackchanneler            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Class for defining the Deep Backchannel model in PyTorch</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/PytorchAcousticBackchanneler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">PytorchAcousticBackchanneler</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Class for defining the Deep Backchannel model in PyTorch&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="p">[],</span> <span class="n">load_params</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        Defines the elements/layers of the neural network as well as loads the pretrained parameters</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        The model is constituted by two parallel CNNs followed by a concatenation, a  FFN and a softmax layer.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">            parameters (list): list of pre-trained parameters to be used for prediction</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">            load_params (bool): Bool to signal if params should be loaded</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">PytorchAcousticBackchanneler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="c1"># First CNN</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">cnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>            <span class="n">cnn</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>            <span class="n">cnn</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cnn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>            <span class="n">cnn</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="c1"># Second CNN</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="n">cnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="n">cnn</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="n">cnn</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cnn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="n">cnn</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="c1"># Linear layer</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="c1"># Softmax</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feat_inputs</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">        PyTorch forward method used for training and prediction. It defines the interaction between layers.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            feat_inputs (numpy array): It contains the network&#39;s input.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">            out (torch.tensor): Network&#39;s output</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="n">feat_inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">feat_inputs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="n">feat_inputs</span> <span class="o">=</span> <span class="n">feat_inputs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="n">cnn_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn1</span><span class="p">(</span><span class="n">feat_inputs</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="n">cnn_1</span> <span class="o">=</span> <span class="n">cnn_1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="n">cnn_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn2</span><span class="p">(</span><span class="n">feat_inputs</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">cnn_1</span><span class="p">,</span> <span class="n">cnn_2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">[],</span> <span class="n">load_params</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Defines the elements/layers of the neural network as well as loads the pretrained parameters</p>
<p>The model is constituted by two parallel CNNs followed by a concatenation, a  FFN and a softmax layer.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>parameters</code></td>
        <td><code>list</code></td>
        <td><p>list of pre-trained parameters to be used for prediction</p></td>
        <td><code>[]</code></td>
      </tr>
      <tr>
        <td><code>load_params</code></td>
        <td><code>bool</code></td>
        <td><p>Bool to signal if params should be loaded</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/PytorchAcousticBackchanneler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="p">[],</span> <span class="n">load_params</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Defines the elements/layers of the neural network as well as loads the pretrained parameters</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    The model is constituted by two parallel CNNs followed by a concatenation, a  FFN and a softmax layer.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        parameters (list): list of pre-trained parameters to be used for prediction</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        load_params (bool): Bool to signal if params should be loaded</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">PytorchAcousticBackchanneler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="c1"># First CNN</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">cnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">cnn</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="n">cnn</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cnn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="n">cnn</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="c1"># Second CNN</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="n">cnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="n">cnn</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">cnn</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cnn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="n">cnn</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="mi">23</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="c1"># Linear layer</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="c1"># Softmax</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="k">if</span> <span class="n">load_params</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feat_inputs</span><span class="p">)</span></code>


<a href="#adviser.services.backchannel.PytorchAcousticBackchanneler.PytorchAcousticBackchanneler.forward" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>PyTorch forward method used for training and prediction. It defines the interaction between layers.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>feat_inputs</code></td>
        <td><code>numpy array</code></td>
        <td><p>It contains the network's input.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>out (torch.tensor)</code></td>
      <td><p>Network's output</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/PytorchAcousticBackchanneler.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feat_inputs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    PyTorch forward method used for training and prediction. It defines the interaction between layers.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        feat_inputs (numpy array): It contains the network&#39;s input.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        out (torch.tensor): Network&#39;s output</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">feat_inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">feat_inputs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">feat_inputs</span> <span class="o">=</span> <span class="n">feat_inputs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">cnn_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn1</span><span class="p">(</span><span class="n">feat_inputs</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">cnn_1</span> <span class="o">=</span> <span class="n">cnn_1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">cnn_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn2</span><span class="p">(</span><span class="n">feat_inputs</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">cnn_1</span><span class="p">,</span> <span class="n">cnn_2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.backchannel.acoustic_backchanneller" class="doc doc-heading">
        <code>acoustic_backchanneller</code>



<a href="#adviser.services.backchannel.acoustic_backchanneller" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h4 id="adviser.services.backchannel.acoustic_backchanneller.gpu" class="doc doc-heading">
<code class="highlight language-python"><span class="n">gpu</span></code>


<a href="#adviser.services.backchannel.acoustic_backchanneller.gpu" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h4 id="adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller" class="doc doc-heading">
        <code>
AcousticBackchanneller            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>AcousticBackchanneller predicts a backchannel given the last user utterance.
The model can predict: No backchannel (0), Assessment (1), Continuer (2)
The backchannel realization is added in the NLG module.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/acoustic_backchanneller.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">AcousticBackchanneller</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;AcousticBackchanneller predicts a backchannel given the last user utterance.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">       The model can predict: No backchannel (0), Assessment (1), Continuer (2)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">       The backchannel realization is added in the NLG module.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">speech_in_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trained_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;backchannel&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/pytorch_acoustic_backchanneller.pt&#39;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        The PyTorch Backchannel model is instantiated and the pretrained parameters are loaded.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PytorchAcousticBackchanneler</span><span class="p">()</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trained_model_path</span><span class="p">))</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">def</span> <span class="nf">split_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mfcc_features</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        Preprocess and segmentation of MFCC features of the user&#39;s speech.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">        Segmentation is done every 150ms without overlapping.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">            mfcc_features (numpy.array): mffcc features of users speech</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">            new_data (list): segmented mfcc features</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="n">input_height</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># this stands for 150ms</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="n">input_length</span> <span class="o">=</span> <span class="n">mfcc_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">zero_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mfcc_features</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">zero_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_height</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">input_height</span><span class="p">)]))</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">new_data</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">input_height</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                <span class="n">zero_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">zero_shape</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                <span class="n">zero_data</span><span class="p">[</span><span class="o">-</span><span class="n">r</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mfcc_features</span><span class="p">[:</span><span class="n">r</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                <span class="n">new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero_data</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                <span class="n">new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfcc_features</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="n">input_height</span><span class="p">:</span><span class="n">r</span><span class="p">,</span> <span class="p">:])</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mfcc&#39;</span><span class="p">],</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>                      <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;predicted_BC&quot;</span><span class="p">])</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    <span class="k">def</span> <span class="nf">backchannel_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mfcc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">        Service that receives the MFCC features from the user&#39;s speech.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">        It preprocess and normalize them and makes the BC prediction.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">            mfcc_features (torch.tensor): MFCC features</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">            (dict): a dictionary with the key &quot;predicted_BC&quot; and the value of the BC type</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="c1"># class_int_mapping = {0: b&#39;no_bc&#39;, 1: b&#39;assessment&#39;, 2: b&#39;continuer&#39;}</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="n">mfcc_features</span> <span class="o">=</span> <span class="n">mfcc</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="n">scaler</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">()</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="n">mfcc_features</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">mfcc_features</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="n">input_splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_input_data</span><span class="p">(</span><span class="n">mfcc_features</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_splits</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="c1"># Returning the majority, unless a BC appears,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;predicted_BC&#39;</span><span class="p">:</span>  <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="k">elif</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">prediction</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">in</span> <span class="n">prediction</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="n">ones</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="n">prediction</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="n">twos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="n">prediction</span><span class="o">==</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;predicted_BC&#39;</span><span class="p">:</span>  <span class="mi">1</span> <span class="k">if</span> <span class="n">ones</span> <span class="o">&gt;</span> <span class="n">twos</span> <span class="k">else</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;predicted_BC&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">prediction</span> <span class="k">else</span> <span class="mi">2</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/acoustic_backchanneller.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">speech_in_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">trained_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;backchannel&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/pytorch_acoustic_backchanneller.pt&#39;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.backchannel_prediction" class="doc doc-heading">
<code class="highlight language-python"><span class="n">backchannel_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.backchannel_prediction" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/acoustic_backchanneller.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.load_model" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.load_model" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>The PyTorch Backchannel model is instantiated and the pretrained parameters are loaded.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/acoustic_backchanneller.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    The PyTorch Backchannel model is instantiated and the pretrained parameters are loaded.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PytorchAcousticBackchanneler</span><span class="p">()</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trained_model_path</span><span class="p">))</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.split_input_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">split_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mfcc_features</span><span class="p">)</span></code>


<a href="#adviser.services.backchannel.acoustic_backchanneller.AcousticBackchanneller.split_input_data" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Preprocess and segmentation of MFCC features of the user's speech.
Segmentation is done every 150ms without overlapping.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>mfcc_features</code></td>
        <td><code>numpy.array</code></td>
        <td><p>mffcc features of users speech</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>new_data (list)</code></td>
      <td><p>segmented mfcc features</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/backchannel/acoustic_backchanneller.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">split_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mfcc_features</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Preprocess and segmentation of MFCC features of the user&#39;s speech.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Segmentation is done every 150ms without overlapping.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        mfcc_features (numpy.array): mffcc features of users speech</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        new_data (list): segmented mfcc features</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">input_height</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># this stands for 150ms</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">input_length</span> <span class="o">=</span> <span class="n">mfcc_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">zero_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mfcc_features</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">zero_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_height</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">input_height</span><span class="p">)]))</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">new_data</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">input_height</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>            <span class="n">zero_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">zero_shape</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="n">zero_data</span><span class="p">[</span><span class="o">-</span><span class="n">r</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mfcc_features</span><span class="p">[:</span><span class="n">r</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="n">new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero_data</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfcc_features</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="n">input_height</span><span class="p">:</span><span class="n">r</span><span class="p">,</span> <span class="p">:])</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.bst" class="doc doc-heading">
        <code>bst</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.bst" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.bst.bst" class="doc doc-heading">
        <code>bst</code>



<a href="#adviser.services.bst.bst" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.bst.bst.HandcraftedBST" class="doc doc-heading">
        <code>
HandcraftedBST            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.bst.bst.HandcraftedBST" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>A rule-based approach to belief state tracking.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/bst/bst.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedBST</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    A rule-based approach to belief state tracking.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">BeliefState</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;beliefstate&quot;</span><span class="p">])</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span> <span class="nf">update_bst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_acts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">beliefstate</span><span class="o">=</span><span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">            Updates the current dialog belief state (which tracks the system&#39;s</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">            knowledge about what has been said in the dialog) based on the user actions generated</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">            from the user&#39;s utterances</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">                user_acts (list): a list of UserAct objects mapped from the user&#39;s last utterance</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">                (dict): a dictionary with the key &quot;beliefstate&quot; and the value the updated</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">                        BeliefState object</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="c1"># save last turn to memory</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">start_new_turn</span><span class="p">()</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="k">if</span> <span class="n">user_acts</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_informs</span><span class="p">(</span><span class="n">user_acts</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_requests</span><span class="p">()</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_usr_action_types</span><span class="p">(</span><span class="n">user_acts</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_user_acts</span><span class="p">(</span><span class="n">user_acts</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="n">num_entries</span><span class="p">,</span> <span class="n">discriminable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">get_num_dbmatches</span><span class="p">()</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;num_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_entries</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;discriminable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discriminable</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;beliefstate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">}</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">            Restets the belief state so it is ready for a new dialog</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="sd">                (dict): a dictionary with a single entry where the key is &#39;beliefstate&#39;and</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="sd">                        the value is a new BeliefState object</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="c1"># initialize belief state</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">BeliefState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    <span class="k">def</span> <span class="nf">_reset_informs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">]):</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">            If the user specifies a new value for a given slot, delete the old</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">            entry from the beliefstate</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="p">{</span><span class="n">act</span><span class="o">.</span><span class="n">slot</span> <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">acts</span> <span class="k">if</span> <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">}</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]]:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">slot</span><span class="p">]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>    <span class="k">def</span> <span class="nf">_reset_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a><span class="sd">            gets rid of requests from the previous turn</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>    <span class="k">def</span> <span class="nf">_get_all_usr_action_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_acts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">UserActionType</span><span class="p">]:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="sd">&quot;&quot;&quot; </span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a><span class="sd">        Returns a set of all different UserActionTypes in user_acts.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="sd">            user_acts (List[UserAct]): list of UserAct objects</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="sd">            set of UserActionType objects</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>        <span class="n">action_type_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>        <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">user_acts</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="n">action_type_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>        <span class="k">return</span> <span class="n">action_type_set</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>    <span class="k">def</span> <span class="nf">_handle_user_acts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_acts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">]):</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a><span class="sd">            Updates the belief state based on the information contained in the user act(s)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a><span class="sd">                user_acts (list[UserAct]): the list of user acts to use to update the belief state</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="c1"># reset any offers if the user informs any new information</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]</span> \
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>                <span class="ow">and</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>        <span class="c1"># We choose to interpret switching as wanting to start a new dialog and do not support</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>        <span class="c1"># resuming an old dialog</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">SelectDomain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;informs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;requests&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>        <span class="c1"># Handle user acts</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>        <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">user_acts</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="k">if</span> <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">][</span><span class="n">act</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">act</span><span class="o">.</span><span class="n">score</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="k">elif</span> <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>                <span class="c1"># add informs and their scores to the beliefstate</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>                <span class="k">if</span> <span class="n">act</span><span class="o">.</span><span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s2">&quot;informs&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">act</span><span class="o">.</span><span class="n">slot</span><span class="p">][</span><span class="n">act</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">act</span><span class="o">.</span><span class="n">score</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">act</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">act</span><span class="o">.</span><span class="n">value</span><span class="p">:</span> <span class="n">act</span><span class="o">.</span><span class="n">score</span><span class="p">}</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>            <span class="k">elif</span> <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">NegativeInform</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>                <span class="c1"># reset mentioned value to zero probability</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>                <span class="k">if</span> <span class="n">act</span><span class="o">.</span><span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>                    <span class="k">if</span> <span class="n">act</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">act</span><span class="o">.</span><span class="n">slot</span><span class="p">]:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">act</span><span class="o">.</span><span class="n">slot</span><span class="p">][</span><span class="n">act</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>            <span class="k">elif</span> <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">RequestAlternatives</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>                <span class="c1"># This way it is clear that the user is no longer asking about that one item</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.bst.bst.HandcraftedBST.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.bst.bst.HandcraftedBST.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/bst/bst.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">BeliefState</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.bst.bst.HandcraftedBST.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.bst.bst.HandcraftedBST.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Restets the belief state so it is ready for a new dialog</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(dict)</code></td>
      <td><p>a dictionary with a single entry where the key is 'beliefstate'and
        the value is a new BeliefState object</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/bst/bst.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Restets the belief state so it is ready for a new dialog</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">            (dict): a dictionary with a single entry where the key is &#39;beliefstate&#39;and</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                    the value is a new BeliefState object</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="c1"># initialize belief state</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">BeliefState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.bst.bst.HandcraftedBST.update_bst" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_bst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.bst.bst.HandcraftedBST.update_bst" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/bst/bst.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.domain_tracker" class="doc doc-heading">
        <code>domain_tracker</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.domain_tracker" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.domain_tracker.domain_tracker" class="doc doc-heading">
        <code>domain_tracker</code>



<a href="#adviser.services.domain_tracker.domain_tracker" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The console module provides ADVISER services for tracking current domain</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.domain_tracker.domain_tracker.DomainTracker" class="doc doc-heading">
        <code>
DomainTracker            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Responsible for selecting which domain should be active at a given time.
Current implmentation uses keywords to switch domains.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/domain_tracker/domain_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">DomainTracker</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Responsible for selecting which domain should be active at a given time.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        Current implmentation uses keywords to switch domains.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domains</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Domain</span><span class="p">],</span> <span class="n">greet_on_first_turn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="n">domains</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greet_on_first_turn</span> <span class="o">=</span> <span class="n">greet_on_first_turn</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">            Resets the domain tracker for the start of a new dialog</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gen_user_utterance&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_utterance&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_utterance&quot;</span><span class="p">])</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">def</span> <span class="nf">select_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen_user_utterance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user_utterance</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">            Determines which domain should currently be active. In general, if a keyword is mentioned, the domain</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">            will change, otherwise it is assumed that the previous domain is still active.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">                gen_user_utterance (str): the user utterance, before a domain has been determined</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">                (dict): A dictionary with &quot;user_utterane&quot; as a key and a string as the value with the</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">                        selected domain appended to the end so the message can be properly routed.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">greet_on_first_turn</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_utterance&#39;</span><span class="p">:</span> <span class="s2">&quot;Hello, please let me know how I can help you, I can discuss &quot;</span> <span class="o">+</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                    <span class="sa">f</span><span class="s2">&quot;the following domains: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domains_to_str</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">}</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="c1"># if there is only a single domain, simply route the message forward</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="c1"># make sure the utterance is lowercase if there is one</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="n">user_utterance</span> <span class="o">=</span> <span class="n">gen_user_utterance</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">if</span> <span class="n">user_utterance</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="n">user_utterance</span> <span class="o">=</span> <span class="n">gen_user_utterance</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="c1"># perform keyword matching to see if any domains are explicitely made active</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="n">active_domains</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get_keyword</span><span class="p">()</span> <span class="ow">in</span> <span class="n">user_utterance</span><span class="p">]</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="c1"># Even if no domain has been specified, we should be able to exit</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="k">if</span> <span class="s2">&quot;bye&quot;</span> <span class="ow">in</span> <span class="n">user_utterance</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">:</span> <span class="s2">&quot;Thank you, goodbye.&quot;</span><span class="p">}</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="c1"># if there are active domains, use the first one</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="k">elif</span> <span class="n">active_domains</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>            <span class="n">out_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user_utterance/</span><span class="si">{</span><span class="n">active_domains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span> <span class="o">=</span> <span class="n">active_domains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="k">return</span> <span class="p">{</span><span class="n">out_key</span><span class="p">:</span> <span class="n">user_utterance</span><span class="p">}</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="c1"># if no domain is explicitely mentioned, assume the last one is still active</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>            <span class="n">out_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user_utterance/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>            <span class="k">return</span> <span class="p">{</span><span class="n">out_key</span><span class="p">:</span> <span class="n">user_utterance</span><span class="p">}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="c1"># Otherwise ask the user what domain they want</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello, please let me know how I can help you, I can discuss &quot;</span> <span class="o">+</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>                    <span class="sa">f</span><span class="s2">&quot;the following domains: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domains_to_str</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">}</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>    <span class="k">def</span> <span class="nf">domains_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a><span class="sd">            Method to create the greeting on the first turn, grammatically joins the names of possible domains into</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a><span class="sd">            a string</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="sd">                (str): String representing a list of all domain names the system can talk about</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="k">return</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">])</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>            <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;, and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.domain_tracker.domain_tracker.DomainTracker.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">greet_on_first_turn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/domain_tracker/domain_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domains</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Domain</span><span class="p">],</span> <span class="n">greet_on_first_turn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="n">domains</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">greet_on_first_turn</span> <span class="o">=</span> <span class="n">greet_on_first_turn</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.domain_tracker.domain_tracker.DomainTracker.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Resets the domain tracker for the start of a new dialog</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/domain_tracker/domain_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Resets the domain tracker for the start of a new dialog</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">current_domain</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.domain_tracker.domain_tracker.DomainTracker.domains_to_str" class="doc doc-heading">
<code class="highlight language-python"><span class="n">domains_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.domains_to_str" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Method to create the greeting on the first turn, grammatically joins the names of possible domains into
a string</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(str)</code></td>
      <td><p>String representing a list of all domain names the system can talk about</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/domain_tracker/domain_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">domains_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Method to create the greeting on the first turn, grammatically joins the names of possible domains into</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        a string</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">            (str): String representing a list of all domain names the system can talk about</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">return</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">])</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;, and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_display_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.domain_tracker.domain_tracker.DomainTracker.select_domain" class="doc doc-heading">
<code class="highlight language-python"><span class="n">select_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.domain_tracker.domain_tracker.DomainTracker.select_domain" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/domain_tracker/domain_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.emotion" class="doc doc-heading">
        <code>emotion</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.emotion" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.emotion.EmotionRecognition" class="doc doc-heading">
        <code>EmotionRecognition</code>



<a href="#adviser.services.emotion.EmotionRecognition" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Emotion recognition module.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.emotion.EmotionRecognition.EmotionRecognition" class="doc doc-heading">
        <code>
EmotionRecognition            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Emotion recognition module.</p>
<p>This module receives acoustic features, loads pretrained models and outputs
predictions of emotional states. It can easily be extended/adapted to use
different models and facial features in addition.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/emotion/EmotionRecognition.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">EmotionRecognition</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Emotion recognition module.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    This module receives acoustic features, loads pretrained models and outputs</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    predictions of emotional states. It can easily be extended/adapted to use</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    different models and facial features in addition.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="sd">&quot;&quot;&quot; Emotion recognition module.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        On initialization all necessary models are loaded.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">emotion_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">emotion_dir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;emotion&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">def</span> <span class="nf">load_args</span><span class="p">(</span><span class="n">emo_representation</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="n">arg_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">emo_representation</span><span class="si">}</span><span class="s1">_args.pkl&#39;</span><span class="p">),</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                     <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="k">return</span> <span class="n">arg_dict</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">emo_representation</span><span class="p">,</span> <span class="n">arg_dict</span><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="n">ARGS</span> <span class="o">=</span> <span class="n">arg_dict</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">cnn</span><span class="p">(</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">ARGS</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">arg_dict</span><span class="p">[</span><span class="s1">&#39;D_in&#39;</span><span class="p">]),</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="n">D_out</span><span class="o">=</span><span class="n">arg_dict</span><span class="p">[</span><span class="s1">&#39;D_out&#39;</span><span class="p">],</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                <span class="n">args</span><span class="o">=</span><span class="n">ARGS</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>                                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">emo_representation</span><span class="si">}</span><span class="s1">_model_params.pt&#39;</span><span class="p">),</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>                    <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>                <span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">emo_representations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;arousal&#39;</span><span class="p">,</span> <span class="s1">&#39;valence&#39;</span><span class="p">]</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="k">for</span> <span class="n">emo_representation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emo_representations</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_args</span><span class="p">(</span><span class="n">emo_representation</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>                <span class="n">emo_representation</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">]</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>            <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arousal_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">}</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">valence_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;positive&#39;</span><span class="p">}</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">category_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="mi">0</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Angry</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>            <span class="mi">1</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Happy</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="mi">2</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Neutral</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="mi">3</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Sad</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="p">}</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fbank&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;emotion&quot;</span><span class="p">])</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>    <span class="k">def</span> <span class="nf">predict_from_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fbank</span><span class="p">):</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="sd">&quot;&quot;&quot;Emotion prediction from acoustic features.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a><span class="sd">            fbank (torch.Tensor): feature array, shape (sequence, num_mel_bins)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a><span class="sd">            dict: nested dictionary containing all results, main key: &#39;emotion&#39;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="k">def</span> <span class="nf">normalize_and_pad_features</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">mean</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">std</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>            <span class="c1"># normalize</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="n">features</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>            <span class="c1"># cut or pad with zeros as necessary</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>                <span class="p">[</span><span class="n">features</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">],</span>  <span class="c1"># take feature data until :seq_len</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                 <span class="n">features</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span>  <span class="c1"># pad with zeros if seq_len &gt; feature.size(0)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>                    <span class="p">(</span><span class="n">seq_len</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&gt;</span> <span class="n">features</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>                     <span class="n">features</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))],</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># concatenate zeros in time dimension</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>            <span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>            <span class="k">return</span> <span class="n">features</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>        <span class="k">for</span> <span class="n">emo_representation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emo_representations</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>            <span class="n">seq_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seq_length</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">][</span><span class="s1">&#39;norm_mean&#39;</span><span class="p">]</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>            <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">][</span><span class="s1">&#39;norm_std&#39;</span><span class="p">]</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>            <span class="c1"># feature normalization and padding has to be done for each</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>            <span class="c1"># emotion representation individually because the means and</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>            <span class="c1"># standard (deviations) (and sequence length) can be different</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>            <span class="n">features</span> <span class="o">=</span> <span class="n">normalize_and_pad_features</span><span class="p">(</span><span class="n">fbank</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mean</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">std</span><span class="p">))</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>            <span class="n">predictions</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">]</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">](</span><span class="n">features</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>            <span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>        <span class="n">arousal_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arousal_mapping</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;arousal&#39;</span><span class="p">])]</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="n">valence_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valence_mapping</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;valence&#39;</span><span class="p">])]</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="n">category_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_mapping</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">])]</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;emotion&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;arousal&#39;</span><span class="p">:</span> <span class="n">arousal_level</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>                            <span class="s1">&#39;valence&#39;</span><span class="p">:</span> <span class="n">valence_level</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>                            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category_label</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>                            <span class="s1">&#39;cateogry_probabilities&#39;</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>                                <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)}}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.emotion.EmotionRecognition.EmotionRecognition.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Emotion recognition module.</p>
<p>On initialization all necessary models are loaded.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/emotion/EmotionRecognition.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Emotion recognition module.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    On initialization all necessary models are loaded.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">emotion_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">emotion_dir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;emotion&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">def</span> <span class="nf">load_args</span><span class="p">(</span><span class="n">emo_representation</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="n">arg_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">emo_representation</span><span class="si">}</span><span class="s1">_args.pkl&#39;</span><span class="p">),</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                 <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="k">return</span> <span class="n">arg_dict</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">emo_representation</span><span class="p">,</span> <span class="n">arg_dict</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="n">ARGS</span> <span class="o">=</span> <span class="n">arg_dict</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">cnn</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">ARGS</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">arg_dict</span><span class="p">[</span><span class="s1">&#39;D_in&#39;</span><span class="p">]),</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="n">D_out</span><span class="o">=</span><span class="n">arg_dict</span><span class="p">[</span><span class="s1">&#39;D_out&#39;</span><span class="p">],</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="n">args</span><span class="o">=</span><span class="n">ARGS</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">emo_representation</span><span class="si">}</span><span class="s1">_model_params.pt&#39;</span><span class="p">),</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">emo_representations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;arousal&#39;</span><span class="p">,</span> <span class="s1">&#39;valence&#39;</span><span class="p">]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="k">for</span> <span class="n">emo_representation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emo_representations</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_args</span><span class="p">(</span><span class="n">emo_representation</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="n">emo_representation</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">emo_representation</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">arousal_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">}</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">valence_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;positive&#39;</span><span class="p">}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">category_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="mi">0</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Angry</span><span class="p">,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="mi">1</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Happy</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="mi">2</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Neutral</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="mi">3</span><span class="p">:</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Sad</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.emotion.EmotionRecognition.EmotionRecognition.predict_from_audio" class="doc doc-heading">
<code class="highlight language-python"><span class="n">predict_from_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.emotion.EmotionRecognition.EmotionRecognition.predict_from_audio" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/emotion/EmotionRecognition.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.engagement" class="doc doc-heading">
        <code>engagement</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.engagement" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.engagement.engagement_tracker" class="doc doc-heading">
        <code>engagement_tracker</code>



<a href="#adviser.services.engagement.engagement_tracker" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.engagement.engagement_tracker.EngagementTracker" class="doc doc-heading">
        <code>
EngagementTracker            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.engagement.engagement_tracker.EngagementTracker" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Start feature extraction with OpenFace.
Requires OpenFace to be installed - instructions can be found in tool/openface.txt</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">EngagementTracker</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Start feature extraction with OpenFace.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Requires OpenFace to be installed - instructions can be found in tool/openface.txt</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">openface_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6004</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            camera_id: index of the camera you want to use (if you only have one camera: 0)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">camera_id</span> <span class="o">=</span> <span class="n">camera_id</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">openface_port</span> <span class="o">=</span> <span class="n">openface_port</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">openface_running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">delay</span>   <span class="c1"># provide number of seconds as parameter, one second = 15 frames</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://127.0.0.1:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">openface_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="n">startExtraction</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s1">&#39;tools/OpenFace/build/bin/FaceLandmarkVidZMQ&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> -device </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_id</span><span class="si">}</span><span class="s2"> -port 6004&quot;</span>    <span class="c1"># todo config open face port</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_openface</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">startExtraction</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>	<span class="c1"># start OpenFace</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="c1"># Set openface to publishing mode and wait until it is ready</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPENFACE_START&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>    <span class="c1"># receive started signal</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;OPENFACE_STARTED&quot;</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;START EXTRACTION&quot;</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">publish_gaze_directions</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;engagement&quot;</span><span class="p">,</span> <span class="s2">&quot;gaze_direction&quot;</span><span class="p">])</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="k">def</span> <span class="nf">yield_gaze_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engagement</span><span class="p">:</span> <span class="n">EngagementType</span><span class="p">,</span> <span class="n">gaze_direction</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">        This is a helper function for the continuous publishing of engagement features.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="sd">        Call this function from a continuously running loop.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="sd">            engagement (EngagementType): high / low</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="sd">            gaze_direction (float, float): tuple of gaze-x-angle and gaze-y-angle</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;engagement&quot;</span><span class="p">:</span> <span class="n">engagement</span><span class="p">,</span> <span class="s2">&quot;gaze_direction&quot;</span><span class="p">:</span> <span class="n">gaze_direction</span><span class="p">}</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="k">def</span> <span class="nf">publish_gaze_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">        Meant to be used in a thread.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">        Runs an inifinte loop polling features from OpenFace library, parsing them and extracting engagement features.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">        Calls `yield_gaze_direction` to publish the polled and processed engagement features.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="n">x_coordinates</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="n">y_coordinates</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.0</span>			<span class="c1"># center point of screen; should be close(r) to 0</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="n">looking</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPENFACE_PULL&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="n">msg</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>                <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;OPENFACE_ENDED&quot;</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>                <span class="n">gaze_x</span> <span class="o">=</span> <span class="n">msg_data</span><span class="p">[</span><span class="s2">&quot;gaze&quot;</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>                <span class="n">gaze_y</span> <span class="o">=</span> <span class="n">msg_data</span><span class="p">[</span><span class="s2">&quot;gaze&quot;</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>                <span class="n">gaze_x</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">gaze_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>				<span class="c1"># gaze_angle_x (left-right movement), square + root is done to yield only positive values</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>                <span class="n">gaze_y</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">gaze_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>				<span class="c1"># gaze_angle_y (up-down movement) </span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>                <span class="n">x_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                <span class="n">y_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaze_y</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>                <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_coordinates</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>                <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>                    <span class="n">previous_x</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">x_coordinates</span><span class="p">[</span><span class="n">current</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">current</span><span class="p">])</span>		<span class="c1"># obtain the average of previous frames</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>                    <span class="n">previous_y</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">y_coordinates</span><span class="p">[</span><span class="n">current</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">current</span><span class="p">])</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>                    <span class="n">difference_x</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">norm</span> <span class="o">-</span> <span class="n">previous_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>					<span class="c1"># compare current frame to average of previous frames</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>                    <span class="n">difference_y</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">norm</span> <span class="o">-</span> <span class="n">previous_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>                    <span class="c1"># print(difference_x, difference_y)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>                    <span class="k">if</span> <span class="n">difference_x</span> <span class="o">&lt;</span> <span class="mf">0.15</span> <span class="ow">and</span> <span class="n">difference_y</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>				<span class="c1"># check whether difference between current and previous frames exceeds certain threshold (regulates tolerance/strictness)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>                        <span class="k">if</span> <span class="n">looking</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>                            <span class="n">looking</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">yield_gaze_direction</span><span class="p">(</span><span class="n">engagement</span><span class="o">=</span><span class="n">EngagementType</span><span class="o">.</span><span class="n">High</span><span class="p">,</span> <span class="n">gaze_direction</span><span class="o">=</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">,</span> <span class="n">gaze_y</span><span class="p">))</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>                        <span class="k">if</span> <span class="n">looking</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>                            <span class="n">looking</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">yield_gaze_direction</span><span class="p">(</span><span class="n">engagement</span><span class="o">=</span><span class="n">EngagementType</span><span class="o">.</span><span class="n">Low</span><span class="p">,</span> <span class="n">gaze_direction</span><span class="o">=</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">,</span> <span class="n">gaze_y</span><span class="p">))</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>                <span class="c1"># import traceback</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>                <span class="c1"># traceback.print_exc()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>                <span class="k">pass</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>    <span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="c1"># Set openface to non-publishing mode and wait until it is ready</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPENFACE_END&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>    <span class="k">def</span> <span class="nf">dialog_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>        <span class="c1"># close openface process</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_openface</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.engagement.engagement_tracker.EngagementTracker.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">camera_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">openface_port</span><span class="o">=</span><span class="mi">6004</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>camera_id</code></td>
        <td><code>int</code></td>
        <td><p>index of the camera you want to use (if you only have one camera: 0)</p></td>
        <td><code>0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">openface_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6004</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        camera_id: index of the camera you want to use (if you only have one camera: 0)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">camera_id</span> <span class="o">=</span> <span class="n">camera_id</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">openface_port</span> <span class="o">=</span> <span class="n">openface_port</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">openface_running</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">delay</span>   <span class="c1"># provide number of seconds as parameter, one second = 15 frames</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://127.0.0.1:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">openface_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">startExtraction</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s1">&#39;tools/OpenFace/build/bin/FaceLandmarkVidZMQ&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> -device </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_id</span><span class="si">}</span><span class="s2"> -port 6004&quot;</span>    <span class="c1"># todo config open face port</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">p_openface</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">startExtraction</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>	<span class="c1"># start OpenFace</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_end" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>This function is called after a dialog ended (Topics.DIALOG_END message was received).
You should overwrite this function to record dialog-level information. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># Set openface to non-publishing mode and wait until it is ready</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPENFACE_END&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_exit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_exit" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>This function is called when the dialog system is shutting down.
You should overwrite this function to stop your threads and cleanup any open resources. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># close openface process</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">p_openface</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>This function is called before the first message to a new dialog is published.
You should overwrite this function to set/reset dialog-level variables. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># Set openface to publishing mode and wait until it is ready</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPENFACE_START&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>    <span class="c1"># receive started signal</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;OPENFACE_STARTED&quot;</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;START EXTRACTION&quot;</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">publish_gaze_directions</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">extractor_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.engagement.engagement_tracker.EngagementTracker.publish_gaze_directions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">publish_gaze_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.publish_gaze_directions" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Meant to be used in a thread.
Runs an inifinte loop polling features from OpenFace library, parsing them and extracting engagement features.
Calls <code>yield_gaze_direction</code> to publish the polled and processed engagement features.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">publish_gaze_directions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Meant to be used in a thread.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Runs an inifinte loop polling features from OpenFace library, parsing them and extracting engagement features.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Calls `yield_gaze_direction` to publish the polled and processed engagement features.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">x_coordinates</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">y_coordinates</span><span class="o">=</span><span class="p">[]</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.0</span>			<span class="c1"># center point of screen; should be close(r) to 0</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">looking</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPENFACE_PULL&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">msg</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">openface_endpoint</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;OPENFACE_ENDED&quot;</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">extracting</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>            <span class="n">msg_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="n">gaze_x</span> <span class="o">=</span> <span class="n">msg_data</span><span class="p">[</span><span class="s2">&quot;gaze&quot;</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>            <span class="n">gaze_y</span> <span class="o">=</span> <span class="n">msg_data</span><span class="p">[</span><span class="s2">&quot;gaze&quot;</span><span class="p">][</span><span class="s2">&quot;angle&quot;</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="n">gaze_x</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">gaze_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>				<span class="c1"># gaze_angle_x (left-right movement), square + root is done to yield only positive values</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="n">gaze_y</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">gaze_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>				<span class="c1"># gaze_angle_y (up-down movement) </span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="n">x_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">y_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaze_y</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_coordinates</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                <span class="n">previous_x</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">x_coordinates</span><span class="p">[</span><span class="n">current</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">current</span><span class="p">])</span>		<span class="c1"># obtain the average of previous frames</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">previous_y</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">y_coordinates</span><span class="p">[</span><span class="n">current</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">current</span><span class="p">])</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="n">difference_x</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">norm</span> <span class="o">-</span> <span class="n">previous_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>					<span class="c1"># compare current frame to average of previous frames</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                <span class="n">difference_y</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">norm</span> <span class="o">-</span> <span class="n">previous_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>                <span class="c1"># print(difference_x, difference_y)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                <span class="k">if</span> <span class="n">difference_x</span> <span class="o">&lt;</span> <span class="mf">0.15</span> <span class="ow">and</span> <span class="n">difference_y</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>				<span class="c1"># check whether difference between current and previous frames exceeds certain threshold (regulates tolerance/strictness)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>                    <span class="k">if</span> <span class="n">looking</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                        <span class="n">looking</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">yield_gaze_direction</span><span class="p">(</span><span class="n">engagement</span><span class="o">=</span><span class="n">EngagementType</span><span class="o">.</span><span class="n">High</span><span class="p">,</span> <span class="n">gaze_direction</span><span class="o">=</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">,</span> <span class="n">gaze_y</span><span class="p">))</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>                    <span class="k">if</span> <span class="n">looking</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                        <span class="n">looking</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">yield_gaze_direction</span><span class="p">(</span><span class="n">engagement</span><span class="o">=</span><span class="n">EngagementType</span><span class="o">.</span><span class="n">Low</span><span class="p">,</span> <span class="n">gaze_direction</span><span class="o">=</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">,</span> <span class="n">gaze_y</span><span class="p">))</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="c1"># import traceback</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="c1"># traceback.print_exc()</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.engagement.engagement_tracker.EngagementTracker.yield_gaze_direction" class="doc doc-heading">
<code class="highlight language-python"><span class="n">yield_gaze_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.engagement.engagement_tracker.EngagementTracker.yield_gaze_direction" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h4 id="adviser.services.engagement.engagement_tracker.get_root_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_root_dir</span><span class="p">()</span></code>


<a href="#adviser.services.engagement.engagement_tracker.get_root_dir" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/engagement/engagement_tracker.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_root_dir</span><span class="p">():</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.hci" class="doc doc-heading">
        <code>hci</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 id="adviser.services.hci.__all__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__all__</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.__all__" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

    </div>

  </div>







  <div class="doc doc-object doc-module">



<h3 id="adviser.services.hci.console" class="doc doc-heading">
        <code>console</code>



<a href="#adviser.services.hci.console" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>The console module provides ADVISER modules that access the console for input and output.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.hci.console.ConsoleInput" class="doc doc-heading">
        <code>
ConsoleInput            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.console.ConsoleInput" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Gets the user utterance from the console.</p>
<p>Waits for the built-in input function to return a non-empty text.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/console.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ConsoleInput</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Gets the user utterance from the console.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Waits for the built-in input function to return a non-empty text.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="c1"># self.language = language</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># if self.language is None:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="c1">#     self.language = self._set_language()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="n">Topic</span><span class="o">.</span><span class="n">DIALOG_END</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gen_user_utterance&quot;</span><span class="p">])</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">def</span> <span class="nf">get_user_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user_utterance</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">        If this function has not been called before, do not pass a message.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        Otherwise, it blocks the application until the user has entered a</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">        valid (i.e. non-empty) message in the console.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">            dict: a dict containing the user utterance</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">if</span> <span class="n">dialog_end</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="k">return</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="n">utterance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">()</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="c1"># write into logging directory</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;_user.txt&quot;</span><span class="p">)),</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>                      <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">convo_log</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                <span class="n">convo_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">utterance</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gen_user_utterance&#39;</span><span class="p">:</span> <span class="n">utterance</span><span class="p">}</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="k">def</span> <span class="nf">_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="s2">&quot;Helper function for reading text input from the console&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="n">utterance</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; &#39;</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="k">while</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dialog_system_parent&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">terminating</span><span class="p">():</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                <span class="n">line</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="n">utterance</span> <span class="o">=</span> <span class="n">line</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dialog_system_parent&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">terminating</span><span class="p">():</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>                <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>            <span class="k">return</span> <span class="n">utterance</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>            <span class="k">return</span> <span class="n">utterance</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    <span class="k">def</span> <span class="nf">_set_language</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Language</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            asks the user to select the language of the system, returning the enum</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">            representing their preference, or None if they don&#39;t give a recognized</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">            input</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="n">utterance</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please select your language: English or German&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="k">while</span> <span class="n">utterance</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>            <span class="n">utterance</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; &quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="n">utterance</span> <span class="o">=</span> <span class="n">utterance</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="k">if</span> <span class="n">utterance</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span> <span class="ow">or</span> <span class="n">utterance</span> <span class="o">==</span> <span class="s1">&#39;english&#39;</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="k">return</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="k">elif</span> <span class="n">utterance</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">or</span> <span class="n">utterance</span> <span class="o">==</span> <span class="s1">&#39;german&#39;</span> <span class="ow">or</span> <span class="n">utterance</span> <span class="o">==</span> <span class="s1">&#39;deutsch&#39;</span> \
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>                <span class="ow">or</span> <span class="n">utterance</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="k">return</span> <span class="n">Language</span><span class="o">.</span><span class="n">GERMAN</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.console.ConsoleInput.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.console.ConsoleInput.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/console.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="c1"># self.language = language</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">interaction_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="c1"># if self.language is None:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="c1">#     self.language = self._set_language()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.console.ConsoleInput.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.hci.console.ConsoleInput.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>This function is called before the first message to a new dialog is published.
You should overwrite this function to set/reset dialog-level variables. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/console.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">interaction_count</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.console.ConsoleInput.get_user_input" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_user_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.console.ConsoleInput.get_user_input" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/console.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="adviser.services.hci.console.ConsoleOutput" class="doc doc-heading">
        <code>
ConsoleOutput            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.console.ConsoleOutput" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Writes the system utterance to the console.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/console.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ConsoleOutput</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Writes the system utterance to the console.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="n">Topic</span><span class="o">.</span><span class="n">DIALOG_END</span><span class="p">])</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="nf">print_sys_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_utterance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">():</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        The message is simply printed to the console.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">            sys_utterance (str): The system utterance</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">            dict with entry dialog_end: True or False</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">            ValueError: if there is no system utterance to print</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">if</span> <span class="n">sys_utterance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sys_utterance</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys_utterance</span><span class="p">))</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There is no system utterance. Did you forget to call an NLG module before?&quot;</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="k">return</span> <span class="p">{</span><span class="n">Topic</span><span class="o">.</span><span class="n">DIALOG_END</span><span class="p">:</span> <span class="s1">&#39;bye&#39;</span> <span class="ow">in</span> <span class="n">sys_utterance</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.console.ConsoleOutput.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.console.ConsoleOutput.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/console.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.console.ConsoleOutput.print_sys_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">print_sys_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.console.ConsoleOutput.print_sys_utterance" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/console.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.hci.gui" class="doc doc-heading">
        <code>gui</code>



<a href="#adviser.services.hci.gui" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.hci.gui.GUIServer" class="doc doc-heading">
        <code>
GUIServer            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.gui.GUIServer" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/gui.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">GUIServer</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;GUIServer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loopy_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="c1"># open UI in webbrowser automatically</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">webui_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;file:///</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;tools&#39;</span><span class="p">,</span> <span class="s1">&#39;webui&#39;</span><span class="p">,</span> <span class="s1">&#39;chat.html&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WEBUI accessible at&quot;</span><span class="p">,</span> <span class="n">webui_path</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">webui_path</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gen_user_utterance&#39;</span><span class="p">])</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span> <span class="nf">user_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gen_user_utterance&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sys_utterance&#39;</span><span class="p">])</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="k">def</span> <span class="nf">forward_sys_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forward_message_to_react</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">sys_utterance</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">def</span> <span class="nf">forward_message_to_react</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loopy_loop</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="o">.</span><span class="n">write_message</span><span class="p">({</span><span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="n">topic</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">})</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.gui.GUIServer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.gui.GUIServer.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/gui.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;GUIServer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">loopy_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="c1"># open UI in webbrowser automatically</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">webui_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;file:///</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;tools&#39;</span><span class="p">,</span> <span class="s1">&#39;webui&#39;</span><span class="p">,</span> <span class="s1">&#39;chat.html&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WEBUI accessible at&quot;</span><span class="p">,</span> <span class="n">webui_path</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">webui_path</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.gui.GUIServer.forward_message_to_react" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward_message_to_react</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span></code>


<a href="#adviser.services.hci.gui.GUIServer.forward_message_to_react" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/gui.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">forward_message_to_react</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loopy_loop</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="o">.</span><span class="n">write_message</span><span class="p">({</span><span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="n">topic</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.gui.GUIServer.forward_sys_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward_sys_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.gui.GUIServer.forward_sys_utterance" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/gui.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.hci.gui.GUIServer.user_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">user_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.gui.GUIServer.user_utterance" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/gui.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.hci.speech" class="doc doc-heading">
        <code>speech</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.speech" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.speech.SpeechInputDecoder" class="doc doc-heading">
        <code>SpeechInputDecoder</code>



<a href="#adviser.services.hci.speech.SpeechInputDecoder" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder" class="doc doc-heading">
        <code>
SpeechInputDecoder            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputDecoder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">SpeechInputDecoder</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        Transforms spoken input from the user to text for further processing.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">            domain (Domain): Needed for Service, but has no meaning here</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            identifier (string): Needed for Service</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">            conversation_log_dir (string): If this is provided, logfiles will be placed by this Service into the specified directory.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">            use_cuda (boolean): Whether or not to run the computations on a GPU</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="c1"># load model</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;speech&quot;</span><span class="p">,</span> <span class="s2">&quot;multi_en_20190916&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">load_trained_model</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s2">&quot;model.bin&quot;</span><span class="p">))</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">char_list</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="c1"># setup beam search</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">BeamSearch</span><span class="p">(</span><span class="n">scorers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scorers</span><span class="p">(),</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                             <span class="n">weights</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;decoder&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;ctc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                             <span class="n">sos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sos</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                             <span class="n">eos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eos</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                             <span class="n">beam_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                             <span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">),</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                             <span class="n">pre_beam_score_key</span><span class="o">=</span><span class="s2">&quot;decoder&quot;</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">BatchBeamSearch</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="c1"># choose hardware to run on</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="c1"># change from training mode to eval mode</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="c1"># scale and offset for feature normalization</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="c1"># follows https://github.com/kaldi-asr/kaldi/blob/33255ed224500f55c8387f1e4fa40e08b73ff48a/src/transform/cmvn.cc#L92-L111</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="n">norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s2">&quot;cmvn.bin&quot;</span><span class="p">))</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="n">count</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span> <span class="o">*</span> <span class="n">mean</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">mean</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;speech_features&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gen_user_utterance&quot;</span><span class="p">])</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="k">def</span> <span class="nf">features_to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speech_features</span><span class="p">):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">        Turns features of the utterance into a string and returns the user utterance in form of text</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            speech_features (np.array): The features that the speech feature extraction module produces</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">            dict(string, string): The user utterance as text</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="n">speech_in_features_normalized</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">speech_features</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>            <span class="n">encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">speech_in_features_normalized</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="c1"># We only consider the most probable hypothesis.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="c1"># Language Model could improve this, right now we don&#39;t use one.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="c1"># This might need some post-processing...</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="n">user_utterance</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yseq</span><span class="p">)</span> \
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;▁&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> \
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> \
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;eos&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> \
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>            <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="c1"># write decoded text into logging directory</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;_user.txt&quot;</span><span class="p">)),</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                      <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">convo_log</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>                <span class="n">convo_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;User: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">))</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;gen_user_utterance&#39;</span><span class="p">:</span> <span class="n">user_utterance</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Transforms spoken input from the user to text for further processing.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>Needed for Service, but has no meaning here</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>identifier</code></td>
        <td><code>string</code></td>
        <td><p>Needed for Service</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>conversation_log_dir</code></td>
        <td><code>string</code></td>
        <td><p>If this is provided, logfiles will be placed by this Service into the specified directory.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>use_cuda</code></td>
        <td><code>boolean</code></td>
        <td><p>Whether or not to run the computations on a GPU</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputDecoder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Transforms spoken input from the user to text for further processing.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        domain (Domain): Needed for Service, but has no meaning here</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        identifier (string): Needed for Service</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        conversation_log_dir (string): If this is provided, logfiles will be placed by this Service into the specified directory.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        use_cuda (boolean): Whether or not to run the computations on a GPU</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="c1"># load model</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;speech&quot;</span><span class="p">,</span> <span class="s2">&quot;multi_en_20190916&quot;</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">load_trained_model</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s2">&quot;model.bin&quot;</span><span class="p">))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">char_list</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="c1"># setup beam search</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">BeamSearch</span><span class="p">(</span><span class="n">scorers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scorers</span><span class="p">(),</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                         <span class="n">weights</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;decoder&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;ctc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                         <span class="n">sos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sos</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                         <span class="n">eos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eos</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                         <span class="n">beam_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                         <span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">),</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                         <span class="n">pre_beam_score_key</span><span class="o">=</span><span class="s2">&quot;decoder&quot;</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">BatchBeamSearch</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="c1"># choose hardware to run on</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="c1"># change from training mode to eval mode</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="c1"># scale and offset for feature normalization</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="c1"># follows https://github.com/kaldi-asr/kaldi/blob/33255ed224500f55c8387f1e4fa40e08b73ff48a/src/transform/cmvn.cc#L92-L111</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="n">norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="s2">&quot;cmvn.bin&quot;</span><span class="p">))</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="n">count</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">count</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span> <span class="o">*</span> <span class="n">mean</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">mean</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.features_to_text" class="doc doc-heading">
<code class="highlight language-python"><span class="n">features_to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechInputDecoder.SpeechInputDecoder.features_to_text" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputDecoder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.SpeechInputDecoder.get_root_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_root_dir</span><span class="p">()</span></code>


<a href="#adviser.services.hci.speech.SpeechInputDecoder.get_root_dir" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputDecoder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_root_dir</span><span class="p">():</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.speech.SpeechInputFeatureExtractor" class="doc doc-heading">
        <code>SpeechInputFeatureExtractor</code>



<a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor" class="doc doc-heading">
        <code>
SpeechInputFeatureExtractor            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputFeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">SpeechInputFeatureExtractor</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        Given a sound, this service extracts features and passes them on to the decoder for ASR</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">            domain (Domain): Needed for Service, no meaning here</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;speech_in&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;speech_features&quot;</span><span class="p">])</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">def</span> <span class="nf">speech_to_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speech_in</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        Turns numpy array with utterance into features</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">            speech_in (tuple(np.array), int): The utterance, represented as array and the sampling rate</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">            np.array: The extracted features of the utterance</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="n">sample_frequence</span> <span class="o">=</span> <span class="n">speech_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">speech_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">speech_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">filter_bank</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">compliance</span><span class="o">.</span><span class="n">kaldi</span><span class="o">.</span><span class="n">fbank</span><span class="p">(</span><span class="n">speech_in</span><span class="p">,</span> <span class="n">num_mel_bins</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">sample_frequency</span><span class="o">=</span><span class="n">sample_frequence</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="c1"># Default ASR model uses 16kHz, but different models are possible, then the sampling rate only needs to be changd in the recorder</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="n">pitch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">filter_bank</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># TODO: check if torchaudio pitch function is better</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="n">speech_in_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">filter_bank</span><span class="p">,</span> <span class="n">pitch</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;speech_features&#39;</span><span class="p">:</span> <span class="n">speech_in_features</span><span class="p">}</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;speech_in&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mfcc&quot;</span><span class="p">])</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="k">def</span> <span class="nf">speech_to_mfcc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speech_in</span><span class="p">):</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        Extracts 13 Mel Frequency Cepstral Coefficients (MFCC) from input utterance.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">            speech_in (tuple(np.array), int): The utterance, represented as array and the sampling rate</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">            np.array: The extracted features of the utterance</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="n">speech</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">speech_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="n">mfcc</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">compliance</span><span class="o">.</span><span class="n">kaldi</span><span class="o">.</span><span class="n">mfcc</span><span class="p">(</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="n">speech</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="n">sample_frequency</span><span class="o">=</span><span class="n">speech_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;mfcc&#39;</span><span class="p">:</span> <span class="n">mfcc</span><span class="p">}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;speech_in&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fbank&quot;</span><span class="p">])</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    <span class="k">def</span> <span class="nf">speech_to_fbank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speech_in</span><span class="p">):</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">        Extracts 23 filterbanks from input utterance.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">            speech_in (tuple(np.array), int): The utterance, represented as array and the sampling rate</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            np.array: The extracted features of the utterance</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="n">speech</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">speech_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="n">fbank</span> <span class="o">=</span> <span class="n">torchaudio</span><span class="o">.</span><span class="n">compliance</span><span class="o">.</span><span class="n">kaldi</span><span class="o">.</span><span class="n">fbank</span><span class="p">(</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>            <span class="n">speech</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>            <span class="n">sample_frequency</span><span class="o">=</span><span class="n">speech_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;fbank&#39;</span><span class="p">:</span> <span class="n">fbank</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Given a sound, this service extracts features and passes them on to the decoder for ASR</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>Needed for Service, no meaning here</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputFeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Given a sound, this service extracts features and passes them on to the decoder for ASR</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        domain (Domain): Needed for Service, no meaning here</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_fbank" class="doc doc-heading">
<code class="highlight language-python"><span class="n">speech_to_fbank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_fbank" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputFeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_features" class="doc doc-heading">
<code class="highlight language-python"><span class="n">speech_to_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_features" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputFeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_mfcc" class="doc doc-heading">
<code class="highlight language-python"><span class="n">speech_to_mfcc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechInputFeatureExtractor.SpeechInputFeatureExtractor.speech_to_mfcc" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechInputFeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.speech.SpeechOutputGenerator" class="doc doc-heading">
        <code>SpeechOutputGenerator</code>



<a href="#adviser.services.hci.speech.SpeechOutputGenerator" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator" class="doc doc-heading">
        <code>
SpeechOutputGenerator            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputGenerator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">SpeechOutputGenerator</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        Text To Speech Module that reads out the system utterance.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">            domain (Domain): Needed for Service, no meaning here</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            identifier (string): Needed for Service</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">            use_cuda (boolean): Whether or not to perform computations on GPU. Highly recommended if available</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">            sub_topic_domains: see `services.service.Service` constructor for more details</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;speech&quot;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="c1"># The following lines can be changed to incorporate different models.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="c1"># This is the only thing that needs to be changed for that, everything else should be dynamic.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transcription_type</span> <span class="o">=</span> <span class="s2">&quot;phn&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dict_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                                      <span class="s2">&quot;phn_train_no_dev_pytorch_train_fastspeech.v4&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;lang_1phn&quot;</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                                      <span class="s2">&quot;train_no_dev_units.txt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                                       <span class="s2">&quot;phn_train_no_dev_pytorch_train_fastspeech.v4&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                                       <span class="s2">&quot;phn_train_no_dev_pytorch_train_fastspeech.v4&quot;</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                                       <span class="s2">&quot;model.last1.avg.best&quot;</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocoder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                                         <span class="s2">&quot;ljspeech.parallel_wavegan.v1&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint-400000steps.pkl&quot;</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocoder_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span> <span class="s2">&quot;ljspeech.parallel_wavegan.v1&quot;</span><span class="p">,</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="c1"># define device to run the synthesis on</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="c1"># define end to end TTS model</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_args</span> <span class="o">=</span> <span class="n">get_model_conf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">model_class</span> <span class="o">=</span> <span class="n">dynamic_import</span><span class="o">.</span><span class="n">dynamic_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_args</span><span class="o">.</span><span class="n">model_module</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_args</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">torch_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inference_args</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;minlenratio&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;maxlenratio&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">})</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="c1"># define neural vocoder</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocoder_conf</span><span class="p">)</span> <span class="k">as</span> <span class="n">vocoder_config_file</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">vocoder_config_file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="n">vocoder</span> <span class="o">=</span> <span class="n">ParallelWaveGANGenerator</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;generator_params&quot;</span><span class="p">])</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="n">vocoder</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocoder_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;generator&quot;</span><span class="p">])</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="n">vocoder</span><span class="o">.</span><span class="n">remove_weight_norm</span><span class="p">()</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocoder</span> <span class="o">=</span> <span class="n">vocoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">dictionary_file</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">dictionary_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">}</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span> <span class="o">=</span> <span class="n">G2p</span><span class="p">()</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="c1"># download the pretrained Punkt tokenizer from NLTK. This is done only</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="c1"># the first time the code is executed on a machine, if it has been done</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="c1"># before, this line will be skipped and output a warning. We will probably</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="c1"># redirect warnings into a file rather than std_err in the future, since</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="c1"># there&#39;s also a lot of pytorch warnings going on etc.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;punkt&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>    <span class="k">def</span> <span class="nf">preprocess_text_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="sd">        Clean the text and then convert it to id sequence.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a><span class="sd">            text (string): The text to preprocess</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">custom_english_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># cleans the text</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transcription_type</span> <span class="o">==</span> <span class="s2">&quot;phn&quot;</span><span class="p">:</span>  <span class="c1"># depending on the model type, different preprocessing is needed.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="n">text</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>            <span class="n">char_sequence</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="n">char_sequence</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="n">id_sequence</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">char_sequence</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="p">[</span><span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>            <span class="k">elif</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>                <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>                <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dimensions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># &lt;eos&gt;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">id_sequence</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;system_speech&quot;</span><span class="p">])</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>    <span class="k">def</span> <span class="nf">generate_speech</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_utterance</span><span class="p">):</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">        Takes the system utterance and turns it into a sound</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a><span class="sd">            sys_utterance (string): The new system utterance</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a><span class="sd">            dict(string, tuple(np.array, int, string)): Everything needed to play the system utterance as an audio and the utterance in text for logging</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>            <span class="n">preprocessed_text_as_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_text_input</span><span class="p">(</span><span class="n">sys_utterance</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>            <span class="n">features_from_text</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">preprocessed_text_as_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_args</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>            <span class="n">feature_dimension</span> <span class="o">=</span> <span class="n">features_from_text</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;hop_size&quot;</span><span class="p">]</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>            <span class="n">random_tensor_with_proper_dimensions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">feature_dimension</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>            <span class="n">auxiliary_content_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;generator_params&quot;</span><span class="p">][</span><span class="s2">&quot;aux_context_window&quot;</span><span class="p">]</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>            <span class="n">preprocessed_features</span> <span class="o">=</span> <span class="n">features_from_text</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="n">features_from_text</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReplicationPad1d</span><span class="p">(</span><span class="n">auxiliary_content_window</span><span class="p">)(</span><span class="n">preprocessed_features</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>            <span class="n">generated_speech</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocoder</span><span class="p">(</span><span class="n">random_tensor_with_proper_dimensions</span><span class="p">,</span> <span class="n">features_from_text</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="n">sound_as_array</span> <span class="o">=</span> <span class="n">generated_speech</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;system_speech&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sound_as_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sampling_rate&quot;</span><span class="p">],</span> <span class="n">sys_utterance</span><span class="p">)}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="p">{})</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Text To Speech Module that reads out the system utterance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>Needed for Service, no meaning here</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>identifier</code></td>
        <td><code>string</code></td>
        <td><p>Needed for Service</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>use_cuda</code></td>
        <td><code>boolean</code></td>
        <td><p>Whether or not to perform computations on GPU. Highly recommended if available</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>sub_topic_domains</code></td>
        <td><code>Dict[str, str]</code></td>
        <td><p>see <code>services.service.Service</code> constructor for more details</p></td>
        <td><code>{}</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputGenerator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Text To Speech Module that reads out the system utterance.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        domain (Domain): Needed for Service, no meaning here</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        identifier (string): Needed for Service</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        use_cuda (boolean): Whether or not to perform computations on GPU. Highly recommended if available</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        sub_topic_domains: see `services.service.Service` constructor for more details</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;speech&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="c1"># The following lines can be changed to incorporate different models.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="c1"># This is the only thing that needs to be changed for that, everything else should be dynamic.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">transcription_type</span> <span class="o">=</span> <span class="s2">&quot;phn&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">dict_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                                  <span class="s2">&quot;phn_train_no_dev_pytorch_train_fastspeech.v4&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;lang_1phn&quot;</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                                  <span class="s2">&quot;train_no_dev_units.txt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                                   <span class="s2">&quot;phn_train_no_dev_pytorch_train_fastspeech.v4&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                                   <span class="s2">&quot;phn_train_no_dev_pytorch_train_fastspeech.v4&quot;</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                                   <span class="s2">&quot;model.last1.avg.best&quot;</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">vocoder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                                     <span class="s2">&quot;ljspeech.parallel_wavegan.v1&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint-400000steps.pkl&quot;</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">vocoder_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_directory</span><span class="p">,</span> <span class="s2">&quot;ljspeech.parallel_wavegan.v1&quot;</span><span class="p">,</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="c1"># define device to run the synthesis on</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="c1"># define end to end TTS model</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">input_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_args</span> <span class="o">=</span> <span class="n">get_model_conf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="n">model_class</span> <span class="o">=</span> <span class="n">dynamic_import</span><span class="o">.</span><span class="n">dynamic_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_args</span><span class="o">.</span><span class="n">model_module</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dimensions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_args</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="n">torch_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">inference_args</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;minlenratio&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;maxlenratio&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">})</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="c1"># define neural vocoder</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocoder_conf</span><span class="p">)</span> <span class="k">as</span> <span class="n">vocoder_config_file</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">vocoder_config_file</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="n">vocoder</span> <span class="o">=</span> <span class="n">ParallelWaveGANGenerator</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;generator_params&quot;</span><span class="p">])</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="n">vocoder</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocoder_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;generator&quot;</span><span class="p">])</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="n">vocoder</span><span class="o">.</span><span class="n">remove_weight_norm</span><span class="p">()</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">vocoder</span> <span class="o">=</span> <span class="n">vocoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">dictionary_file</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">dictionary_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">}</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span> <span class="o">=</span> <span class="n">G2p</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="c1"># download the pretrained Punkt tokenizer from NLTK. This is done only</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>    <span class="c1"># the first time the code is executed on a machine, if it has been done</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    <span class="c1"># before, this line will be skipped and output a warning. We will probably</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>    <span class="c1"># redirect warnings into a file rather than std_err in the future, since</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    <span class="c1"># there&#39;s also a lot of pytorch warnings going on etc.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;punkt&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.generate_speech" class="doc doc-heading">
<code class="highlight language-python"><span class="n">generate_speech</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.generate_speech" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputGenerator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.preprocess_text_input" class="doc doc-heading">
<code class="highlight language-python"><span class="n">preprocess_text_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechOutputGenerator.SpeechOutputGenerator.preprocess_text_input" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Clean the text and then convert it to id sequence.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>text</code></td>
        <td><code>string</code></td>
        <td><p>The text to preprocess</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputGenerator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">preprocess_text_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Clean the text and then convert it to id sequence.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        text (string): The text to preprocess</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">custom_english_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># cleans the text</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transcription_type</span> <span class="o">==</span> <span class="s2">&quot;phn&quot;</span><span class="p">:</span>  <span class="c1"># depending on the model type, different preprocessing is needed.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">text</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">g2p</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">char_sequence</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">char_sequence</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">id_sequence</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">char_sequence</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>            <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="p">[</span><span class="s2">&quot;&lt;space&gt;&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">elif</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>            <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="p">[</span><span class="s2">&quot;&lt;unk&gt;&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char_to_id</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">id_sequence</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dimensions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># &lt;eos&gt;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">id_sequence</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.SpeechOutputGenerator.get_root_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_root_dir</span><span class="p">()</span></code>


<a href="#adviser.services.hci.speech.SpeechOutputGenerator.get_root_dir" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputGenerator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_root_dir</span><span class="p">():</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.speech.SpeechOutputPlayer" class="doc doc-heading">
        <code>SpeechOutputPlayer</code>



<a href="#adviser.services.hci.speech.SpeechOutputPlayer" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer" class="doc doc-heading">
        <code>
SpeechOutputPlayer            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputPlayer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">SpeechOutputPlayer</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        Service that plays the system utterance as sound</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">            domain (Domain): Needed for Service, but has no meaning here</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            conversation_log_dir (string): If this is provided it will create log files in the specified directory.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">            identifier (string): Needed for Service.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;system_speech&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[])</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_speech</span><span class="p">):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">        Takes the system utterance and reads it out. Also can log the audio and text.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">            system_speech (np.array): An array of audio that is meant to produce a sound from. The result of the systems TTS synthesis service.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">sounddevice</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">system_speech</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">system_speech</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="c1"># log the utterance</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))))</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s2">&quot;_system.wav&quot;</span><span class="p">,</span> <span class="n">system_speech</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">system_speech</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;PCM_24&#39;</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s2">&quot;_system.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">convo_log</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                <span class="n">convo_log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">system_speech</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Service that plays the system utterance as sound</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>Needed for Service, but has no meaning here</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>conversation_log_dir</code></td>
        <td><code>string</code></td>
        <td><p>If this is provided it will create log files in the specified directory.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>identifier</code></td>
        <td><code>string</code></td>
        <td><p>Needed for Service.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputPlayer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Service that plays the system utterance as sound</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        domain (Domain): Needed for Service, but has no meaning here</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        conversation_log_dir (string): If this is provided it will create log files in the specified directory.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        identifier (string): Needed for Service.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">interaction_count</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.speak" class="doc doc-heading">
<code class="highlight language-python"><span class="n">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechOutputPlayer.SpeechOutputPlayer.speak" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechOutputPlayer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.speech.SpeechRecorder" class="doc doc-heading">
        <code>SpeechRecorder</code>



<a href="#adviser.services.hci.speech.SpeechRecorder" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.hci.speech.SpeechRecorder.SpeechRecorder" class="doc doc-heading">
        <code>
SpeechRecorder            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechRecorder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">SpeechRecorder</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Domain</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enable_plotting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                 <span class="n">voice_privacy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        A service that can record a microphone upon a key pressing event </span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        and publish the result as an array. The end of the utterance is </span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        detected automatically, also the voice can be masked to alleviate </span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        privacy issues.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">            domain (Domain): I don&#39;t know why this is here. Service needs it, but it means nothing in this context.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">            conversation_log_dir (string): If this parameter is given, log files of the conversation will be created in this directory</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">            enable_plotting (boolean): If this is set to True, the recorder is no longer real time able and thus the recordings don&#39;t work properly. This is just to be used to tune the threshold for the end of utterance detection, not during deployment.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">            threshold (int): The threshold below which the assumption of the end of utterance detection is silence</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">            voice_privacy (boolean): Whether or not to enable the masking of the users voice</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">            identifier (string): I don&#39;t know why this is here. Service needs it.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">recording_indicator</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">audio_interface</span> <span class="o">=</span> <span class="n">pyaudio</span><span class="o">.</span><span class="n">PyAudio</span><span class="p">()</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">push_to_talk_listener</span> <span class="o">=</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Listener</span><span class="p">(</span><span class="n">on_press</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_recording</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_plotting</span> <span class="o">=</span> <span class="n">enable_plotting</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">voice_privacy</span> <span class="o">=</span> <span class="n">voice_privacy</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;speech_in&quot;</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">def</span> <span class="nf">record_user_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">        Records audio once a button is pressed and stops if there is enough continuous silence.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">        The numpy array consisting of the frames will be published once it&#39;s done.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">            dict(string, tuple(np.array, int)): The utterance in form of an array and the sampling rate of the utterance</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">recording_indicator</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">chunk</span> <span class="o">=</span> <span class="mi">1024</span>  <span class="c1"># how many frames per chunk</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">audio_format</span> <span class="o">=</span> <span class="n">pyaudio</span><span class="o">.</span><span class="n">paInt16</span>  <span class="c1"># 16 bit integer based audio for quick processing</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># our asr model only accepts mono sounds</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="n">sampling_rate</span> <span class="o">=</span> <span class="mi">16000</span>  <span class="c1"># only 16000 Hz works for the asr model we&#39;re using</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">audio_interface</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">audio_format</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                                           <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                                           <span class="n">rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                                           <span class="nb">input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>                                           <span class="n">frames_per_buffer</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="n">binary_sequence</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># this will hold the entire utterance once it&#39;s finished as binary data</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="c1"># setup for naive end of utterance detection</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="n">continuous_seconds_of_silence_before_utterance_ends</span> <span class="o">=</span> <span class="mf">3.0</span>  <span class="c1"># this may be changed freely</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="n">required_silence_length_to_stop_in_chunks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="p">(</span><span class="n">continuous_seconds_of_silence_before_utterance_ends</span> <span class="o">*</span> <span class="n">sampling_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="n">reset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">continuous_seconds_of_silence_before_utterance_ends</span> <span class="o">*</span> <span class="n">sampling_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="n">maximum_utterance_time_in_chunks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">20</span> <span class="o">*</span> <span class="n">sampling_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">chunk</span><span class="p">)</span>  <span class="c1"># 20 seconds</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_plotting</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>            <span class="n">threshold_plotter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold_plotter_generator</span><span class="p">()</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="n">chunks_recorded</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">recording...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maximum_utterance_time_in_chunks</span><span class="p">):</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>            <span class="n">chunks_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="n">wave_data</span> <span class="o">=</span> <span class="n">wave</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">h&quot;</span> <span class="o">%</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="n">binary_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_plotting</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>                <span class="n">threshold_plotter</span><span class="p">(</span><span class="n">wave_data</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wave_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>                <span class="n">required_silence_length_to_stop_in_chunks</span> <span class="o">=</span> <span class="n">reset</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>                <span class="n">required_silence_length_to_stop_in_chunks</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>                <span class="k">if</span> <span class="n">required_silence_length_to_stop_in_chunks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>                    <span class="k">break</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...done recording.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="n">stream</span><span class="o">.</span><span class="n">stop_stream</span><span class="p">()</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_plotting</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>            <span class="n">audio_file</span> <span class="o">=</span> <span class="n">wave</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;_user.wav&quot;</span><span class="p">)),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>            <span class="n">audio_file</span><span class="o">.</span><span class="n">setnchannels</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="n">audio_file</span><span class="o">.</span><span class="n">setsampwidth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">audio_interface</span><span class="o">.</span><span class="n">get_sample_size</span><span class="p">(</span><span class="n">audio_format</span><span class="p">))</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="n">audio_file</span><span class="o">.</span><span class="n">setframerate</span><span class="p">(</span><span class="n">sampling_rate</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="n">audio_file</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">binary_sequence</span><span class="p">))</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>            <span class="n">audio_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">recording_indicator</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="n">audio_sequence</span> <span class="o">=</span> <span class="n">wave</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">h&quot;</span> <span class="o">%</span> <span class="n">chunk</span> <span class="o">*</span> <span class="n">chunks_recorded</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">binary_sequence</span><span class="p">))</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice_privacy</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;speech_in&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">voice_sanitizer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">audio_sequence</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> <span class="n">sampling_rate</span><span class="p">)}</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;speech_in&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">audio_sequence</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">sampling_rate</span><span class="p">)}</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>    <span class="k">def</span> <span class="nf">start_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">        This method is a callback of the push to talk key</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="sd">        listener. It calls the recorder, if it&#39;s not already recording.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a><span class="sd">            key (Key): The pressed key</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">is</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">cmd_r</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">ctrl_r</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording_indicator</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">record_user_utterance</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>    <span class="k">def</span> <span class="nf">start_recorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a><span class="sd">        Starts the listener and outputs that the speech recorder is ready for use</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">push_to_talk_listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To speak to the system, tap your right [CTRL] or [CMD] key.</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>              <span class="s2">&quot;It will try to automatically detect when your utterance is over.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>    <span class="k">def</span> <span class="nf">threshold_plotter_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a><span class="sd">        Generates a plotter to visualize when the signal is above the set threshold</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a><span class="sd">            function: Plots the threshold with the current continuous waveform</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>        <span class="kn">import</span> <span class="nn">matplotlib</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.000000000001</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>        <span class="k">def</span> <span class="nf">threshold_plotter</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">-</span><span class="mi">20000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">])</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.000000000001</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>        <span class="k">return</span> <span class="n">threshold_plotter</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enable_plotting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">voice_privacy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>A service that can record a microphone upon a key pressing event 
and publish the result as an array. The end of the utterance is 
detected automatically, also the voice can be masked to alleviate 
privacy issues.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>I don't know why this is here. Service needs it, but it means nothing in this context.</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>conversation_log_dir</code></td>
        <td><code>string</code></td>
        <td><p>If this parameter is given, log files of the conversation will be created in this directory</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>enable_plotting</code></td>
        <td><code>boolean</code></td>
        <td><p>If this is set to True, the recorder is no longer real time able and thus the recordings don't work properly. This is just to be used to tune the threshold for the end of utterance detection, not during deployment.</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>threshold</code></td>
        <td><code>int</code></td>
        <td><p>The threshold below which the assumption of the end of utterance detection is silence</p></td>
        <td><code>8000</code></td>
      </tr>
      <tr>
        <td><code>voice_privacy</code></td>
        <td><code>boolean</code></td>
        <td><p>Whether or not to enable the masking of the users voice</p></td>
        <td><code>False</code></td>
      </tr>
      <tr>
        <td><code>identifier</code></td>
        <td><code>string</code></td>
        <td><p>I don't know why this is here. Service needs it.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechRecorder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Domain</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">conversation_log_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enable_plotting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">voice_privacy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    A service that can record a microphone upon a key pressing event </span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    and publish the result as an array. The end of the utterance is </span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    detected automatically, also the voice can be masked to alleviate </span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    privacy issues.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        domain (Domain): I don&#39;t know why this is here. Service needs it, but it means nothing in this context.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        conversation_log_dir (string): If this parameter is given, log files of the conversation will be created in this directory</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        enable_plotting (boolean): If this is set to True, the recorder is no longer real time able and thus the recordings don&#39;t work properly. This is just to be used to tune the threshold for the end of utterance detection, not during deployment.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        threshold (int): The threshold below which the assumption of the end of utterance detection is silence</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        voice_privacy (boolean): Whether or not to enable the masking of the users voice</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        identifier (string): I don&#39;t know why this is here. Service needs it.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_log_dir</span> <span class="o">=</span> <span class="n">conversation_log_dir</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">recording_indicator</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">audio_interface</span> <span class="o">=</span> <span class="n">pyaudio</span><span class="o">.</span><span class="n">PyAudio</span><span class="p">()</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">push_to_talk_listener</span> <span class="o">=</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Listener</span><span class="p">(</span><span class="n">on_press</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_recording</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">enable_plotting</span> <span class="o">=</span> <span class="n">enable_plotting</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">voice_privacy</span> <span class="o">=</span> <span class="n">voice_privacy</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.record_user_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">record_user_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.record_user_utterance" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechRecorder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recorder" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start_recorder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recorder" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Starts the listener and outputs that the speech recorder is ready for use</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechRecorder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">start_recorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Starts the listener and outputs that the speech recorder is ready for use</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">push_to_talk_listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To speak to the system, tap your right [CTRL] or [CMD] key.</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>          <span class="s2">&quot;It will try to automatically detect when your utterance is over.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recording" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.start_recording" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>This method is a callback of the push to talk key
listener. It calls the recorder, if it's not already recording.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>key</code></td>
        <td><code>Key</code></td>
        <td><p>The pressed key</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechRecorder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">start_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    This method is a callback of the push to talk key</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    listener. It calls the recorder, if it&#39;s not already recording.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        key (Key): The pressed key</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">is</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">cmd_r</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">ctrl_r</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording_indicator</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">record_user_utterance</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.threshold_plotter_generator" class="doc doc-heading">
<code class="highlight language-python"><span class="n">threshold_plotter_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechRecorder.SpeechRecorder.threshold_plotter_generator" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Generates a plotter to visualize when the signal is above the set threshold</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>function</code></td>
      <td><p>Plots the threshold with the current continuous waveform</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechRecorder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">threshold_plotter_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Generates a plotter to visualize when the signal is above the set threshold</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        function: Plots the threshold with the current continuous waveform</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="kn">import</span> <span class="nn">matplotlib</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.000000000001</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">def</span> <span class="nf">threshold_plotter</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">-</span><span class="mi">20000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">])</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.000000000001</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">return</span> <span class="n">threshold_plotter</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.SpeechRecorder.voice_sanitizer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">voice_sanitizer</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.SpeechRecorder.voice_sanitizer" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>While this is by no means a good voice sanitizer,
it works as a proof of concept. It randomly shifts
the spectrogram of a speakers utterance up or down,
making automatic speaker identification much harder
while keeping impact on asr performance as low as
possible. The use should be turned off by default.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>audio</code></td>
        <td><code>np.array</code></td>
        <td><p>The audio represented as array</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>np.array</code></td>
      <td><p>The mutated audio as array</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/SpeechRecorder.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">voice_sanitizer</span><span class="p">(</span><span class="n">audio</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    While this is by no means a good voice sanitizer,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    it works as a proof of concept. It randomly shifts</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    the spectrogram of a speakers utterance up or down,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    making automatic speaker identification much harder</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    while keeping impact on asr performance as low as</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    possible. The use should be turned off by default.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        audio (np.array): The audio represented as array</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        np.array: The mutated audio as array</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">stft</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">voice_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">for</span> <span class="n">frequency_index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>            <span class="c1"># mutate the voice to be higher</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                <span class="n">spectrogram</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">frequency_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">[</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">frequency_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">voice_shift</span><span class="p">)]</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="k">pass</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="k">for</span> <span class="n">frequency_index</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="c1"># mutate the voice to be lower</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                <span class="n">spectrogram</span><span class="p">[</span><span class="n">frequency_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">[</span><span class="n">frequency_index</span> <span class="o">+</span> <span class="n">voice_shift</span><span class="p">]</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                <span class="k">pass</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="k">return</span> <span class="n">librosa</span><span class="o">.</span><span class="n">istft</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.speech.cleaners" class="doc doc-heading">
        <code>cleaners</code>



<a href="#adviser.services.hci.speech.cleaners" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>This file is derived from https://github.com/keithito/tacotron.</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.basic_cleaners" class="doc doc-heading">
<code class="highlight language-python"><span class="n">basic_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.basic_cleaners" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Basic pipeline that lowercases and collapses whitespace without transliteration.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">basic_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Basic pipeline that lowercases and collapses whitespace without transliteration.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">lowercase</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">collapse_whitespace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.collapse_whitespace" class="doc doc-heading">
<code class="highlight language-python"><span class="n">collapse_whitespace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.collapse_whitespace" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">collapse_whitespace</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_whitespace_re</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.convert_to_ascii" class="doc doc-heading">
<code class="highlight language-python"><span class="n">convert_to_ascii</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.convert_to_ascii" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">convert_to_ascii</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">unidecode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.custom_english_cleaners" class="doc doc-heading">
<code class="highlight language-python"><span class="n">custom_english_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.custom_english_cleaners" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Custom pipeline for English text, including number and abbreviation expansion.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">custom_english_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Custom pipeline for English text, including number and abbreviation expansion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">convert_to_ascii</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_email</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_acronym</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">lowercase</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_abbreviations</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_symbols</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">remove_unnecessary_symbols</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">uppercase</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">collapse_whitespace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.english_cleaners" class="doc doc-heading">
<code class="highlight language-python"><span class="n">english_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.english_cleaners" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Pipeline for English text, including number and abbreviation expansion.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">english_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Pipeline for English text, including number and abbreviation expansion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">convert_to_ascii</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">lowercase</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">expand_abbreviations</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">collapse_whitespace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.expand_abbreviations" class="doc doc-heading">
<code class="highlight language-python"><span class="n">expand_abbreviations</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.expand_abbreviations" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Preprocesses a text to turn abbreviations into forms that the TTS can pronounce properly</p>
<p>text (string): Text to be preprocessed</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Preprocesses a text to turn abbreviations into forms that the TTS can pronounce properly</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    text (string): Text to be preprocessed</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">for</span> <span class="n">regex</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">_abbreviations</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.expand_acronym" class="doc doc-heading">
<code class="highlight language-python"><span class="n">expand_acronym</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.expand_acronym" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Preprocesses a text to turn acronyms into forms that the TTS can pronounce properly</p>
<p>text (string): Text to be preprocessed</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">expand_acronym</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Preprocesses a text to turn acronyms into forms that the TTS can pronounce properly</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    text (string): Text to be preprocessed</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">_acronym</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.expand_email" class="doc doc-heading">
<code class="highlight language-python"><span class="n">expand_email</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.expand_email" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">expand_email</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_email_re</span><span class="p">,</span> <span class="n">_expand_email</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.expand_numbers" class="doc doc-heading">
<code class="highlight language-python"><span class="n">expand_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.expand_numbers" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">expand_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">normalize_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.expand_symbols" class="doc doc-heading">
<code class="highlight language-python"><span class="n">expand_symbols</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.expand_symbols" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">expand_symbols</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># added</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.lowercase" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lowercase</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.lowercase" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">lowercase</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.normalize_numbers" class="doc doc-heading">
<code class="highlight language-python"><span class="n">normalize_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.normalize_numbers" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Normalizes numbers in an utterance as preparation for TTS</p>
<p>text (string): Text to be preprocessed</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">normalize_numbers</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Normalizes numbers in an utterance as preparation for TTS</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    text (string): Text to be preprocessed</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_comma_number_re</span><span class="p">,</span> <span class="n">_remove_commas</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_pounds_re</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1 pounds&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_dollars_re</span><span class="p">,</span> <span class="n">_expand_dollars</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_decimal_number_re</span><span class="p">,</span> <span class="n">_expand_decimal_point</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_ordinal_re</span><span class="p">,</span> <span class="n">_expand_ordinal</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_ID_number_re</span><span class="p">,</span> <span class="n">_expand_ID_number</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_number_re</span><span class="p">,</span> <span class="n">_expand_number</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.remove_unnecessary_symbols" class="doc doc-heading">
<code class="highlight language-python"><span class="n">remove_unnecessary_symbols</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.remove_unnecessary_symbols" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">remove_unnecessary_symbols</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># added</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[()[]&lt;&gt;&quot;]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.transliteration_cleaners" class="doc doc-heading">
<code class="highlight language-python"><span class="n">transliteration_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.transliteration_cleaners" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Pipeline for non-English text that transliterates to ASCII.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">transliteration_cleaners</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Pipeline for non-English text that transliterates to ASCII.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">convert_to_ascii</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">lowercase</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">text</span> <span class="o">=</span> <span class="n">collapse_whitespace</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.cleaners.uppercase" class="doc doc-heading">
<code class="highlight language-python"><span class="n">uppercase</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.cleaners.uppercase" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/cleaners.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">uppercase</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># added</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.speech.speech_utility" class="doc doc-heading">
        <code>speech_utility</code>



<a href="#adviser.services.hci.speech.speech_utility" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Utility for the emotion recognition script that needs the utterance a s file</p>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.speech_utility.delete_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">delete_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.speech_utility.delete_file" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Deletes the file at the given path to clean up the audio file
once it's not needed anymore. This is why unique filenames are
important.</p>
<p>filepath (string): path to the file that is to be deleted</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/speech_utility.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delete_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Deletes the file at the given path to clean up the audio file</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    once it&#39;s not needed anymore. This is why unique filenames are</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    important.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    filepath (string): path to the file that is to be deleted</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The file cannot be deleted, as it was not found. &quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>              <span class="s2">&quot;Please check the provided path for errors: </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.hci.speech.speech_utility.sound_array_to_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sound_array_to_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">sound_as_array</span><span class="p">)</span></code>


<a href="#adviser.services.hci.speech.speech_utility.sound_array_to_file" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Saves the recording of the recorder to a file</p>
<p>Turns the audio from the recorder service into a wav file for 
processing with opensmile c++ scripts </p>
<p>filepath (string): full path, including filename and .wav suffix
at an arbitrary location. Careful: python takes paths as
relative to the main script. The name should be unique, to
ensure files don't get mixed up if there are multiple calls
in short time and one file might get overwriteen or deleted
before it's done being processed.
sampling_rate (int): the sampling rate of the audio, as
published by the recorder
sound_as_array (np.array): the audio in form of an array as
published by the recorder</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/speech/speech_utility.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">sound_array_to_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">sound_as_array</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Saves the recording of the recorder to a file</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Turns the audio from the recorder service into a wav file for </span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    processing with opensmile c++ scripts </span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    filepath (string): full path, including filename and .wav suffix</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    at an arbitrary location. Careful: python takes paths as</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    relative to the main script. The name should be unique, to</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    ensure files don&#39;t get mixed up if there are multiple calls</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    in short time and one file might get overwriteen or deleted</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    before it&#39;s done being processed.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">    sampling_rate (int): the sampling rate of the audio, as</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    published by the recorder</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    sound_as_array (np.array): the audio in form of an array as</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">    published by the recorder</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">librosa</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write_wav</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sound_as_array</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.hci.video" class="doc doc-heading">
        <code>video</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.video" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.video.FeatureExtractor" class="doc doc-heading">
        <code>FeatureExtractor</code>



<a href="#adviser.services.hci.video.FeatureExtractor" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Feature extraction with openSMILE</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor" class="doc doc-heading">
        <code>
VideoFeatureExtractor            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>TODO</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/FeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">VideoFeatureExtractor</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="c1"># # CLAHE (Contrast Limited Adaptive Histogram Equalization)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">CLAHE</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># for detecting faces (returns coordinates of rectangle(s) of face area(s))</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">DETECTOR</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_frontal_face_detector</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="c1"># facial landmark predictor</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">predictor_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_dir</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;shape_predictor_68_face_landmarks.dat&#39;</span><span class="p">))</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">PREDICTOR</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="n">predictor_file</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">queued_sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;video_input&quot;</span><span class="p">],</span> <span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">],</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>                      <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fl_features&quot;</span><span class="p">])</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">def</span> <span class="nf">extract_fl_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">video_input</span><span class="p">,</span> <span class="n">user_acts</span><span class="p">):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="sd">&quot;&quot;&quot;TODO</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">            dict: TODO</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="k">def</span> <span class="nf">_distance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;VIDEO FEATURE ENTER, len(video_input): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">video_input</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">aggregated_feats</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">video_input</span><span class="p">[::</span><span class="mi">2</span><span class="p">]:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLAHE</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="n">faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DETECTOR</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">faces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># at least one face detected</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">landmarks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PREDICTOR</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">faces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="n">landmarks</span> <span class="o">=</span> <span class="n">face_utils</span><span class="o">.</span><span class="n">shape_to_np</span><span class="p">(</span><span class="n">landmarks</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                <span class="n">norm_left_eye</span> <span class="o">=</span> <span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">39</span><span class="p">])</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>                <span class="n">norm_right_eye</span> <span class="o">=</span> <span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">42</span><span class="p">])</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                <span class="n">norm_lips</span> <span class="o">=</span> <span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">52</span><span class="p">])</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>                <span class="n">eyebrow_left</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                    <span class="p">[(</span><span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">39</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">norm_left_eye</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">]]</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>                <span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>                <span class="n">eyebrow_right</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                    <span class="p">[(</span><span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">norm_right_eye</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">]]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                <span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>                <span class="n">lip_left</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                    <span class="p">[(</span><span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">norm_lips</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">]]</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>                <span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                <span class="n">lip_right</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>                    <span class="p">[(</span><span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">norm_lips</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">]]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>                <span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                <span class="n">mouth_width</span> <span class="o">=</span> <span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">48</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">54</span><span class="p">])</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                <span class="n">mouth_height</span> <span class="o">=</span> <span class="n">_distance</span><span class="p">(</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">51</span><span class="p">],</span> <span class="n">landmarks</span><span class="p">[</span><span class="mi">57</span><span class="p">])</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>                <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>                    <span class="n">eyebrow_left</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>                    <span class="n">eyebrow_right</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>                    <span class="n">lip_left</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>                    <span class="n">lip_right</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>                    <span class="n">mouth_width</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>                    <span class="n">mouth_height</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>                <span class="p">]))</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="c1"># aggregate features across frames</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="n">mini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>            <span class="n">perc25</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>            <span class="n">perc75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="n">aggregated_feats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">mini</span><span class="p">,</span> <span class="n">maxi</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">perc25</span><span class="p">,</span> <span class="n">perc75</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VIDEO FEAT PUB&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;fl_features&#39;</span><span class="p">:</span> <span class="n">aggregated_feats</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/FeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">module_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="c1"># # CLAHE (Contrast Limited Adaptive Histogram Equalization)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">CLAHE</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="c1"># for detecting faces (returns coordinates of rectangle(s) of face area(s))</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">DETECTOR</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_frontal_face_detector</span><span class="p">()</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="c1"># facial landmark predictor</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">predictor_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module_dir</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;shape_predictor_68_face_landmarks.dat&#39;</span><span class="p">))</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">PREDICTOR</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="n">predictor_file</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.extract_fl_features" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_fl_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.video.FeatureExtractor.VideoFeatureExtractor.extract_fl_features" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/FeatureExtractor.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.hci.video.VideoInput" class="doc doc-heading">
        <code>VideoInput</code>



<a href="#adviser.services.hci.video.VideoInput" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.hci.video.VideoInput.VideoInput" class="doc doc-heading">
        <code>
VideoInput            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.hci.video.VideoInput.VideoInput" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Captures frames with a specified capture interval between two consecutive dialog turns and returns a list of frames.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/VideoInput.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">VideoInput</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Captures frames with a specified capture interval between two consecutive dialog turns and returns a list of frames.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">capture_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">10e5</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            camera_id (int): device id (if only 1 camera device is connected, id is 0, if two are connected choose between 0 and 1, ...)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">            capture_interval (int): try to capture a frame every x microseconds - is a lower bound, no hard time guarantees (e.g. 5e5 -&gt; every &gt;= 0.5 seconds)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">camera_id</span><span class="p">)</span>  <span class="c1"># get handle to camera device</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>                     <span class="c1"># open</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capture_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">)</span> <span class="c1"># create thread object for capturing</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capture_interval</span> <span class="o">=</span> <span class="n">capture_interval</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        Continuous video capture, meant to be run in a loop.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">        Calls `publish_img` once per interval tick to publish the captured image.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="c1"># Capture frame-by-frame</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="c1"># cap.read() returns a bool (true when frame was read correctly)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="c1"># Our operations on the frame come here</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>                <span class="n">rgb_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">publish_img</span><span class="p">(</span><span class="n">rgb_img</span><span class="o">=</span><span class="n">rgb_img</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>            <span class="n">time_diff</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="n">wait_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capture_interval</span> <span class="o">-</span> <span class="n">time_diff</span><span class="o">.</span><span class="n">microseconds</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span>   <span class="c1"># note: time to wait for next capture to match specified sampling rate in seconds</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="k">if</span> <span class="n">wait_seconds</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_seconds</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting video capture...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">capture_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;video_input&#39;</span><span class="p">])</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>    <span class="k">def</span> <span class="nf">publish_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgb_img</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">video_input</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]):</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">        Helper function to publish images from a loop.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;video_input&#39;</span><span class="p">:</span> <span class="n">rgb_img</span><span class="p">}</span>  <span class="c1"># NOTE: in the future, copy frames for more safety (capturing thread may overwrite them)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.video.VideoInput.VideoInput.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">camera_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">capture_interval</span><span class="o">=</span><span class="mf">1000000.0</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.hci.video.VideoInput.VideoInput.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>camera_id</code></td>
        <td><code>int</code></td>
        <td><p>device id (if only 1 camera device is connected, id is 0, if two are connected choose between 0 and 1, ...)</p></td>
        <td><code>0</code></td>
      </tr>
      <tr>
        <td><code>capture_interval</code></td>
        <td><code>int</code></td>
        <td><p>try to capture a frame every x microseconds - is a lower bound, no hard time guarantees (e.g. 5e5 -&gt; every &gt;= 0.5 seconds)</p></td>
        <td><code>1000000.0</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/VideoInput.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">camera_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">capture_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">10e5</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        camera_id (int): device id (if only 1 camera device is connected, id is 0, if two are connected choose between 0 and 1, ...)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        capture_interval (int): try to capture a frame every x microseconds - is a lower bound, no hard time guarantees (e.g. 5e5 -&gt; every &gt;= 0.5 seconds)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">camera_id</span><span class="p">)</span>  <span class="c1"># get handle to camera device</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>                     <span class="c1"># open</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">capture_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">)</span> <span class="c1"># create thread object for capturing</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">capture_interval</span> <span class="o">=</span> <span class="n">capture_interval</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.video.VideoInput.VideoInput.capture" class="doc doc-heading">
<code class="highlight language-python"><span class="n">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.hci.video.VideoInput.VideoInput.capture" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Continuous video capture, meant to be run in a loop.
Calls <code>publish_img</code> once per interval tick to publish the captured image.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/VideoInput.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Continuous video capture, meant to be run in a loop.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Calls `publish_img` once per interval tick to publish the captured image.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># Capture frame-by-frame</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="c1"># cap.read() returns a bool (true when frame was read correctly)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="c1"># Our operations on the frame come here</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="n">rgb_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">publish_img</span><span class="p">(</span><span class="n">rgb_img</span><span class="o">=</span><span class="n">rgb_img</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">wait_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capture_interval</span> <span class="o">-</span> <span class="n">time_diff</span><span class="o">.</span><span class="n">microseconds</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span>   <span class="c1"># note: time to wait for next capture to match specified sampling rate in seconds</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="k">if</span> <span class="n">wait_seconds</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_seconds</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.video.VideoInput.VideoInput.dialog_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.hci.video.VideoInput.VideoInput.dialog_end" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>This function is called after a dialog ended (Topics.DIALOG_END message was received).
You should overwrite this function to record dialog-level information. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/VideoInput.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">terminating</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.video.VideoInput.VideoInput.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.hci.video.VideoInput.VideoInput.dialog_start" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>This function is called before the first message to a new dialog is published.
You should overwrite this function to set/reset dialog-level variables. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/VideoInput.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting video capture...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capture_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.hci.video.VideoInput.VideoInput.publish_img" class="doc doc-heading">
<code class="highlight language-python"><span class="n">publish_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.hci.video.VideoInput.VideoInput.publish_img" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/hci/video/VideoInput.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.nlg" class="doc doc-heading">
        <code>nlg</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h3 id="adviser.services.nlg.__all__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__all__</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.__all__" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

    </div>

  </div>







  <div class="doc doc-object doc-module">



<h3 id="adviser.services.nlg.affective_nlg" class="doc doc-heading">
        <code>affective_nlg</code>



<a href="#adviser.services.nlg.affective_nlg" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Handcrafted (i.e. template-based) Natural Language Generation Module</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG" class="doc doc-heading">
        <code>
HandcraftedEmotionNLG            (<span title="services.nlg.nlg.HandcraftedNLG">HandcraftedNLG</span>)
        </code>



<a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>A child of the HandcraftedNLG, the HandcraftedEmotionNLG can choose between multiple affective
response templates for each sys_act dependingon the current sys_emotion</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/affective_nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedEmotionNLG</span><span class="p">(</span><span class="n">HandcraftedNLG</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        A child of the HandcraftedNLG, the HandcraftedEmotionNLG can choose between multiple affective</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        response templates for each sys_act dependingon the current sys_emotion</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="p">{},</span> <span class="n">template_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                 <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                 <span class="n">emotions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">debug_logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="sd">&quot;&quot;&quot;Constructor mainly extracts methods and rules from the template file&quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">,</span> <span class="n">debug_logger</span><span class="o">=</span><span class="n">debug_logger</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="n">template_file</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">emotions</span> <span class="o">=</span> <span class="n">emotions</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_templates</span><span class="p">()</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_emotion&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_engagement&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">])</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">def</span> <span class="nf">generate_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sys_emotion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                                  <span class="n">sys_engagement</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sys_utterance</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">        Takes a system act, system emotion choice, and system engagement level choice, then</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">        searches for a fitting rule, applies it and returns the message.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">            sys_act (SysAct): The system act, to check whether the dialogue was finished</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">            sys_emotion (str): A string representing the system&#39;s choice of emotional response</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">            sys_engagement (str): A string representing how engaged the system thinks the user is</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">            dict: a dict containing the system utterance</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">rule_found</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">sys_emotion</span><span class="p">]</span><span class="o">.</span><span class="n">create_message</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="n">rule_found</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="k">raise</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="c1"># inform if no applicable rule could be found in the template file</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_found</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not find a fitting rule for the given system act!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;System Action: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                             <span class="o">+</span> <span class="s2">&quot; - Slots: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">))</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="c1"># self.logger.dialog_turn(&quot;System Action: &quot; + message)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_utterance&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="k">def</span> <span class="nf">_initialise_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">            Loads the correct template file based on which language has been selected</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">            this should only be called on the first turn of the dialog</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">                language (Language): Enum representing the language the user has selected</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="k">for</span> <span class="n">emotion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotions</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">emotion</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">TemplateFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>                <span class="sa">f</span><span class="s1">&#39;../../resources/nlg_templates/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span><span class="si">}</span><span class="s1">Messages</span><span class="si">{</span><span class="n">emotion</span><span class="si">}</span><span class="s1">.nlg&#39;</span><span class="p">),</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="s2">&quot;neutral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TemplateFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="sa">f</span><span class="s1">&#39;../../resources/nlg_templates/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span><span class="si">}</span><span class="s1">Messages.nlg&#39;</span><span class="p">),</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_additional_methods_for_template_file</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>    <span class="k">def</span> <span class="nf">_add_additional_methods_for_template_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="sd">&quot;&quot;&quot;add the function prefixed by &quot;_template_&quot; to the template file interpreter&quot;&quot;&quot;</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="k">if</span> <span class="n">method_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_template_&#39;</span><span class="p">):</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>                <span class="k">for</span> <span class="n">emotion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">emotion</span><span class="p">]</span><span class="o">.</span><span class="n">add_python_function</span><span class="p">(</span><span class="n">method_name</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">method</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">])</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="p">{},</span> <span class="n">template_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">template_file_german</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">emotions</span><span class="o">=</span><span class="p">[],</span> <span class="n">debug_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/affective_nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="p">{},</span> <span class="n">template_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">emotions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">debug_logger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Constructor mainly extracts methods and rules from the template file&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">,</span> <span class="n">debug_logger</span><span class="o">=</span><span class="n">debug_logger</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="n">template_file</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">emotions</span> <span class="o">=</span> <span class="n">emotions</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_templates</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.generate_system_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">generate_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.affective_nlg.HandcraftedEmotionNLG.generate_system_utterance" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/affective_nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.nlg.bc_nlg" class="doc doc-heading">
        <code>bc_nlg</code>



<a href="#adviser.services.nlg.bc_nlg" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Handcrafted (i.e. template-based) Natural Language Generation Module with backchannel</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG" class="doc doc-heading">
        <code>
BackchannelHandcraftedNLG            (<span title="services.nlg.nlg.HandcraftedNLG">HandcraftedNLG</span>)
        </code>



<a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Handcrafted (i.e. template-based) Natural Language Generation Module</p>
<p>A rule-based approach on natural language generation.
The rules have to be specified within a template file using the ADVISER NLG syntax.
Python methods that are called within a template file must be specified in the
HandcraftedNLG class by using the prefix "<em>template</em>". For example, the method
"_template_genitive_s" can be accessed in the template file via calling {genitive_s(name)}</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>the domain</p></td>
      </tr>
      <tr>
        <td><code>template_filename</code></td>
        <td><code>str</code></td>
        <td><p>the NLG template filename</p></td>
      </tr>
      <tr>
        <td><code>templates</code></td>
        <td><code>TemplateFile</code></td>
        <td><p>the parsed and ready-to-go NLG template file</p></td>
      </tr>
      <tr>
        <td><code>template_english</code></td>
        <td><code>str</code></td>
        <td><p>the name of the English NLG template file</p></td>
      </tr>
      <tr>
        <td><code>template_german</code></td>
        <td><code>str</code></td>
        <td><p>the name of the German NLG template file</p></td>
      </tr>
      <tr>
        <td><code>language</code></td>
        <td><code>Language</code></td>
        <td><p>the language of the dialogue</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/bc_nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">BackchannelHandcraftedNLG</span><span class="p">(</span><span class="n">HandcraftedNLG</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Handcrafted (i.e. template-based) Natural Language Generation Module</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    A rule-based approach on natural language generation.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    The rules have to be specified within a template file using the ADVISER NLG syntax.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Python methods that are called within a template file must be specified in the</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    HandcraftedNLG class by using the prefix &quot;_template_&quot;. For example, the method</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;_template_genitive_s&quot; can be accessed in the template file via calling {genitive_s(name)}</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        domain (Domain): the domain</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        template_filename (str): the NLG template filename</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        templates (TemplateFile): the parsed and ready-to-go NLG template file</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        template_english (str): the name of the English NLG template file</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        template_german (str): the name of the German NLG template file</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">        language (Language): the language of the dialogue</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">template_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                 <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                 <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="sd">&quot;&quot;&quot;Constructor mainly extracts methods and rules from the template file&quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">HandcraftedNLG</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">template_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>            <span class="n">logger</span><span class="o">=</span><span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="c1"># class_int_mapping = {0: b&#39;no_bc&#39;, 1: b&#39;assessment&#39;, 2: b&#39;continuer&#39;}</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backchannels</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Okay. &#39;</span><span class="p">,</span> <span class="s1">&#39;Yeah. &#39;</span><span class="p">],</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Um-hum. &#39;</span><span class="p">,</span> <span class="s1">&#39;Uh-huh. &#39;</span><span class="p">]</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="p">}</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">,</span> <span class="s1">&#39;predicted_BC&#39;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">])</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="k">def</span> <span class="nf">publish_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">predicted_BC</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sys_utterance</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">        Takes a system act, searches for a fitting rule, adds, backchannel and applies it</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">        and returns the message.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">        mapping = {0: b&#39;no_bc&#39;, 1: b&#39;assessment&#39;, 2: b&#39;continuer&#39;}</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">            sys_act (SysAct): The system act, to check whether the dialogue was finished</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">            predicted_BC (int): integer representation of the BC</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="sd">            dict: a dict containing the system utterance</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="n">rule_found</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_system_utterance</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="k">if</span> <span class="s1">&#39;Sorry&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backchannels</span><span class="p">[</span><span class="n">predicted_BC</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">message</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_utterance&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="p">{},</span> <span class="n">template_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">template_file_german</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/bc_nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">template_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Constructor mainly extracts methods and rules from the template file&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">HandcraftedNLG</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">template_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">logger</span><span class="o">=</span><span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="c1"># class_int_mapping = {0: b&#39;no_bc&#39;, 1: b&#39;assessment&#39;, 2: b&#39;continuer&#39;}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">backchannels</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Okay. &#39;</span><span class="p">,</span> <span class="s1">&#39;Yeah. &#39;</span><span class="p">],</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Um-hum. &#39;</span><span class="p">,</span> <span class="s1">&#39;Uh-huh. &#39;</span><span class="p">]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.publish_system_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">publish_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.bc_nlg.BackchannelHandcraftedNLG.publish_system_utterance" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/bc_nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.nlg.nlg" class="doc doc-heading">
        <code>nlg</code>



<a href="#adviser.services.nlg.nlg" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Handcrafted (i.e. template-based) Natural Language Generation Module</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.nlg.nlg.HandcraftedNLG" class="doc doc-heading">
        <code>
HandcraftedNLG            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.nlg.nlg.HandcraftedNLG" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Handcrafted (i.e. template-based) Natural Language Generation Module</p>
<p>A rule-based approach on natural language generation.
The rules have to be specified within a template file using the ADVISER NLG syntax.
Python methods that are called within a template file must be specified in the
HandcraftedNLG class by using the prefix "<em>template</em>". For example, the method
"_template_genitive_s" can be accessed in the template file via calling {genitive_s(name)}</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>the domain</p></td>
      </tr>
      <tr>
        <td><code>template_filename</code></td>
        <td><code>str</code></td>
        <td><p>the NLG template filename</p></td>
      </tr>
      <tr>
        <td><code>templates</code></td>
        <td><code>TemplateFile</code></td>
        <td><p>the parsed and ready-to-go NLG template file</p></td>
      </tr>
      <tr>
        <td><code>template_english</code></td>
        <td><code>str</code></td>
        <td><p>the name of the English NLG template file</p></td>
      </tr>
      <tr>
        <td><code>template_german</code></td>
        <td><code>str</code></td>
        <td><p>the name of the German NLG template file</p></td>
      </tr>
      <tr>
        <td><code>language</code></td>
        <td><code>Language</code></td>
        <td><p>the language of the dialogue</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedNLG</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Handcrafted (i.e. template-based) Natural Language Generation Module</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    A rule-based approach on natural language generation.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    The rules have to be specified within a template file using the ADVISER NLG syntax.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Python methods that are called within a template file must be specified in the</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    HandcraftedNLG class by using the prefix &quot;_template_&quot;. For example, the method</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;_template_genitive_s&quot; can be accessed in the template file via calling {genitive_s(name)}</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        domain (Domain): the domain</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        template_filename (str): the NLG template filename</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        templates (TemplateFile): the parsed and ready-to-go NLG template file</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        template_english (str): the name of the English NLG template file</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        template_german (str): the name of the German NLG template file</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">        language (Language): the language of the dialogue</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">template_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                 <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                 <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="sd">&quot;&quot;&quot;Constructor mainly extracts methods and rules from the template file&quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span> <span class="k">if</span> <span class="n">language</span> <span class="k">else</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">template_english</span> <span class="o">=</span> <span class="n">template_file</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="c1"># TODO: at some point if we expand languages, maybe make kwargs? --LV</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">template_german</span> <span class="o">=</span> <span class="n">template_file_german</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_language</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_utterance&quot;</span><span class="p">])</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="k">def</span> <span class="nf">publish_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sys_utterance</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="sd">&quot;&quot;&quot;Generates the system utterance and publishes it.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">            sys_act (SysAct): The system act published by the policy</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="sd">            dict: a dict containing the system utterance</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_utterance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_system_utterance</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)}</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="k">def</span> <span class="nf">generate_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="sd">&quot;&quot;&quot;Main function of the NLG module</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">        Takes a system act, searches for a fitting rule, applies it and returns the message.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">        Overwrite this function if you inherit from the NLG module.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">            sys_act (SysAct): The system act</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            The utterance generated by applying a fitting template</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="n">rule_found</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">create_message</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>            <span class="n">rule_found</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="k">raise</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="c1"># inform if no applicable rule could be found in the template file</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_found</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not find a fitting rule for the given system act!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;System Action: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>                             <span class="o">+</span> <span class="s2">&quot; - Slots: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">))</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="c1"># self.logger.dialog_turn(&quot;System Action: &quot; + message)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="k">return</span> <span class="n">message</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>    <span class="k">def</span> <span class="nf">_initialise_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="n">Language</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a><span class="sd">            Loads the correct template file based on which language has been selected</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a><span class="sd">            this should only be called on the first turn of the dialog</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a><span class="sd">                language (Language): Enum representing the language the user has selected</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>        <span class="k">if</span> <span class="n">language</span> <span class="o">==</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_english</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>                    <span class="s1">&#39;../../resources/nlg_templates/</span><span class="si">%s</span><span class="s1">Messages.nlg&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">())</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_english</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>        <span class="k">if</span> <span class="n">language</span> <span class="o">==</span> <span class="n">Language</span><span class="o">.</span><span class="n">GERMAN</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_german</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>                    <span class="s1">&#39;../../resources/nlg_templates/</span><span class="si">{}</span><span class="s1">MessagesGerman.nlg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()))</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_german</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="n">TemplateFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_additional_methods_for_template_file</span><span class="p">()</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>    <span class="k">def</span> <span class="nf">_add_additional_methods_for_template_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>        <span class="sd">&quot;&quot;&quot;add the function prefixed by &quot;_template_&quot; to the template file interpreter&quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>            <span class="k">if</span> <span class="n">method_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_template_&#39;</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">add_python_function</span><span class="p">(</span><span class="n">method_name</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">method</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">])</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>    <span class="k">def</span> <span class="nf">_template_genitive_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;s&quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>    <span class="k">def</span> <span class="nf">_template_genitive_s_german</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;ß&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">):</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">s&quot;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlg.nlg.HandcraftedNLG.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">template_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="p">{},</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">template_file_german</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.nlg.HandcraftedNLG.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Constructor mainly extracts methods and rules from the template file</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">template_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">template_file_german</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;Constructor mainly extracts methods and rules from the template file&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="n">sub_topic_domains</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span> <span class="k">if</span> <span class="n">language</span> <span class="k">else</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">template_english</span> <span class="o">=</span> <span class="n">template_file</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="c1"># TODO: at some point if we expand languages, maybe make kwargs? --LV</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">template_german</span> <span class="o">=</span> <span class="n">template_file_german</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">template_filename</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_language</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlg.nlg.HandcraftedNLG.generate_system_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">generate_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.nlg.HandcraftedNLG.generate_system_utterance" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Main function of the NLG module</p>
<p>Takes a system act, searches for a fitting rule, applies it and returns the message.
Overwrite this function if you inherit from the NLG module.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>sys_act</code></td>
        <td><code>SysAct</code></td>
        <td><p>The system act</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>The utterance generated by applying a fitting template</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">generate_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Main function of the NLG module</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Takes a system act, searches for a fitting rule, applies it and returns the message.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Overwrite this function if you inherit from the NLG module.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        sys_act (SysAct): The system act</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        The utterance generated by applying a fitting template</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">rule_found</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">create_message</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="n">rule_found</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="k">raise</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="c1"># inform if no applicable rule could be found in the template file</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_found</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not find a fitting rule for the given system act!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;System Action: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                         <span class="o">+</span> <span class="s2">&quot; - Slots: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">))</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="c1"># self.logger.dialog_turn(&quot;System Action: &quot; + message)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">return</span> <span class="n">message</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlg.nlg.HandcraftedNLG.publish_system_utterance" class="doc doc-heading">
<code class="highlight language-python"><span class="n">publish_system_utterance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.nlg.HandcraftedNLG.publish_system_utterance" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/nlg.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.nlg.templates" class="doc doc-heading">
        <code>templates</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="adviser.services.nlg.templates.builtinfunctions" class="doc doc-heading">
        <code>builtinfunctions</code>



<a href="#adviser.services.nlg.templates.builtinfunctions" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.nlg.templates.builtinfunctions.ForEntryFunction" class="doc doc-heading">
        <code>
ForEntryFunction            (<span title="services.nlg.templates.data.commands.function.Function">Function</span>)
        </code>



<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ForEntryFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;for_entry(slots, function, separator_first, separator_last)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">global_memory</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">function</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">extra_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">:]]</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">for</span> <span class="n">slot_value_pair</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_memory</span><span class="p">(</span><span class="n">slot_value_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slot_value_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extra_arguments</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">memory</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s1"> could not be called &#39;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                                    <span class="sa">f</span><span class="s1">&#39;from the for_entry function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                                               <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">def</span> <span class="nf">_build_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;slot&#39;</span><span class="p">,</span> <span class="n">slot</span><span class="p">))</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">argument</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;arg</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">argument</span><span class="p">))</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="k">return</span> <span class="n">memory</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">def</span> <span class="nf">_create_text_from_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">last_separator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="k">return</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>            <span class="n">text</span> <span class="o">+=</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">text</span> <span class="o">+=</span> <span class="n">last_separator</span> <span class="o">+</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;for_entry(slots, function, separator_first, separator_last)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">global_memory</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.apply" class="doc doc-heading">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.apply" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">function</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">extra_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">:]]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">for</span> <span class="n">slot_value_pair</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_memory</span><span class="p">(</span><span class="n">slot_value_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slot_value_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extra_arguments</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">memory</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s1"> could not be called &#39;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                                <span class="sa">f</span><span class="s1">&#39;from the for_entry function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                                           <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.is_applicable" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryFunction.is_applicable" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction" class="doc doc-heading">
        <code>
ForEntryListFunction            (<span title="services.nlg.templates.data.commands.function.Function">Function</span>)
        </code>



<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ForEntryListFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">:</span> <span class="n">GlobalMemory</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;for_entry_list(slots, function, value_sep, value_sep_last, &#39;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                                <span class="s1">&#39;slot_sep, slot_sep_last)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">global_memory</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">function</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">extra_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">6</span><span class="p">:]]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="n">texts_per_slot</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">for</span> <span class="n">slot_values_pair</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="n">slot_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">slot_values_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>            
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_memory</span><span class="p">(</span><span class="n">slot_values_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">extra_arguments</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">memory</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                    <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s1"> could not be &#39;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                                        <span class="sa">f</span><span class="s1">&#39;called from the for_entry_list function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                <span class="n">slot_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">slot_texts</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                                                   <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">texts_per_slot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">texts_per_slot</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                                               <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="k">def</span> <span class="nf">_build_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;slot&#39;</span><span class="p">,</span> <span class="n">slot</span><span class="p">))</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">argument</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;arg</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">argument</span><span class="p">))</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="k">return</span> <span class="n">memory</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="k">def</span> <span class="nf">_create_text_from_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">last_separator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="k">return</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="n">text</span> <span class="o">+=</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="n">text</span> <span class="o">+=</span> <span class="n">last_separator</span> <span class="o">+</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">:</span> <span class="n">GlobalMemory</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;for_entry_list(slots, function, value_sep, value_sep_last, &#39;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                            <span class="s1">&#39;slot_sep, slot_sep_last)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">global_memory</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.apply" class="doc doc-heading">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.apply" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">function</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">extra_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">6</span><span class="p">:]]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">texts_per_slot</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">for</span> <span class="n">slot_values_pair</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">slot_texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">slot_values_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>            
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_memory</span><span class="p">(</span><span class="n">slot_values_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">extra_arguments</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">memory</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s1"> could not be &#39;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                                    <span class="sa">f</span><span class="s1">&#39;called from the for_entry_list function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="n">slot_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">slot_texts</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                                               <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">texts_per_slot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">texts_per_slot</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                                           <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.is_applicable" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.ForEntryListFunction.is_applicable" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="adviser.services.nlg.templates.builtinfunctions.ForFunction" class="doc doc-heading">
        <code>
ForFunction            (<span title="services.nlg.templates.data.commands.function.Function">Function</span>)
        </code>



<a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ForFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;for(values, function, separator_first, separator_last, *args)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">global_memory</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">function</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">extra_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">:]]</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_memory</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">extra_arguments</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">memory</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s1"> could not be called &#39;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                                    <span class="sa">f</span><span class="s1">&#39;from the for function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                                               <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">def</span> <span class="nf">_build_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">argument</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="n">memory</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;arg</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">argument</span><span class="p">))</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="k">return</span> <span class="n">memory</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="k">def</span> <span class="nf">_create_text_from_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">separator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">last_separator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">elements</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="k">return</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="n">text</span> <span class="o">+=</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">text</span> <span class="o">+=</span> <span class="n">last_separator</span> <span class="o">+</span> <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">return</span> <span class="n">text</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForFunction.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_memory</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;for(values, function, separator_first, separator_last, *args)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">global_memory</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForFunction.apply" class="doc doc-heading">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.apply" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">function</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">extra_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">4</span><span class="p">:]]</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_memory</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">extra_arguments</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">memory</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s1"> could not be called &#39;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                                <span class="sa">f</span><span class="s1">&#39;from the for function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">memory</span><span class="p">))</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_text_from_elements</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                                           <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.ForFunction.is_applicable" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.ForFunction.is_applicable" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="adviser.services.nlg.templates.builtinfunctions.PythonFunction" class="doc doc-heading">
        <code>
PythonFunction            (<span title="services.nlg.templates.data.commands.function.Function">Function</span>)
        </code>



<a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">PythonFunction</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">function_to_call</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                 <span class="n">obligatory_arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">()&#39;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function_to_call</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">obligatory_arguments</span> <span class="o">=</span> <span class="n">obligatory_arguments</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obligatory_arguments</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="n">arguments</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">])</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.PythonFunction.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function_to_call</span><span class="p">,</span> <span class="n">obligatory_arguments</span><span class="o">=</span><span class="p">[])</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">function_to_call</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">obligatory_arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">Function</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">()&#39;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function_to_call</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">obligatory_arguments</span> <span class="o">=</span> <span class="n">obligatory_arguments</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.PythonFunction.apply" class="doc doc-heading">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.apply" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obligatory_arguments</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">arguments</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">variables</span><span class="p">])</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.builtinfunctions.PythonFunction.is_applicable" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.builtinfunctions.PythonFunction.is_applicable" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/builtinfunctions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Memory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.nlg.templates.parsing" class="doc doc-heading">
        <code>parsing</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h5 id="adviser.services.nlg.templates.parsing.automaton" class="doc doc-heading">
        <code>automaton</code>



<a href="#adviser.services.nlg.templates.parsing.automaton" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton" class="doc doc-heading">
        <code>
ModifiedPushdownAutomaton        </code>



<a href="#adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/automaton.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ModifiedPushdownAutomaton</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">accept_states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">State</span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                 <span class="n">state_descriptions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StateDescription</span><span class="p">]):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start_state</span> <span class="o">=</span> <span class="n">start_state</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept_states</span> <span class="o">=</span> <span class="n">accept_states</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_descriptions</span> <span class="o">=</span> <span class="n">state_descriptions</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_transition_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_state_transition_mapping</span><span class="p">()</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_default_transition_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_state_default_transition_mapping</span><span class="p">()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">AutomatonStack</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">def</span> <span class="nf">_create_state_transition_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Transition</span><span class="p">]]:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">state_transition_mapping</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">for</span> <span class="n">state_description</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_descriptions</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="n">input_state</span> <span class="o">=</span> <span class="n">state_description</span><span class="o">.</span><span class="n">default_state</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="k">if</span> <span class="n">input_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state_transition_mapping</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                <span class="n">state_transition_mapping</span><span class="p">[</span><span class="n">input_state</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">state_description</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                <span class="n">input_char</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">input_configuration</span><span class="o">.</span><span class="n">character</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                <span class="n">state_transition_mapping</span><span class="p">[</span><span class="n">input_state</span><span class="p">][</span><span class="n">input_char</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">return</span> <span class="n">state_transition_mapping</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">def</span> <span class="nf">_create_state_default_transition_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="n">DefaultTransition</span><span class="p">]:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">state_default_transition_mapping</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="k">for</span> <span class="n">state_description</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_descriptions</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="n">state_default_transition_mapping</span><span class="p">[</span><span class="n">state_description</span><span class="o">.</span><span class="n">default_state</span><span class="p">]</span> <span class="o">=</span> \
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">state_description</span><span class="o">.</span><span class="n">default_transition</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="k">return</span> <span class="n">state_default_transition_mapping</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tape</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_state</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="n">input_tape_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="k">for</span> <span class="n">input_char</span> <span class="ow">in</span> <span class="n">input_tape</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>                <span class="n">configuration</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">input_char</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_transition</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>                <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_transition</span><span class="p">(</span><span class="n">transition</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>                <span class="n">input_tape_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="k">except</span> <span class="n">ParsingError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;State:&#39;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span> <span class="n">input_tape_index</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original Input:&#39;</span><span class="p">,</span> <span class="n">input_tape</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>                <span class="k">raise</span> <span class="n">error</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="k">if</span> <span class="n">current_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_states</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;State:&#39;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>            <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Parser was not in a final state after the input tape was read.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">data_stack</span><span class="p">[:]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="k">def</span> <span class="nf">_apply_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transition</span><span class="p">:</span> <span class="n">Transition</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                          <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="n">transition</span><span class="o">.</span><span class="n">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="n">output_configuration</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">get_output_configuration</span><span class="p">(</span><span class="n">input_configuration</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">add_char</span><span class="p">(</span><span class="n">output_configuration</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="k">return</span> <span class="n">output_configuration</span><span class="o">.</span><span class="n">state</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="k">def</span> <span class="nf">_find_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_transition_mapping</span> <span class="ow">or</span> \
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>            <span class="n">configuration</span><span class="o">.</span><span class="n">character</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_transition_mapping</span><span class="p">[</span><span class="n">configuration</span><span class="o">.</span><span class="n">state</span><span class="p">]:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_default_transition</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_transition_mapping</span><span class="p">[</span><span class="n">configuration</span><span class="o">.</span><span class="n">state</span><span class="p">][</span><span class="n">configuration</span><span class="o">.</span><span class="n">character</span><span class="p">]</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>    <span class="k">def</span> <span class="nf">_find_default_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="k">if</span> <span class="n">current_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_default_transition_mapping</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No default transition found for state </span><span class="si">{</span><span class="n">current_state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_default_transition_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_state</span><span class="p">,</span> <span class="n">accept_states</span><span class="p">,</span> <span class="n">state_descriptions</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/automaton.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">accept_states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">State</span><span class="p">],</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">state_descriptions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StateDescription</span><span class="p">]):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">start_state</span> <span class="o">=</span> <span class="n">start_state</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">accept_states</span> <span class="o">=</span> <span class="n">accept_states</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">state_descriptions</span> <span class="o">=</span> <span class="n">state_descriptions</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">state_transition_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_state_transition_mapping</span><span class="p">()</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">state_default_transition_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_state_default_transition_mapping</span><span class="p">()</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">AutomatonStack</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton.parse" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tape</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton.parse" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/automaton.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tape</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_state</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">input_tape_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">for</span> <span class="n">input_char</span> <span class="ow">in</span> <span class="n">input_tape</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>            <span class="n">configuration</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">current_state</span><span class="p">,</span> <span class="n">input_char</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_transition</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_transition</span><span class="p">(</span><span class="n">transition</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>            <span class="n">input_tape_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">except</span> <span class="n">ParsingError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;State:&#39;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index:&#39;</span><span class="p">,</span> <span class="n">input_tape_index</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original Input:&#39;</span><span class="p">,</span> <span class="n">input_tape</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="k">raise</span> <span class="n">error</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">if</span> <span class="n">current_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_states</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;State:&#39;</span><span class="p">,</span> <span class="n">current_state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Parser was not in a final state after the input tape was read.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">data_stack</span><span class="p">[:]</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="adviser.services.nlg.templates.parsing.configuration" class="doc doc-heading">
        <code>configuration</code>



<a href="#adviser.services.nlg.templates.parsing.configuration" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.Configuration" class="doc doc-heading">
        <code>
Configuration        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.Configuration" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">character</span> <span class="o">=</span> <span class="n">character</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.Configuration.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">character</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.Configuration.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">character</span> <span class="o">=</span> <span class="n">character</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.DefaultTransition" class="doc doc-heading">
        <code>
DefaultTransition            (<a class="autorefs autorefs-internal" title="adviser.services.nlg.templates.parsing.configuration.Transition" href="#adviser.services.nlg.templates.parsing.configuration.Transition">Transition</a>)
        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.DefaultTransition" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">DefaultTransition</span><span class="p">(</span><span class="n">Transition</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">Transition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.DefaultTransition.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.DefaultTransition.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Transition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition" class="doc doc-heading">
        <code>
SimpleForwardDefaultTransition            (<a class="autorefs autorefs-internal" title="adviser.services.nlg.templates.parsing.configuration.DefaultTransition" href="#adviser.services.nlg.templates.parsing.configuration.DefaultTransition">DefaultTransition</a>)
        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">SimpleForwardDefaultTransition</span><span class="p">(</span><span class="n">DefaultTransition</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">DefaultTransition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="k">return</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">input_configuration</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">input_configuration</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">pass</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">DefaultTransition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition.get_output_configuration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition.get_output_configuration" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">input_configuration</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">input_configuration</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition.perform_stack_action" class="doc doc-heading">
<code class="highlight language-python"><span class="n">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.SimpleForwardDefaultTransition.perform_stack_action" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.State" class="doc doc-heading">
        <code>
State        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.State" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">State</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">State</span><span class="p">)</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.State.__eq__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.State.__eq__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">State</span><span class="p">)</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.State.__hash__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.State.__hash__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.State.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.State.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.StateDescription" class="doc doc-heading">
        <code>
StateDescription        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.StateDescription" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">StateDescription</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">default_transition</span><span class="p">:</span> <span class="n">DefaultTransition</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                 <span class="n">transitions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Transition</span><span class="p">]):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">default_state</span> <span class="o">=</span> <span class="n">default_state</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">default_transition</span> <span class="o">=</span> <span class="n">default_transition</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="n">transitions</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.StateDescription.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_state</span><span class="p">,</span> <span class="n">default_transition</span><span class="p">,</span> <span class="n">transitions</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.StateDescription.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">default_transition</span><span class="p">:</span> <span class="n">DefaultTransition</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">transitions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Transition</span><span class="p">]):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">default_state</span> <span class="o">=</span> <span class="n">default_state</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">default_transition</span> <span class="o">=</span> <span class="n">default_transition</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="n">transitions</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.Transition" class="doc doc-heading">
        <code>
Transition        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.Transition" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Transition</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_configuration</span> <span class="o">=</span> <span class="n">input_configuration</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.Transition.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.Transition.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">input_configuration</span> <span class="o">=</span> <span class="n">input_configuration</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.Transition.get_output_configuration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.Transition.get_output_configuration" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.Transition.perform_stack_action" class="doc doc-heading">
<code class="highlight language-python"><span class="n">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.Transition.perform_stack_action" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithAction" class="doc doc-heading">
        <code>
TransitionWithAction            (<a class="autorefs autorefs-internal" title="adviser.services.nlg.templates.parsing.configuration.Transition" href="#adviser.services.nlg.templates.parsing.configuration.Transition">Transition</a>)
        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithAction" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">TransitionWithAction</span><span class="p">(</span><span class="n">Transition</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">output_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                 <span class="n">action</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">AutomatonStack</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">Transition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span> <span class="o">=</span> <span class="n">output_configuration</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithAction.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">,</span> <span class="n">output_configuration</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithAction.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">output_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">action</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">AutomatonStack</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">Transition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span> <span class="o">=</span> <span class="n">output_configuration</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithAction.get_output_configuration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithAction.get_output_configuration" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithAction.perform_stack_action" class="doc doc-heading">
<code class="highlight language-python"><span class="n">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithAction.perform_stack_action" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction" class="doc doc-heading">
        <code>
TransitionWithoutAction            (<a class="autorefs autorefs-internal" title="adviser.services.nlg.templates.parsing.configuration.Transition" href="#adviser.services.nlg.templates.parsing.configuration.Transition">Transition</a>)
        </code>



<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">TransitionWithoutAction</span><span class="p">(</span><span class="n">Transition</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">output_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">Transition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span> <span class="o">=</span> <span class="n">output_configuration</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="k">pass</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">,</span> <span class="n">output_configuration</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">output_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Transition</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span> <span class="o">=</span> <span class="n">output_configuration</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction.get_output_configuration" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction.get_output_configuration" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_output_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Configuration</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_configuration</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction.perform_stack_action" class="doc doc-heading">
<code class="highlight language-python"><span class="n">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.configuration.TransitionWithoutAction.perform_stack_action" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/configuration.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">perform_stack_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">AutomatonStack</span><span class="p">,</span> <span class="n">configuration</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="adviser.services.nlg.templates.parsing.exceptions" class="doc doc-heading">
        <code>exceptions</code>



<a href="#adviser.services.nlg.templates.parsing.exceptions" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.exceptions.ParsingError" class="doc doc-heading">
        <code>
ParsingError            (<span title="Exception">Exception</span>)
        </code>



<a href="#adviser.services.nlg.templates.parsing.exceptions.ParsingError" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/exceptions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ParsingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.exceptions.ParsingError.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.exceptions.ParsingError.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/exceptions.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="adviser.services.nlg.templates.parsing.parsers" class="doc doc-heading">
        <code>parsers</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.parsers" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h6 id="adviser.services.nlg.templates.parsing.parsers.messageparser" class="doc doc-heading">
        <code>messageparser</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.parsers.messageparser" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h7 id="adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser" class="doc doc-heading">
        <code>messageparser</code>



<a href="#adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h8 id="adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser.head_location" class="doc doc-heading">
<code class="highlight language-python"><span class="n">head_location</span></code>


<a href="#adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser.head_location" class="headerlink" title="Permanent link">&para;</a></h8>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h8 id="adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser.MessageParser" class="doc doc-heading">
        <code>
MessageParser            (<span title="services.nlg.templates.parsing.automaton.ModifiedPushdownAutomaton">ModifiedPushdownAutomaton</span>)
        </code>



<a href="#adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser.MessageParser" class="headerlink" title="Permanent link">&para;</a></h8>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/parsers/messageparser/messageparser.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">MessageParser</span><span class="p">(</span><span class="n">ModifiedPushdownAutomaton</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">ModifiedPushdownAutomaton</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">StartState</span><span class="p">(),</span> <span class="p">[</span><span class="n">AcceptState</span><span class="p">()],</span> <span class="p">[</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>            <span class="n">StartStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>            <span class="n">AcceptStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>            <span class="n">MessageStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>            <span class="n">EscapeStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>            <span class="n">CodeStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="n">AdviserStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="n">PythonStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>            <span class="n">PythonClosingBraceStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>            <span class="n">CodeStringStateDescription</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="p">])</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h9 id="adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser.MessageParser.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.parsers.messageparser.messageparser.MessageParser.__init__" class="headerlink" title="Permanent link">&para;</a></h9>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/parsers/messageparser/messageparser.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">ModifiedPushdownAutomaton</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">StartState</span><span class="p">(),</span> <span class="p">[</span><span class="n">AcceptState</span><span class="p">()],</span> <span class="p">[</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="n">StartStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">AcceptStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="n">MessageStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">EscapeStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">CodeStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="n">AdviserStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="n">PythonStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">PythonClosingBraceStateDescription</span><span class="p">(),</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">CodeStringStateDescription</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h5 id="adviser.services.nlg.templates.parsing.stack" class="doc doc-heading">
        <code>stack</code>



<a href="#adviser.services.nlg.templates.parsing.stack" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack" class="doc doc-heading">
        <code>
AutomatonStack        </code>



<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">AutomatonStack</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="c1"># self.char_stack = []  # the automaton&#39;s stack</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># the stack in which custom data structures can be stored</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># multiple automaton stacks are possible here</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">def</span> <span class="nf">add_char</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_char</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="s1">&#39;No more levels left on the stack&#39;</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack_char</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">def</span> <span class="nf">pop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">def</span> <span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">def</span> <span class="nf">add_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">def</span> <span class="nf">get_current_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="s1">&#39;No more levels left on the stack&#39;</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">def</span> <span class="nf">remove_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="s1">&#39;No more levels to remove from the stack&#39;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[[]]</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.__init__" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># self.char_stack = []  # the automaton&#39;s stack</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># the stack in which custom data structures can be stored</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># multiple automaton stacks are possible here</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.add_char" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_char</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_char</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.add_char" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">add_char</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_char</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="s1">&#39;No more levels left on the stack&#39;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack_char</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.add_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.add_data" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.add_level" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.add_level" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">add_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.clear" class="doc doc-heading">
<code class="highlight language-python"><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.clear" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[[]]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.fetch_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.fetch_data" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.get_current_content" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_current_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.get_current_content" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_current_content</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="s1">&#39;No more levels left on the stack&#39;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.pop_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">pop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.pop_data" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">pop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h7 id="adviser.services.nlg.templates.parsing.stack.AutomatonStack.remove_level" class="doc doc-heading">
<code class="highlight language-python"><span class="n">remove_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.parsing.stack.AutomatonStack.remove_level" class="headerlink" title="Permanent link">&para;</a></h7>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/parsing/stack.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">remove_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="k">raise</span> <span class="n">ParsingError</span><span class="p">(</span><span class="s1">&#39;No more levels to remove from the stack&#39;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.nlg.templates.preprocessing" class="doc doc-heading">
        <code>preprocessing</code>



<a href="#adviser.services.nlg.templates.preprocessing" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">



    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.nlg.templates.templatefile" class="doc doc-heading">
        <code>templatefile</code>



<a href="#adviser.services.nlg.templates.templatefile" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h5 id="adviser.services.nlg.templates.templatefile.KEYWORDS" class="doc doc-heading">
<code class="highlight language-python"><span class="n">KEYWORDS</span></code>


<a href="#adviser.services.nlg.templates.templatefile.KEYWORDS" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h5 id="adviser.services.nlg.templates.templatefile.TemplateFile" class="doc doc-heading">
        <code>
TemplateFile        </code>



<a href="#adviser.services.nlg.templates.templatefile.TemplateFile" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Interprets a template file</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/templatefile.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">TemplateFile</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Interprets a template file</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        global_memory {GlobalMemory} -- memory that can be accessed at all times in the tempaltes</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">GlobalMemory</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_built_in_functions</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">tfr</span> <span class="o">=</span> <span class="n">_TemplateFileReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_template_dict</span><span class="p">(</span><span class="n">tfr</span><span class="o">.</span><span class="n">get_templates</span><span class="p">())</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_functions_to_global_memory</span><span class="p">(</span><span class="n">tfr</span><span class="o">.</span><span class="n">get_functions</span><span class="p">())</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">def</span> <span class="nf">_add_built_in_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">ForFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="p">))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">ForEntryFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="p">))</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">ForEntryListFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="p">))</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">def</span> <span class="nf">_create_template_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Template</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Template</span><span class="p">]:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="n">template_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">intent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template_dict</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">template_dict</span><span class="p">[</span><span class="n">template</span><span class="o">.</span><span class="n">intent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">template_dict</span><span class="p">[</span><span class="n">template</span><span class="o">.</span><span class="n">intent</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="k">return</span> <span class="n">template_dict</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="k">def</span> <span class="nf">_add_functions_to_global_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Function</span><span class="p">]):</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">def</span> <span class="nf">create_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="sd">&quot;&quot;&quot;Iterates through all possible templates and applies the first one to fit the system act</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">        Arguments:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">            sys_act {SysAct} -- the system act to find a template for</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">            BaseException: when no template could be applied</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">            str -- the message returned by the template</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_memory_from_sys_act</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span><span class="p">]:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">slots</span><span class="p">):</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">slots</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="s1">&#39;No template was found for the given system act.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="k">def</span> <span class="nf">_create_memory_from_sys_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Memory</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="n">slots</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">Variable</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">]))</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="k">return</span> <span class="n">slots</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="k">def</span> <span class="nf">add_python_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">python_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">object</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>                            <span class="n">obligatory_arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]):</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="sd">&quot;&quot;&quot;Add a python function to the global memory of the template file interpreter</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">        Arguments:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">            function_name {str} -- name under which the function can be accessed in template file</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">            python_function {Callable[[object], str]} -- python function which is called when being</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">                accessed in the template file</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="sd">        Keyword Arguments:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a><span class="sd">            obligatory_arguments {List[object]} -- objects that are always passed as first</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="sd">                arguments to the python function, e.g. &quot;self&quot; (default: {[]})</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">PythonFunction</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">python_function</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>                                                       <span class="n">obligatory_arguments</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.templatefile.TemplateFile.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlg.templates.templatefile.TemplateFile.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/templatefile.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span> <span class="o">=</span> <span class="n">GlobalMemory</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_add_built_in_functions</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">tfr</span> <span class="o">=</span> <span class="n">_TemplateFileReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_template_dict</span><span class="p">(</span><span class="n">tfr</span><span class="o">.</span><span class="n">get_templates</span><span class="p">())</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_add_functions_to_global_memory</span><span class="p">(</span><span class="n">tfr</span><span class="o">.</span><span class="n">get_functions</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.templatefile.TemplateFile.add_python_function" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_python_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">python_function</span><span class="p">,</span> <span class="n">obligatory_arguments</span><span class="o">=</span><span class="p">[])</span></code>


<a href="#adviser.services.nlg.templates.templatefile.TemplateFile.add_python_function" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Add a python function to the global memory of the template file interpreter</p>

<p><strong>Keyword arguments:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>obligatory_arguments</code></td>
        <td><code>{List[object]} -- objects that are always passed as first
arguments to the python function, e.g. &#34;self&#34; (default</code></td>
        <td><p>{[]})</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/templatefile.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">add_python_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">python_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">object</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>                        <span class="n">obligatory_arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;Add a python function to the global memory of the template file interpreter</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Arguments:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        function_name {str} -- name under which the function can be accessed in template file</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        python_function {Callable[[object], str]} -- python function which is called when being</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">            accessed in the template file</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Keyword Arguments:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        obligatory_arguments {List[object]} -- objects that are always passed as first</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">            arguments to the python function, e.g. &quot;self&quot; (default: {[]})</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">global_memory</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">PythonFunction</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">python_function</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                                                   <span class="n">obligatory_arguments</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.nlg.templates.templatefile.TemplateFile.create_message" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">)</span></code>


<a href="#adviser.services.nlg.templates.templatefile.TemplateFile.create_message" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Iterates through all possible templates and applies the first one to fit the system act</p>

<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>BaseException</code></td>
        <td><p>when no template could be applied</p></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>str -- the message returned by the template</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/nlg/templates/templatefile.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">create_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Iterates through all possible templates and applies the first one to fit the system act</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Arguments:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        sys_act {SysAct} -- the system act to find a template for</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        BaseException: when no template could be applied</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        str -- the message returned by the template</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_memory_from_sys_act</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templates</span><span class="p">[</span><span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span><span class="p">]:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">(</span><span class="n">slots</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">slots</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="s1">&#39;No template was found for the given system act.&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.nlu" class="doc doc-heading">
        <code>nlu</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlu" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.nlu.nlu" class="doc doc-heading">
        <code>nlu</code>



<a href="#adviser.services.nlu.nlu" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.nlu.nlu.HandcraftedNLU" class="doc doc-heading">
        <code>
HandcraftedNLU            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.nlu.nlu.HandcraftedNLU" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Class for Handcrafted Natural Language Understanding Module (HDC-NLU).</p>
<p>HDC-NLU is a rule-based approach to recognize the user acts as well as
their respective slots and values from the user input (i.e. text)
by means of regular expressions.</p>
<p>HDC-NLU is domain-independet. The regular expressions of are read
from JSON files.</p>
<p>There exist a JSON file that stores general rules (GeneralRules.json),
i.e. rules that apply to any domain, e.g. rules to detect salutation (Hello, Hi).</p>
<p>There are two more files per domain that contain the domain-specific rules
for request and inform user acts, e.g. ImsCoursesInformRules.json and
ImsCoursesRequestRules.json.</p>
<p>The output during dialog interaction of this module is a semantic
representation of the user input.</p>
<p>"I am looking for pizza" --&gt; inform(slot=food,value=italian)</p>
<p>See the regex_generator under tools, if the existing regular expressions
need to be changed or a new domain should be added.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/nlu/nlu.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedNLU</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Class for Handcrafted Natural Language Understanding Module (HDC-NLU).</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    HDC-NLU is a rule-based approach to recognize the user acts as well as</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    their respective slots and values from the user input (i.e. text)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    by means of regular expressions.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    HDC-NLU is domain-independet. The regular expressions of are read</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    from JSON files.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    There exist a JSON file that stores general rules (GeneralRules.json),</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    i.e. rules that apply to any domain, e.g. rules to detect salutation (Hello, Hi).</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    There are two more files per domain that contain the domain-specific rules</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    for request and inform user acts, e.g. ImsCoursesInformRules.json and</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">    ImsCoursesRequestRules.json.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">    The output during dialog interaction of this module is a semantic</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">    representation of the user input.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">    &quot;I am looking for pizza&quot; --&gt; inform(slot=food,value=italian)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">    See the regex_generator under tools, if the existing regular expressions</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">    need to be changed or a new domain should be added.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                 <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">        Loads</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">            - domain key</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">            - informable slots</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">            - requestable slots</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">            - domain-independent regular expressions</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">            - domain-specific regualer espressions</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">        It sets the previous system act to None</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">            domain {domain.jsonlookupdomain.JSONLookupDomain} -- Domain</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span> <span class="k">if</span> <span class="n">language</span> <span class="k">else</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="c1"># Getting domain information</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain_name</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="c1"># Getting lists of informable and requestable slots</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">USER_INFORMABLE</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">()</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">USER_REQUESTABLE</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">()</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="c1"># Getting the relative path where regexes are stored</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;nlu_regexes&#39;</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="c1"># Setting previous system act to None to signal the first turn</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="c1"># self.prev_sys_act = None</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>            <span class="s1">&#39;last_act&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">()</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a><span class="sd">        Sets the previous system act as None.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a><span class="sd">        This function is called when the dialog starts</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="sd">            Empty dictionary</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>            <span class="s1">&#39;last_act&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slots_informed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slots_requested</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">req_everything</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_utterance&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">])</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>    <span class="k">def</span> <span class="nf">extract_user_acts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user_acts</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">]):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a><span class="sd">        Responsible for detecting user acts with their respective slot-values from the user</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a><span class="sd">        utterance through regular expressions.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">            user_utterance (BeliefState) - a BeliefState obejct representing current system</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="sd">                                           knowledge</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a><span class="sd">            dict of str: UserAct - a dictionary with the key &quot;user_acts&quot; and the value</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="sd">                                            containing a list of user actions</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>        <span class="c1"># Setting request everything to False at every turn</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">req_everything</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>        <span class="c1"># slots_requested &amp; slots_informed store slots requested and informed in this turn</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>        <span class="c1"># they are used later for later disambiguation</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slots_requested</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_informed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>        <span class="k">if</span> <span class="n">user_utterance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>            <span class="n">user_utterance</span> <span class="o">=</span> <span class="n">user_utterance</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_match_general_act</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_match_domain_specific_act</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_solve_informable_values</span><span class="p">()</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>        <span class="c1"># If nothing else has been matched, see if the user chose a domain; otherwise if it&#39;s</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>        <span class="c1"># not the first turn, it&#39;s a bad act</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_keyword</span><span class="p">()</span> <span class="ow">in</span> <span class="n">user_utterance</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">user_utterance</span> <span class="k">if</span> <span class="n">user_utterance</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>                                              <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">SelectDomain</span><span class="p">))</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>                <span class="c1"># start of dialogue or no regex matched</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">user_utterance</span> <span class="k">if</span> <span class="n">user_utterance</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>                                              <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span><span class="p">))</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_assign_scores</span><span class="p">()</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;User Actions: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="p">))</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_state&quot;</span><span class="p">])</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>    <span class="k">def</span> <span class="nf">_update_sys_act_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_state</span><span class="p">):</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>        <span class="k">if</span> <span class="s2">&quot;lastInformedPrimKeyVal&quot;</span> <span class="ow">in</span> <span class="n">sys_state</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_offer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>        <span class="k">if</span> <span class="s2">&quot;lastRequestSlot&quot;</span> <span class="ow">in</span> <span class="n">sys_state</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>        <span class="k">if</span> <span class="s2">&quot;last_act&quot;</span> <span class="ow">in</span> <span class="n">sys_state</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>    <span class="k">def</span> <span class="nf">_match_general_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a><span class="sd">        Finds general acts (e.g. Hello, Bye) in the user input</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a><span class="sd">            user_utterance {str} --  text input from user</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>        <span class="c1"># Iteration over all general acts</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>        <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_regex</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>            <span class="c1"># Check if the regular expression and the user utterance match</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">general_regex</span><span class="p">[</span><span class="n">act</span><span class="p">],</span> <span class="n">user_utterance</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>                <span class="c1"># Mapping the act to User Act</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>                <span class="k">if</span> <span class="n">act</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span> <span class="ow">and</span> <span class="n">act</span> <span class="o">!=</span> <span class="s1">&#39;req_everything&#39;</span><span class="p">:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>                    <span class="n">user_act_type</span> <span class="o">=</span> <span class="n">UserActionType</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>                    <span class="n">user_act_type</span> <span class="o">=</span> <span class="n">act</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>                <span class="c1"># Check if the found user act is affirm or deny</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user_act_type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Affirm</span> <span class="ow">or</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>                                                      <span class="n">user_act_type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Deny</span><span class="p">):</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>                    <span class="c1"># Conditions to check the history in order to assign affirm or deny</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>                    <span class="c1"># slots mentioned in the previous system act</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>                    <span class="c1"># Check if the preceeding system act was confirm</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Confirm</span><span class="p">:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>                        <span class="c1"># Iterate over all slots in the system confimation</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>                        <span class="c1"># and make a list of Affirm/Deny(slot=value)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>                        <span class="c1"># where value is taken from the previous sys act</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>                        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>                            <span class="c1"># New user act -- Affirm/Deny(slot=value)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>                            <span class="n">user_act</span> <span class="o">=</span> <span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="p">(</span><span class="n">act</span><span class="p">),</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>                                               <span class="n">text</span><span class="o">=</span><span class="n">user_utterance</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>                                               <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a>                                               <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_act</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>                    <span class="c1"># Check if the preceeding system act was request</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a>                    <span class="c1"># This covers the binary requests, e.g. &#39;Is the course related to Math?&#39;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>                        <span class="c1"># Iterate over all slots in the system request</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>                        <span class="c1"># and make a list of Inform(slot={True|False})</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>                        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>                            <span class="c1"># Assign value for the slot mapping from Affirm or Request to Logical,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>                            <span class="c1"># True if user affirms, False if user denies</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>                            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="n">user_act_type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Affirm</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>                            <span class="c1"># Adding user inform act</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">_add_inform</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>                    <span class="c1"># Check if Deny happens after System Request more, then trigger bye</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span> \
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>                            <span class="ow">and</span> <span class="n">user_act_type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Deny</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>                        <span class="n">user_act</span> <span class="o">=</span> <span class="n">UserAct</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Bye</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_act</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>                <span class="c1"># Check if Request or Select is the previous system act</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>                <span class="k">elif</span> <span class="n">user_act_type</span> <span class="o">==</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span> <span class="ow">or</span> \
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Select</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>                        <span class="c1"># Iteration over all slots mentioned in the last system act</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>                        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>                            <span class="c1"># Adding user inform act</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">_add_inform</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">user_act_type</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>                <span class="c1"># Check if the user wants to get all information about a particular entity</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>                <span class="k">elif</span> <span class="n">user_act_type</span> <span class="o">==</span> <span class="s1">&#39;req_everything&#39;</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">req_everything</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>                    <span class="c1"># This section covers all general user acts that do not depend on</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>                    <span class="c1"># the dialog history</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>                    <span class="c1"># New user act -- UserAct()</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>                    <span class="n">user_act</span> <span class="o">=</span> <span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">user_act_type</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">user_utterance</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_act</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>    <span class="k">def</span> <span class="nf">_match_domain_specific_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a><span class="sd">        Matches in-domain user acts</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a><span class="sd">        Calls functions to find user requests and informs</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a><span class="sd">            user_utterance {str} --  text input from user</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>        <span class="c1"># Find Requests</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_match_request</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">)</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>        <span class="c1"># Find Informs</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_match_inform</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>    <span class="k">def</span> <span class="nf">_match_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a><span class="sd">        Iterates over all user request regexes and find matches with the user utterance</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a><span class="sd">            user_utterance {str} --  text input from user</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>        <span class="c1"># Iteration over all user requestable slots</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">USER_REQUESTABLE</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_regex</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">user_utterance</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)):</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_add_request</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a>    <span class="k">def</span> <span class="nf">_add_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a><span class="sd">        Creates the user request act and adds it to the user act list</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a><span class="sd">            user_utterance {str} --  text input from user</span>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a><span class="sd">            slot {str} -- requested slot</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>        <span class="c1"># New user act -- Request(slot)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>        <span class="n">user_act</span> <span class="o">=</span> <span class="n">UserAct</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_act</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>        <span class="c1"># Storing user requested slots during the whole dialog</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slots_requested</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>    <span class="k">def</span> <span class="nf">_match_inform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a><span class="sd">        Iterates over all user inform slot-value regexes and find matches with the user utterance</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a><span class="sd">            user_utterance {str} --  text input from user</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>        <span class="c1"># Iteration over all user informable slots and their slots</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">USER_INFORMABLE</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inform_regex</span><span class="p">[</span><span class="n">slot</span><span class="p">]:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inform_regex</span><span class="p">[</span><span class="n">slot</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="n">user_utterance</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)):</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>                    <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_everything</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>                        <span class="c1"># Adding all requestable slots because of the req_everything</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>                        <span class="k">for</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">USER_REQUESTABLE</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>                            <span class="c1"># skipping the domain key slot</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>                            <span class="k">if</span> <span class="n">req_slot</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>                                <span class="c1"># Adding user request act</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">_add_request</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>                    <span class="c1"># Adding user inform act</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_inform</span><span class="p">(</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>    <span class="k">def</span> <span class="nf">_add_inform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a><span class="sd">        Creates the user request act and adds it to the user act list</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a><span class="sd">            user_utterance {str} --  text input from user</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a><span class="sd">            slot {str} -- informed slot</span>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a><span class="sd">            value {str} -- value for the informed slot</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>        <span class="n">user_act</span> <span class="o">=</span> <span class="n">UserAct</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">user_utterance</span><span class="p">,</span> <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>                           <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_act</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>        <span class="c1"># Storing user informed slots in this turn</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slots_informed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>    <span class="k">def</span> <span class="nf">_exact_match</span><span class="p">(</span><span class="n">phrases</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a><span class="sd">        Checks if the user utterance is exactly like one in the</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a><span class="sd">            phrases List[str] --  list of contextual don&#39;t cares</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a><span class="sd">            user_utterance {str} --  text input from user</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>        <span class="c1"># apostrophes are removed</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>        <span class="k">if</span> <span class="n">user_utterance</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">phrases</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>    <span class="k">def</span> <span class="nf">_match_affirm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>        <span class="sd">&quot;&quot;&quot;TO BE DEFINED AT A LATER POINT&quot;&quot;&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>        <span class="k">pass</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>    <span class="k">def</span> <span class="nf">_match_negative_inform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_utterance</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>        <span class="sd">&quot;&quot;&quot;TO BE DEFINED AT A LATER POINT&quot;&quot;&quot;</span>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>        <span class="k">pass</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="n">re_object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a><span class="sd">        Checks if the regular expression and the user utterance matched</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a><span class="sd">            re_object: output from re.search(...)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a><span class="sd">            True/False if match happened</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a>        <span class="k">if</span> <span class="n">re_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a>        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">re_object</span><span class="o">.</span><span class="n">groups</span><span class="p">():</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a>            <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>    <span class="k">def</span> <span class="nf">_assign_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a><span class="sd">        Goes over the user act list, checks concurrencies and assign scores</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="p">)):</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>            <span class="c1"># TODO: Create a clever and meaningful mechanism to assign scores</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>            <span class="c1"># Since the user acts are matched, they get 1.0 as score</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>    <span class="k">def</span> <span class="nf">_disambiguate_co_occurrence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>        <span class="c1"># Check if there is user inform and request occur simultaneously for a binary slot</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>        <span class="c1"># E.g. request(applied_nlp) &amp; inform(applied_nlp=true)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>        <span class="c1"># Difficult to disambiguate using regexes</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_requested</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots_informed</span><span class="p">):</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>            <span class="k">if</span> <span class="n">beliefstate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>                <span class="n">act_to_del</span> <span class="o">=</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;**NONE**&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>                <span class="n">act_to_del</span> <span class="o">=</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a>                <span class="n">act_to_del</span> <span class="o">=</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>            <span class="n">acts_to_del</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slots_requested</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slots_informed</span><span class="p">):</span>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_act</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="p">):</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a>                    <span class="k">if</span> <span class="n">user_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">act_to_del</span> <span class="ow">and</span> <span class="n">user_act</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a>                        <span class="n">acts_to_del</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_act</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_act</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>                              <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acts_to_del</span><span class="p">]</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a>    <span class="k">def</span> <span class="nf">_solve_informable_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>        <span class="c1"># Verify if two or more informable slots with the same value were caught</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a>        <span class="c1"># Cases:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>        <span class="c1"># If a system request precedes and the slot is the on of the two informable, keep that one.</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a>        <span class="c1"># If there is no preceding request, take</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>        <span class="n">informed_values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_act</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span><span class="p">):</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>            <span class="k">if</span> <span class="n">user_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">:</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a>                <span class="k">if</span> <span class="n">user_act</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;true&quot;</span> <span class="ow">and</span> <span class="n">user_act</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>                    <span class="k">if</span> <span class="n">user_act</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">informed_values</span><span class="p">:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a>                        <span class="n">informed_values</span><span class="p">[</span><span class="n">user_act</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">user_act</span><span class="o">.</span><span class="n">slot</span><span class="p">)]</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a>                        <span class="n">informed_values</span><span class="p">[</span><span class="n">user_act</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">user_act</span><span class="o">.</span><span class="n">slot</span><span class="p">))</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a>        <span class="n">informed_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span> <span class="n">informed_values</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">informed_values</span> <span class="k">if</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>                           <span class="nb">len</span><span class="p">(</span><span class="n">informed_values</span><span class="p">[</span><span class="n">value</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a>        <span class="k">if</span> <span class="s2">&quot;6&quot;</span> <span class="ow">in</span> <span class="n">informed_values</span><span class="p">:</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a><span class="sd">            Loads the correct regex files based on which language has been selected</span>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a><span class="sd">            this should only be called on the first turn of the dialog</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a><span class="sd">                language (Language): Enum representing the language the user has selected</span>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span><span class="p">:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a>            <span class="c1"># Loading regular expression from JSON files</span>
<a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a>            <span class="c1"># as dictionaries {act:regex, ...} or {slot:{value:regex, ...}, ...}</span>
<a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">general_regex</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s1">&#39;/GeneralRules.json&#39;</span><span class="p">))</span>
<a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_regex</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_name</span>
<a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a>                                                <span class="o">+</span> <span class="s1">&#39;RequestRules.json&#39;</span><span class="p">))</span>
<a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inform_regex</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_name</span>
<a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a>                                               <span class="o">+</span> <span class="s1">&#39;InformRules.json&#39;</span><span class="p">))</span>
<a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="n">Language</span><span class="o">.</span><span class="n">GERMAN</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a>            <span class="c1"># TODO: Change this once</span>
<a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a>            <span class="c1"># Loading regular expression from JSON files</span>
<a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a>            <span class="c1"># as dictionaries {act:regex, ...} or {slot:{value:regex, ...}, ...}</span>
<a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">general_regex</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s1">&#39;/GeneralRulesGerman.json&#39;</span><span class="p">))</span>
<a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_regex</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_name</span>
<a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a>                                                <span class="o">+</span> <span class="s1">&#39;GermanRequestRules.json&#39;</span><span class="p">))</span>
<a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inform_regex</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_name</span>
<a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a>                                               <span class="o">+</span> <span class="s1">&#39;GermanInformRules.json&#39;</span><span class="p">))</span>
<a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No language&#39;</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlu.nlu.HandcraftedNLU.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.nlu.nlu.HandcraftedNLU.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Loads
    - domain key
    - informable slots
    - requestable slots
    - domain-independent regular expressions
    - domain-specific regualer espressions</p>
<p>It sets the previous system act to None</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/nlu/nlu.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">language</span><span class="p">:</span> <span class="n">Language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Loads</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        - domain key</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        - informable slots</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        - requestable slots</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        - domain-independent regular expressions</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        - domain-specific regualer espressions</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    It sets the previous system act to None</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        domain {domain.jsonlookupdomain.JSONLookupDomain} -- Domain</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">language</span> <span class="k">if</span> <span class="n">language</span> <span class="k">else</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="c1"># Getting domain information</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain_name</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="c1"># Getting lists of informable and requestable slots</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">USER_INFORMABLE</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">()</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">USER_REQUESTABLE</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">()</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="c1"># Getting the relative path where regexes are stored</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">base_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_root_dir</span><span class="p">(),</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;nlu_regexes&#39;</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="c1"># Setting previous system act to None to signal the first turn</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="c1"># self.prev_sys_act = None</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="s1">&#39;last_act&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">Language</span><span class="o">.</span><span class="n">ENGLISH</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlu.nlu.HandcraftedNLU.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.nlu.nlu.HandcraftedNLU.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Sets the previous system act as None.
This function is called when the dialog starts</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>Empty dictionary</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/nlu/nlu.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Sets the previous system act as None.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    This function is called when the dialog starts</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        Empty dictionary</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sys_act_info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="s1">&#39;last_act&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">user_acts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">slots_informed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">slots_requested</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">req_everything</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.nlu.nlu.HandcraftedNLU.extract_user_acts" class="doc doc-heading">
<code class="highlight language-python"><span class="n">extract_user_acts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.nlu.nlu.HandcraftedNLU.extract_user_acts" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlu/nlu.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h4 id="adviser.services.nlu.nlu.get_root_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_root_dir</span><span class="p">()</span></code>


<a href="#adviser.services.nlu.nlu.get_root_dir" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/nlu/nlu.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_root_dir</span><span class="p">():</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.policy" class="doc doc-heading">
        <code>policy</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.policy.affective_policy" class="doc doc-heading">
        <code>affective_policy</code>



<a href="#adviser.services.policy.affective_policy" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.policy.affective_policy.EmotionPolicy" class="doc doc-heading">
        <code>
EmotionPolicy            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.policy.affective_policy.EmotionPolicy" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Module for deciding what type of emotional response/ engagement level of response, the system
should give</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/affective_policy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">EmotionPolicy</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Module for deciding what type of emotional response/ engagement level of response, the system</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        should give</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        Initializes the policy</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        Arguments:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">            domain (JSONLookupDomain): the domain that the affective policy should operate in</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">pass</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;userstate&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_emotion&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_engagement&quot;</span><span class="p">])</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">def</span> <span class="nf">choose_sys_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userstate</span><span class="p">:</span> <span class="n">UserState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>\
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">            This method maps observed user emotion and user engagement to the system&#39;s choices</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">            for output emotion/engagement</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">                userstate (UserState): a UserState obejct representing current system</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">                                       knowledge of the user&#39;s emotional state and engagement</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">                (dict): a dictionary with the keys &quot;sys_emotion&quot; and &quot;sys_engagement&quot; and the</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">                        corresponding values</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sys_emotion&quot;</span><span class="p">:</span> <span class="n">userstate</span><span class="p">[</span><span class="s2">&quot;emotion&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                <span class="s2">&quot;sys_engagement&quot;</span><span class="p">:</span> <span class="n">userstate</span><span class="p">[</span><span class="s2">&quot;engagement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.affective_policy.EmotionPolicy.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.affective_policy.EmotionPolicy.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Initializes the policy</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>JSONLookupDomain</code></td>
        <td><p>the domain that the affective policy should operate in</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/affective_policy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Initializes the policy</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Arguments:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        domain (JSONLookupDomain): the domain that the affective policy should operate in</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.affective_policy.EmotionPolicy.choose_sys_emotion" class="doc doc-heading">
<code class="highlight language-python"><span class="n">choose_sys_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.policy.affective_policy.EmotionPolicy.choose_sys_emotion" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/affective_policy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.affective_policy.EmotionPolicy.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.affective_policy.EmotionPolicy.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>This function is called before the first message to a new dialog is published.
You should overwrite this function to set/reset dialog-level variables. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/affective_policy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.policy.policy_api" class="doc doc-heading">
        <code>policy_api</code>



<a href="#adviser.services.policy.policy_api" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.policy.policy_api.HandcraftedPolicy" class="doc doc-heading">
        <code>
HandcraftedPolicy            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.policy.policy_api.HandcraftedPolicy" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Handcrafted policy for API domains</p>
<p>Differs from the default HandcraftedPolicy class by taking into account mandatory slots,
i.e. slots which have to be informed about before an API can even be called.
The class is currently a copy of an older version of the HandcraftedPolicy class with the
required changes for API usage.
The classes will probably be merged in the future.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_api.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedPolicy</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Handcrafted policy for API domains</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Differs from the default HandcraftedPolicy class by taking into account mandatory slots,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    i.e. slots which have to be informed about before an API can even be called.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    The class is currently a copy of an older version of the HandcraftedPolicy class with the</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    required changes for API usage.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    The classes will probably be merged in the future.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">LookupDomain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        Initializes the policy</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        Arguments:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">            domain {domain.lookupdomain.LookupDomain} -- Domain</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;beliefstate&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">])</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="k">def</span> <span class="nf">choose_sys_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>\
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sys_act</span><span class="o">=</span><span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">            Responsible for walking the policy through a single turn. Uses the current user</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">            action and system belief state to determine what the next system action should be.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">            To implement an alternate policy, this method may need to be overwritten</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">                belief_state (BeliefState): a BeliefState object representing current system</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">                                           knowledge</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">                user_acts (list): a list of UserAct objects mapped from the user&#39;s last utterance</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">                sys_act (SysAct): this should be None</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">                (dict): a dictionary with the key &quot;sys_act&quot; and the value that of the systems next</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="sd">                        action</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="c1"># variables for general (non-domain specific) actions</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="c1"># self.turn = dialog_graph.num_turns</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prev_sys_act</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_gen_actions</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="n">sys_state</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="c1"># do nothing on the first turn --LV</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Welcome</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">}</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bad</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="c1"># if the action is &#39;bye&#39; tell system to end dialog</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bye</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="c1"># if user only says thanks, ask if they want anything else</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Thanks</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="c1"># If user only says hello, request a random slot to move dialog along</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">SelectDomain</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_open_slot</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>            <span class="c1"># prepare sys_state info</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="c1"># If we switch to the domain, start a new dialog</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="k">if</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">SelectDomain</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dialog_start</span><span class="p">()</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="c1"># handle domain specific actions</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>            <span class="n">sys_act</span><span class="p">,</span> <span class="n">sys_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_action</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;System Action: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="p">))</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>        <span class="k">if</span> <span class="s1">&#39;last_act&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_state</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>            <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">,</span> <span class="s1">&#39;sys_state&#39;</span><span class="p">:</span> <span class="n">sys_state</span><span class="p">}</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>    <span class="k">def</span> <span class="nf">_remove_gen_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a><span class="sd">            Helper function to read through user action list and if necessary</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a><span class="sd">            delete filler actions (eg. Hello, thanks) when there are other non-filler</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a><span class="sd">            (eg. Inform, Request) actions from the user. Stores list of relevant actions</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a><span class="sd">            as a class variable</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a><span class="sd">                user_acts (list): a list of UserAct objects</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>        <span class="n">act_types_lst</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>        <span class="c1"># These are filler actions, so if there are other non-filler acions, remove them from</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>        <span class="c1"># the list of action types</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">act_types_lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>            <span class="k">if</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Thanks</span> <span class="ow">in</span> <span class="n">act_types_lst</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>                <span class="n">act_types_lst</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Thanks</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>            <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span> <span class="ow">in</span> <span class="n">act_types_lst</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>                <span class="n">act_types_lst</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>            <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span> <span class="ow">in</span> <span class="n">act_types_lst</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>                <span class="n">act_types_lst</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>                <span class="k">break</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>    <span class="k">def</span> <span class="nf">_query_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>        <span class="sd">&quot;&quot;&quot;Based on the constraints specified, uses self.domain to generate the appropriate type</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a><span class="sd">           of query for the database</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a><span class="sd">            iterable: representing the results of the database lookup</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>        <span class="c1"># determine if an entity has already been suggested or was mentioned by the user</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>        <span class="c1"># if yes and the user is asking for info about a specific entity, generate a query to get</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>        <span class="c1"># that info for the slots they have specified</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>            <span class="n">requested_slots</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">requested_slots</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>        <span class="c1"># otherwise, issue a query to find all entities which satisfy the constraints the user</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>        <span class="c1"># has given so far</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>            <span class="n">constraints</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>    <span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>        <span class="sd">&quot;&quot;&quot;Finds if an entity has been suggested by the system (in the form of an offer candidate)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a><span class="sd">           or by the user (in the form of an InformByName act). If so returns the identifier for</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a><span class="sd">           it, otherwise returns None</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a><span class="sd">            belief_state (dict): dictionary tracking the current system beliefs</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a><span class="sd">        Return:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a><span class="sd">            (str): Returns a string representing the current entity name</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a><span class="sd">        -LV</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>        <span class="n">prim_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>        <span class="k">if</span> <span class="n">prim_key</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>            <span class="n">possible_names</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">prim_key</span><span class="p">]</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>            <span class="n">name</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">possible_names</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>        <span class="c1"># if the user is trying to query by name</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">):</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>                <span class="n">current_suggestion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s_index</span><span class="p">]</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>                <span class="k">if</span> <span class="n">current_suggestion</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>                    <span class="n">name</span> <span class="o">=</span> <span class="n">current_suggestion</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>        <span class="k">return</span> <span class="n">name</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>    <span class="k">def</span> <span class="nf">_get_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>        <span class="sd">&quot;&quot;&quot;Reads the belief state and extracts any user specified constraints and any constraints</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a><span class="sd">           the user indicated they don&#39;t care about, so the system knows not to ask about them</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a><span class="sd">            belief_state (dict): dictionary tracking the current system beliefs</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a><span class="sd">        Return:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a><span class="sd">            (tuple): dict of user requested slot names and their values and list of slots the user</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a><span class="sd">                     doesn&#39;t care about</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>        <span class="c1"># parts of the belief state which don&#39;t contain constraints</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>        <span class="n">dontcare</span> <span class="o">=</span> <span class="p">[</span><span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;dontcare&quot;</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;informs&quot;</span><span class="p">][</span><span class="n">slot</span><span class="p">]]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>        <span class="n">informs</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;informs&quot;</span><span class="p">]</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">informs</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dontcare</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">informs</span><span class="p">[</span><span class="n">slot</span><span class="p">]:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>                    <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>        <span class="k">return</span> <span class="n">slots</span><span class="p">,</span> <span class="n">dontcare</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>    <span class="k">def</span> <span class="nf">_mandatory_requests_fulfilled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>        <span class="sd">&quot;&quot;&quot;whether or not all mandatory slots have a value</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a><span class="sd">        Arguments:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a><span class="sd">            beliefstate (BeliefState): dictionary tracking the current system beliefs</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>        <span class="n">filled_slots</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>        <span class="n">mandatory_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_mandatory_slots</span><span class="p">()</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">mandatory_slots</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filled_slots</span><span class="p">:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>    <span class="k">def</span> <span class="nf">_get_open_mandatory_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a><span class="sd">            belief_state (dict): dictionary tracking the current system beliefs</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a><span class="sd">            (str): a string representing a category the system might want more info on. If all</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a><span class="sd">            system requestables have been filled, return none</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>        <span class="n">filled_slots</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>        <span class="n">mandatory_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_mandatory_slots</span><span class="p">()</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">mandatory_slots</span><span class="p">:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filled_slots</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>                <span class="k">return</span> <span class="n">slot</span>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>    <span class="k">def</span> <span class="nf">_get_open_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>        <span class="sd">&quot;&quot;&quot;For a hello statement we need to be able to figure out what slots the user has not yet</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a><span class="sd">           specified constraint for, this method returns one of those at random</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a><span class="sd">            belief_state (dict): dictionary tracking the current system beliefs</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a><span class="sd">            (str): a string representing a category the system might want more info on. If all</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a><span class="sd">            system requestables have been filled, return none</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a>        <span class="n">filled_slots</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>        <span class="n">requestable_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">()</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">requestable_slots</span><span class="p">:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filled_slots</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>                <span class="k">return</span> <span class="n">slot</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>    <span class="k">def</span> <span class="nf">_next_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>        <span class="sd">&quot;&quot;&quot;Determines the next system action based on the current belief state and</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a><span class="sd">           previous action.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a><span class="sd">           When implementing a new type of policy, this method MUST be rewritten</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a><span class="sd">            belief_state (HandCraftedBeliefState): system values on liklihood</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a><span class="sd">            of each possible state</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a><span class="sd">        Return:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a><span class="sd">            (SysAct): the next system action</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>        <span class="n">sys_state</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>        <span class="c1"># Assuming this happens only because domain is not actually active --LV</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>        <span class="sd">&quot;&quot;&quot;if UserActionType.Bad in beliefstate[&#39;user_acts&#39;] or beliefstate[&#39;requests&#39;] \</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a><span class="sd">                and not self._get_name(beliefstate):</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a><span class="sd">            sys_act = SysAct()</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a><span class="sd">            sys_act.type = SysActionType.Bad</span>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a><span class="sd">            return sys_act, {&#39;last_action&#39;: sys_act}&quot;&quot;&quot;</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mandatory_requests_fulfilled</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">):</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_open_mandatory_slot</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">):</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>            <span class="k">return</span> <span class="n">sys_act</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;last_action&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">}</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">RequestAlternatives</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]</span> \
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bad</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>            <span class="k">return</span> <span class="n">sys_act</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;last_action&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">}</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]</span> \
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">))</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>            <span class="k">return</span> <span class="n">sys_act</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;last_action&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">}</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>        <span class="c1"># Otherwise we need to query the db to determine next action</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_db</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>        <span class="n">sys_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_action</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>        <span class="c1"># requests are fairly easy, if it&#39;s a request, return it directly</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>        <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>                <span class="c1"># update the belief state to reflec the slot we just asked about</span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>                <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>                <span class="c1"># belief_state[&#39;system&#39;][&#39;lastRequestSlot&#39;] = list(sys_act.slot_values.keys())[0]</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>        <span class="c1"># otherwise we need to convert a raw inform into a one with proper slots and values</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>        <span class="k">elif</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span><span class="p">:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>            <span class="c1"># update belief state to reflect the offer we just made</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">())</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>                <span class="c1"># belief_state[&#39;system&#39;][&#39;lastInformedPrimKeyVal&#39;] = values[0]</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>                <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">(),</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>        <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">sys_act</span><span class="p">,</span> <span class="n">sys_state</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>    <span class="k">def</span> <span class="nf">_raw_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_res</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SysAct</span><span class="p">:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>        <span class="sd">&quot;&quot;&quot;Based on the output of the db query and the method, choose</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a><span class="sd">           whether next action should be request or inform</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a><span class="sd">            q_res (list): rows (list of dicts) returned by the issued sqlite3</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a><span class="sd">            query</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a><span class="sd">            method (str): the type of user action</span>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a><span class="sd">                     (&#39;byprimarykey&#39;, &#39;byconstraints&#39;, &#39;byalternatives&#39;)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a><span class="sd">            (SysAct): SysAct object of appropriate type</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>        <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>        <span class="c1"># if there is more than one result</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>            <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>            <span class="c1"># Gather all the results for each column</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>            <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>            <span class="c1"># If any column has multiple values, ask for clarification</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">q_res</span><span class="p">:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>                        <span class="n">temp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>            <span class="n">next_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_next_request</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>            <span class="k">if</span> <span class="n">next_req</span><span class="p">:</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">next_req</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>                <span class="k">return</span> <span class="n">sys_act</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a>        <span class="c1"># Otherwise action type will be inform, so return an empty inform (to be filled in later)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>        <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a>        <span class="k">return</span> <span class="n">sys_act</span>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a>    <span class="k">def</span> <span class="nf">_gen_next_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a><span class="sd">            Calculates which slot to request next based asking for non-binary slotes first and then</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a><span class="sd">            based on which binary slots provide the biggest reduction in the size of db results</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a><span class="sd">            NOTE: If the dataset is large, this is probably not a great idea to calculate each turn</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a><span class="sd">                  it&#39;s relatively simple, but could add up over time</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a><span class="sd">                temp (Dict[str, List[str]]: a dictionary with the keys and values for each result</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a><span class="sd">                                            in the result set</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a><span class="sd">            Returns: (str) representing the slot to ask for next (or empty if none)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a>        <span class="n">req_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">()</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>        <span class="c1"># don&#39;t other to cacluate statistics for things which have been specified</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>        <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>        <span class="c1"># split out binary slots so we can ask about them second</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>        <span class="n">req_slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">req_slots</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dontcare</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">]</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>        <span class="n">bin_slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">req_slots</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>        <span class="n">non_bin_slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">req_slots</span> <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bin_slots</span><span class="p">]</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>        <span class="c1"># check if there are any differences in values for non-binary slots,</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>        <span class="c1"># if a slot has multiple values, ask about that slot</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">non_bin_slots</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">slot</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>                <span class="k">return</span> <span class="n">slot</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>        <span class="c1"># Otherwise look to see if there are differnces in binary slots</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highest_info_gain</span><span class="p">(</span><span class="n">bin_slots</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>    <span class="k">def</span> <span class="nf">_highest_info_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_slots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">temp</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a>        <span class="sd">&quot;&quot;&quot; Since we don&#39;t have lables, we can&#39;t properlly calculate entropy, so instead we&#39;ll go</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a><span class="sd">            for trying to ask after a feature that splits the results in half as evenly as possible</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a><span class="sd">            (that way we gain most info regardless of which way the user chooses)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a><span class="sd">                bin_slots: a list of strings representing system requestable binary slots which</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a><span class="sd">                           have not yet been specified</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a><span class="sd">                temp (Dict[str, List[str]]: a dictionary with the keys and values for each result</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a><span class="sd">                                            in the result set</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a><span class="sd">            Returns: (str) representing the slot to ask for next (or empty if none)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>        <span class="n">diffs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">bin_slots</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>            <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a>            <span class="n">values_dic</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[</span><span class="n">slot</span><span class="p">]:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a>                <span class="n">values_dic</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>            <span class="k">if</span> <span class="n">val1</span> <span class="ow">in</span> <span class="n">values_dic</span> <span class="ow">and</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">values_dic</span><span class="p">:</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a>                <span class="n">diffs</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">values_dic</span><span class="p">[</span><span class="n">val1</span><span class="p">]</span> <span class="o">-</span> <span class="n">values_dic</span><span class="p">[</span><span class="n">val2</span><span class="p">])</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>            <span class="c1"># If all slots have the same value, we don&#39;t need to request anything, return none</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">diffs</span><span class="p">:</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a>        <span class="n">sorted_diffs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">diffs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>        <span class="k">return</span> <span class="n">sorted_diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>    <span class="k">def</span> <span class="nf">_convert_inform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_results</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a>                        <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>        <span class="sd">&quot;&quot;&quot;Fills in the slots and values for a raw inform so it can be returned as the</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a><span class="sd">           next system action.</span>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a><span class="sd">            method (str): the type of user action</span>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a><span class="sd">                     (&#39;byprimarykey&#39;, &#39;byconstraints&#39;, &#39;byalternatives&#39;)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a><span class="sd">            q_results (list): Results of SQL database query</span>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a><span class="sd">            sys_act (SysAct): the act to be modified</span>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a><span class="sd">            belief_state(dict): contains info on what columns were queried</span>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a>        <span class="sd">&quot;&quot;&quot;beliefstate[&quot;requests&quot;] or &quot;&quot;&quot;</span>
<a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform_by_primkey</span><span class="p">(</span><span class="n">q_results</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">RequestAlternatives</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform_by_alternatives</span><span class="p">(</span><span class="n">sys_act</span><span class="p">,</span> <span class="n">q_results</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform_by_constraints</span><span class="p">(</span><span class="n">q_results</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a>    <span class="k">def</span> <span class="nf">_convert_inform_by_primkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_results</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a>                                   <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a><span class="sd">            Helper function that adds the values for slots to a SysAct object when the system</span>
<a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a><span class="sd">            is answering a request for information about an entity from the user</span>
<a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a>
<a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-437" name="__codelineno-0-437" href="#__codelineno-0-437"></a><span class="sd">                q_results (iterable): list of query results from the database</span>
<a id="__codelineno-0-438" name="__codelineno-0-438" href="#__codelineno-0-438"></a><span class="sd">                sys_act (SysAct): current raw sys_act to be filled in</span>
<a id="__codelineno-0-439" name="__codelineno-0-439" href="#__codelineno-0-439"></a><span class="sd">                belief_state (BeliefState)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440" href="#__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441" href="#__codelineno-0-441"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442" href="#__codelineno-0-442"></a>        <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-443" name="__codelineno-0-443" href="#__codelineno-0-443"></a>        <span class="k">if</span> <span class="n">q_results</span><span class="p">:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444" href="#__codelineno-0-444"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">q_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># currently return just the first result</span>
<a id="__codelineno-0-445" name="__codelineno-0-445" href="#__codelineno-0-445"></a>            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># should represent all user specified constraints</span>
<a id="__codelineno-0-446" name="__codelineno-0-446" href="#__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447" href="#__codelineno-0-447"></a>            <span class="c1"># add slots + values (where available) to the sys_act</span>
<a id="__codelineno-0-448" name="__codelineno-0-448" href="#__codelineno-0-448"></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449" href="#__codelineno-0-449"></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;not available&#39;</span>
<a id="__codelineno-0-450" name="__codelineno-0-450" href="#__codelineno-0-450"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451" href="#__codelineno-0-451"></a>            <span class="c1"># Name might not be a constraint in request queries, so add it</span>
<a id="__codelineno-0-452" name="__codelineno-0-452" href="#__codelineno-0-452"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-453" name="__codelineno-0-453" href="#__codelineno-0-453"></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454" href="#__codelineno-0-454"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-455" name="__codelineno-0-455" href="#__codelineno-0-455"></a>            <span class="c1"># Add default Inform slots</span>
<a id="__codelineno-0-456" name="__codelineno-0-456" href="#__codelineno-0-456"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_default_inform_slots</span><span class="p">():</span>
<a id="__codelineno-0-457" name="__codelineno-0-457" href="#__codelineno-0-457"></a>                <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458" href="#__codelineno-0-458"></a>                    <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
<a id="__codelineno-0-459" name="__codelineno-0-459" href="#__codelineno-0-459"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-460" name="__codelineno-0-460" href="#__codelineno-0-460"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461" href="#__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462" href="#__codelineno-0-462"></a>    <span class="k">def</span> <span class="nf">_convert_inform_by_alternatives</span><span class="p">(</span>
<a id="__codelineno-0-463" name="__codelineno-0-463" href="#__codelineno-0-463"></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">q_res</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-464" name="__codelineno-0-464" href="#__codelineno-0-464"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-465" name="__codelineno-0-465" href="#__codelineno-0-465"></a><span class="sd">            Helper Function, scrolls through the list of alternative entities which match the</span>
<a id="__codelineno-0-466" name="__codelineno-0-466" href="#__codelineno-0-466"></a><span class="sd">            user&#39;s specified constraints and uses the next item in the list to fill in the raw</span>
<a id="__codelineno-0-467" name="__codelineno-0-467" href="#__codelineno-0-467"></a><span class="sd">            inform act.</span>
<a id="__codelineno-0-468" name="__codelineno-0-468" href="#__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469" href="#__codelineno-0-469"></a><span class="sd">            When the end of the list is reached, currently continues to give last item in the list</span>
<a id="__codelineno-0-470" name="__codelineno-0-470" href="#__codelineno-0-470"></a><span class="sd">            as a suggestion</span>
<a id="__codelineno-0-471" name="__codelineno-0-471" href="#__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472" href="#__codelineno-0-472"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473" href="#__codelineno-0-473"></a><span class="sd">                sys_act (SysAct): the raw inform to be filled in</span>
<a id="__codelineno-0-474" name="__codelineno-0-474" href="#__codelineno-0-474"></a><span class="sd">                belief_state (BeliefState): current system belief state ()</span>
<a id="__codelineno-0-475" name="__codelineno-0-475" href="#__codelineno-0-475"></a>
<a id="__codelineno-0-476" name="__codelineno-0-476" href="#__codelineno-0-476"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-477" name="__codelineno-0-477" href="#__codelineno-0-477"></a>        <span class="k">if</span> <span class="n">q_res</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478" href="#__codelineno-0-478"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-479" name="__codelineno-0-479" href="#__codelineno-0-479"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-480" name="__codelineno-0-480" href="#__codelineno-0-480"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">q_res</span><span class="p">:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481" href="#__codelineno-0-481"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-482" name="__codelineno-0-482" href="#__codelineno-0-482"></a>
<a id="__codelineno-0-483" name="__codelineno-0-483" href="#__codelineno-0-483"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-484" name="__codelineno-0-484" href="#__codelineno-0-484"></a>        <span class="c1"># here we should scroll through possible offers presenting one each turn the user asks</span>
<a id="__codelineno-0-485" name="__codelineno-0-485" href="#__codelineno-0-485"></a>        <span class="c1"># for alternatives</span>
<a id="__codelineno-0-486" name="__codelineno-0-486" href="#__codelineno-0-486"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487" href="#__codelineno-0-487"></a>            <span class="c1"># the first time we inform, we should inform by name, so we use the right template</span>
<a id="__codelineno-0-488" name="__codelineno-0-488" href="#__codelineno-0-488"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-489" name="__codelineno-0-489" href="#__codelineno-0-489"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-490" name="__codelineno-0-490" href="#__codelineno-0-490"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491" href="#__codelineno-0-491"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span>
<a id="__codelineno-0-492" name="__codelineno-0-492" href="#__codelineno-0-492"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s_index</span><span class="p">]</span>
<a id="__codelineno-0-493" name="__codelineno-0-493" href="#__codelineno-0-493"></a>            <span class="c1"># Inform by alternatives according to our current templates is</span>
<a id="__codelineno-0-494" name="__codelineno-0-494" href="#__codelineno-0-494"></a>            <span class="c1"># just a normal inform apparently --LV</span>
<a id="__codelineno-0-495" name="__codelineno-0-495" href="#__codelineno-0-495"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">])</span>
<a id="__codelineno-0-496" name="__codelineno-0-496" href="#__codelineno-0-496"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497" href="#__codelineno-0-497"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span>
<a id="__codelineno-0-498" name="__codelineno-0-498" href="#__codelineno-0-498"></a>            <span class="c1"># default to last suggestion in the list</span>
<a id="__codelineno-0-499" name="__codelineno-0-499" href="#__codelineno-0-499"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-500" name="__codelineno-0-500" href="#__codelineno-0-500"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">(),</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501" href="#__codelineno-0-501"></a>
<a id="__codelineno-0-502" name="__codelineno-0-502" href="#__codelineno-0-502"></a>        <span class="c1"># in addition to the name, add the constraints the user has specified, so they know the</span>
<a id="__codelineno-0-503" name="__codelineno-0-503" href="#__codelineno-0-503"></a>        <span class="c1"># offer is relevant to them</span>
<a id="__codelineno-0-504" name="__codelineno-0-504" href="#__codelineno-0-504"></a>        <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-505" name="__codelineno-0-505" href="#__codelineno-0-505"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506" href="#__codelineno-0-506"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">constraints</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
<a id="__codelineno-0-507" name="__codelineno-0-507" href="#__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508" href="#__codelineno-0-508"></a>    <span class="k">def</span> <span class="nf">_convert_inform_by_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_results</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509" href="#__codelineno-0-509"></a>                                       <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-510" name="__codelineno-0-510" href="#__codelineno-0-510"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-511" name="__codelineno-0-511" href="#__codelineno-0-511"></a><span class="sd">            Helper function for filling in slots and values of a raw inform act when the system is</span>
<a id="__codelineno-0-512" name="__codelineno-0-512" href="#__codelineno-0-512"></a><span class="sd">            ready to make the user an offer</span>
<a id="__codelineno-0-513" name="__codelineno-0-513" href="#__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514" href="#__codelineno-0-514"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515" href="#__codelineno-0-515"></a><span class="sd">                q_results (iter): the results from the databse query</span>
<a id="__codelineno-0-516" name="__codelineno-0-516" href="#__codelineno-0-516"></a><span class="sd">                sys_act (SysAct): the raw infor act to be filled in</span>
<a id="__codelineno-0-517" name="__codelineno-0-517" href="#__codelineno-0-517"></a><span class="sd">                belief_state (BeliefState): the current system beliefs</span>
<a id="__codelineno-0-518" name="__codelineno-0-518" href="#__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519" href="#__codelineno-0-519"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-520" name="__codelineno-0-520" href="#__codelineno-0-520"></a>        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">q_results</span><span class="p">):</span>
<a id="__codelineno-0-521" name="__codelineno-0-521" href="#__codelineno-0-521"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-522" name="__codelineno-0-522" href="#__codelineno-0-522"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-523" name="__codelineno-0-523" href="#__codelineno-0-523"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">q_results</span><span class="p">:</span>
<a id="__codelineno-0-524" name="__codelineno-0-524" href="#__codelineno-0-524"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525" href="#__codelineno-0-525"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-526" name="__codelineno-0-526" href="#__codelineno-0-526"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">])</span>
<a id="__codelineno-0-527" name="__codelineno-0-527" href="#__codelineno-0-527"></a>            <span class="c1"># Add default Inform slots</span>
<a id="__codelineno-0-528" name="__codelineno-0-528" href="#__codelineno-0-528"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_default_inform_slots</span><span class="p">():</span>
<a id="__codelineno-0-529" name="__codelineno-0-529" href="#__codelineno-0-529"></a>                <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-530" name="__codelineno-0-530" href="#__codelineno-0-530"></a>                    <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
<a id="__codelineno-0-531" name="__codelineno-0-531" href="#__codelineno-0-531"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-532" name="__codelineno-0-532" href="#__codelineno-0-532"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533" href="#__codelineno-0-533"></a>
<a id="__codelineno-0-534" name="__codelineno-0-534" href="#__codelineno-0-534"></a>        <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-535" name="__codelineno-0-535" href="#__codelineno-0-535"></a>        <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-536" name="__codelineno-0-536" href="#__codelineno-0-536"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537" href="#__codelineno-0-537"></a>            <span class="c1"># Using constraints here rather than results to deal with empty</span>
<a id="__codelineno-0-538" name="__codelineno-0-538" href="#__codelineno-0-538"></a>            <span class="c1"># results sets (eg. user requests something impossible) --LV</span>
<a id="__codelineno-0-539" name="__codelineno-0-539" href="#__codelineno-0-539"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">constraints</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
<a id="__codelineno-0-540" name="__codelineno-0-540" href="#__codelineno-0-540"></a>
<a id="__codelineno-0-541" name="__codelineno-0-541" href="#__codelineno-0-541"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">:</span>
<a id="__codelineno-0-542" name="__codelineno-0-542" href="#__codelineno-0-542"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">belief_state</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-543" name="__codelineno-0-543" href="#__codelineno-0-543"></a>                <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-544" name="__codelineno-0-544" href="#__codelineno-0-544"></a>                    <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">slot</span><span class="p">])</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.policy_api.HandcraftedPolicy.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.policy_api.HandcraftedPolicy.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Initializes the policy</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_api.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">LookupDomain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Initializes the policy</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Arguments:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        domain {domain.lookupdomain.LookupDomain} -- Domain</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.policy_api.HandcraftedPolicy.choose_sys_act" class="doc doc-heading">
<code class="highlight language-python"><span class="n">choose_sys_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.policy.policy_api.HandcraftedPolicy.choose_sys_act" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_api.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.policy_api.HandcraftedPolicy.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.policy_api.HandcraftedPolicy.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>This function is called before the first message to a new dialog is published.
You should overwrite this function to set/reset dialog-level variables. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_api.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.policy.policy_handcrafted" class="doc doc-heading">
        <code>policy_handcrafted</code>



<a href="#adviser.services.policy.policy_handcrafted" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.policy.policy_handcrafted.HandcraftedPolicy" class="doc doc-heading">
        <code>
HandcraftedPolicy            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Base class for handcrafted policies.</p>
<p>Provides a simple rule-based policy. Can be used for any domain where a user is
trying to find an entity (eg. a course from a module handbook) from a database
by providing constraints (eg. semester the course is offered) or where a user is
trying to find out additional information about a named entity.</p>
<p>Output is a system action such as:
 * <code>inform</code>: provides information on an entity
 * <code>request</code>: request more information from the user
 * <code>bye</code>: issue parting message and end dialog</p>
<p>In order to create your own policy, you can inherit from this class.
Make sure to overwrite the <code>choose_sys_act</code>-method with whatever additionally
rules/functionality required.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_handcrafted.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedPolicy</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Base class for handcrafted policies.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Provides a simple rule-based policy. Can be used for any domain where a user is</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    trying to find an entity (eg. a course from a module handbook) from a database</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    by providing constraints (eg. semester the course is offered) or where a user is</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    trying to find out additional information about a named entity.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Output is a system action such as:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">     * `inform`: provides information on an entity</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">     * `request`: request more information from the user</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">     * `bye`: issue parting message and end dialog</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">    In order to create your own policy, you can inherit from this class.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    Make sure to overwrite the `choose_sys_act`-method with whatever additionally</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    rules/functionality required.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                 <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">        Initializes the policy</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        Arguments:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">            domain {domain.jsonlookupdomain.JSONLookupDomain} -- Domain</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_turns</span> <span class="o">=</span> <span class="n">max_turns</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">            resets the policy after each dialog</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;beliefstate&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">])</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="k">def</span> <span class="nf">choose_sys_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">)</span> \
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sys_act</span><span class="o">=</span><span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="sd">            Responsible for walking the policy through a single turn. Uses the current user</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">            action and system belief state to determine what the next system action should be.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">            To implement an alternate policy, this method may need to be overwritten</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">                belief_state (BeliefState): a BeliefState obejct representing current system</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">                                           knowledge</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">                (dict): a dictionary with the key &quot;sys_act&quot; and the value that of the systems next</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">                        action</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="c1"># do nothing on the first turn --LV</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="n">sys_state</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Welcome</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>            <span class="n">sys_state</span><span class="p">[</span><span class="s2">&quot;last_act&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">:</span> <span class="n">sys_state</span><span class="p">}</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="c1"># Handles case where it was the first turn, but there are user acts</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_turns</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="n">sys_state</span><span class="p">[</span><span class="s2">&quot;last_act&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">:</span> <span class="n">sys_state</span><span class="p">}</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="c1"># removes hello and thanks if there are also domain specific actions</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_gen_actions</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="k">if</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bad</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="c1"># if the action is &#39;bye&#39; tell system to end dialog</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bye</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="c1"># if user only says thanks, ask if they want anything else</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Thanks</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>        <span class="c1"># If user only says hello, request a random slot to move dialog along</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">SelectDomain</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>            <span class="c1"># as long as there are open slots, choose one randomly</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_open_slot</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>                <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>                <span class="n">slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_open_slot</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="c1"># If there are no more open slots, ask the user if you can help with anything else since</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>            <span class="c1"># this can only happen in the case an offer has already been made --LV</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>                <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>            <span class="c1"># If we switch to the domain, start a new dialog</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>            <span class="k">if</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">SelectDomain</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dialog_start</span><span class="p">()</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>        <span class="c1"># handle domain specific actions</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>            <span class="n">sys_act</span><span class="p">,</span> <span class="n">sys_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_action</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;System Action: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys_act</span><span class="p">))</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>        <span class="k">if</span> <span class="s2">&quot;last_act&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_state</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>            <span class="n">sys_state</span><span class="p">[</span><span class="s2">&quot;last_act&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">:</span> <span class="n">sys_state</span><span class="p">}</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>    <span class="k">def</span> <span class="nf">_remove_gen_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a><span class="sd">            Helper function to read through user action list and if necessary</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a><span class="sd">            delete filler actions (eg. Hello, thanks) when there are other non-filler</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a><span class="sd">            (eg. Inform, Request) actions from the user. Stores list of relevant actions</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a><span class="sd">            as a class variable</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a><span class="sd">                beliefstate (BeliefState): BeliefState object - includes list of all</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a><span class="sd">                                           current UserActionTypes</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>        <span class="n">act_types_lst</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>        <span class="c1"># These are filler actions, so if there are other non-filler acions, remove them from</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>        <span class="c1"># the list of action types</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">act_types_lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>            <span class="k">if</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Thanks</span> <span class="ow">in</span> <span class="n">act_types_lst</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>                <span class="n">act_types_lst</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Thanks</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>            <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span> <span class="ow">in</span> <span class="n">act_types_lst</span><span class="p">:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>                <span class="n">act_types_lst</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>            <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span> <span class="ow">in</span> <span class="n">act_types_lst</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>                <span class="n">act_types_lst</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>                <span class="k">break</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>    <span class="k">def</span> <span class="nf">_query_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>        <span class="sd">&quot;&quot;&quot;Based on the constraints specified, uses the domain to generate the appropriate type</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a><span class="sd">           of query for the database</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a><span class="sd">            beliefstate (BeliefState): BeliefState object; contains all given user constraints to date</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a><span class="sd">            iterable: representing the results of the database lookup</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>        <span class="c1"># determine if an entity has already been suggested or was mentioned by the user</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>        <span class="c1"># if yes and the user is asking for info about a specific entity, generate a query to get</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>        <span class="c1"># that info for the slots they have specified</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>            <span class="n">requested_slots</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">requested_slots</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>        <span class="c1"># otherwise, issue a query to find all entities which satisfy the constraints the user</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>        <span class="c1"># has given so far</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>            <span class="n">constraints</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>    <span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>        <span class="sd">&quot;&quot;&quot;Finds if an entity has been suggested by the system (in the form of an offer candidate)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a><span class="sd">           or by the user (in the form of an InformByName act). If so returns the identifier for</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a><span class="sd">           it, otherwise returns None</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="sd">            beliefstate (BeliefState): BeliefState object, contains all known user informs</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a><span class="sd">        Return:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a><span class="sd">            (str): Returns a string representing the current entity name</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a><span class="sd">        -LV</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>        <span class="n">prim_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>        <span class="k">if</span> <span class="n">prim_key</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>            <span class="n">possible_names</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">prim_key</span><span class="p">]</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>            <span class="n">name</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">possible_names</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>        <span class="c1"># if the user is tyring to query by name</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">):</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>                <span class="n">current_suggestion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s_index</span><span class="p">]</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>                <span class="k">if</span> <span class="n">current_suggestion</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>                    <span class="n">name</span> <span class="o">=</span> <span class="n">current_suggestion</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">]</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>        <span class="k">return</span> <span class="n">name</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>    <span class="k">def</span> <span class="nf">_get_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>        <span class="sd">&quot;&quot;&quot;Reads the belief state and extracts any user specified constraints and any constraints</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a><span class="sd">           the user indicated they don&#39;t care about, so the system knows not to ask about them</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a><span class="sd">            beliefstate (BeliefState): BeliefState object; contains all user constraints to date</span>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a><span class="sd">        Return:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a><span class="sd">            (tuple): dict of user requested slot names and their values and list of slots the user</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a><span class="sd">                     doesn&#39;t care about</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>        <span class="c1"># parts of the belief state which don&#39;t contain constraints</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>        <span class="n">dontcare</span> <span class="o">=</span> <span class="p">[</span><span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;dontcare&quot;</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;informs&quot;</span><span class="p">][</span><span class="n">slot</span><span class="p">]]</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>        <span class="n">informs</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;informs&quot;</span><span class="p">]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>        <span class="c1"># TODO: consider threshold of belief for adding a value? --LV</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">informs</span><span class="p">:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dontcare</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">informs</span><span class="p">[</span><span class="n">slot</span><span class="p">]:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>                    <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>        <span class="k">return</span> <span class="n">slots</span><span class="p">,</span> <span class="n">dontcare</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>    <span class="k">def</span> <span class="nf">_get_open_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>        <span class="sd">&quot;&quot;&quot;For a hello statement we need to be able to figure out what slots the user has not yet</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a><span class="sd">           specified constraint for, this method returns one of those at random</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a><span class="sd">            beliefstate (BeliefState): BeliefState object; contains all user constraints to date</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a><span class="sd">            (str): a string representing a category the system might want more info on. If all</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a><span class="sd">            system requestables have been filled, return none</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>        <span class="n">filled_slots</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a>        <span class="n">requestable_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">()</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">requestable_slots</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filled_slots</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>                <span class="k">return</span> <span class="n">slot</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>    <span class="k">def</span> <span class="nf">_next_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>        <span class="sd">&quot;&quot;&quot;Determines the next system action based on the current belief state and</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a><span class="sd">           previous action.</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a><span class="sd">           When implementing a new type of policy, this method MUST be rewritten</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a><span class="sd">            beliefstate (BeliefState): BeliefState object; contains all user constraints to date</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a><span class="sd">            of each possible state</span>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a><span class="sd">        Return:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a><span class="sd">            (SysAct): the next system action</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>        <span class="n">sys_state</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>        <span class="c1"># Assuming this happens only because domain is not actually active --LV</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>        <span class="k">if</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bad</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]</span> \
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">):</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bad</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>            <span class="k">return</span> <span class="n">sys_act</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;last_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">}</span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">RequestAlternatives</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]</span> \
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bad</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>            <span class="k">return</span> <span class="n">sys_act</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;last_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">}</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]</span> \
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>            <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">))</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>            <span class="k">return</span> <span class="n">sys_act</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;last_act&#39;</span><span class="p">:</span> <span class="n">sys_act</span><span class="p">}</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>        <span class="c1"># Otherwise we need to query the db to determine next action</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_db</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>        <span class="n">sys_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_action</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>        <span class="c1"># requests are fairly easy, if it&#39;s a request, return it directly</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>        <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>                <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>        <span class="c1"># otherwise we need to convert a raw inform into a one with proper slots and values</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>        <span class="k">elif</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span><span class="p">:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>            <span class="c1"># update belief state to reflect the offer we just made</span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">())</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>                <span class="c1"># belief_state[&#39;system&#39;][&#39;lastInformedPrimKeyVal&#39;] = values[0]</span>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>                <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">(),</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>        <span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;last_act&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">sys_act</span><span class="p">,</span> <span class="n">sys_state</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>    <span class="k">def</span> <span class="nf">_raw_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_res</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SysAct</span><span class="p">:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>        <span class="sd">&quot;&quot;&quot;Based on the output of the db query and the method, choose</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a><span class="sd">           whether next action should be request or inform</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a><span class="sd">            q_res (list): rows (list of dicts) returned by the issued sqlite3 query</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a><span class="sd">            beliefstate (BeliefState): contains all UserActionTypes for the current turn</span>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a><span class="sd">            (SysAct): SysAct object of appropriate type</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a>        <span class="n">sys_act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>        <span class="c1"># if there is more than one result</span>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>            <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>            <span class="c1"># Gather all the results for each column</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>            <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">q_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>            <span class="c1"># If any column has multiple values, ask for clarification</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">q_res</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>                        <span class="n">temp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>            <span class="n">next_req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_next_request</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>            <span class="k">if</span> <span class="n">next_req</span><span class="p">:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">next_req</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>                <span class="k">return</span> <span class="n">sys_act</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>        <span class="c1"># Otherwise action type will be inform, so return an empty inform (to be filled in later)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>        <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>        <span class="k">return</span> <span class="n">sys_act</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>    <span class="k">def</span> <span class="nf">_gen_next_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">belief_state</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a><span class="sd">            Calculates which slot to request next based asking for non-binary slotes first and then</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a><span class="sd">            based on which binary slots provide the biggest reduction in the size of db results</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a><span class="sd">            NOTE: If the dataset is large, this is probably not a great idea to calculate each turn</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a><span class="sd">                  it&#39;s relatively simple, but could add up over time</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a><span class="sd">                temp (Dict[str, List[str]]: a dictionary with the keys and values for each result</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a><span class="sd">                                            in the result set</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a><span class="sd">            Returns: (str) representing the slot to ask for next (or empty if none)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>        <span class="n">req_slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">()</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>        <span class="c1"># don&#39;t other to cacluate statistics for things which have been specified</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>        <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">belief_state</span><span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>        <span class="c1"># split out binary slots so we can ask about them second</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>        <span class="n">req_slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">req_slots</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dontcare</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">]</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>        <span class="n">bin_slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">req_slots</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>        <span class="n">non_bin_slots</span> <span class="o">=</span> <span class="p">[</span><span class="n">slot</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">req_slots</span> <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bin_slots</span><span class="p">]</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>        <span class="c1"># check if there are any differences in values for non-binary slots,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a>        <span class="c1"># if a slot has multiple values, ask about that slot</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">non_bin_slots</span><span class="p">:</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">slot</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>                <span class="k">return</span> <span class="n">slot</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>        <span class="c1"># Otherwise look to see if there are differnces in binary slots</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highest_info_gain</span><span class="p">(</span><span class="n">bin_slots</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>    <span class="k">def</span> <span class="nf">_highest_info_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_slots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">temp</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>        <span class="sd">&quot;&quot;&quot; Since we don&#39;t have lables, we can&#39;t properlly calculate entropy, so instead we&#39;ll go</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a><span class="sd">            for trying to ask after a feature that splits the results in half as evenly as possible</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a><span class="sd">            (that way we gain most info regardless of which way the user chooses)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a><span class="sd">                bin_slots: a list of strings representing system requestable binary slots which</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a><span class="sd">                           have not yet been specified</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a><span class="sd">                temp (Dict[str, List[str]]: a dictionary with the keys and values for each result</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a><span class="sd">                                            in the result set</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a><span class="sd">            Returns: (str) representing the slot to ask for next (or empty if none)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>        <span class="n">diffs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">bin_slots</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>            <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a>            <span class="n">values_dic</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[</span><span class="n">slot</span><span class="p">]:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a>                <span class="n">values_dic</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>            <span class="k">if</span> <span class="n">val1</span> <span class="ow">in</span> <span class="n">values_dic</span> <span class="ow">and</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">values_dic</span><span class="p">:</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>                <span class="n">diffs</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">values_dic</span><span class="p">[</span><span class="n">val1</span><span class="p">]</span> <span class="o">-</span> <span class="n">values_dic</span><span class="p">[</span><span class="n">val2</span><span class="p">])</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>            <span class="c1"># If all slots have the same value, we don&#39;t need to request anything, return none</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">diffs</span><span class="p">:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a>        <span class="n">sorted_diffs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">diffs</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>        <span class="k">return</span> <span class="n">sorted_diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>    <span class="k">def</span> <span class="nf">_convert_inform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_results</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a>                        <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>        <span class="sd">&quot;&quot;&quot;Fills in the slots and values for a raw inform so it can be returned as the</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a><span class="sd">           next system action.</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a><span class="sd">            q_results (list): Results of SQL database query</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a><span class="sd">            sys_act (SysAct): the act to be modified</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a><span class="sd">            beliefstate(BeliefState): BeliefState object; contains all user constraints to date and</span>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a><span class="sd">                                      the UserActionTypes for the current turn</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a><span class="sd">        --LV</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>        <span class="k">if</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;requests&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform_by_primkey</span><span class="p">(</span><span class="n">q_results</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a>        <span class="k">elif</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">RequestAlternatives</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform_by_alternatives</span><span class="p">(</span><span class="n">sys_act</span><span class="p">,</span> <span class="n">q_results</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_inform_by_constraints</span><span class="p">(</span><span class="n">q_results</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a>    <span class="k">def</span> <span class="nf">_convert_inform_by_primkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_results</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a>                                   <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a><span class="sd">            Helper function that adds the values for slots to a SysAct object when the system</span>
<a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a><span class="sd">            is answering a request for information about an entity from the user</span>
<a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>
<a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a><span class="sd">                q_results (iterable): list of query results from the database</span>
<a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a><span class="sd">                sys_act (SysAct): current raw sys_act to be filled in</span>
<a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a><span class="sd">                beliefstate (BeliefState): BeliefState object; contains all user informs to date</span>
<a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a>        <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a>        <span class="k">if</span> <span class="n">q_results</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">q_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># currently return just the first result</span>
<a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a>            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># should represent all user specified constraints</span>
<a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a>
<a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a>            <span class="c1"># add slots + values (where available) to the sys_act</span>
<a id="__codelineno-0-437" name="__codelineno-0-437" href="#__codelineno-0-437"></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-438" name="__codelineno-0-438" href="#__codelineno-0-438"></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;not available&#39;</span>
<a id="__codelineno-0-439" name="__codelineno-0-439" href="#__codelineno-0-439"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440" href="#__codelineno-0-440"></a>            <span class="c1"># Name might not be a constraint in request queries, so add it</span>
<a id="__codelineno-0-441" name="__codelineno-0-441" href="#__codelineno-0-441"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-442" name="__codelineno-0-442" href="#__codelineno-0-442"></a>                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443" href="#__codelineno-0-443"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444" href="#__codelineno-0-444"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-445" name="__codelineno-0-445" href="#__codelineno-0-445"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446" href="#__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447" href="#__codelineno-0-447"></a>    <span class="k">def</span> <span class="nf">_convert_inform_by_alternatives</span><span class="p">(</span>
<a id="__codelineno-0-448" name="__codelineno-0-448" href="#__codelineno-0-448"></a>            <span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">q_res</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-449" name="__codelineno-0-449" href="#__codelineno-0-449"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-450" name="__codelineno-0-450" href="#__codelineno-0-450"></a><span class="sd">            Helper Function, scrolls through the list of alternative entities which match the</span>
<a id="__codelineno-0-451" name="__codelineno-0-451" href="#__codelineno-0-451"></a><span class="sd">            user&#39;s specified constraints and uses the next item in the list to fill in the raw</span>
<a id="__codelineno-0-452" name="__codelineno-0-452" href="#__codelineno-0-452"></a><span class="sd">            inform act.</span>
<a id="__codelineno-0-453" name="__codelineno-0-453" href="#__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454" href="#__codelineno-0-454"></a><span class="sd">            When the end of the list is reached, currently continues to give last item in the list</span>
<a id="__codelineno-0-455" name="__codelineno-0-455" href="#__codelineno-0-455"></a><span class="sd">            as a suggestion</span>
<a id="__codelineno-0-456" name="__codelineno-0-456" href="#__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457" href="#__codelineno-0-457"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458" href="#__codelineno-0-458"></a><span class="sd">                sys_act (SysAct): the raw inform to be filled in</span>
<a id="__codelineno-0-459" name="__codelineno-0-459" href="#__codelineno-0-459"></a><span class="sd">                beliefstate (BeliefState): current system belief state</span>
<a id="__codelineno-0-460" name="__codelineno-0-460" href="#__codelineno-0-460"></a>
<a id="__codelineno-0-461" name="__codelineno-0-461" href="#__codelineno-0-461"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-462" name="__codelineno-0-462" href="#__codelineno-0-462"></a>        <span class="k">if</span> <span class="n">q_res</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">:</span>
<a id="__codelineno-0-463" name="__codelineno-0-463" href="#__codelineno-0-463"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-464" name="__codelineno-0-464" href="#__codelineno-0-464"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-465" name="__codelineno-0-465" href="#__codelineno-0-465"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">q_res</span><span class="p">:</span>
<a id="__codelineno-0-466" name="__codelineno-0-466" href="#__codelineno-0-466"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-467" name="__codelineno-0-467" href="#__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468" href="#__codelineno-0-468"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-469" name="__codelineno-0-469" href="#__codelineno-0-469"></a>        <span class="c1"># here we should scroll through possible offers presenting one each turn the user asks</span>
<a id="__codelineno-0-470" name="__codelineno-0-470" href="#__codelineno-0-470"></a>        <span class="c1"># for alternatives</span>
<a id="__codelineno-0-471" name="__codelineno-0-471" href="#__codelineno-0-471"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472" href="#__codelineno-0-472"></a>            <span class="c1"># the first time we inform, we should inform by name, so we use the right template</span>
<a id="__codelineno-0-473" name="__codelineno-0-473" href="#__codelineno-0-473"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474" href="#__codelineno-0-474"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-475" name="__codelineno-0-475" href="#__codelineno-0-475"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476" href="#__codelineno-0-476"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span>
<a id="__codelineno-0-477" name="__codelineno-0-477" href="#__codelineno-0-477"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s_index</span><span class="p">]</span>
<a id="__codelineno-0-478" name="__codelineno-0-478" href="#__codelineno-0-478"></a>            <span class="c1"># Inform by alternatives according to our current templates is</span>
<a id="__codelineno-0-479" name="__codelineno-0-479" href="#__codelineno-0-479"></a>            <span class="c1"># just a normal inform apparently --LV</span>
<a id="__codelineno-0-480" name="__codelineno-0-480" href="#__codelineno-0-480"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">])</span>
<a id="__codelineno-0-481" name="__codelineno-0-481" href="#__codelineno-0-481"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482" href="#__codelineno-0-482"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span>
<a id="__codelineno-0-483" name="__codelineno-0-483" href="#__codelineno-0-483"></a>            <span class="c1"># default to last suggestion in the list</span>
<a id="__codelineno-0-484" name="__codelineno-0-484" href="#__codelineno-0-484"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-485" name="__codelineno-0-485" href="#__codelineno-0-485"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">(),</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486" href="#__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487" href="#__codelineno-0-487"></a>        <span class="c1"># in addition to the name, add the constraints the user has specified, so they know the</span>
<a id="__codelineno-0-488" name="__codelineno-0-488" href="#__codelineno-0-488"></a>        <span class="c1"># offer is relevant to them</span>
<a id="__codelineno-0-489" name="__codelineno-0-489" href="#__codelineno-0-489"></a>        <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490" href="#__codelineno-0-490"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491" href="#__codelineno-0-491"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">constraints</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
<a id="__codelineno-0-492" name="__codelineno-0-492" href="#__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493" href="#__codelineno-0-493"></a>    <span class="k">def</span> <span class="nf">_convert_inform_by_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_results</span><span class="p">:</span> <span class="nb">iter</span><span class="p">,</span>
<a id="__codelineno-0-494" name="__codelineno-0-494" href="#__codelineno-0-494"></a>                                       <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-495" name="__codelineno-0-495" href="#__codelineno-0-495"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-496" name="__codelineno-0-496" href="#__codelineno-0-496"></a><span class="sd">            Helper function for filling in slots and values of a raw inform act when the system is</span>
<a id="__codelineno-0-497" name="__codelineno-0-497" href="#__codelineno-0-497"></a><span class="sd">            ready to make the user an offer</span>
<a id="__codelineno-0-498" name="__codelineno-0-498" href="#__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499" href="#__codelineno-0-499"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-500" name="__codelineno-0-500" href="#__codelineno-0-500"></a><span class="sd">                q_results (iter): the results from the databse query</span>
<a id="__codelineno-0-501" name="__codelineno-0-501" href="#__codelineno-0-501"></a><span class="sd">                sys_act (SysAct): the raw infor act to be filled in</span>
<a id="__codelineno-0-502" name="__codelineno-0-502" href="#__codelineno-0-502"></a><span class="sd">                beliefstate (BeliefState): the current system beliefs</span>
<a id="__codelineno-0-503" name="__codelineno-0-503" href="#__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504" href="#__codelineno-0-504"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-505" name="__codelineno-0-505" href="#__codelineno-0-505"></a>        <span class="c1"># TODO: Do we want some way to allow users to scroll through</span>
<a id="__codelineno-0-506" name="__codelineno-0-506" href="#__codelineno-0-506"></a>        <span class="c1"># result set other than to type &#39;alternatives&#39;? --LV</span>
<a id="__codelineno-0-507" name="__codelineno-0-507" href="#__codelineno-0-507"></a>        <span class="k">if</span> <span class="n">q_results</span><span class="p">:</span>
<a id="__codelineno-0-508" name="__codelineno-0-508" href="#__codelineno-0-508"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-509" name="__codelineno-0-509" href="#__codelineno-0-509"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-510" name="__codelineno-0-510" href="#__codelineno-0-510"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">q_results</span><span class="p">:</span>
<a id="__codelineno-0-511" name="__codelineno-0-511" href="#__codelineno-0-511"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512" href="#__codelineno-0-512"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-513" name="__codelineno-0-513" href="#__codelineno-0-513"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">])</span>
<a id="__codelineno-0-514" name="__codelineno-0-514" href="#__codelineno-0-514"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515" href="#__codelineno-0-515"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516" href="#__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517" href="#__codelineno-0-517"></a>        <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-518" name="__codelineno-0-518" href="#__codelineno-0-518"></a>        <span class="n">constraints</span><span class="p">,</span> <span class="n">dontcare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_constraints</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-519" name="__codelineno-0-519" href="#__codelineno-0-519"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520" href="#__codelineno-0-520"></a>            <span class="c1"># Using constraints here rather than results to deal with empty</span>
<a id="__codelineno-0-521" name="__codelineno-0-521" href="#__codelineno-0-521"></a>            <span class="c1"># results sets (eg. user requests something impossible) --LV</span>
<a id="__codelineno-0-522" name="__codelineno-0-522" href="#__codelineno-0-522"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">constraints</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.policy_handcrafted.HandcraftedPolicy.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">max_turns</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Initializes the policy</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_handcrafted.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Initializes the policy</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Arguments:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        domain {domain.jsonlookupdomain.JSONLookupDomain} -- Domain</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain_key</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_turns</span> <span class="o">=</span> <span class="n">max_turns</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.policy_handcrafted.HandcraftedPolicy.choose_sys_act" class="doc doc-heading">
<code class="highlight language-python"><span class="n">choose_sys_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.choose_sys_act" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_handcrafted.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.policy.policy_handcrafted.HandcraftedPolicy.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.policy_handcrafted.HandcraftedPolicy.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>resets the policy after each dialog</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/policy_handcrafted.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        resets the policy after each dialog</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">first_turn</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">current_suggestions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of current suggestions</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">s_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the index in current suggestions for the current system reccomendation</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.policy.rl" class="doc doc-heading">
        <code>rl</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="adviser.services.policy.rl.dqn" class="doc doc-heading">
        <code>dqn</code>



<a href="#adviser.services.policy.rl.dqn" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.dqn.DQN" class="doc doc-heading">
        <code>
DQN            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#adviser.services.policy.rl.dqn.DQN" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Simple Deep Q-Network </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqn.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">DQN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Simple Deep Q-Network &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hidden_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                 <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="sd">&quot;&quot;&quot; Initialize a DQN Network with an arbitrary amount of linear hidden</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">            layers &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DQN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Architecture: DQN&quot;</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># create layers</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">current_input_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">hidden_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">current_input_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>            <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="n">current_input_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="c1"># output layer</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">current_input_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">))</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="sd">&quot;&quot;&quot; Forward pass: calculate Q(state) for all actions</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">            state_batch (torch.FloatTensor): tensor of size batch_size x state_dim</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">            output: tensor of size batch_size x action_dim</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">state_batch</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqn.DQN.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">,</span> <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.dqn.DQN.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Initialize a DQN Network with an arbitrary amount of linear hidden
layers </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqn.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hidden_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot; Initialize a DQN Network with an arbitrary amount of linear hidden</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        layers &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">DQN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Architecture: DQN&quot;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="c1"># create layers</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">current_input_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">hidden_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">current_input_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">current_input_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="c1"># output layer</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">current_input_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqn.DQN.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_batch</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqn.DQN.forward" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Forward pass: calculate Q(state) for all actions</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>state_batch</code></td>
        <td><code>torch.FloatTensor</code></td>
        <td><p>tensor of size batch_size x state_dim</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>output</code></td>
      <td><p>tensor of size batch_size x action_dim</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqn.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Forward pass: calculate Q(state) for all actions</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        state_batch (torch.FloatTensor): tensor of size batch_size x state_dim</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        output: tensor of size batch_size x action_dim</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">state_batch</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">return</span> <span class="n">output</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.dqn.DuelingDQN" class="doc doc-heading">
        <code>
DuelingDQN            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



<a href="#adviser.services.policy.rl.dqn.DuelingDQN" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Dueling DQN network architecture</p>
<p>Splits network into value- and advantage stream (V(s) and A(s,a)), 
recombined in final layer to form Q-value again:
Q(s,a) = V(s) + A(s,a).</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqn.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">DuelingDQN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Dueling DQN network architecture</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Splits network into value- and advantage stream (V(s) and A(s,a)), </span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    recombined in final layer to form Q-value again:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Q(s,a) = V(s) + A(s,a).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                 <span class="n">shared_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">value_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                 <span class="n">advantage_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DuelingDQN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ARCHITECTURE: Dueling&quot;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="c1"># configure layers</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># shared layer: state_dim -&gt; shared_layer_sizes[-1]</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="n">shared_layer_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">shared_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">shared_layer_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">shared_layer_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="c1"># value layer: shared_layer_sizes[-1] -&gt; 1</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">value_layer_dim</span> <span class="o">=</span> <span class="n">shared_layer_dim</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">value_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">value_layer_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="n">value_layer_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">value_layer_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="c1"># advantage layer: shared_layer_sizes[-1] -&gt; actions</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">advantage_layer_dim</span> <span class="o">=</span> <span class="n">shared_layer_dim</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">advantage_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">advantage_layer_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="n">advantage_layer_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">advantage_layer_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">))</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="sd">&quot;&quot;&quot; Forward pass: calculate Q(state) for all actions</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">            input (torch.FloatTensor): tensor of size batch_size x state_dim</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">            tensor of size batch_size x action_dim</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="n">shared_output</span> <span class="o">=</span> <span class="n">state_batch</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="c1"># shared layer representation</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="n">shared_output</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">shared_output</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="c1"># value stream</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="n">value_stream</span> <span class="o">=</span> <span class="n">shared_output</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>            <span class="n">value_stream</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">value_stream</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="c1"># advantage stream</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="n">advantage_stream</span> <span class="o">=</span> <span class="n">shared_output</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="n">advantage_stream</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">advantage_stream</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="c1"># combine value and advantage streams into Q values</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">value_stream</span> <span class="o">+</span> <span class="n">advantage_stream</span> <span class="o">-</span> <span class="n">advantage_stream</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqn.DuelingDQN.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">,</span> <span class="n">shared_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">value_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">advantage_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.dqn.DuelingDQN.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqn.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">shared_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">value_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">advantage_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">],</span> <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">DuelingDQN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ARCHITECTURE: Dueling&quot;</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="c1"># configure layers</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="c1"># shared layer: state_dim -&gt; shared_layer_sizes[-1]</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">shared_layer_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">shared_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">shared_layer_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">shared_layer_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="c1"># value layer: shared_layer_sizes[-1] -&gt; 1</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="n">value_layer_dim</span> <span class="o">=</span> <span class="n">shared_layer_dim</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">value_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">value_layer_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="n">value_layer_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">value_layer_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="c1"># advantage layer: shared_layer_sizes[-1] -&gt; actions</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="n">advantage_layer_dim</span> <span class="o">=</span> <span class="n">shared_layer_dim</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">for</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="n">advantage_layer_sizes</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">advantage_layer_dim</span><span class="p">,</span> <span class="n">layer_size</span><span class="p">))</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">if</span> <span class="n">dropout_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_rate</span><span class="p">))</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">advantage_layer_dim</span> <span class="o">=</span> <span class="n">layer_size</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">advantage_layer_dim</span><span class="p">,</span> <span class="n">action_dim</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqn.DuelingDQN.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_batch</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqn.DuelingDQN.forward" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Forward pass: calculate Q(state) for all actions</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>input</code></td>
        <td><code>torch.FloatTensor</code></td>
        <td><p>tensor of size batch_size x state_dim</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>tensor of size batch_size x action_dim</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqn.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Forward pass: calculate Q(state) for all actions</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        input (torch.FloatTensor): tensor of size batch_size x state_dim</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        tensor of size batch_size x action_dim</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">shared_output</span> <span class="o">=</span> <span class="n">state_batch</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="c1"># shared layer representation</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_layers</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">shared_output</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">shared_output</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="c1"># value stream</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">value_stream</span> <span class="o">=</span> <span class="n">shared_output</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_layers</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="n">value_stream</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">value_stream</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="c1"># advantage stream</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">advantage_stream</span> <span class="o">=</span> <span class="n">shared_output</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">advantage_layers</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">advantage_stream</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">advantage_stream</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="c1"># combine value and advantage streams into Q values</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">value_stream</span> <span class="o">+</span> <span class="n">advantage_stream</span> <span class="o">-</span> <span class="n">advantage_stream</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.dqn.NetArchitecture" class="doc doc-heading">
        <code>
NetArchitecture            (<span title="enum.Enum">Enum</span>)
        </code>



<a href="#adviser.services.policy.rl.dqn.NetArchitecture" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Network architecture for DQN </p>
<p>vanilla: normal MLP
dueling: splits network into value- and advantage stream, recombined in final layer</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqn.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">NetArchitecture</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Network architecture for DQN </span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        vanilla: normal MLP</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        dueling: splits network into value- and advantage stream, recombined in final layer</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">VANILLA</span> <span class="o">=</span> <span class="s1">&#39;vanilla&#39;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">DUELING</span> <span class="o">=</span> <span class="s1">&#39;dueling&#39;</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h6 id="adviser.services.policy.rl.dqn.NetArchitecture.DUELING" class="doc doc-heading">
<code class="highlight language-python"><span class="n">DUELING</span></code>


<a href="#adviser.services.policy.rl.dqn.NetArchitecture.DUELING" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h6 id="adviser.services.policy.rl.dqn.NetArchitecture.VANILLA" class="doc doc-heading">
<code class="highlight language-python"><span class="n">VANILLA</span></code>


<a href="#adviser.services.policy.rl.dqn.NetArchitecture.VANILLA" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

    </div>

  </div>








  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.policy.rl.dqnpolicy" class="doc doc-heading">
        <code>dqnpolicy</code>



<a href="#adviser.services.policy.rl.dqnpolicy" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy" class="doc doc-heading">
        <code>
DQNPolicy            (<span title="services.policy.rl.policy_rl.RLPolicy">RLPolicy</span>, <span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">DQNPolicy</span><span class="p">(</span><span class="n">RLPolicy</span><span class="p">,</span> <span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                 <span class="n">architecture</span><span class="p">:</span> <span class="n">NetArchitecture</span> <span class="o">=</span> <span class="n">NetArchitecture</span><span class="o">.</span><span class="n">DUELING</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                 <span class="n">hidden_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">],</span>  <span class="c1"># vanilla architecture</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                 <span class="n">shared_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">value_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                 <span class="n">advantage_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span>  <span class="c1"># dueling architecture</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                 <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                 <span class="n">target_update_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                 <span class="n">replay_buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                 <span class="n">buffer_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Buffer</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaivePrioritizedBuffer</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                 <span class="n">eps_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">eps_end</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                 <span class="n">l2_regularisation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">gradient_clipping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                 <span class="n">p_dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">training_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">train_dialogs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                 <span class="n">include_confreq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>                 <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                 <span class="n">summary_writer</span><span class="p">:</span> <span class="n">SummaryWriter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">            target_update_rate: if 1, vanilla dqn update</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">                                if &gt; 1, double dqn with specified target update</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">                                rate</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">RLPolicy</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="n">domain</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=</span><span class="n">buffer_cls</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="n">buffer_size</span><span class="o">=</span><span class="n">replay_buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span> <span class="n">include_confreq</span><span class="o">=</span><span class="n">include_confreq</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">max_turns</span><span class="o">=</span><span class="n">max_turns</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">summary_writer</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">training_frequency</span> <span class="o">=</span> <span class="n">training_frequency</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dialogs</span> <span class="o">=</span> <span class="n">train_dialogs</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gradient_clipping</span> <span class="o">=</span> <span class="n">gradient_clipping</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="k">if</span> <span class="n">gradient_clipping</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Gradient Clipping: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gradient_clipping</span><span class="p">))</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_update_rate</span> <span class="o">=</span> <span class="n">target_update_rate</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span> <span class="o">=</span> <span class="n">eps_start</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_end</span> <span class="o">=</span> <span class="n">eps_end</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="c1"># Select network architecture</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="k">if</span> <span class="n">architecture</span> <span class="o">==</span> <span class="n">NetArchitecture</span><span class="o">.</span><span class="n">VANILLA</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Architecture: Vanilla&quot;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                             <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="n">hidden_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>                             <span class="n">dropout_rate</span><span class="o">=</span><span class="n">p_dropout</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Architecture: Dueling&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DuelingDQN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>                                    <span class="n">shared_layer_sizes</span><span class="o">=</span><span class="n">shared_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>                                    <span class="n">value_layer_sizes</span><span class="o">=</span><span class="n">value_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>                                    <span class="n">advantage_layer_sizes</span><span class="o">=</span><span class="n">advantage_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>                                    <span class="n">dropout_rate</span><span class="o">=</span><span class="n">p_dropout</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="c1"># Select network update</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="k">if</span> <span class="n">target_update_rate</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Update: Double&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>            <span class="k">if</span> <span class="n">architecture</span> <span class="o">==</span> <span class="n">NetArchitecture</span><span class="o">.</span><span class="n">VANILLA</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Update: Vanilla&quot;</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optim</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2_regularisation</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fun</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="c1"># self.loss_fun = nn.MSELoss(reduction=&#39;none&#39;)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_train_dialogs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_start</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_train_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>            <span class="s2">&quot;lastInformedPrimKeyVal&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>            <span class="s2">&quot;lastActionInformNone&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>            <span class="s2">&quot;offerHappened&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>            <span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>    <span class="k">def</span> <span class="nf">select_action_eps_greedy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>        <span class="sd">&quot;&quot;&quot; Epsilon-greedy policy.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="sd">            state_vector (torch.FloatTensor): current state (dimension 1 x state_dim)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="sd">            action index for action selected by the agent for the current state</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eps_scheduler</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>        <span class="c1"># epsilon greedy exploration</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="ow">and</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>            <span class="n">next_action_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>            <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">state_vector</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="n">next_action_idx</span> <span class="o">=</span> <span class="n">q_values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>        <span class="k">return</span> <span class="n">next_action_idx</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sim_goal&quot;</span><span class="p">])</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a><span class="sd">            Once the simulation ends, need to store the simulation goal for evaluation</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a><span class="sd">                sim_goal (Goal): the simulation goal, needed for evaluation</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sim_goal</span> <span class="o">=</span> <span class="n">sim_goal</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>    <span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a><span class="sd">            clean up needed at the end of a dialog</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_goal</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_batch</span><span class="p">()</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;beliefstate&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">])</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>    <span class="k">def</span> <span class="nf">choose_sys_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sys_act</span><span class="o">=</span><span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a><span class="sd">            Determine the next system act based on the given beliefstate</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a><span class="sd">                beliefstate (BeliefState): beliefstate, contains all information the system knows</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a><span class="sd">                                           about the environment (in this case the user)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a><span class="sd">                (dict): dictionary where the keys are &quot;sys_act&quot; representing the action chosen by</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a><span class="sd">                        the policy, and &quot;sys_state&quot; which contains additional informatino which might</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a><span class="sd">                        be needed by the NLU to disambiguate challenging utterances.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_dialogs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_train_dialogs</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dialogs</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_train_dialogs</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>            <span class="c1"># start with same weights for target and online net when a new epoch begins</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>            <span class="c1"># first turn of dialog: say hello &amp; don&#39;t record</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>            <span class="n">out_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_hello</span><span class="p">()</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>            <span class="n">out_dict</span><span class="p">[</span><span class="s2">&quot;sys_state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;last_act&quot;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">]}</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>            <span class="k">return</span> <span class="n">out_dict</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_turns</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>            <span class="c1"># reached turn limit -&gt; terminate dialog</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>            <span class="n">bye_action</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>            <span class="n">bye_action</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="n">bye_action</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>            <span class="c1"># self.end_dialog(sim_goal)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;system action &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bye_action</span><span class="p">))</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>            <span class="n">sys_state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;last_act&quot;</span><span class="p">:</span> <span class="n">bye_action</span><span class="p">}</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">bye_action</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">:</span> <span class="n">sys_state</span><span class="p">}</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>        <span class="c1"># intermediate or closing turn</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>        <span class="n">state_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beliefstate_dict_to_vector</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>        <span class="n">next_action_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>        <span class="c1"># check if user ended dialog</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>        <span class="k">if</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bye</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>            <span class="c1"># user terminated current dialog -&gt; say bye</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>            <span class="n">next_action_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_idx</span><span class="p">(</span><span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>        <span class="k">if</span> <span class="n">next_action_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>            <span class="c1"># dialog continues</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>            <span class="n">next_action_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_action_eps_greedy</span><span class="p">(</span><span class="n">state_vector</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turn_end</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">,</span> <span class="n">next_action_idx</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>        <span class="c1"># Update the sys_state</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span><span class="p">,</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span><span class="p">]:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">())</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>                <span class="c1"># belief_state[&#39;system&#39;][&#39;lastInformedPrimKeyVal&#39;] = values[0]</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s2">&quot;last_act&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="p">,</span> <span class="s2">&quot;sys_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">}</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>    <span class="k">def</span> <span class="nf">_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">):</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>        <span class="sd">&quot;&quot;&quot; Forward state through DQN, return only Q-values for given actions.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a><span class="sd">            state (torch.FloatTensor): states (dimension batch x state_dim)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a><span class="sd">            action (torch.LongTensor): actions to select Q-value for (dimension batch x 1)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a><span class="sd">            Q-values for selected actions</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>        <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>        <span class="k">return</span> <span class="n">q_values</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>    <span class="k">def</span> <span class="nf">_forward_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>                        <span class="n">terminal</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>        <span class="sd">&quot;&quot;&quot; Calculate target for TD-loss (DQN)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a><span class="sd">            state (torch.FloatTensor): states (dimension batch x state_dim)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a><span class="sd">            reward (torch.FloatTensor): rewards (dimension batch x 1)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a><span class="sd">            terminal (torch.LongTensor): indicator {0,1} for terminal states (dimension: batch x 1)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a><span class="sd">            gamma (float): discount factor</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a><span class="sd">            TD-loss targets</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>        <span class="n">target_q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>        <span class="n">greedy_actions</span> <span class="o">=</span> <span class="n">target_q_values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>        <span class="k">return</span> <span class="n">reward</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">terminal</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">target_q_values</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">greedy_actions</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>    <span class="k">def</span> <span class="nf">_forward_target_ddqn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>                             <span class="n">terminal</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>        <span class="sd">&quot;&quot;&quot; Calculate target for TD-loss (Double DQN - uses online and target network)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a><span class="sd">            state (torch.FloatTensor): states (dimension batch x state_dim)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a><span class="sd">            reward (torch.FloatTensor): rewards (dimension batch x 1)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a><span class="sd">            terminal (torch.FloatTensor): indicator {0,1} for terminal states (dimension: batch x 1)</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a><span class="sd">            gamma (float): discount factor</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a><span class="sd">            TD-loss targets</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a>        <span class="n">greedy_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a>        <span class="n">target_q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">greedy_actions</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>        <span class="n">target_q_values</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">terminal</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">target_q_values</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a>        <span class="k">return</span> <span class="n">target_q_values</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>             <span class="n">s2_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a>             <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>        <span class="sd">&quot;&quot;&quot; Calculate TD-loss for given experience tuples</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a><span class="sd">            s_batch (torch.FloatTensor): states (dimension batch x state_dim)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a><span class="sd">            a_batch (torch.LongTensor): actions (dimension batch x 1)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a><span class="sd">            s2_batch (torch.FloatTensor): next states (dimension: batch x state_dim)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a><span class="sd">            r_batch (torch.FloatTensor): rewards (dimension batch x 1)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a><span class="sd">            t_batch (torch.FloatTensor): indicator {0,1} for terminal states (dimension: batch x 1)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a><span class="sd">            gamma (float): discount factor</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a><span class="sd">            TD-loss</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>        <span class="c1"># forward value</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>        <span class="n">q_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>        <span class="c1"># forward target</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>            <span class="n">q_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_target</span><span class="p">(</span><span class="n">s2_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>            <span class="n">q_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_target_ddqn</span><span class="p">(</span><span class="n">s2_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>                                                 <span class="n">gamma</span><span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>        <span class="c1"># loss</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fun</span><span class="p">(</span><span class="n">q_val</span><span class="p">,</span> <span class="n">q_target</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>        <span class="k">return</span> <span class="n">loss</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>    <span class="k">def</span> <span class="nf">train_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>        <span class="sd">&quot;&quot;&quot; Train on a minibatch drawn from the experience buffer. &quot;&quot;&quot;</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>            <span class="k">return</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">10</span> <span class="ow">and</span> \
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>            <span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">s2_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">importance_weights</span> <span class="o">=</span> \
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>            <span class="n">s_batch</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>            <span class="n">gamma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">discount_gamma</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>                                 <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>            <span class="c1"># calculate loss</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">s2_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>            <span class="k">if</span> <span class="n">importance_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">*</span> <span class="n">importance_weights</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>                    <span class="c1"># importance weighting</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>                    <span class="c1"># update priorities</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>            <span class="c1"># clip gradients</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_clipping</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_clipping</span><span class="p">)</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>            <span class="c1"># update weights</span>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>            <span class="n">current_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a>                <span class="c1"># plot loss</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/loss&#39;</span><span class="p">,</span> <span class="n">current_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a>                <span class="c1"># plot min/max gradients</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>                <span class="n">max_grad_norm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a>                <span class="n">min_grad_norm</span> <span class="o">=</span> <span class="mf">1000000.0</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>                    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>                        <span class="c1"># TODO decide on norm</span>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>                        <span class="n">current_grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>                        <span class="k">if</span> <span class="n">current_grad_norm</span> <span class="o">&gt;</span> <span class="n">max_grad_norm</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>                            <span class="n">max_grad_norm</span> <span class="o">=</span> <span class="n">current_grad_norm</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>                        <span class="k">if</span> <span class="n">current_grad_norm</span> <span class="o">&lt;</span> <span class="n">min_grad_norm</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>                            <span class="n">min_grad_norm</span> <span class="o">=</span> <span class="n">current_grad_norm</span>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/min_grad&#39;</span><span class="p">,</span> <span class="n">min_grad_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/max_grad&#39;</span><span class="p">,</span> <span class="n">max_grad_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>            <span class="c1"># update target net</span>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>    <span class="k">def</span> <span class="nf">eps_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>        <span class="sd">&quot;&quot;&quot; Linear epsilon decay &quot;&quot;&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>                               <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_end</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>                               <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_dialogs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/eps&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;dqn&#39;</span><span class="p">),</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">):</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>        <span class="sd">&quot;&quot;&quot; Save model weights</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a><span class="sd">            path (str): path to model folder</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a><span class="sd">            version (str): appendix to filename, enables having multiple models for the same domain</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a><span class="sd">                           (or saving a model after each training epoch)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>        <span class="n">model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>            <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rlpolicy_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;dqn&#39;</span><span class="p">),</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">):</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>        <span class="sd">&quot;&quot;&quot; Load model weights</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a><span class="sd">            path (str): path to model folder</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a><span class="sd">            version (str): appendix to filename, enables having multiple models for the same domain</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a><span class="sd">                           (or saving a model after each training epoch)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>        <span class="n">model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>            <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rlpolicy_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Could not find DQN policy weight file &quot;</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loaded DQN weights from file &quot;</span> <span class="o">+</span> <span class="n">model_file</span><span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a>        <span class="sd">&quot;&quot;&quot; Sets module and its subgraph to training mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DQNPolicy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a>        <span class="sd">&quot;&quot;&quot; Sets module and its subgraph to eval mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DQNPolicy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">architecture</span><span class="o">=&lt;</span><span class="n">NetArchitecture</span><span class="o">.</span><span class="n">DUELING</span><span class="p">:</span> <span class="s1">&#39;dueling&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">],</span> <span class="n">shared_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">value_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span> <span class="n">advantage_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">target_update_rate</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">replay_buffer_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">services</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">rl</span><span class="o">.</span><span class="n">experience_buffer</span><span class="o">.</span><span class="n">NaivePrioritizedBuffer</span><span class="s1">&#39;&gt;, eps_start=0.3, eps_end=0.0, l2_regularisation=0.0, gradient_clipping=5.0, p_dropout=0.0, training_frequency=2, train_dialogs=1000, include_confreq=False, logger=&lt;DiasysLogger adviser (NOTSET)&gt;, max_turns=25, summary_writer=None, device=device(type=&#39;</span><span class="n">cpu</span><span class="s1">&#39;))</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>target_update_rate</code></td>
        <td><code>int</code></td>
        <td><p>if 1, vanilla dqn update
                if &gt; 1, double dqn with specified target update
                rate</p></td>
        <td><code>3</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">architecture</span><span class="p">:</span> <span class="n">NetArchitecture</span> <span class="o">=</span> <span class="n">NetArchitecture</span><span class="o">.</span><span class="n">DUELING</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">hidden_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">],</span>  <span class="c1"># vanilla architecture</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>             <span class="n">shared_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">value_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>             <span class="n">advantage_layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span>  <span class="c1"># dueling architecture</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>             <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>             <span class="n">target_update_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>             <span class="n">replay_buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>             <span class="n">buffer_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Buffer</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaivePrioritizedBuffer</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>             <span class="n">eps_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">eps_end</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>             <span class="n">l2_regularisation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">gradient_clipping</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>             <span class="n">p_dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">training_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">train_dialogs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>             <span class="n">include_confreq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>             <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>             <span class="n">summary_writer</span><span class="p">:</span> <span class="n">SummaryWriter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        target_update_rate: if 1, vanilla dqn update</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">                            if &gt; 1, double dqn with specified target update</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">                            rate</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="n">RLPolicy</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">domain</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=</span><span class="n">buffer_cls</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">buffer_size</span><span class="o">=</span><span class="n">replay_buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span> <span class="n">include_confreq</span><span class="o">=</span><span class="n">include_confreq</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">max_turns</span><span class="o">=</span><span class="n">max_turns</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">summary_writer</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">training_frequency</span> <span class="o">=</span> <span class="n">training_frequency</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_dialogs</span> <span class="o">=</span> <span class="n">train_dialogs</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">gradient_clipping</span> <span class="o">=</span> <span class="n">gradient_clipping</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="k">if</span> <span class="n">gradient_clipping</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Gradient Clipping: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gradient_clipping</span><span class="p">))</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">target_update_rate</span> <span class="o">=</span> <span class="n">target_update_rate</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span> <span class="o">=</span> <span class="n">eps_start</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_end</span> <span class="o">=</span> <span class="n">eps_end</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="c1"># Select network architecture</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="k">if</span> <span class="n">architecture</span> <span class="o">==</span> <span class="n">NetArchitecture</span><span class="o">.</span><span class="n">VANILLA</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Architecture: Vanilla&quot;</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>                         <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="n">hidden_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>                         <span class="n">dropout_rate</span><span class="o">=</span><span class="n">p_dropout</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Architecture: Dueling&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DuelingDQN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                                <span class="n">shared_layer_sizes</span><span class="o">=</span><span class="n">shared_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                                <span class="n">value_layer_sizes</span><span class="o">=</span><span class="n">value_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>                                <span class="n">advantage_layer_sizes</span><span class="o">=</span><span class="n">advantage_layer_sizes</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>                                <span class="n">dropout_rate</span><span class="o">=</span><span class="n">p_dropout</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    <span class="c1"># Select network update</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    <span class="k">if</span> <span class="n">target_update_rate</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Update: Double&quot;</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="k">if</span> <span class="n">architecture</span> <span class="o">==</span> <span class="n">NetArchitecture</span><span class="o">.</span><span class="n">VANILLA</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Update: Vanilla&quot;</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">optim</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2_regularisation</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">loss_fun</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>    <span class="c1"># self.loss_fun = nn.MSELoss(reduction=&#39;none&#39;)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_train_dialogs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.choose_sys_act" class="doc doc-heading">
<code class="highlight language-python"><span class="n">choose_sys_act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.choose_sys_act" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_end" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>clean up needed at the end of a dialog</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        clean up needed at the end of a dialog</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_goal</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_batch</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_start</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.dialog_start" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>This function is called before the first message to a new dialog is published.
You should overwrite this function to set/reset dialog-level variables. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_start</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">turns</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_train_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="s2">&quot;lastInformedPrimKeyVal&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="s2">&quot;lastActionInformNone&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="s2">&quot;offerHappened&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">:</span> <span class="p">[]}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.end" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.eps_scheduler" class="doc doc-heading">
<code class="highlight language-python"><span class="n">eps_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.eps_scheduler" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Linear epsilon decay </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">eps_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Linear epsilon decay &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                           <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_end</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                           <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_dialogs</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/eps&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.eval" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.eval" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Sets module and its subgraph to eval mode </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Sets module and its subgraph to eval mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">DQNPolicy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.load" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;models/dqn&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.load" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Load model weights</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>path</code></td>
        <td><code>str</code></td>
        <td><p>path to model folder</p></td>
        <td><code>&#39;models/dqn&#39;</code></td>
      </tr>
      <tr>
        <td><code>version</code></td>
        <td><code>str</code></td>
        <td><p>appendix to filename, enables having multiple models for the same domain
           (or saving a model after each training epoch)</p></td>
        <td><code>&#39;1.0&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;dqn&#39;</span><span class="p">),</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Load model weights</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        path (str): path to model folder</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        version (str): appendix to filename, enables having multiple models for the same domain</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                       (or saving a model after each training epoch)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rlpolicy_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Could not find DQN policy weight file &quot;</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loaded DQN weights from file &quot;</span> <span class="o">+</span> <span class="n">model_file</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">s2_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.loss" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Calculate TD-loss for given experience tuples</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>s_batch</code></td>
        <td><code>torch.FloatTensor</code></td>
        <td><p>states (dimension batch x state_dim)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>a_batch</code></td>
        <td><code>torch.LongTensor</code></td>
        <td><p>actions (dimension batch x 1)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>s2_batch</code></td>
        <td><code>torch.FloatTensor</code></td>
        <td><p>next states (dimension: batch x state_dim)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>r_batch</code></td>
        <td><code>torch.FloatTensor</code></td>
        <td><p>rewards (dimension batch x 1)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>t_batch</code></td>
        <td><code>torch.FloatTensor</code></td>
        <td><p>indicator {0,1} for terminal states (dimension: batch x 1)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>gamma</code></td>
        <td><code>float</code></td>
        <td><p>discount factor</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>TD-loss</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>         <span class="n">s2_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>         <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot; Calculate TD-loss for given experience tuples</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        s_batch (torch.FloatTensor): states (dimension batch x state_dim)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        a_batch (torch.LongTensor): actions (dimension batch x 1)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        s2_batch (torch.FloatTensor): next states (dimension: batch x state_dim)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        r_batch (torch.FloatTensor): rewards (dimension batch x 1)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        t_batch (torch.FloatTensor): indicator {0,1} for terminal states (dimension: batch x 1)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        gamma (float): discount factor</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        TD-loss</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="c1"># forward value</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">q_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="c1"># forward target</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">q_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_target</span><span class="p">(</span><span class="n">s2_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">q_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_target_ddqn</span><span class="p">(</span><span class="n">s2_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                                             <span class="n">gamma</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="c1"># loss</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fun</span><span class="p">(</span><span class="n">q_val</span><span class="p">,</span> <span class="n">q_target</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;models/dqn&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.save" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Save model weights</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>path</code></td>
        <td><code>str</code></td>
        <td><p>path to model folder</p></td>
        <td><code>&#39;models/dqn&#39;</code></td>
      </tr>
      <tr>
        <td><code>version</code></td>
        <td><code>str</code></td>
        <td><p>appendix to filename, enables having multiple models for the same domain
           (or saving a model after each training epoch)</p></td>
        <td><code>&#39;1.0&#39;</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;dqn&#39;</span><span class="p">),</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Save model weights</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        path (str): path to model folder</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        version (str): appendix to filename, enables having multiple models for the same domain</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                       (or saving a model after each training epoch)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">model_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rlpolicy_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.select_action_eps_greedy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">select_action_eps_greedy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.select_action_eps_greedy" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Epsilon-greedy policy.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>state_vector</code></td>
        <td><code>torch.FloatTensor</code></td>
        <td><p>current state (dimension 1 x state_dim)</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>action index for action selected by the agent for the current state</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">select_action_eps_greedy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Epsilon-greedy policy.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        state_vector (torch.FloatTensor): current state (dimension 1 x state_dim)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        action index for action selected by the agent for the current state</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eps_scheduler</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="c1"># epsilon greedy exploration</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="ow">and</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">next_action_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">state_vector</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="n">next_action_idx</span> <span class="o">=</span> <span class="n">q_values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">return</span> <span class="n">next_action_idx</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.train" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Sets module and its subgraph to training mode </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Sets module and its subgraph to training mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">DQNPolicy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.dqnpolicy.DQNPolicy.train_batch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.dqnpolicy.DQNPolicy.train_batch" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Train on a minibatch drawn from the experience buffer. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">train_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Train on a minibatch drawn from the experience buffer. &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="k">return</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">10</span> <span class="ow">and</span> \
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">s2_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">importance_weights</span> <span class="o">=</span> \
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="n">s_batch</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">gamma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">discount_gamma</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                             <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="c1"># calculate loss</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">s2_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">if</span> <span class="n">importance_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">*</span> <span class="n">importance_weights</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="c1"># importance weighting</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="c1"># update priorities</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="c1"># clip gradients</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_clipping</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_clipping</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="c1"># update weights</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="n">current_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>            <span class="c1"># plot loss</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/loss&#39;</span><span class="p">,</span> <span class="n">current_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="c1"># plot min/max gradients</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="n">max_grad_norm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="n">min_grad_norm</span> <span class="o">=</span> <span class="mf">1000000.0</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                    <span class="c1"># TODO decide on norm</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>                    <span class="n">current_grad_norm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>                    <span class="k">if</span> <span class="n">current_grad_norm</span> <span class="o">&gt;</span> <span class="n">max_grad_norm</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                        <span class="n">max_grad_norm</span> <span class="o">=</span> <span class="n">current_grad_norm</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>                    <span class="k">if</span> <span class="n">current_grad_norm</span> <span class="o">&lt;</span> <span class="n">min_grad_norm</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>                        <span class="n">min_grad_norm</span> <span class="o">=</span> <span class="n">current_grad_norm</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/min_grad&#39;</span><span class="p">,</span> <span class="n">min_grad_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/max_grad&#39;</span><span class="p">,</span> <span class="n">max_grad_norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="c1"># update target net</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">train_call_count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_update_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.policy.rl.experience_buffer" class="doc doc-heading">
        <code>experience_buffer</code>



<a href="#adviser.services.policy.rl.experience_buffer" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.experience_buffer.Buffer" class="doc doc-heading">
        <code>
Buffer        </code>



<a href="#adviser.services.policy.rl.experience_buffer.Buffer" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Base class for experience replay buffers</p>
<p>Initializes the memory, provides a print function for the memory contents 
and a method to insert new items into the buffer.
Sampling has to be implemented by child classes.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Buffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Base class for experience replay buffers</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Initializes the memory, provides a print function for the memory contents </span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    and a method to insert new items into the buffer.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Sampling has to be implemented by child classes.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                 <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">assert</span> <span class="n">buffer_size</span> <span class="o">&gt;=</span> <span class="n">batch_size</span><span class="p">,</span> <span class="s1">&#39;the buffer hast to be larger than the batch size&#39;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">discount_gamma</span> <span class="o">=</span> <span class="n">discount_gamma</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="c1"># construct memory</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="sd">&quot;&quot;&quot; Reset the state between consecutive dialogs</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">            Will be executed automatically after store with terminal=True was</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">            called.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_state</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_reward</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>              <span class="n">terminal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="sd">&quot;&quot;&quot; Store an experience of the form (s,a,r,s&#39;,t).</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="sd">        Only needs the current state s (will construct transition to s&#39;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="sd">        automatically).</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">            state (torch.tensor): this turn&#39;s state tensor, or None if terminal = True</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">            action (torch.tensor): this turn&#39;s action index (int), or None if terminal = True</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">            reward (torch.tensor): this turn&#39;s reward (float)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">            terminal (bool): indicates whether episode finished (boolean)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="n">reward</span> <span class="o">/=</span> <span class="mf">20.0</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_state</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>  <span class="c1"># and terminal == False:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="c1"># first turn of trajectory, don&#39;t record since s&#39; is needed</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="n">action</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_reward</span> <span class="o">=</span> <span class="n">reward</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>            <span class="k">if</span> <span class="n">terminal</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>                    <span class="c1"># update last state&#39;s reward and set it to terminal</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reward</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>                <span class="c1"># in-between turn of trajectory: record</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">]</span> <span class="o">=</span> \
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">last_state</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_reward</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>                <span class="c1"># update last encountered state</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="n">action</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_reward</span> <span class="o">=</span> <span class="n">reward</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>                <span class="c1"># update write index</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>    <span class="k">def</span> <span class="nf">print_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="sd">&quot;&quot;&quot; Print contents of the experience replay memory.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a><span class="sd">            max_size (int): restrict the number of printed items to this number (if not None)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="c1"># how many entries to print</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="n">print_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>            <span class="n">print_items</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">print_items</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# REPLAY BUFFER CAPACITY: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# CURRENT ITEM COUNT&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">print_items</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;entry &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  action&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  reward&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  terminal&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------&#39;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>            <span class="c1"># TODO finish printing buffer (state, reward, actions, belief?)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>        <span class="sd">&quot;&quot;&quot; Returns the number of items currently inside the buffer &quot;&quot;&quot;</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>        <span class="sd">&quot;&quot;&quot; Sample from buffer, has to be implemented by subclasses &quot;&quot;&quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.Buffer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.experience_buffer.Buffer.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">assert</span> <span class="n">buffer_size</span> <span class="o">&gt;=</span> <span class="n">batch_size</span><span class="p">,</span> <span class="s1">&#39;the buffer hast to be larger than the batch size&#39;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">discount_gamma</span> <span class="o">=</span> <span class="n">discount_gamma</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="c1"># construct memory</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.Buffer.__len__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.experience_buffer.Buffer.__len__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Returns the number of items currently inside the buffer </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Returns the number of items currently inside the buffer &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.Buffer.print_contents" class="doc doc-heading">
<code class="highlight language-python"><span class="n">print_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.experience_buffer.Buffer.print_contents" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Print contents of the experience replay memory.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>max_size</code></td>
        <td><code>int</code></td>
        <td><p>restrict the number of printed items to this number (if not None)</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">print_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Print contents of the experience replay memory.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        max_size (int): restrict the number of printed items to this number (if not None)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="c1"># how many entries to print</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">print_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">print_items</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">print_items</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# REPLAY BUFFER CAPACITY: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# CURRENT ITEM COUNT&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">print_items</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;entry &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  action&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  reward&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  terminal&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------&#39;</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="c1"># TODO finish printing buffer (state, reward, actions, belief?)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.Buffer.sample" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.experience_buffer.Buffer.sample" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Sample from buffer, has to be implemented by subclasses </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Sample from buffer, has to be implemented by subclasses &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.Buffer.store" class="doc doc-heading">
<code class="highlight language-python"><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.experience_buffer.Buffer.store" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Store an experience of the form (s,a,r,s',t).</p>
<p>Only needs the current state s (will construct transition to s'
automatically).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>state</code></td>
        <td><code>torch.tensor</code></td>
        <td><p>this turn's state tensor, or None if terminal = True</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>action</code></td>
        <td><code>torch.tensor</code></td>
        <td><p>this turn's action index (int), or None if terminal = True</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>reward</code></td>
        <td><code>torch.tensor</code></td>
        <td><p>this turn's reward (float)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>terminal</code></td>
        <td><code>bool</code></td>
        <td><p>indicates whether episode finished (boolean)</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>          <span class="n">terminal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot; Store an experience of the form (s,a,r,s&#39;,t).</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Only needs the current state s (will construct transition to s&#39;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    automatically).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        state (torch.tensor): this turn&#39;s state tensor, or None if terminal = True</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        action (torch.tensor): this turn&#39;s action index (int), or None if terminal = True</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        reward (torch.tensor): this turn&#39;s reward (float)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        terminal (bool): indicates whether episode finished (boolean)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">reward</span> <span class="o">/=</span> <span class="mf">20.0</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_state</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>  <span class="c1"># and terminal == False:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="c1"># first turn of trajectory, don&#39;t record since s&#39; is needed</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="n">action</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_reward</span> <span class="o">=</span> <span class="n">reward</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="k">if</span> <span class="n">terminal</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="c1"># update last state&#39;s reward and set it to terminal</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reward</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="c1"># in-between turn of trajectory: record</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">]</span> <span class="o">=</span> \
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_state</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_reward</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>            <span class="c1"># update last encountered state</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="n">action</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_reward</span> <span class="o">=</span> <span class="n">reward</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="c1"># update write index</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer" class="doc doc-heading">
        <code>
NaivePrioritizedBuffer            (<a class="autorefs autorefs-internal" title="adviser.services.policy.rl.experience_buffer.Buffer" href="#adviser.services.policy.rl.experience_buffer.Buffer">Buffer</a>)
        </code>



<a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Prioritized experience replay buffer.</p>
<p>Assigns sampling probabilities dependent on TD-error of the transitions.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">NaivePrioritizedBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Prioritized experience replay buffer.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Assigns sampling probabilities dependent on TD-error of the transitions.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                 <span class="n">sample_last_transition</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                 <span class="n">regularisation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="n">exponent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                 <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">NaivePrioritizedBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                                                     <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                                                     <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  REPLAY MEMORY: NAIVE Prioritized&quot;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">buffer_size</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regularisation</span> <span class="o">=</span> <span class="n">regularisation</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="n">exponent</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span> <span class="o">=</span> <span class="n">sample_last_transition</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># TODO anneal beta over time (see paper prioritized experience replay)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="c1"># note: did not make a significant difference with the tested parameters</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="c1"># - is it worth to re-implement that feature?</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="k">def</span> <span class="nf">_priority_to_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="sd">&quot;&quot;&quot; Convert priority number to probability space (inside [0,1]) &quot;&quot;&quot;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">priority</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularisation</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>              <span class="n">terminal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="sd">&quot;&quot;&quot; Store an experience of the form (s,a,r,s&#39;,t).</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">        Only needs the current state s (will construct transition to s&#39;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">        automatically).</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">        Newly added experience tuples will be assigned maximum priority.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">            state: this turn&#39;s state tensor, or None if terminal = True</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">            action: this turn&#39;s action index (int), or None if terminal = True</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">            reward: this turn&#39;s reward (float)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">            terminal: indicates whether episode finished (boolean)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="k">if</span> <span class="nb">super</span><span class="p">(</span><span class="n">NaivePrioritizedBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="n">terminal</span><span class="p">):</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="c1"># create new tree node only if something new was added to the buffers</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority_to_probability</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_p</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="sd">&quot;&quot;&quot; Update the priority of transition with index idx &quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority_to_probability</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span> <span class="o">=</span> <span class="n">p</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="sd">&quot;&quot;&quot; Sample from buffer.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">            states, actions, rewards, next states, terminal state indicator {0,1}, buffer indices,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">            importance weights</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="n">batch_write_pos</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="n">data_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="n">p_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span><span class="p">],</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span><span class="p">)),</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>                                             <span class="n">p</span><span class="o">=</span><span class="n">p_normed</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>            <span class="c1"># include last transition (was at tree.write - 1) </span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>            <span class="c1"># -&gt; see Sutton: A deeper look at experience replay</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="n">data_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>            <span class="n">probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="c1"># correct size of batch</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="n">batch_write_pos</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>        <span class="c1"># TODO add option to sample each segment uniformly</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_write_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>            <span class="n">data_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>            <span class="n">probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">data_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>        <span class="c1"># assemble batch from data indices</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="n">s_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>        <span class="n">a_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>        <span class="n">r_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>        <span class="n">t_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="n">s2_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>        <span class="c1"># calculate importance sampling weights</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="n">importance_weights</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">*</span> <span class="n">probabilities</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>        <span class="n">importance_weights</span> <span class="o">=</span> <span class="n">importance_weights</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>        <span class="n">importance_weights</span> <span class="o">=</span> <span class="n">importance_weights</span> <span class="o">/</span> <span class="n">importance_weights</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>        <span class="k">return</span> <span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">s2_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">,</span> \
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>               <span class="n">importance_weights</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">sample_last_transition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regularisation</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">sample_last_transition</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">regularisation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="n">exponent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>             <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">NaivePrioritizedBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                                                 <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                                                 <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  REPLAY MEMORY: NAIVE Prioritized&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">buffer_size</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">regularisation</span> <span class="o">=</span> <span class="n">regularisation</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="n">exponent</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span> <span class="o">=</span> <span class="n">sample_last_transition</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="c1"># TODO anneal beta over time (see paper prioritized experience replay)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="c1"># note: did not make a significant difference with the tested parameters</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="c1"># - is it worth to re-implement that feature?</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.sample" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.sample" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Sample from buffer.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>states, actions, rewards, next states, terminal state indicator {0,1}, buffer indices,
importance weights</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Sample from buffer.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        states, actions, rewards, next states, terminal state indicator {0,1}, buffer indices,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        importance weights</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">batch_write_pos</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">data_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">p_normed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span><span class="p">],</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span><span class="p">)),</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                                         <span class="n">p</span><span class="o">=</span><span class="n">p_normed</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># include last transition (was at tree.write - 1) </span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="c1"># -&gt; see Sutton: A deeper look at experience replay</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">data_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="n">probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="c1"># correct size of batch</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">batch_write_pos</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="c1"># TODO add option to sample each segment uniformly</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_write_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="n">data_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="n">probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">data_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="c1"># assemble batch from data indices</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="n">s_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="n">a_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="n">r_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="n">t_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="n">s2_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="c1"># calculate importance sampling weights</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="n">importance_weights</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">*</span> <span class="n">probabilities</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="n">importance_weights</span> <span class="o">=</span> <span class="n">importance_weights</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="n">importance_weights</span> <span class="o">=</span> <span class="n">importance_weights</span> <span class="o">/</span> <span class="n">importance_weights</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="k">return</span> <span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">r_batch</span><span class="p">,</span> <span class="n">s2_batch</span><span class="p">,</span> <span class="n">t_batch</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">,</span> \
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>           <span class="n">importance_weights</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.store" class="doc doc-heading">
<code class="highlight language-python"><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.store" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Store an experience of the form (s,a,r,s',t).</p>
<p>Only needs the current state s (will construct transition to s'
automatically).</p>
<p>Newly added experience tuples will be assigned maximum priority.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>state</code></td>
        <td><code>FloatTensor</code></td>
        <td><p>this turn's state tensor, or None if terminal = True</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>action</code></td>
        <td><code>LongTensor</code></td>
        <td><p>this turn's action index (int), or None if terminal = True</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>reward</code></td>
        <td><code>float</code></td>
        <td><p>this turn's reward (float)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>terminal</code></td>
        <td><code>bool</code></td>
        <td><p>indicates whether episode finished (boolean)</p></td>
        <td><code>False</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>          <span class="n">terminal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot; Store an experience of the form (s,a,r,s&#39;,t).</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Only needs the current state s (will construct transition to s&#39;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    automatically).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Newly added experience tuples will be assigned maximum priority.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        state: this turn&#39;s state tensor, or None if terminal = True</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        action: this turn&#39;s action index (int), or None if terminal = True</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        reward: this turn&#39;s reward (float)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        terminal: indicates whether episode finished (boolean)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">if</span> <span class="nb">super</span><span class="p">(</span><span class="n">NaivePrioritizedBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="n">terminal</span><span class="p">):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="c1"># create new tree node only if something new was added to the buffers</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority_to_probability</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_p</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.update" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.experience_buffer.NaivePrioritizedBuffer.update" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Update the priority of transition with index idx </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Update the priority of transition with index idx &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority_to_probability</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span> <span class="o">=</span> <span class="n">p</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.experience_buffer.UniformBuffer" class="doc doc-heading">
        <code>
UniformBuffer            (<a class="autorefs autorefs-internal" title="adviser.services.policy.rl.experience_buffer.Buffer" href="#adviser.services.policy.rl.experience_buffer.Buffer">Buffer</a>)
        </code>



<a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Experience replay buffer with uniformly random sampling </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">UniformBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Experience replay buffer with uniformly random sampling &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                 <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">sample_last_transition</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                 <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            sample_last_transition (bool): if True, a batch will always include the most recent</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">                                           transition</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">                                           (see Sutton: A deeper look at experience replay)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">UniformBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                                            <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                                            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  REPLAY MEMORY: Uniform&quot;</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span> <span class="o">=</span> <span class="n">sample_last_transition</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="sd">&quot;&quot;&quot; Sample from buffer.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">            states, actions, rewards, next states, terminal state indicator {0,1}, buffer indices,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">            None</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="c1"># create random indices</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">data_indices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="c1"># include last transition (was at write - 1)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="c1"># - see Sutton: A deeper look at experience replay</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                <span class="c1"># last transition filled the capacity of the buffer</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">data_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                <span class="n">data_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="n">data_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                             <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span><span class="p">))])</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">data_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">state_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="n">action_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="n">reward_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="n">next_state_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="n">terminal_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="k">return</span> <span class="n">state_batch</span><span class="p">,</span> <span class="n">action_batch</span><span class="p">,</span> <span class="n">reward_batch</span><span class="p">,</span> <span class="n">next_state_batch</span><span class="p">,</span> <span class="n">terminal_batch</span><span class="p">,</span> \
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>               <span class="n">data_indices</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.UniformBuffer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">sample_last_transition</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>sample_last_transition</code></td>
        <td><code>bool</code></td>
        <td><p>if True, a batch will always include the most recent
                           transition
                           (see Sutton: A deeper look at experience replay)</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">discount_gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">sample_last_transition</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        sample_last_transition (bool): if True, a batch will always include the most recent</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                                       transition</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">                                       (see Sutton: A deeper look at experience replay)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">UniformBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                                        <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                                        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  REPLAY MEMORY: Uniform&quot;</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span> <span class="o">=</span> <span class="n">sample_last_transition</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.experience_buffer.UniformBuffer.sample" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.experience_buffer.UniformBuffer.sample" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Sample from buffer.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>states, actions, rewards, next states, terminal state indicator {0,1}, buffer indices,
None</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/experience_buffer.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Sample from buffer.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        states, actions, rewards, next states, terminal state indicator {0,1}, buffer indices,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        None</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="c1"># create random indices</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">data_indices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="c1"># include last transition (was at write - 1)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="c1"># - see Sutton: A deeper look at experience replay</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="c1"># last transition filled the capacity of the buffer</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="n">data_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="n">data_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">data_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                         <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_last_transition</span><span class="p">))])</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">data_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="n">state_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">action_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_action</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="n">reward_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_reward</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="n">next_state_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_next_state</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="n">terminal_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_terminal</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_indices</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="k">return</span> <span class="n">state_batch</span><span class="p">,</span> <span class="n">action_batch</span><span class="p">,</span> <span class="n">reward_batch</span><span class="p">,</span> <span class="n">next_state_batch</span><span class="p">,</span> <span class="n">terminal_batch</span><span class="p">,</span> \
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>           <span class="n">data_indices</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.policy.rl.policy_rl" class="doc doc-heading">
        <code>policy_rl</code>



<a href="#adviser.services.policy.rl.policy_rl" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="adviser.services.policy.rl.policy_rl.RLPolicy" class="doc doc-heading">
        <code>
RLPolicy        </code>



<a href="#adviser.services.policy.rl.policy_rl.RLPolicy" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Base class for Reinforcement Learning based policies.</p>
<p>Functionality provided includes the setup of state- and action spaces,
conversion of <code>BeliefState</code> objects into pytorch tensors,
updating the last performed system actions and informed entities,
populating the experience replay buffer,
extraction of most probable user hypothesis and candidate action expansion.</p>
<p>Output of an agent is a candidate action like
<code>inform_food</code>
which is then populated with the most probable slot/value pair from the
beliefstate and database candidates by the <code>expand_system_action</code>-function to become
<code>inform(slot=food,value=italian)</code>.</p>
<p>In order to create your own policy, you can inherit from this class.
Make sure to call the <code>turn_end</code>-function after each system turn and the <code>end_dialog</code>-function
after each completed dialog.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">RLPolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Base class for Reinforcement Learning based policies.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Functionality provided includes the setup of state- and action spaces,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    conversion of `BeliefState` objects into pytorch tensors,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    updating the last performed system actions and informed entities,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    populating the experience replay buffer,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    extraction of most probable user hypothesis and candidate action expansion.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    Output of an agent is a candidate action like</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    ``inform_food``</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    which is then populated with the most probable slot/value pair from the</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    beliefstate and database candidates by the `expand_system_action`-function to become</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">    ``inform(slot=food,value=italian)``.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    In order to create your own policy, you can inherit from this class.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">    Make sure to call the `turn_end`-function after each system turn and the `end_dialog`-function</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">    after each completed dialog.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=</span><span class="n">UniformBuffer</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                 <span class="n">buffer_size</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                 <span class="n">include_confreq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                 <span class="n">include_select</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">        Creates state- and action spaces, initializes experience replay</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">        buffers.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">        Arguments:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">            domain {domain.jsonlookupdomain.JSONLookupDomain} -- Domain</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">        Keyword Arguments:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">            subgraph {[type]} -- [see services.Module] (default: {None})</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">            buffer_cls {services.policy.rl.experience_buffer.Buffer}</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">            -- [Experience replay buffer *class*, **not** an instance - will be</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">                initialized by this constructor!] (default: {UniformBuffer})</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">            buffer_size {int} -- [see services.policy.rl.experience_buffer.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">                                  Buffer] (default: {6000})</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">            batch_size {int} -- [see services.policy.rl.experience_buffer.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">                                  Buffer] (default: {64})</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">            discount_gamma {float} -- [Discount factor] (default: {0.99})</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">            include_confreq {bool} -- [Use confirm_request actions]</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">                                       (default: {False})</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="s2">&quot;lastInformedPrimKeyVal&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>            <span class="s2">&quot;lastActionInformNone&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="s2">&quot;offerHappened&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_turns</span> <span class="o">=</span> <span class="n">max_turns</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="c1"># setup evaluator for training</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">ObjectiveReachedEvaluator</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">discount_gamma</span> <span class="o">=</span> <span class="n">discount_gamma</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="c1"># get state size</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beliefstate_dict_to_vector</span><span class="p">(</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="n">BeliefState</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">_init_beliefstate</span><span class="p">())</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;state space dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">))</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="c1"># get system action list</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;inform_byname&quot;</span><span class="p">,</span>  <span class="c1"># TODO rename to &#39;bykey&#39;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>                        <span class="s2">&quot;inform_alternatives&quot;</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>                        <span class="s2">&quot;reqmore&quot;</span><span class="p">]</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="c1"># TODO badaction</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="k">for</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">():</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;request#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;confirm#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>            <span class="k">if</span> <span class="n">include_select</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;select#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="k">if</span> <span class="n">include_confreq</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                <span class="k">for</span> <span class="n">conf_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">():</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">req_slot</span> <span class="o">==</span> <span class="n">conf_slot</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>                        <span class="c1"># skip case where confirm slot = request slot</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;confreq#&#39;</span> <span class="o">+</span> <span class="n">conf_slot</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>                                            <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="c1"># don&#39;t include closingmsg in learnable actions</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;closingmsg&#39;</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>        <span class="c1"># self.actions.append(&quot;closingmsg&quot;)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;action space dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span><span class="p">))</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="c1"># init replay memory</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_cls</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>                                 <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>    <span class="k">def</span> <span class="nf">action_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="sd">&quot;&quot;&quot; Returns the action name for the specified action index &quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">action_idx</span><span class="p">]</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>    <span class="k">def</span> <span class="nf">action_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>        <span class="sd">&quot;&quot;&quot; Returns the action index for the specified action name &quot;&quot;&quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>    <span class="k">def</span> <span class="nf">beliefstate_dict_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>        <span class="sd">&quot;&quot;&quot; Converts the beliefstate dict to a torch tensor</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a><span class="sd">            beliefstate: dict of belief (with at least beliefs and system keys)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a><span class="sd">            belief tensor with dimension 1 x state_dim</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>        <span class="n">belief_vec</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>        <span class="c1"># add user acts</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>        <span class="n">belief_vec</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">UserActionType</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>        <span class="c1"># handle none actions</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">belief_vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>        <span class="c1"># add informs (including special flag if slot not mentioned)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">()):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;dontcare&quot;</span><span class="p">]</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>                <span class="c1"># add **NONE** value first, then 0.0 for all others</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>                <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>                <span class="c1"># also add value for don&#39;t care</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>                <span class="n">belief_vec</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))]</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>                <span class="c1"># add **NONE** value first</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>                <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>                <span class="n">bs_slot</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">slot</span><span class="p">]</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>                <span class="n">belief_vec</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bs_slot</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">bs_slot</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>        <span class="c1"># add requests</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">()):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>            <span class="k">if</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>                <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>                <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>        <span class="c1"># append system features</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastActionInformNone&#39;</span><span class="p">]))</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;offerHappened&#39;</span><span class="p">]))</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>        <span class="n">candidate_count</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;num_matches&#39;</span><span class="p">]</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>        <span class="c1"># buckets for match count: 0, 1, 2-4, &gt;4</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">candidate_count</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;discriminable&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>        <span class="c1"># convert to torch tensor</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">belief_vec</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>    <span class="k">def</span> <span class="nf">_remove_dontcare_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot_value_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>        <span class="sd">&quot;&quot;&quot; Returns a new dictionary without the slots set to dontcare &quot;&quot;&quot;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>        <span class="k">return</span> <span class="p">{</span><span class="n">slot</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">slot_value_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">}</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>    <span class="k">def</span> <span class="nf">_get_slotnames_from_actionname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>        <span class="sd">&quot;&quot;&quot; Return the slot names of an action of format &#39;action_slot1_slot2_...&#39; &quot;&quot;&quot;</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>        <span class="k">return</span> <span class="n">action_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>    <span class="k">def</span> <span class="nf">_db_results_to_sysact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">constraints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">db_entity</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>        <span class="sd">&quot;&quot;&quot; Adds values of db_entity to constraints of sys_act</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a><span class="sd">            (primary key is always added).</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a><span class="sd">            Omits values which are not available in database. &quot;&quot;&quot;</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>        <span class="k">for</span> <span class="n">constraint_slot</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>            <span class="k">if</span> <span class="n">constraints</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dontcare&#39;</span> <span class="ow">and</span> \
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>                    <span class="n">constraint_slot</span> <span class="ow">in</span> <span class="n">db_entity</span> <span class="ow">and</span> \
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a>                    <span class="n">db_entity</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;not available&#39;</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>                <span class="c1"># fill user dontcare with database value</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">constraint_slot</span><span class="p">,</span> <span class="n">db_entity</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">])</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a>                <span class="k">if</span> <span class="n">constraint_slot</span> <span class="ow">in</span> <span class="n">db_entity</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>                    <span class="c1"># fill with database value</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>                    <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">constraint_slot</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>                                      <span class="n">db_entity</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">])</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>                    <span class="c1"># slot not in db entity -&gt; create warning</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Slot &quot;</span> <span class="o">+</span> <span class="n">constraint_slot</span> <span class="o">+</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>                                        <span class="s2">&quot; not found in db entity &quot;</span> <span class="o">+</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>                                        <span class="n">db_entity</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">])</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>        <span class="c1"># ensure primary key is included</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">db_entity</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">])</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>    <span class="k">def</span> <span class="nf">_expand_byconstraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>        <span class="sd">&quot;&quot;&quot; Create inform act with an entity from the database, if any matches</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a><span class="sd">            could be found for the constraints, otherwise will return an inform</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a><span class="sd">            act with primary key=none &quot;&quot;&quot;</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Inform</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>        <span class="c1"># get constraints and query db by them</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>        <span class="n">constraints</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>                                                                <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>        <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">requested_slots</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>            <span class="c1"># no matching entity found -&gt; return inform with primary key=none</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>            <span class="c1"># and other constraints</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>            <span class="n">filtered_slot_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>            <span class="n">filtered_slots</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>                <span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>                <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">filtered_slots</span><span class="p">:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>            <span class="c1"># match found -&gt; return its name</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>            <span class="c1"># if &gt; 1 match and matches contain last informed entity,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>            <span class="c1"># stick to this</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">db_match</span> <span class="k">for</span> <span class="n">db_match</span> <span class="ow">in</span> <span class="n">db_matches</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>                     <span class="k">if</span> <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span> <span class="o">==</span>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>                     <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]]</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>                <span class="c1"># none matches last informed venue -&gt; pick first result</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>                <span class="c1"># match = db_matches[0]</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">db_matches</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>            <span class="c1"># fill act with values from db</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_db_results_to_sysact</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a>    <span class="k">def</span> <span class="nf">_expand_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a>        <span class="sd">&quot;&quot;&quot; Expand request_*slot* action &quot;&quot;&quot;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>        <span class="n">req_slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>    <span class="k">def</span> <span class="nf">_expand_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>        <span class="sd">&quot;&quot;&quot; Expand select_*slot* action &quot;&quot;&quot;</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Select</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>        <span class="n">sel_slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a>        <span class="n">most_likely_choice</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_slot_beliefs</span><span class="p">(</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a>            <span class="n">consider_NONE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">sel_slot</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a>        <span class="n">first_value</span> <span class="o">=</span> <span class="n">most_likely_choice</span><span class="p">[</span><span class="n">sel_slot</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>        <span class="n">second_value</span> <span class="o">=</span> <span class="n">most_likely_choice</span><span class="p">[</span><span class="n">sel_slot</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a>        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">sel_slot</span><span class="p">,</span> <span class="n">first_value</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a>        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">sel_slot</span><span class="p">,</span> <span class="n">second_value</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>    <span class="k">def</span> <span class="nf">_expand_confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>        <span class="sd">&quot;&quot;&quot; Expand confirm_*slot* action &quot;&quot;&quot;</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Confirm</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a>        <span class="n">conf_slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>                                                               <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>        <span class="c1"># If the slot isn&#39;t in the beliefstate choose a random value from the ontology</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>        <span class="n">conf_value</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">conf_slot</span><span class="p">]</span> <span class="k">if</span> <span class="n">conf_slot</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">conf_slot</span><span class="p">))</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">conf_slot</span><span class="p">,</span> <span class="n">conf_value</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>    <span class="k">def</span> <span class="nf">_expand_confreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>        <span class="sd">&quot;&quot;&quot; Expand confreq_*confirmslot*_*requestslot* action &quot;&quot;&quot;</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">ConfirmRequest</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>        <span class="c1"># first slot name is confirmation, second is request</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>        <span class="n">slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>        <span class="n">conf_slot</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>        <span class="n">req_slot</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>        <span class="c1"># get value that needs confirmation</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>                                                               <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>        <span class="n">conf_value</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">conf_slot</span><span class="p">]</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">conf_slot</span><span class="p">,</span> <span class="n">conf_value</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>        <span class="c1"># add request slot</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>    <span class="k">def</span> <span class="nf">_expand_informbyname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>        <span class="sd">&quot;&quot;&quot; Expand inform_byname action &quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>        <span class="c1"># get most probable entity primary key</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>            <span class="n">primkeyval</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>                <span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;informs&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>            <span class="c1"># try to use previously informed name instead</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>            <span class="n">primkeyval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>            <span class="c1"># TODO change behaviour from here, because primkeyval might be &quot;**NONE**&quot; and this might be an entity in the database</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>        <span class="c1"># find db entry by primary key</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>        <span class="n">constraints</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>                                                                <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>        <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">({</span><span class="o">**</span><span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span> <span class="n">primkeyval</span><span class="p">})</span>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>        <span class="c1"># NOTE usually not needed to give all constraints (shouldn&#39;t make a difference)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a>            <span class="c1"># select random entity if none could be found</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>            <span class="n">primkeyvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a>            <span class="n">primkeyval</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">primkeyvals</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>            <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a>                <span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">())</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>            <span class="c1"># use knowledge from current belief state</span>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>            <span class="c1"># no results found</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>            <span class="n">filtered_slot_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>                    <span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>                    <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>                <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>            <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>        <span class="c1"># select random match</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>        <span class="n">db_match</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">db_matches</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>        <span class="n">db_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>            <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">],</span> <span class="n">requested_slots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>        <span class="c1"># get slots requested by user</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>        <span class="n">usr_requests</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_requested_slots</span><span class="p">()</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>        <span class="c1"># remove primary key (to exlude from minimum number) since it is added anyway at the end</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">in</span> <span class="n">usr_requests</span><span class="p">:</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>            <span class="n">usr_requests</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>        <span class="k">if</span> <span class="n">usr_requests</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>            <span class="c1"># add user requested values into system act using db result</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>            <span class="k">for</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">usr_requests</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">usr_requests</span><span class="p">)),</span>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a>                                                       <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>                <span class="k">if</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="n">db_match</span><span class="p">:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a>                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">,</span> <span class="n">db_match</span><span class="p">[</span><span class="n">req_slot</span><span class="p">])</span>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a>                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a>            <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a>            <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a>                <span class="k">for</span> <span class="n">inform_slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>                        <span class="nb">list</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>                        <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>                    <span class="n">value</span> <span class="o">=</span> <span class="n">db_match</span><span class="p">[</span><span class="n">inform_slot</span><span class="p">]</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">inform_slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>                <span class="c1"># add random slot and value if no user request was detected</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>                <span class="n">usr_requestable_slots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">())</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>                <span class="n">usr_requestable_slots</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a>                <span class="n">random_slot</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">usr_requestable_slots</span><span class="p">))</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">db_match</span><span class="p">[</span><span class="n">random_slot</span><span class="p">]</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>                <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">random_slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>        <span class="c1"># ensure entity primary key is included</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">])</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>    <span class="k">def</span> <span class="nf">_expand_informbyalternatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>        <span class="sd">&quot;&quot;&quot; Expand inform_byalternatives action &quot;&quot;&quot;</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>        <span class="c1"># get set of all previously informed primary key values</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>        <span class="n">informedPrimKeyValsSinceNone</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">])</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>                                                               <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a>        <span class="n">filtered_slot_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a>        <span class="c1"># query db by constraints</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>        <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>            <span class="c1"># no results found</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a>                    <span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a>                    <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>                <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>            <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>        <span class="c1"># don&#39;t inform about already informed entities</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a>        <span class="c1"># -&gt; exclude primary key values from informedPrimKeyValsSinceNone</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>        <span class="k">for</span> <span class="n">db_match</span> <span class="ow">in</span> <span class="n">db_matches</span><span class="p">:</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a>            <span class="k">if</span> <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">informedPrimKeyValsSinceNone</span><span class="p">:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>                <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a>                        <span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>                        <span class="nb">min</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a>                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>                <span class="n">additional_constraints</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a>                <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a>                        <span class="n">additional_constraints</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>                <span class="n">db_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a>                    <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">],</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>                    <span class="n">requested_slots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_db_results_to_sysact</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">additional_constraints</span><span class="p">,</span> <span class="n">db_match</span><span class="p">)</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>                <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a>        <span class="c1"># no alternatives found (that were not already mentioned)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a>        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a>    <span class="k">def</span> <span class="nf">_expand_bye</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a>        <span class="sd">&quot;&quot;&quot; Expand bye action &quot;&quot;&quot;</span>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a>    <span class="k">def</span> <span class="nf">_expand_reqmore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a>        <span class="sd">&quot;&quot;&quot; Expand reqmore action &quot;&quot;&quot;</span>
<a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a>        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span>
<a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a>        <span class="k">return</span> <span class="n">act</span>
<a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a>    <span class="k">def</span> <span class="nf">expand_system_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a>        <span class="sd">&quot;&quot;&quot; Expands an action index to a real sytem act &quot;&quot;&quot;</span>
<a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a>        <span class="n">action_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_name</span><span class="p">(</span><span class="n">action_idx</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a>        <span class="k">if</span> <span class="s1">&#39;request#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_request</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a>        <span class="k">elif</span> <span class="s1">&#39;select#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_select</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a>        <span class="k">elif</span> <span class="s1">&#39;confirm#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_confirm</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a>        <span class="k">elif</span> <span class="s1">&#39;confreq#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-437" name="__codelineno-0-437" href="#__codelineno-0-437"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_confreq</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438" href="#__codelineno-0-438"></a>        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;inform_byname&#39;</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439" href="#__codelineno-0-439"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_informbyname</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440" href="#__codelineno-0-440"></a>        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;inform_alternatives&#39;</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441" href="#__codelineno-0-441"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_informbyalternatives</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442" href="#__codelineno-0-442"></a>        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;closingmsg&#39;</span><span class="p">:</span>
<a id="__codelineno-0-443" name="__codelineno-0-443" href="#__codelineno-0-443"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_bye</span><span class="p">()</span>
<a id="__codelineno-0-444" name="__codelineno-0-444" href="#__codelineno-0-444"></a>        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;repeat&#39;</span><span class="p">:</span>
<a id="__codelineno-0-445" name="__codelineno-0-445" href="#__codelineno-0-445"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span>
<a id="__codelineno-0-446" name="__codelineno-0-446" href="#__codelineno-0-446"></a>        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;reqmore&#39;</span><span class="p">:</span>
<a id="__codelineno-0-447" name="__codelineno-0-447" href="#__codelineno-0-447"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_reqmore</span><span class="p">()</span>
<a id="__codelineno-0-448" name="__codelineno-0-448" href="#__codelineno-0-448"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449" href="#__codelineno-0-449"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RL POLICY: system action not supported: &quot;</span> <span class="o">+</span>
<a id="__codelineno-0-450" name="__codelineno-0-450" href="#__codelineno-0-450"></a>                                <span class="n">action_name</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451" href="#__codelineno-0-451"></a>
<a id="__codelineno-0-452" name="__codelineno-0-452" href="#__codelineno-0-452"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-453" name="__codelineno-0-453" href="#__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454" href="#__codelineno-0-454"></a>    <span class="k">def</span> <span class="nf">_update_system_belief</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-455" name="__codelineno-0-455" href="#__codelineno-0-455"></a>        <span class="sd">&quot;&quot;&quot; Update the system&#39;s belief state features &quot;&quot;&quot;</span>
<a id="__codelineno-0-456" name="__codelineno-0-456" href="#__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457" href="#__codelineno-0-457"></a>        <span class="c1"># check if system informed an entity primary key vlaue this turn</span>
<a id="__codelineno-0-458" name="__codelineno-0-458" href="#__codelineno-0-458"></a>        <span class="c1"># (and remember it), otherwise, keep previous one</span>
<a id="__codelineno-0-459" name="__codelineno-0-459" href="#__codelineno-0-459"></a>        <span class="c1"># reset, if primary key value == none (found no matching entities)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460" href="#__codelineno-0-460"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastActionInformNone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-461" name="__codelineno-0-461" href="#__codelineno-0-461"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;offerHappened&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-462" name="__codelineno-0-462" href="#__codelineno-0-462"></a>        <span class="n">informed_names</span> <span class="o">=</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463" href="#__codelineno-0-463"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">informed_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464" href="#__codelineno-0-464"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;offerHappened&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-465" name="__codelineno-0-465" href="#__codelineno-0-465"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-466" name="__codelineno-0-466" href="#__codelineno-0-466"></a>            <span class="k">if</span> <span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467" href="#__codelineno-0-467"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-468" name="__codelineno-0-468" href="#__codelineno-0-468"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastActionInformNone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-469" name="__codelineno-0-469" href="#__codelineno-0-469"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470" href="#__codelineno-0-470"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-471" name="__codelineno-0-471" href="#__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472" href="#__codelineno-0-472"></a>        <span class="c1"># set last system request slot s.t. BST can infer &quot;this&quot; reference</span>
<a id="__codelineno-0-473" name="__codelineno-0-473" href="#__codelineno-0-473"></a>        <span class="c1"># from user simulator (where user inform omits primary key slot)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474" href="#__codelineno-0-474"></a>        <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span> <span class="ow">or</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Select</span><span class="p">:</span>
<a id="__codelineno-0-475" name="__codelineno-0-475" href="#__codelineno-0-475"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-476" name="__codelineno-0-476" href="#__codelineno-0-476"></a>        <span class="k">elif</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">ConfirmRequest</span><span class="p">:</span>
<a id="__codelineno-0-477" name="__codelineno-0-477" href="#__codelineno-0-477"></a>            <span class="n">req_slot</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-478" name="__codelineno-0-478" href="#__codelineno-0-478"></a>            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
<a id="__codelineno-0-479" name="__codelineno-0-479" href="#__codelineno-0-479"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-480" name="__codelineno-0-480" href="#__codelineno-0-480"></a>                    <span class="n">req_slot</span> <span class="o">=</span> <span class="n">slot</span>
<a id="__codelineno-0-481" name="__codelineno-0-481" href="#__codelineno-0-481"></a>                    <span class="k">break</span>
<a id="__codelineno-0-482" name="__codelineno-0-482" href="#__codelineno-0-482"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_slot</span>
<a id="__codelineno-0-483" name="__codelineno-0-483" href="#__codelineno-0-483"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484" href="#__codelineno-0-484"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-485" name="__codelineno-0-485" href="#__codelineno-0-485"></a>
<a id="__codelineno-0-486" name="__codelineno-0-486" href="#__codelineno-0-486"></a>    <span class="k">def</span> <span class="nf">turn_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
<a id="__codelineno-0-487" name="__codelineno-0-487" href="#__codelineno-0-487"></a>                 <span class="n">sys_act_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-488" name="__codelineno-0-488" href="#__codelineno-0-488"></a>        <span class="sd">&quot;&quot;&quot; Call this function after a turn is done by the system &quot;&quot;&quot;</span>
<a id="__codelineno-0-489" name="__codelineno-0-489" href="#__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490" href="#__codelineno-0-490"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_system_action</span><span class="p">(</span><span class="n">sys_act_idx</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-491" name="__codelineno-0-491" href="#__codelineno-0-491"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492" href="#__codelineno-0-492"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;system action &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="p">))</span>
<a id="__codelineno-0-493" name="__codelineno-0-493" href="#__codelineno-0-493"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_update_system_belief</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494" href="#__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495" href="#__codelineno-0-495"></a>        <span class="n">turn_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_turn_reward</span><span class="p">()</span>
<a id="__codelineno-0-496" name="__codelineno-0-496" href="#__codelineno-0-496"></a>
<a id="__codelineno-0-497" name="__codelineno-0-497" href="#__codelineno-0-497"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-498" name="__codelineno-0-498" href="#__codelineno-0-498"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">state_vector</span><span class="p">,</span> <span class="n">sys_act_idx</span><span class="p">,</span> <span class="n">turn_reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499" href="#__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500" href="#__codelineno-0-500"></a>    <span class="k">def</span> <span class="nf">_expand_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-501" name="__codelineno-0-501" href="#__codelineno-0-501"></a>        <span class="sd">&quot;&quot;&quot; Call this function when a dialog begins &quot;&quot;&quot;</span>
<a id="__codelineno-0-502" name="__codelineno-0-502" href="#__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503" href="#__codelineno-0-503"></a>        <span class="n">hello_action</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
<a id="__codelineno-0-504" name="__codelineno-0-504" href="#__codelineno-0-504"></a>        <span class="n">hello_action</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Welcome</span>
<a id="__codelineno-0-505" name="__codelineno-0-505" href="#__codelineno-0-505"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="n">hello_action</span>
<a id="__codelineno-0-506" name="__codelineno-0-506" href="#__codelineno-0-506"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-507" name="__codelineno-0-507" href="#__codelineno-0-507"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;system action &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hello_action</span><span class="p">))</span>
<a id="__codelineno-0-508" name="__codelineno-0-508" href="#__codelineno-0-508"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">hello_action</span><span class="p">}</span>
<a id="__codelineno-0-509" name="__codelineno-0-509" href="#__codelineno-0-509"></a>
<a id="__codelineno-0-510" name="__codelineno-0-510" href="#__codelineno-0-510"></a>    <span class="k">def</span> <span class="nf">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-511" name="__codelineno-0-511" href="#__codelineno-0-511"></a>        <span class="sd">&quot;&quot;&quot; Call this function when a dialog ended &quot;&quot;&quot;</span>
<a id="__codelineno-0-512" name="__codelineno-0-512" href="#__codelineno-0-512"></a>        <span class="k">if</span> <span class="n">sim_goal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-513" name="__codelineno-0-513" href="#__codelineno-0-513"></a>            <span class="c1"># real user interaction, no simulator - don&#39;t have to evaluate</span>
<a id="__codelineno-0-514" name="__codelineno-0-514" href="#__codelineno-0-514"></a>            <span class="c1"># anything, just reset counters</span>
<a id="__codelineno-0-515" name="__codelineno-0-515" href="#__codelineno-0-515"></a>            <span class="k">return</span>
<a id="__codelineno-0-516" name="__codelineno-0-516" href="#__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517" href="#__codelineno-0-517"></a>        <span class="n">final_reward</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_final_reward</span><span class="p">(</span><span class="n">sim_goal</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518" href="#__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519" href="#__codelineno-0-519"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520" href="#__codelineno-0-520"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">final_reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-521" name="__codelineno-0-521" href="#__codelineno-0-521"></a>
<a id="__codelineno-0-522" name="__codelineno-0-522" href="#__codelineno-0-522"></a>        <span class="c1"># if self.writer is not None:</span>
<a id="__codelineno-0-523" name="__codelineno-0-523" href="#__codelineno-0-523"></a>        <span class="c1">#     self.writer.add_scalar(&#39;buffer/items&#39;, len(self.buffer),</span>
<a id="__codelineno-0-524" name="__codelineno-0-524" href="#__codelineno-0-524"></a>        <span class="c1">#                     self.train + self.total_train_dialogs)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.policy_rl.RLPolicy.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">services</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">rl</span><span class="o">.</span><span class="n">experience_buffer</span><span class="o">.</span><span class="n">UniformBuffer</span><span class="s1">&#39;&gt;, buffer_size=6000, batch_size=64, discount_gamma=0.99, max_turns=25, include_confreq=False, logger=&lt;DiasysLogger adviser (NOTSET)&gt;, include_select=False, device=device(type=&#39;</span><span class="n">cpu</span><span class="s1">&#39;))</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.policy.rl.policy_rl.RLPolicy.__init__" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Creates state- and action spaces, initializes experience replay
buffers.</p>

<p><strong>Keyword arguments:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>subgraph</code></td>
        <td><code>{[type]} -- [see services.Module] (default</code></td>
        <td><p>{None})</p></td>
      </tr>
      <tr>
        <td><code>--</code></td>
        <td><code>[Experience replay buffer *class*, **not** an instance - will be
initialized by this constructor!] (default</code></td>
        <td><p>{UniformBuffer})</p></td>
      </tr>
      <tr>
        <td><code>buffer_size</code></td>
        <td><code>{int} -- [see services.policy.rl.experience_buffer.
                  Buffer] (default</code></td>
        <td><p>{6000})</p></td>
      </tr>
      <tr>
        <td><code>batch_size</code></td>
        <td><code>{int} -- [see services.policy.rl.experience_buffer.
                  Buffer] (default</code></td>
        <td><p>{64})</p></td>
      </tr>
      <tr>
        <td><code>discount_gamma</code></td>
        <td><code>{float} -- [Discount factor] (default</code></td>
        <td><p>{0.99})</p></td>
      </tr>
      <tr>
        <td><code>include_confreq</code></td>
        <td><code>{bool} -- [Use confirm_request actions]
                       (default</code></td>
        <td><p>{False})</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=</span><span class="n">UniformBuffer</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">buffer_size</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">include_confreq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>             <span class="n">include_select</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Creates state- and action spaces, initializes experience replay</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    buffers.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Arguments:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        domain {domain.jsonlookupdomain.JSONLookupDomain} -- Domain</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    Keyword Arguments:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        subgraph {[type]} -- [see services.Module] (default: {None})</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        buffer_cls {services.policy.rl.experience_buffer.Buffer}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        -- [Experience replay buffer *class*, **not** an instance - will be</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">            initialized by this constructor!] (default: {UniformBuffer})</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">        buffer_size {int} -- [see services.policy.rl.experience_buffer.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">                              Buffer] (default: {6000})</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">        batch_size {int} -- [see services.policy.rl.experience_buffer.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">                              Buffer] (default: {64})</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">        discount_gamma {float} -- [Discount factor] (default: {0.99})</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">        include_confreq {bool} -- [Use confirm_request actions]</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">                                   (default: {False})</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="s2">&quot;lastInformedPrimKeyVal&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="s2">&quot;lastActionInformNone&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="s2">&quot;offerHappened&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">max_turns</span> <span class="o">=</span> <span class="n">max_turns</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="c1"># setup evaluator for training</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">ObjectiveReachedEvaluator</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">discount_gamma</span> <span class="o">=</span> <span class="n">discount_gamma</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="c1"># get state size</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beliefstate_dict_to_vector</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="n">BeliefState</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">_init_beliefstate</span><span class="p">())</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;state space dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">))</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="c1"># get system action list</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;inform_byname&quot;</span><span class="p">,</span>  <span class="c1"># TODO rename to &#39;bykey&#39;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>                    <span class="s2">&quot;inform_alternatives&quot;</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>                    <span class="s2">&quot;reqmore&quot;</span><span class="p">]</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="c1"># TODO badaction</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="k">for</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">():</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;request#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;confirm#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="k">if</span> <span class="n">include_select</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;select#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="k">if</span> <span class="n">include_confreq</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="k">for</span> <span class="n">conf_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">():</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">req_slot</span> <span class="o">==</span> <span class="n">conf_slot</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>                    <span class="c1"># skip case where confirm slot = request slot</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;confreq#&#39;</span> <span class="o">+</span> <span class="n">conf_slot</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>                                        <span class="n">req_slot</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>    <span class="c1"># don&#39;t include closingmsg in learnable actions</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;closingmsg&#39;</span><span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>    <span class="c1"># self.actions.append(&quot;closingmsg&quot;)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;action space dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span><span class="p">))</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>    <span class="c1"># init replay memory</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_cls</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>                             <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.policy_rl.RLPolicy.action_idx" class="doc doc-heading">
<code class="highlight language-python"><span class="n">action_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.policy_rl.RLPolicy.action_idx" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Returns the action index for the specified action name </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">action_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Returns the action index for the specified action name &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.policy_rl.RLPolicy.action_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">action_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.policy_rl.RLPolicy.action_name" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Returns the action name for the specified action index </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">action_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Returns the action name for the specified action index &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">action_idx</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.policy_rl.RLPolicy.beliefstate_dict_to_vector" class="doc doc-heading">
<code class="highlight language-python"><span class="n">beliefstate_dict_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.policy_rl.RLPolicy.beliefstate_dict_to_vector" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Converts the beliefstate dict to a torch tensor</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>beliefstate</code></td>
        <td><code>BeliefState</code></td>
        <td><p>dict of belief (with at least beliefs and system keys)</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>belief tensor with dimension 1 x state_dim</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">beliefstate_dict_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Converts the beliefstate dict to a torch tensor</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        beliefstate: dict of belief (with at least beliefs and system keys)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        belief tensor with dimension 1 x state_dim</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">belief_vec</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="c1"># add user acts</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">belief_vec</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;user_acts&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">UserActionType</span><span class="p">]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="c1"># handle none actions</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">belief_vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="c1"># add informs (including special flag if slot not mentioned)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">()):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;dontcare&quot;</span><span class="p">]</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">if</span> <span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="c1"># add **NONE** value first, then 0.0 for all others</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>            <span class="c1"># also add value for don&#39;t care</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="n">belief_vec</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))]</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="c1"># add **NONE** value first</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">bs_slot</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;informs&#39;</span><span class="p">][</span><span class="n">slot</span><span class="p">]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="n">belief_vec</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bs_slot</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">bs_slot</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="c1"># add requests</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">()):</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="k">if</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="c1"># append system features</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;lastActionInformNone&#39;</span><span class="p">]))</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_state</span><span class="p">[</span><span class="s1">&#39;offerHappened&#39;</span><span class="p">]))</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="n">candidate_count</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;num_matches&#39;</span><span class="p">]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="c1"># buckets for match count: 0, 1, 2-4, &gt;4</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">candidate_count</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="s2">&quot;discriminable&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="c1"># convert to torch tensor</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">belief_vec</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.policy_rl.RLPolicy.end_dialog" class="doc doc-heading">
<code class="highlight language-python"><span class="n">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.policy_rl.RLPolicy.end_dialog" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Call this function when a dialog ended </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Call this function when a dialog ended &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">if</span> <span class="n">sim_goal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="c1"># real user interaction, no simulator - don&#39;t have to evaluate</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="c1"># anything, just reset counters</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="k">return</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">final_reward</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_final_reward</span><span class="p">(</span><span class="n">sim_goal</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">final_reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="c1"># if self.writer is not None:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="c1">#     self.writer.add_scalar(&#39;buffer/items&#39;, len(self.buffer),</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="c1">#                     self.train + self.total_train_dialogs)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.policy_rl.RLPolicy.expand_system_action" class="doc doc-heading">
<code class="highlight language-python"><span class="n">expand_system_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.policy_rl.RLPolicy.expand_system_action" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Expands an action index to a real sytem act </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">expand_system_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Expands an action index to a real sytem act &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">action_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_name</span><span class="p">(</span><span class="n">action_idx</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">if</span> <span class="s1">&#39;request#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_request</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">elif</span> <span class="s1">&#39;select#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_select</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">elif</span> <span class="s1">&#39;confirm#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_confirm</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">elif</span> <span class="s1">&#39;confreq#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_confreq</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;inform_byname&#39;</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_informbyname</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;inform_alternatives&#39;</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_informbyalternatives</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;closingmsg&#39;</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_bye</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;repeat&#39;</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;reqmore&#39;</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_reqmore</span><span class="p">()</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RL POLICY: system action not supported: &quot;</span> <span class="o">+</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                            <span class="n">action_name</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="adviser.services.policy.rl.policy_rl.RLPolicy.turn_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">turn_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">,</span> <span class="n">sys_act_idx</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.policy_rl.RLPolicy.turn_end" class="headerlink" title="Permanent link">&para;</a></h6>

    <div class="doc doc-contents ">

      <p>Call this function after a turn is done by the system </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/policy_rl.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">turn_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">sys_act_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot; Call this function after a turn is done by the system &quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_system_action</span><span class="p">(</span><span class="n">sys_act_idx</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;system action &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="p">))</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_update_system_belief</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">turn_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_turn_reward</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">state_vector</span><span class="p">,</span> <span class="n">sys_act_idx</span><span class="p">,</span> <span class="n">turn_reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="adviser.services.policy.rl.train_dqnpolicy" class="doc doc-heading">
        <code>train_dqnpolicy</code>



<a href="#adviser.services.policy.rl.train_dqnpolicy" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <h5 id="adviser.services.policy.rl.train_dqnpolicy--this-script-can-be-executed-to-train-a-dqn-policy">This script can be executed to train a DQN policy.<a class="headerlink" href="#adviser.services.policy.rl.train_dqnpolicy--this-script-can-be-executed-to-train-a-dqn-policy" title="Permanent link">&para;</a></h5>
<h5 id="adviser.services.policy.rl.train_dqnpolicy--it-will-create-a-policy-model-file-ending-with-pt">It will create a policy model (file ending with .pt).<a class="headerlink" href="#adviser.services.policy.rl.train_dqnpolicy--it-will-create-a-policy-model-file-ending-with-pt" title="Permanent link">&para;</a></h5>
<h5 id="adviser.services.policy.rl.train_dqnpolicy--you-need-to-execute-this-script-before-you-can-interact-with-the-rl-agent">You need to execute this script before you can interact with the RL agent.<a class="headerlink" href="#adviser.services.policy.rl.train_dqnpolicy--you-need-to-execute-this-script-before-you-can-interact-with-the-rl-agent" title="Permanent link">&para;</a></h5>
<h5 id="adviser.services.policy.rl.train_dqnpolicy--_1"><a class="headerlink" href="#adviser.services.policy.rl.train_dqnpolicy--_1" title="Permanent link">&para;</a></h5>



  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h5 id="adviser.services.policy.rl.train_dqnpolicy.get_root_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_root_dir</span><span class="p">()</span></code>


<a href="#adviser.services.policy.rl.train_dqnpolicy.get_root_dir" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/train_dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_root_dir</span><span class="p">():</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="adviser.services.policy.rl.train_dqnpolicy.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">domain_name</span><span class="p">,</span> <span class="n">log_to_file</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">train_epochs</span><span class="p">,</span> <span class="n">train_dialogs</span><span class="p">,</span> <span class="n">eval_dialogs</span><span class="p">,</span> <span class="n">max_turns</span><span class="p">,</span> <span class="n">train_error_rate</span><span class="p">,</span> <span class="n">test_error_rate</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">eps_start</span><span class="p">,</span> <span class="n">grad_clipping</span><span class="p">,</span> <span class="n">buffer_classname</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">use_tensorboard</span><span class="p">)</span></code>


<a href="#adviser.services.policy.rl.train_dqnpolicy.train" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Training loop for the RL policy, for information on the parameters, look at the descriptions
of commandline arguments in the "if main" below</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/policy/rl/train_dqnpolicy.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">domain_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_to_file</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">train_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">train_dialogs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>          <span class="n">eval_dialogs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">train_error_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">test_error_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>          <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eps_start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">grad_clipping</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">buffer_classname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>          <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">use_tensorboard</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        Training loop for the RL policy, for information on the parameters, look at the descriptions</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        of commandline arguments in the &quot;if main&quot; below</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="k">if</span> <span class="n">seed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">common</span><span class="o">.</span><span class="n">init_random</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">file_log_lvl</span> <span class="o">=</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">DIALOGS</span> <span class="k">if</span> <span class="n">log_to_file</span> <span class="k">else</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">NONE</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(</span><span class="n">console_log_lvl</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">RESULTS</span><span class="p">,</span> <span class="n">file_log_lvl</span><span class="o">=</span><span class="n">file_log_lvl</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">summary_writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="n">log_dir</span><span class="o">=</span><span class="s1">&#39;logs&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_tensorboard</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">if</span> <span class="n">buffer_classname</span> <span class="o">==</span> <span class="s2">&quot;prioritized&quot;</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">buffer_cls</span> <span class="o">=</span> <span class="n">NaivePrioritizedBuffer</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">elif</span> <span class="n">buffer_classname</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="n">buffer_cls</span> <span class="o">=</span> <span class="n">UniformBuffer</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="n">JSONLookupDomain</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">domain_name</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="n">bst</span> <span class="o">=</span> <span class="n">HandcraftedBST</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="n">user</span> <span class="o">=</span> <span class="n">HandcraftedUserSimulator</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="c1"># noise = SimpleNoise(domain=domain, train_error_rate=train_error_rate,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="c1">#                     test_error_rate=test_error_rate, logger=logger)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="n">policy</span> <span class="o">=</span> <span class="n">DQNPolicy</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">eps_start</span><span class="o">=</span><span class="n">eps_start</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="n">gradient_clipping</span><span class="o">=</span><span class="n">grad_clipping</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=</span><span class="n">buffer_cls</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                    <span class="n">replay_buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">train_dialogs</span><span class="o">=</span><span class="n">train_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">summary_writer</span><span class="o">=</span><span class="n">summary_writer</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">PolicyEvaluator</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">use_tensorboard</span><span class="o">=</span><span class="n">use_tensorboard</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                                <span class="n">experiment_name</span><span class="o">=</span><span class="n">domain_name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                                <span class="n">summary_writer</span><span class="o">=</span><span class="n">summary_writer</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="n">ds</span> <span class="o">=</span> <span class="n">DialogSystem</span><span class="p">(</span><span class="n">services</span><span class="o">=</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">bst</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">evaluator</span><span class="p">],</span> <span class="n">protocol</span><span class="o">=</span><span class="s1">&#39;tcp&#39;</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="c1"># ds.draw_system_graph()</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="n">error_free</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">is_error_free_messaging_pipeline</span><span class="p">()</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">error_free</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="n">ds</span><span class="o">.</span><span class="n">print_inconsistencies</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_epochs</span><span class="p">):</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="c1"># START TRAIN EPOCH</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="n">evaluator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="n">policy</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="n">evaluator</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">()</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_dialogs</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="k">if</span> <span class="n">episode</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DIALOG&quot;</span><span class="p">,</span> <span class="n">episode</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">!!!!!!!!!!!!!!!! NEW DIALOG !!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="n">ds</span><span class="o">.</span><span class="n">run_dialog</span><span class="p">(</span><span class="n">start_signals</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;user_acts/</span><span class="si">{</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="p">[]})</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="n">evaluator</span><span class="o">.</span><span class="n">end_epoch</span><span class="p">()</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="n">policy</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="c1"># START EVAL EPOCH</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="n">evaluator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="n">policy</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="n">evaluator</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">()</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eval_dialogs</span><span class="p">):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">!!!!!!!!!!!!!!!! NEW DIALOG !!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="n">ds</span><span class="o">.</span><span class="n">run_dialog</span><span class="p">(</span><span class="n">start_signals</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;user_acts/</span><span class="si">{</span><span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="p">[]})</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="n">evaluator</span><span class="o">.</span><span class="n">end_epoch</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>    <span class="n">ds</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.service" class="doc doc-heading">
        <code>service</code>



<a href="#adviser.services.service" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="adviser.services.service.DialogSystem" class="doc doc-heading">
        <code>
DialogSystem        </code>



<a href="#adviser.services.service.DialogSystem" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This class will constrct a dialog system from the list of services provided to the constructor.
It will also handle synchronization for initalization of services before dialog start / after dialog end / on system shutdown
and lets you discover potential conflicts in you messaging pipeline.
This class is also used to communicate / synchronize with services running on different nodes.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">DialogSystem</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    This class will constrct a dialog system from the list of services provided to the constructor.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    It will also handle synchronization for initalization of services before dialog start / after dialog end / on system shutdown</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    and lets you discover potential conflicts in you messaging pipeline.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    This class is also used to communicate / synchronize with services running on different nodes.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">services</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Service</span><span class="p">,</span> <span class="n">RemoteService</span><span class="p">]],</span> <span class="n">sub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65533</span><span class="p">,</span> <span class="n">pub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65534</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                 <span class="n">reg_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span> <span class="n">debug_logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">            services (List[Union[Service, RemoteService]]): List of all (remote) services to connect to.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">                                                            Only once they&#39;re specified here will they start listening for</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">                                                            messages.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">            sub_port(int): subscriber port</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">            sub_addr(str): IP-address or domain name of proxy subscriber interface (e.g. 127.0.0.1 for your local machine)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">            pub_port(int): publisher port</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">            pub_addr(str): IP-address or domain name of proxy publisher interface (e.g. 127.0.0.1 for your local machine) </span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">            reg_port (int): registration port for remote services</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">            protocol(str): communication protol, either &#39;inproc&#39; or &#39;tcp&#39; or `ipc`</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">            debug_logger (DiasysLogger): If not `None`, all messags are printed to the logger, including send/receive events.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">                                Can be useful for debugging because you can still see messages received by the `DialogSystem`</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">                                even if they are never forwarded (as expected) to your `Service`</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="c1"># node-local topics</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span> <span class="o">=</span> <span class="n">debug_logger</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># collects names and instances of local services</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_dialog_services</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># collects names of local services that subscribe to dialog_start</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="c1"># node-local sockets</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_domains</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="c1"># start proxy thread</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span> <span class="o">=</span> <span class="n">ProcessProxy</span><span class="p">(</span><span class="n">in_type</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">XSUB</span><span class="p">,</span> <span class="n">out_type</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">XPUB</span><span class="p">)</span>  <span class="c1"># , mon_type=zmq.XSUB)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span><span class="o">.</span><span class="n">bind_in</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">pub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span><span class="o">.</span><span class="n">bind_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span> <span class="o">=</span> <span class="n">sub_port</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pub_port</span> <span class="o">=</span> <span class="n">pub_port</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="c1"># thread control</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_end_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="c1"># control channels</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="o">.</span><span class="n">sndhwm</span> <span class="o">=</span> <span class="mi">1100000</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">pub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="c1"># register services (local and remote)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="n">remote_services</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>                <span class="c1"># register local service</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>                <span class="n">service_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">service</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">_identifier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">service</span><span class="o">.</span><span class="n">_identifier</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>                <span class="n">service</span><span class="o">.</span><span class="n">_init_pubsub</span><span class="p">()</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_add_service_info</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_domain_name</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>                                       <span class="n">service</span><span class="o">.</span><span class="n">_start_topic</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_end_topic</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_terminate_topic</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>                <span class="n">service</span><span class="o">.</span><span class="n">_register_with_dialogsystem</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">RemoteService</span><span class="p">):</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>                <span class="n">remote_services</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">service</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_remote_services</span><span class="p">(</span><span class="n">remote_services</span><span class="p">,</span> <span class="n">reg_port</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dialog_end_listener</span><span class="p">()</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>    <span class="k">def</span> <span class="nf">_register_pub_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="sd">&quot;&quot;&quot; Map a publisher instance to a topic &quot;&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>    <span class="k">def</span> <span class="nf">_register_sub_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="sd">&quot;&quot;&quot; Map a subscriber instance to a topic &quot;&quot;&quot;</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>    <span class="k">def</span> <span class="nf">_register_remote_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_services</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RemoteService</span><span class="p">],</span> <span class="n">reg_port</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="sd">&quot;&quot;&quot; </span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="sd">        Register all remote services.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">        *Blocking* until an ACK was received from all of them, confirming they&#39;re setup and ready.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a><span class="sd">            remote_services (List[RemoteService]): list of all remote services to register</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a><span class="sd">            reg_port (int): registration port for remote services</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_services</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>            <span class="k">return</span>  <span class="c1"># nothing to register</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>        <span class="c1"># Socket to receive registration requests</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="n">reg_service</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="n">reg_service</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tcp://127.0.0.1:</span><span class="si">{</span><span class="n">reg_port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">remote_services</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="c1"># call next remote service</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>            <span class="n">msg</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reg_service</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;REGISTER_&quot;</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>                <span class="c1"># make sure we have a register message</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>                <span class="n">remote_service_identifier</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;REGISTER_&quot;</span><span class="p">):]</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>                <span class="k">if</span> <span class="n">remote_service_identifier</span> <span class="ow">in</span> <span class="n">remote_services</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;registering service </span><span class="si">{</span><span class="n">remote_service_identifier</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>                    <span class="c1"># add remote service interface info</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>                    <span class="n">domain_name</span><span class="p">,</span> <span class="n">sub_topics</span><span class="p">,</span> <span class="n">pub_topics</span><span class="p">,</span> <span class="n">start_topic</span><span class="p">,</span> <span class="n">end_topic</span><span class="p">,</span> <span class="n">terminate_topic</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_service_info</span><span class="p">(</span><span class="n">remote_service_identifier</span><span class="p">,</span> <span class="n">domain_name</span><span class="p">,</span> <span class="n">sub_topics</span><span class="p">,</span> <span class="n">pub_topics</span><span class="p">,</span> <span class="n">start_topic</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>                                           <span class="n">end_topic</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_remote_identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">remote_service_identifier</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>                    <span class="c1"># acknowledge service registration</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>                    <span class="n">reg_service</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ACK_REGISTER_</span><span class="si">{</span><span class="n">remote_service_identifier</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;CONF_REGISTER_&quot;</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>                <span class="c1"># complete registration</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>                <span class="n">remote_service_identifier</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;CONF_REGISTER_&quot;</span><span class="p">):]</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>                <span class="k">if</span> <span class="n">remote_service_identifier</span> <span class="ow">in</span> <span class="n">remote_services</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>                    <span class="k">del</span> <span class="n">remote_services</span><span class="p">[</span><span class="n">remote_service_identifier</span><span class="p">]</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successfully registered service </span><span class="si">{</span><span class="n">remote_service_identifier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>                <span class="n">reg_service</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;########## Finished registering all remote services ##########&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>    <span class="k">def</span> <span class="nf">_add_service_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">domain_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sub_topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">pub_topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>                            <span class="n">start_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_topic</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>        <span class="sd">&quot;&quot;&quot; Add all relevant info from a service (needed to construct dialog graph for debugging).</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a><span class="sd">            Also, sets up all required control channels for this service based on the service&#39;s info.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a><span class="sd">            service_name (str): service name</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a><span class="sd">            domain_name (str): domain name</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a><span class="sd">            sub_topics (List[str]): list of all subscribed to topics of the given service</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a><span class="sd">            pub_topics (List[str]): list of all topics the given service publishes to</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a><span class="sd">            start_topic (str): control channel topic for setting given service into `listening` mode</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a><span class="sd">            end_topic (str): control channel topic for setting given service into `non-listening` mode</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a><span class="sd">            terminate_topic (str): control channel topic for stopping given service&#39;s listener loops and</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a><span class="sd">                                   closing the listener sockets</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_domains</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">domain_name</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">sub_topics</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_register_sub_topic</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_register_pub_topic</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>        <span class="c1"># setup control channels</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_topics</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">start_topic</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_end_topics</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">end_topic</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topics</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">terminate_topic</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ACK/</span><span class="si">{</span><span class="n">start_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ACK/</span><span class="si">{</span><span class="n">end_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ACK/</span><span class="si">{</span><span class="n">terminate_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>    <span class="k">def</span> <span class="nf">_setup_dialog_end_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>        <span class="sd">&quot;&quot;&quot; Creates socket for listening to Topic.DIALOG_END messages &quot;&quot;&quot;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_end_socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>        <span class="c1"># subscribe to dialog end from all domains</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_end_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">Topic</span><span class="o">.</span><span class="n">DIALOG_END</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_end_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>        <span class="c1"># # add to list of local topics</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>        <span class="c1"># if Topic.DIALOG_END not in self._local_sub_topics:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>        <span class="c1">#     self._local_sub_topics[Topic.DIALOG_END] = set()</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>        <span class="c1"># self._local_sub_topics[Topic.DIALOG_END].add(type(self).__name__)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>        <span class="sd">&quot;&quot;&quot; Set stop event (can be queried by services via the `terminating()` function) &quot;&quot;&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>        <span class="k">pass</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>    <span class="k">def</span> <span class="nf">terminating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>        <span class="sd">&quot;&quot;&quot; Returns True if the system is stopping, else False &quot;&quot;&quot;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>        <span class="sd">&quot;&quot;&quot; Shutdown dialog system.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a><span class="sd">            This will trigger `terminate` messages to be sent to all registered services to stop their listener loops.</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a><span class="sd">            Should be called in the end before exiting your program.</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a><span class="sd">            Blocks until all services sent ACK&#39;s confirming they&#39;re stopped.</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>        <span class="k">for</span> <span class="n">terminate_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topics</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>            <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>            <span class="n">_recv_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>    <span class="k">def</span> <span class="nf">_end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>        <span class="sd">&quot;&quot;&quot; Block until all receivers stopped listening.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a><span class="sd">            Then, calls `dialog_end` on all registered services. &quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>        <span class="c1"># listen for Topic.DIALOG_END messages</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>                <span class="c1"># receive message for subscribed topic</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>                <span class="n">topic</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>                <span class="n">timestamp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>                <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- (DS): received DIALOG_END message in _end_dialog from topic </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>                    <span class="k">break</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>                <span class="k">break</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>                <span class="kn">import</span> <span class="nn">traceback</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR in _end_dialog &quot;</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>        <span class="c1"># stop receivers (blocking)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>        <span class="k">for</span> <span class="n">end_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_topics</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>            <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="n">end_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>            <span class="n">_recv_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="p">,</span> <span class="n">end_topic</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- (DS): all services STOPPED listening&quot;</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>    <span class="k">def</span> <span class="nf">_start_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_signals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>        <span class="sd">&quot;&quot;&quot; Block until all receivers started listening.</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a><span class="sd">            Then, call `dialog_start`on all registered services.</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a><span class="sd">            Finally, publish all start signals given. &quot;&quot;&quot;</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>        <span class="c1"># start receivers (blocking)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>        <span class="k">for</span> <span class="n">start_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_topics</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>            <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="n">start_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>            <span class="n">_recv_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="p">,</span> <span class="n">start_topic</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- (DS): all services STARTED listening&quot;</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>        <span class="c1"># publish first turn trigger</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a>        <span class="c1"># for domain in self._domains:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a>        <span class="c1"># &quot;wildcard&quot; mechanism: publish start messages to all known domains</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">start_signals</span><span class="p">:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>            <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">start_signals</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>    <span class="k">def</span> <span class="nf">run_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_signals</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">Topic</span><span class="o">.</span><span class="n">DIALOG_END</span><span class="p">:</span> <span class="kc">False</span><span class="p">}):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>        <span class="sd">&quot;&quot;&quot; Run a complete dialog (blocking).</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a><span class="sd">            Dialog will be started via messages to the topics specified in `start_signals`.</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a><span class="sd">            The dialog will end on receiving any `Topic.DIALOG_END` message with value &#39;True&#39;,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a><span class="sd">            so make sure at least one service in your dialog graph will publish this message eventually.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a><span class="sd">            start_signals (Dict[str, Any]): mapping from topic -&gt; value</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a><span class="sd">                                            Publishes the value given for each topic to the respective topic.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a><span class="sd">                                            Use this to trigger the start of your dialog system.</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_dialog</span><span class="p">(</span><span class="n">start_signals</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_end_dialog</span><span class="p">()</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a>    <span class="k">def</span> <span class="nf">list_published_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a>        <span class="sd">&quot;&quot;&quot; Get all declared publisher topics.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a><span class="sd">            A dictionary with mapping</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a><span class="sd">                topic (str) -&gt; publishing services (Set[str]).</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a><span class="sd">            * Call this method after instantiating all services.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a><span class="sd">            * Even though a publishing topic might be listed here, there is no guarantee that</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a><span class="sd">            its publisher(s) might ever publish to it.</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">)</span>  <span class="c1"># copy s.t. no user changes this list</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>    <span class="k">def</span> <span class="nf">list_subscribed_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>        <span class="sd">&quot;&quot;&quot; Get all declared subscribed topics.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a><span class="sd">            A dictionary with mapping </span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a><span class="sd">                topic (str) -&gt; subscribing services (Set[str]).</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a><span class="sd">        Notes:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a><span class="sd">            * Call this method after instantiating all services.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">)</span>  <span class="c1"># copy s.t. no user changes this list</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>    <span class="k">def</span> <span class="nf">draw_system_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>        <span class="sd">&quot;&quot;&quot; Draws a graph of the system as a directed graph.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a><span class="sd">            Services are represented by nodes, messages by directed edges (from publisher to subscriber).</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a><span class="sd">            Warnings are drawn as yellow edges (and the missing subscribers represented by an &#39;UNCONNECTED SERVICES&#39; node),</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a><span class="sd">            errors as red edges (and the missing publishers represented by the &#39;UNCONNECTED SERVICES&#39; node as well).</span>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a><span class="sd">            Will mark remote services with blue.</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a><span class="sd">            name (str): used to construct the name of your output file</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a><span class="sd">            format (str): output file format (e.g. png, pdf, jpg, ...)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a><span class="sd">            show (bool): if True, the graph image will be opened in your default image viewer application</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a><span class="sd">        Requires:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a><span class="sd">            graphviz library (pip install graphviz)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>        <span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>        <span class="c1"># collect all services, errors and warnings</span>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>        <span class="n">services</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>        <span class="k">for</span> <span class="n">service_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>            <span class="n">services</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">service_set</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>        <span class="k">for</span> <span class="n">service_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>            <span class="n">services</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">service_set</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>        <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_inconsistencies</span><span class="p">()</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>        <span class="c1"># add services as nodes</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>            <span class="k">if</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_identifiers</span><span class="p">:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>                <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f618d&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>  <span class="c1"># remote service</span>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>                <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1c2833&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>  <span class="c1"># local service</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>            <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s1">&#39;UNCONNECTED SERVICES&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#922b21&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a>        <span class="c1"># draw connections from publisher to subscribers as edges</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a>            <span class="n">publishers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>            <span class="n">receivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a>            <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="n">receivers</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>                <span class="k">for</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>                    <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>        <span class="c1"># draw warnings and errors as edges to node &#39;UNCONNECTED SERVICES&#39;</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>            <span class="n">receivers</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>            <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="n">receivers</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>                <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="s1">&#39;UNCONNECTED SERVICES&#39;</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#c34400&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;#c34400&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>            <span class="n">publishers</span> <span class="o">=</span> <span class="n">warnings</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>            <span class="k">for</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>                <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s1">&#39;UNCONNECTED SERVICES&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#e37c02&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;#e37c02&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>        <span class="c1"># draw graph</span>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>        <span class="n">g</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">view</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>    <span class="k">def</span> <span class="nf">list_inconsistencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>        <span class="sd">&quot;&quot;&quot; Checks for potential errors in the current messaging pipleline:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a><span class="sd">        e.g. len(list_inconsistencies()[0]) == 0 -&gt; error free pipeline</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a><span class="sd">        (Potential) Errors are defined in this context as subscribed topics without publishers.</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a><span class="sd">        Warnings are defined in this context as published topics without subscribers.</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a><span class="sd">            A touple of dictionaries:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a><span class="sd">            * the first dictionary contains potential errors (with the mapping topics -&gt; subsribing services) </span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a><span class="sd">            * the second dictionary contains warnings (with the mapping topics -&gt; publishing services).</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a><span class="sd">        Notes:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a><span class="sd">            * Call this method after instantiating all services.</span>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a><span class="sd">            * Even if there are no errors returned by this method, there is not guarantee that all publishers </span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a><span class="sd">            eventually publish to their respective topics.</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a>        <span class="c1"># look for subscribers w/o publishers by checking topic prefixes</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>        <span class="k">for</span> <span class="n">sub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>            <span class="n">found_pub</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>            <span class="k">for</span> <span class="n">pub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>                <span class="k">if</span> <span class="n">pub_topic</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sub_topic</span><span class="p">):</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>                    <span class="n">found_pub</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>                    <span class="k">break</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_pub</span><span class="p">:</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>                <span class="n">errors</span><span class="p">[</span><span class="n">sub_topic</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">[</span><span class="n">sub_topic</span><span class="p">]</span>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a>        <span class="c1"># look for publishers w/o subscribers by checking topic prefixes</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a>        <span class="n">warnings</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>        <span class="k">for</span> <span class="n">pub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>            <span class="n">found_sub</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>            <span class="k">for</span> <span class="n">sub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">:</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>                <span class="k">if</span> <span class="n">pub_topic</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sub_topic</span><span class="p">):</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>                    <span class="n">found_sub</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>                    <span class="k">break</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_sub</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>                <span class="n">warnings</span><span class="p">[</span><span class="n">pub_topic</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">[</span><span class="n">pub_topic</span><span class="p">]</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>        <span class="k">return</span> <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>    <span class="k">def</span> <span class="nf">print_inconsistencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>        <span class="sd">&quot;&quot;&quot; Checks for potential errors in the current messaging pipleline:</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a><span class="sd">        e.g. len(list_local_inconsistencies()[0]) == 0 -&gt; error free pipeline and prints them </span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a><span class="sd">        to the console.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a><span class="sd">        (Potential) Errors are defined in this context as subscribed topics without publishers.</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a><span class="sd">        Warnings are defined in this context as published topics without subscribers.</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a><span class="sd">        Notes:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a><span class="sd">            * Call this method after instantiating all services.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a><span class="sd">            * Even if there are no errors returned by this method, there is not guarantee that all publishers </span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a><span class="sd">            eventually publish to their respective topics.</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>        <span class="c1"># console colors</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>        <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>        <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a>        <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a>        <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_inconsistencies</span><span class="p">()</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Potential) Errors (subscribed topics without publishers):&quot;</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  topic: &#39;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&#39;, subscribed to in services: </span><span class="si">{</span><span class="n">errors</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">ENDC</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warnings (published topics without subscribers):&quot;</span><span class="p">)</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  topic: &#39;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&#39;, published in services: </span><span class="si">{</span><span class="n">warnings</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">ENDC</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a>    <span class="k">def</span> <span class="nf">is_error_free_messaging_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>        <span class="sd">&quot;&quot;&quot; Checks the current messaging pipeline for potential errors.</span>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a><span class="sd">        (Potential) Errors are defined in this context as subscribed topics without publishers.</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a><span class="sd">            True, if no potential errors could be found - else, False</span>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a><span class="sd">        Notes:</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a><span class="sd">            * Call this method after instantiating all services.</span>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a><span class="sd">            * Lists only node-local (or process-local) inconsistencies.</span>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a><span class="sd">            * Even if there are no errors returned by this method, there is not guarantee that all publishers </span>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a><span class="sd">            eventually publish to their respective topics.</span>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_inconsistencies</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">services</span><span class="p">,</span> <span class="n">sub_port</span><span class="o">=</span><span class="mi">65533</span><span class="p">,</span> <span class="n">pub_port</span><span class="o">=</span><span class="mi">65534</span><span class="p">,</span> <span class="n">reg_port</span><span class="o">=</span><span class="mi">65535</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s1">&#39;tcp&#39;</span><span class="p">,</span> <span class="n">debug_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.service.DialogSystem.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>services</code></td>
        <td><code>List[Union[Service, RemoteService]]</code></td>
        <td><p>List of all (remote) services to connect to.
                                            Only once they're specified here will they start listening for
                                            messages.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>sub_port(int)</code></td>
        <td></td>
        <td><p>subscriber port</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>sub_addr(str)</code></td>
        <td></td>
        <td><p>IP-address or domain name of proxy subscriber interface (e.g. 127.0.0.1 for your local machine)</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>pub_port(int)</code></td>
        <td></td>
        <td><p>publisher port</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>pub_addr(str)</code></td>
        <td></td>
        <td><p>IP-address or domain name of proxy publisher interface (e.g. 127.0.0.1 for your local machine) </p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>reg_port</code></td>
        <td><code>int</code></td>
        <td><p>registration port for remote services</p></td>
        <td><code>65535</code></td>
      </tr>
      <tr>
        <td><code>protocol(str)</code></td>
        <td></td>
        <td><p>communication protol, either 'inproc' or 'tcp' or <code>ipc</code></p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>debug_logger</code></td>
        <td><code>DiasysLogger</code></td>
        <td><p>If not <code>None</code>, all messags are printed to the logger, including send/receive events.
                Can be useful for debugging because you can still see messages received by the <code>DialogSystem</code>
                even if they are never forwarded (as expected) to your <code>Service</code></p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">services</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Service</span><span class="p">,</span> <span class="n">RemoteService</span><span class="p">]],</span> <span class="n">sub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65533</span><span class="p">,</span> <span class="n">pub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65534</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">reg_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;tcp&#39;</span><span class="p">,</span> <span class="n">debug_logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        services (List[Union[Service, RemoteService]]): List of all (remote) services to connect to.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">                                                        Only once they&#39;re specified here will they start listening for</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                                                        messages.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        sub_port(int): subscriber port</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        sub_addr(str): IP-address or domain name of proxy subscriber interface (e.g. 127.0.0.1 for your local machine)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        pub_port(int): publisher port</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        pub_addr(str): IP-address or domain name of proxy publisher interface (e.g. 127.0.0.1 for your local machine) </span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        reg_port (int): registration port for remote services</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        protocol(str): communication protol, either &#39;inproc&#39; or &#39;tcp&#39; or `ipc`</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        debug_logger (DiasysLogger): If not `None`, all messags are printed to the logger, including send/receive events.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">                            Can be useful for debugging because you can still see messages received by the `DialogSystem`</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">                            even if they are never forwarded (as expected) to your `Service`</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="c1"># node-local topics</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span> <span class="o">=</span> <span class="n">debug_logger</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_remote_identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># collects names and instances of local services</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_start_dialog_services</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># collects names of local services that subscribe to dialog_start</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="c1"># node-local sockets</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_domains</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="c1"># start proxy thread</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span> <span class="o">=</span> <span class="n">ProcessProxy</span><span class="p">(</span><span class="n">in_type</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">XSUB</span><span class="p">,</span> <span class="n">out_type</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">XPUB</span><span class="p">)</span>  <span class="c1"># , mon_type=zmq.XSUB)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span><span class="o">.</span><span class="n">bind_in</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">pub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span><span class="o">.</span><span class="n">bind_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_dev</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span> <span class="o">=</span> <span class="n">sub_port</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pub_port</span> <span class="o">=</span> <span class="n">pub_port</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="c1"># thread control</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_start_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_end_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="c1"># control channels</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="o">.</span><span class="n">sndhwm</span> <span class="o">=</span> <span class="mi">1100000</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">pub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="c1"># register services (local and remote)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    <span class="n">remote_services</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>            <span class="c1"># register local service</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>            <span class="n">service_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">service</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">_identifier</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">service</span><span class="o">.</span><span class="n">_identifier</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>            <span class="n">service</span><span class="o">.</span><span class="n">_init_pubsub</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_service_info</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_domain_name</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>                                   <span class="n">service</span><span class="o">.</span><span class="n">_start_topic</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_end_topic</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">_terminate_topic</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>            <span class="n">service</span><span class="o">.</span><span class="n">_register_with_dialogsystem</span><span class="p">()</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">RemoteService</span><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="n">remote_services</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">service</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_register_remote_services</span><span class="p">(</span><span class="n">remote_services</span><span class="p">,</span> <span class="n">reg_port</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2">://127.0.0.1:</span><span class="si">{</span><span class="n">sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dialog_end_listener</span><span class="p">()</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.draw_system_graph" class="doc doc-heading">
<code class="highlight language-python"><span class="n">draw_system_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.draw_system_graph" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Draws a graph of the system as a directed graph.
    Services are represented by nodes, messages by directed edges (from publisher to subscriber).
    Warnings are drawn as yellow edges (and the missing subscribers represented by an 'UNCONNECTED SERVICES' node),
    errors as red edges (and the missing publishers represented by the 'UNCONNECTED SERVICES' node as well).
    Will mark remote services with blue.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>name</code></td>
        <td><code>str</code></td>
        <td><p>used to construct the name of your output file</p></td>
        <td><code>&#39;system&#39;</code></td>
      </tr>
      <tr>
        <td><code>format</code></td>
        <td><code>str</code></td>
        <td><p>output file format (e.g. png, pdf, jpg, ...)</p></td>
        <td><code>&#39;png&#39;</code></td>
      </tr>
      <tr>
        <td><code>show</code></td>
        <td><code>bool</code></td>
        <td><p>if True, the graph image will be opened in your default image viewer application</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>      <div class="admonition requires">
<p class="admonition-title">Requires</p>
<p>graphviz library (pip install graphviz)</p>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">draw_system_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Draws a graph of the system as a directed graph.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Services are represented by nodes, messages by directed edges (from publisher to subscriber).</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        Warnings are drawn as yellow edges (and the missing subscribers represented by an &#39;UNCONNECTED SERVICES&#39; node),</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        errors as red edges (and the missing publishers represented by the &#39;UNCONNECTED SERVICES&#39; node as well).</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        Will mark remote services with blue.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        name (str): used to construct the name of your output file</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        format (str): output file format (e.g. png, pdf, jpg, ...)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        show (bool): if True, the graph image will be opened in your default image viewer application</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    Requires:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        graphviz library (pip install graphviz)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="c1"># collect all services, errors and warnings</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">services</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">for</span> <span class="n">service_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">services</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">service_set</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">for</span> <span class="n">service_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">services</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">service_set</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_inconsistencies</span><span class="p">()</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="c1"># add services as nodes</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="k">if</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_identifiers</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f618d&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>  <span class="c1"># remote service</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1c2833&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>  <span class="c1"># local service</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s1">&#39;UNCONNECTED SERVICES&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#922b21&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="c1"># draw connections from publisher to subscribers as edges</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">publishers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">receivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="n">receivers</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="k">for</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>                <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="c1"># draw warnings and errors as edges to node &#39;UNCONNECTED SERVICES&#39;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="n">receivers</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="k">for</span> <span class="n">receiver</span> <span class="ow">in</span> <span class="n">receivers</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="s1">&#39;UNCONNECTED SERVICES&#39;</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#c34400&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;#c34400&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="n">publishers</span> <span class="o">=</span> <span class="n">warnings</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="k">for</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s1">&#39;UNCONNECTED SERVICES&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#e37c02&#39;</span><span class="p">,</span> <span class="n">fontcolor</span><span class="o">=</span><span class="s1">&#39;#e37c02&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="c1"># draw graph</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="n">g</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">view</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.is_error_free_messaging_pipeline" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_error_free_messaging_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.is_error_free_messaging_pipeline" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Checks the current messaging pipeline for potential errors.</p>
<p>(Potential) Errors are defined in this context as subscribed topics without publishers.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>True, if no potential errors could be found - else, False</p></td>
    </tr>
  </tbody>
</table>      <div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>Call this method after instantiating all services.</li>
<li>Lists only node-local (or process-local) inconsistencies.</li>
<li>Even if there are no errors returned by this method, there is not guarantee that all publishers 
eventually publish to their respective topics.</li>
</ul>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_error_free_messaging_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Checks the current messaging pipeline for potential errors.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    (Potential) Errors are defined in this context as subscribed topics without publishers.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        True, if no potential errors could be found - else, False</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        * Call this method after instantiating all services.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        * Lists only node-local (or process-local) inconsistencies.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        * Even if there are no errors returned by this method, there is not guarantee that all publishers </span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        eventually publish to their respective topics.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_inconsistencies</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.list_inconsistencies" class="doc doc-heading">
<code class="highlight language-python"><span class="n">list_inconsistencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.list_inconsistencies" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Checks for potential errors in the current messaging pipleline:
e.g. len(list_inconsistencies()[0]) == 0 -&gt; error free pipeline</p>
<p>(Potential) Errors are defined in this context as subscribed topics without publishers.
Warnings are defined in this context as published topics without subscribers.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>A touple of dictionaries</code></td>
      <td><ul>
<li>the first dictionary contains potential errors (with the mapping topics -&gt; subsribing services) </li>
<li>the second dictionary contains warnings (with the mapping topics -&gt; publishing services).</li>
</ul></td>
    </tr>
  </tbody>
</table>      <div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>Call this method after instantiating all services.</li>
<li>Even if there are no errors returned by this method, there is not guarantee that all publishers 
eventually publish to their respective topics.</li>
</ul>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">list_inconsistencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Checks for potential errors in the current messaging pipleline:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    e.g. len(list_inconsistencies()[0]) == 0 -&gt; error free pipeline</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    (Potential) Errors are defined in this context as subscribed topics without publishers.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Warnings are defined in this context as published topics without subscribers.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        A touple of dictionaries:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        * the first dictionary contains potential errors (with the mapping topics -&gt; subsribing services) </span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        * the second dictionary contains warnings (with the mapping topics -&gt; publishing services).</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        * Call this method after instantiating all services.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        * Even if there are no errors returned by this method, there is not guarantee that all publishers </span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        eventually publish to their respective topics.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="c1"># look for subscribers w/o publishers by checking topic prefixes</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">for</span> <span class="n">sub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">found_pub</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">pub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>            <span class="k">if</span> <span class="n">pub_topic</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sub_topic</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                <span class="n">found_pub</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="k">break</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_pub</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="n">errors</span><span class="p">[</span><span class="n">sub_topic</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">[</span><span class="n">sub_topic</span><span class="p">]</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="c1"># look for publishers w/o subscribers by checking topic prefixes</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="n">warnings</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">for</span> <span class="n">pub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="n">found_sub</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">for</span> <span class="n">sub_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="k">if</span> <span class="n">pub_topic</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sub_topic</span><span class="p">):</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">found_sub</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="k">break</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_sub</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="n">warnings</span><span class="p">[</span><span class="n">pub_topic</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">[</span><span class="n">pub_topic</span><span class="p">]</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="k">return</span> <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.list_published_topics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">list_published_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.list_published_topics" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Get all declared publisher topics.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>A dictionary with mapping
    topic (str) -&gt; publishing services (Set[str]).</p></td>
    </tr>
  </tbody>
</table>      <div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>Call this method after instantiating all services.</li>
<li>Even though a publishing topic might be listed here, there is no guarantee that
its publisher(s) might ever publish to it.</li>
</ul>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">list_published_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Get all declared publisher topics.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        A dictionary with mapping</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">            topic (str) -&gt; publishing services (Set[str]).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        * Call this method after instantiating all services.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        * Even though a publishing topic might be listed here, there is no guarantee that</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        its publisher(s) might ever publish to it.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">)</span>  <span class="c1"># copy s.t. no user changes this list</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.list_subscribed_topics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">list_subscribed_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.list_subscribed_topics" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Get all declared subscribed topics.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>A dictionary with mapping 
    topic (str) -&gt; subscribing services (Set[str]).</p></td>
    </tr>
  </tbody>
</table>      <div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>Call this method after instantiating all services.</li>
</ul>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">list_subscribed_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Get all declared subscribed topics.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        A dictionary with mapping </span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">            topic (str) -&gt; subscribing services (Set[str]).</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        * Call this method after instantiating all services.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">)</span>  <span class="c1"># copy s.t. no user changes this list</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.print_inconsistencies" class="doc doc-heading">
<code class="highlight language-python"><span class="n">print_inconsistencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.print_inconsistencies" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Checks for potential errors in the current messaging pipleline:
e.g. len(list_local_inconsistencies()[0]) == 0 -&gt; error free pipeline and prints them 
to the console.</p>
<p>(Potential) Errors are defined in this context as subscribed topics without publishers.
Warnings are defined in this context as published topics without subscribers.</p>
<div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>Call this method after instantiating all services.</li>
<li>Even if there are no errors returned by this method, there is not guarantee that all publishers 
eventually publish to their respective topics.</li>
</ul>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">print_inconsistencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Checks for potential errors in the current messaging pipleline:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    e.g. len(list_local_inconsistencies()[0]) == 0 -&gt; error free pipeline and prints them </span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    to the console.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    (Potential) Errors are defined in this context as subscribed topics without publishers.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Warnings are defined in this context as published topics without subscribers.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        * Call this method after instantiating all services.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        * Even if there are no errors returned by this method, there is not guarantee that all publishers </span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">        eventually publish to their respective topics.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="c1"># console colors</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_inconsistencies</span><span class="p">()</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Potential) Errors (subscribed topics without publishers):&quot;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  topic: &#39;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&#39;, subscribed to in services: </span><span class="si">{</span><span class="n">errors</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ENDC</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warnings (published topics without subscribers):&quot;</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  topic: &#39;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&#39;, published in services: </span><span class="si">{</span><span class="n">warnings</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ENDC</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.run_dialog" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_signals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dialog_end&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span></code>


<a href="#adviser.services.service.DialogSystem.run_dialog" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Run a complete dialog (blocking).
    Dialog will be started via messages to the topics specified in <code>start_signals</code>.
    The dialog will end on receiving any <code>Topic.DIALOG_END</code> message with value 'True',
    so make sure at least one service in your dialog graph will publish this message eventually.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>start_signals</code></td>
        <td><code>Dict[str, Any]</code></td>
        <td><p>mapping from topic -&gt; value
                            Publishes the value given for each topic to the respective topic.
                            Use this to trigger the start of your dialog system.</p></td>
        <td><code>{&#39;dialog_end&#39;: False}</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">run_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_signals</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">Topic</span><span class="o">.</span><span class="n">DIALOG_END</span><span class="p">:</span> <span class="kc">False</span><span class="p">}):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Run a complete dialog (blocking).</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Dialog will be started via messages to the topics specified in `start_signals`.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        The dialog will end on receiving any `Topic.DIALOG_END` message with value &#39;True&#39;,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        so make sure at least one service in your dialog graph will publish this message eventually.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        start_signals (Dict[str, Any]): mapping from topic -&gt; value</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">                                        Publishes the value given for each topic to the respective topic.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">                                        Use this to trigger the start of your dialog system.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_start_dialog</span><span class="p">(</span><span class="n">start_signals</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_end_dialog</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.shutdown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.shutdown" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Shutdown dialog system.
This will trigger <code>terminate</code> messages to be sent to all registered services to stop their listener loops.
Should be called in the end before exiting your program.
Blocks until all services sent ACK's confirming they're stopped.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Shutdown dialog system.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        This will trigger `terminate` messages to be sent to all registered services to stop their listener loops.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        Should be called in the end before exiting your program.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        Blocks until all services sent ACK&#39;s confirming they&#39;re stopped.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">for</span> <span class="n">terminate_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topics</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">_recv_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.stop" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Set stop event (can be queried by services via the <code>terminating()</code> function) </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Set stop event (can be queried by services via the `terminating()` function) &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.DialogSystem.terminating" class="doc doc-heading">
<code class="highlight language-python"><span class="n">terminating</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.DialogSystem.terminating" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Returns True if the system is stopping, else False </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">terminating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Returns True if the system is stopping, else False &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopEvent</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="adviser.services.service.RemoteService" class="doc doc-heading">
        <code>
RemoteService        </code>



<a href="#adviser.services.service.RemoteService" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This is a placeholder<code>to be used in the service list argument when constructing a</code>DialogSystem<code>:
* Run the real</code>Service<code>instance on a remote node, give it a *UNIQUE* identifier
    * call</code>run_standalone()<code>on this instance
* Instantiate a remote service on the node about to run the</code>DialogSystem<code>, assign the *SAME* identifier to it
    * add it to the</code>DialogSystem<code>service list
* Now, when calling the constructor of</code>DialogSystem`, you should see messages informing you about the 
  successfull connection, or if the system is still trying to connect, it will block until connected to
  the remote service.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">RemoteService</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    This is a placeholder` to be used in the service list argument when constructing a `DialogSystem`:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    * Run the real `Service` instance on a remote node, give it a *UNIQUE* identifier</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        * call `run_standalone()` on this instance</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    * Instantiate a remote service on the node about to run the `DialogSystem`, assign the *SAME* identifier to it</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        * add it to the `DialogSystem` service list</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    * Now, when calling the constructor of `DialogSystem`, you should see messages informing you about the </span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">      successfull connection, or if the system is still trying to connect, it will block until connected to</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">      the remote service.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">            identifier (str): the *UNIQUE* identifier to call the remote service instance</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.RemoteService.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.service.RemoteService.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>identifier</code></td>
        <td><code>str</code></td>
        <td><p>the <em>UNIQUE</em> identifier to call the remote service instance</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        identifier (str): the *UNIQUE* identifier to call the remote service instance</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="adviser.services.service.Service" class="doc doc-heading">
        <code>
Service        </code>



<a href="#adviser.services.service.Service" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Service base class.
Inherit from this class, if you want to publish / subscribe to topics <em>(Don't forget to call the super constructor!)</em>.
You may decorate arbitrary functions in the child class with the services.service.PublishSubscribe decorator
for this purpose.</p>
<div class="admonition note">
<p class="admonition-title">A <code>Service</code> will only start listening to messages once it is added to a <code>DialogSystem</code> </p>
<p>(or calling <code>run_standalone()</code> in the remote case and adding a corresponding <code>RemoteService</code> to the <code>DialogSystem</code>).</p>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Service</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Service base class.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Inherit from this class, if you want to publish / subscribe to topics *(Don&#39;t forget to call the super constructor!)*.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    You may decorate arbitrary functions in the child class with the services.service.PublishSubscribe decorator</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    for this purpose.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Note: A `Service` will only start listening to messages once it is added to a `DialogSystem` </span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">          (or calling `run_standalone()` in the remote case and adding a corresponding `RemoteService` to the `DialogSystem`).</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Domain</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">pub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                 <span class="n">ds_host_addr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">sub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65533</span><span class="p">,</span> <span class="n">pub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65534</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                 <span class="n">debug_logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">        Create a new service instance *(call this super constructor from your inheriting classes!)*.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">            domain (Union[str, Domain]): The domain(-name) of your service (or empty string, if domain-agnostic).</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">                                         If a domain(-name) is set, it will automatically filter out all messages from other domains.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">                                         If no domain(-name) is set, messages from all domains will be received.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">            sub_topic_domains (Dict[str, str]): change subscribed to topics to listen to a specific domain </span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">                                                (e.g. &#39;erase&#39;/append a domain for a specific topic)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">            pub_topic_domains (Dict[str, str]): change published topics to a specific domain</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">                                               (e.g. &#39;erase&#39;/append a domain for a specific topic)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">            ds_host_addr (str): IP-address of the parent `DialogSystem` (default: localhost)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">            sub_port (int): subscriber port following zmq&#39;s XSUB/XPUB pattern</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">            pub_port (int): publisher port following zmq&#39;s XSUB/XPUB pattern</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">            protocol (string): communication protocol with `DialogSystem` - has to match!</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">                               Possible options: `tcp`, `inproc`, `ipc`</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">            debug_logger (DiasysLogger): If not `None`, all messags are printed to the logger, including send/receive events.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">                                         Can be useful for debugging because you can still see messages received by the `DialogSystem`</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">                                         even if they are never forwarded (as expected) to your `Service`.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">            identifier (str): Set this to a *UNIQUE* identifier per service to be run remotely.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">                              See `RemoteService` for more details.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="c1"># get domain name (gets appended to all sub/pub topics so that different domain topics don&#39;t get shared)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="k">if</span> <span class="n">domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">Domain</span><span class="p">)</span> <span class="k">else</span> <span class="n">domain</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topic_domains</span> <span class="o">=</span> <span class="n">sub_topic_domains</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span> <span class="o">=</span> <span class="n">pub_topic_domains</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="c1"># socket information</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span> <span class="o">=</span> <span class="n">ds_host_addr</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span> <span class="o">=</span> <span class="n">sub_port</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pub_port</span> <span class="o">=</span> <span class="n">pub_port</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">protocol</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">identifier</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span> <span class="o">=</span> <span class="n">debug_logger</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_start_topics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_topics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_terminate_topics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="c1"># NOTE: class name + memory pointer make topic unique (required, e.g. for running mutliple instances of same module!)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/START&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_end_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/END&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/TERMINATE&quot;</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_train_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/TRAIN&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/EVAL&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>    <span class="k">def</span> <span class="nf">_init_pubsub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="sd">&quot;&quot;&quot; Search for all functions decorated with the `PublishSubscribe` decorator and call the setup methods for them &quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="k">for</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func_inst</span><span class="p">,</span> <span class="s2">&quot;pubsub&quot;</span><span class="p">):</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>                <span class="c1"># found decorated publisher / subscriber function -&gt; setup sockets and listeners</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_listener</span><span class="p">(</span><span class="n">func_inst</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func_inst</span><span class="p">,</span> <span class="s2">&quot;sub_topics&quot;</span><span class="p">),</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>                                     <span class="nb">getattr</span><span class="p">(</span><span class="n">func_inst</span><span class="p">,</span> <span class="s1">&#39;queued_sub_topics&#39;</span><span class="p">))</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_publishers</span><span class="p">(</span><span class="n">func_inst</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func_inst</span><span class="p">,</span> <span class="s2">&quot;pub_topics&quot;</span><span class="p">))</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>    <span class="k">def</span> <span class="nf">_register_with_dialogsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>        <span class="sd">&quot;&quot;&quot; Start listening to dialog system control channel messages &quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dialog_ctrl_msg_listener</span><span class="p">()</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_listener</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>    <span class="k">def</span> <span class="nf">_setup_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_instance</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">queued_topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a><span class="sd">        Starts a new subscription thread for a function decorated with `services.service.PublishSubscribe`.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="sd">            func_instance (function): instance of the function that was decorated with `services.service.PublishSubscribe`.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">            topics (List[str]): list of subscribed topics (drops all but most recent messages before function call)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="sd">            queued_topics (List[str]): list for subscribed topics (drops no messages, forward a list of received messages to function call)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">topics</span> <span class="o">+</span> <span class="n">queued_topics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>            <span class="c1"># no subscribed to topics - no need to setup anything (e.g. only publisher)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>            <span class="k">return</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>            <span class="c1"># ensure that sub_topics and queued_sub_topics don&#39;t intersect (otherwise, both would set same function argument value)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">queued_topics</span><span class="p">),</span> <span class="s2">&quot;sub_topics and queued_sub_topics have to be disjoint!&quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>        <span class="c1"># setup socket</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="n">subscriber</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="c1"># subscribe to all listed topics</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">topics</span> <span class="o">+</span> <span class="n">queued_topics</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>            <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>                <span class="c1"># overwrite domain for this specific topic and service instance</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>            <span class="n">subscriber</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>        <span class="c1"># subscribe to control channels</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>        <span class="n">subscriber</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func_instance</span><span class="si">}</span><span class="s2">/START&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>        <span class="n">subscriber</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func_instance</span><span class="si">}</span><span class="s2">/END&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>        <span class="n">subscriber</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func_instance</span><span class="si">}</span><span class="s2">/TERMINATE&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>        <span class="n">subscriber</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_start_topics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span><span class="si">}</span><span class="s2">/START&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_topics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span><span class="si">}</span><span class="s2">/END&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_terminate_topics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span><span class="si">}</span><span class="s2">/TERMINATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>        <span class="c1"># register and run listener thread</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>        <span class="n">listener_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_receiver_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">subscriber</span><span class="p">,</span> <span class="n">func_instance</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>                                                                     <span class="n">topics</span><span class="p">,</span> <span class="n">queued_topics</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>                                                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span><span class="si">}</span><span class="s2">/START&quot;</span><span class="p">,</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>                                                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span><span class="si">}</span><span class="s2">/END&quot;</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>                                                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">func_instance</span><span class="p">)</span><span class="si">}</span><span class="s2">/TERMINATE&quot;</span><span class="p">))</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>        <span class="n">listener_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>        <span class="c1"># add to list of local topics</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>        <span class="c1"># TODO maybe add topic_domain_str instead for more clarity?</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">topics</span> <span class="o">+</span> <span class="n">queued_topics</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>    <span class="k">def</span> <span class="nf">_setup_publishers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_instance</span><span class="p">,</span> <span class="n">topics</span><span class="p">):</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>        <span class="sd">&quot;&quot;&quot; Creates a publish socket for a function decorated with `services.service.PublishSubscribe`. &quot;&quot;&quot;</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>            <span class="k">return</span> <span class="c1"># no topics - no need for a socket</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>        <span class="c1"># setup publish socket</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>        <span class="n">publisher</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>        <span class="n">publisher</span><span class="o">.</span><span class="n">sndhwm</span> <span class="o">=</span> <span class="mi">1100000</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>        <span class="n">publisher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_instance</span><span class="p">]</span> <span class="o">=</span> <span class="n">publisher</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>        <span class="c1"># add to list of local topics</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">topics</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>    <span class="k">def</span> <span class="nf">_setup_dialog_ctrl_msg_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>        <span class="sd">&quot;&quot;&quot; Setup a subscriber socket to receive `DialogSystem` control message &quot;&quot;&quot;</span> 
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>        <span class="c1"># setup receiver for dialog system control messages</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_topic</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_topic</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topic</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_topic</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eval_topic</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>        <span class="c1"># setup sender for dialog system control message acknowledgements </span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="o">.</span><span class="n">sndhwm</span> <span class="o">=</span> <span class="mi">1100000</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>        <span class="c1"># setup receiver for internal ACK messages</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_control_channel_sub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>        <span class="k">for</span> <span class="n">internal_ctrl_topic</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_topics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_internal_start_topics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_terminate_topics</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_control_channel_sub</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>                                                          <span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ACK/</span><span class="si">{</span><span class="n">internal_ctrl_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_control_channel_sub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>    <span class="k">def</span> <span class="nf">_control_channel_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>        <span class="sd">&quot;&quot;&quot; Using the control message subscription socket, listen to control messages from the `DialogSystem` in a loop.</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a><span class="sd">            Meant to be called in a thread.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a>        <span class="n">listen</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>        <span class="k">while</span> <span class="n">listen</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>                <span class="c1"># receive message for subscribed control topic</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a>                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_sub</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>                <span class="n">topic</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>                <span class="n">timestamp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_topic</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>                    <span class="c1"># initialize dialog state</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dialog_start</span><span class="p">()</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>                    <span class="c1"># set all listeners of this service to listening mode (block until they are listening)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>                    <span class="k">for</span> <span class="n">internal_start_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_start_topics</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>                        <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="n">internal_start_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>                        <span class="n">_recv_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_control_channel_sub</span><span class="p">,</span> <span class="n">internal_start_topic</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_topic</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>                <span class="k">elif</span> <span class="n">topic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_topic</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>                    <span class="c1"># stop all listeners of this service (block until they stopped)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>                    <span class="k">for</span> <span class="n">internal_end_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_topics</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>                        <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="n">internal_end_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>                        <span class="n">_recv_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_control_channel_sub</span><span class="p">,</span> <span class="n">internal_end_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dialog_end</span><span class="p">()</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_topic</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>                <span class="k">elif</span> <span class="n">topic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topic</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>                    <span class="c1"># terminate all listeners of this service (block until they stopped)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>                    <span class="k">for</span> <span class="n">internal_terminate_topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_terminate_topics</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>                        <span class="n">_send_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="n">internal_terminate_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>                        <span class="n">_recv_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_control_channel_sub</span><span class="p">,</span> <span class="n">internal_terminate_topic</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dialog_exit</span><span class="p">()</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topic</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>                    <span class="n">listen</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>                <span class="k">elif</span> <span class="n">topic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_topic</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_topic</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>                <span class="k">elif</span> <span class="n">topic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_topic</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_control_channel_pub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_topic</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;- (Service): received unknown control message from topic&quot;</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>                                               <span class="s2">&quot; with content&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>                <span class="k">break</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>                <span class="kn">import</span> <span class="nn">traceback</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR in Service: _control_channel_listener&quot;</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>        <span class="sd">&quot;&quot;&quot; This function is called before the first message to a new dialog is published.</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a><span class="sd">            You should overwrite this function to set/reset dialog-level variables. &quot;&quot;&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>        <span class="k">pass</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>    <span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>        <span class="sd">&quot;&quot;&quot; This function is called after a dialog ended (Topics.DIALOG_END message was received).</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a><span class="sd">            You should overwrite this function to record dialog-level information. &quot;&quot;&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a>        <span class="k">pass</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a>    <span class="k">def</span> <span class="nf">dialog_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a>        <span class="sd">&quot;&quot;&quot; This function is called when the dialog system is shutting down.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a><span class="sd">            You should overwrite this function to stop your threads and cleanup any open resources. &quot;&quot;&quot;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>        <span class="k">pass</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>        <span class="sd">&quot;&quot;&quot; Sets module to training mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>        <span class="sd">&quot;&quot;&quot; Sets module to eval mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>    <span class="k">def</span> <span class="nf">run_standalone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_reg_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">):</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a><span class="sd">        Run this service as a standalone serivce (without a `DialogSystem`) on a remote node.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a><span class="sd">        Use a `RemoteService` with *corresponding identifier* on the `DialogSystem` node to connect both.</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a><span class="sd">        Note: this call is blocking!</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a><span class="sd">            host_reg_port (int): The port on the `DialogSystem` node listening for `Service` register requests</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;running a service on a remote node requires a unique identifier&quot;</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for dialog system host...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>        <span class="c1"># send service info to dialog system node</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_init_pubsub</span><span class="p">()</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a>        <span class="n">sync_endpoint</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>        <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">host_reg_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_topic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_topic</span><span class="p">,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>                             <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topic</span><span class="p">))</span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>        <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">((</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;REGISTER_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">),</span> <span class="n">data</span><span class="p">))</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>        <span class="c1"># wait for registration confirmation</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>        <span class="n">registered</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">registered</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ACK_REGISTER_&quot;</span><span class="p">):</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>                <span class="n">remote_service_identifier</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;ACK_REGISTER_&quot;</span><span class="p">):]</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>                <span class="k">if</span> <span class="n">remote_service_identifier</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_register_with_dialogsystem</span><span class="p">()</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>                    <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>                        <span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CONF_REGISTER_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">),</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="kc">True</span><span class="p">)))</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>                    <span class="n">registered</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>    <span class="k">def</span> <span class="nf">get_all_subscribed_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a><span class="sd">            Set of all topics subscribed to by this `Service`</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>    <span class="k">def</span> <span class="nf">get_all_published_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a><span class="sd">            Set of all topics published to by this `Service` </span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>    <span class="k">def</span> <span class="nf">_receiver_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">:</span> <span class="n">Socket</span><span class="p">,</span> <span class="n">func_instance</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>                         <span class="n">topics</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">queued_topics</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>                         <span class="n">start_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a><span class="sd">        Loop for receiving messages.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a><span class="sd">        Will continue until a message for `terminate_topic` is received.</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a><span class="sd">        Handles waiting for messages, decoding, unpickling and subscription topic to  </span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a><span class="sd">        service function keyword mapping.</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a><span class="sd">        Meant to be run in a Thread!</span>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a><span class="sd">            subscriber (Socket): subscriber socket</span>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a><span class="sd">            func_instance (function instance): the decorated subscriber function instance to be called with the received messages</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a><span class="sd">            topics (Iterable[str]): all last-message-only topics the decorated `func_instance` subscribes to</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a><span class="sd">            queued_topics (Iterable[str]): all collect-all-messages-since-last-call topics the decorated `func_instance` subscribes to</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a><span class="sd">            start_topic (str): Control message topic to set this specific `function_instance` into listening mode (receive all non-control messages)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a><span class="sd">            end_topic (str): Control message topic to set this specific `function_instance` into non-listening mode (ignore all non-control messages)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a><span class="sd">            terminate_topic (str): Control message topic to end the listener loop for this specific `function_instance`. </span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a><span class="sd">                                   Also closes the socket before returning.</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>        <span class="n">control_channel_pub</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>        <span class="n">control_channel_pub</span><span class="o">.</span><span class="n">sndhwm</span> <span class="o">=</span> <span class="mi">1100000</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>        <span class="n">control_channel_pub</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>        <span class="n">all_sub_topics</span> <span class="o">=</span> <span class="n">topics</span> <span class="o">+</span> <span class="n">queued_topics</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>        <span class="n">num_topics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_sub_topics</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>        <span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>        <span class="n">terminating</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">terminating</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>                <span class="n">msg</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>                <span class="n">topic</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>                <span class="c1"># based on topic, decide what to do</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="o">==</span> <span class="n">start_topic</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>                    <span class="c1"># reset values and start listening to non-control messages</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>                    <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>                    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>                    <span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="n">control_channel_pub</span><span class="p">,</span> <span class="n">start_topic</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a>                <span class="k">elif</span> <span class="n">topic</span> <span class="o">==</span> <span class="n">end_topic</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>                    <span class="c1"># ignore all non-control messages</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a>                    <span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="n">control_channel_pub</span><span class="p">,</span> <span class="n">end_topic</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a>                <span class="k">elif</span> <span class="n">topic</span> <span class="o">==</span> <span class="n">terminate_topic</span><span class="p">:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a>                    <span class="c1"># shutdown listener thread by exiting loop</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a>                    <span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a>                    <span class="n">_send_ack</span><span class="p">(</span><span class="n">control_channel_pub</span><span class="p">,</span> <span class="n">terminate_topic</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a>                    <span class="n">terminating</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>                    <span class="c1"># non-control message</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>                    <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>                        <span class="c1"># process message</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>                        <span class="n">timestamp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>                                <span class="sa">f</span><span class="s2">&quot;- (DS): listener thread for function </span><span class="si">{</span><span class="n">func_instance</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   received for topic </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a>                        <span class="c1"># simple synchronization mechanism: remember only newest values,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>                        <span class="c1"># store them until there was at least 1 new value received per topic.</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>                        <span class="c1"># Then call callback function with complete set of values.</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>                        <span class="c1"># Reset values afterwards and start collecting again.</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>                        <span class="c1"># problem: routing based on prefixes -&gt; function argument names may differ</span>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>                        <span class="c1"># solution: find longest common prefix of argument name and received topic</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>                        <span class="n">common_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_sub_topics</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>                            <span class="k">if</span> <span class="n">topic</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">):</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>                                <span class="n">common_prefix</span> <span class="o">=</span> <span class="n">key</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>                        <span class="k">if</span> <span class="n">common_prefix</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>                            <span class="c1"># store only latest value</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>                            <span class="n">values</span><span class="p">[</span><span class="n">common_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>  <span class="c1"># set value for received topic</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a>                            <span class="n">timestamps</span><span class="p">[</span><span class="n">common_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span>  <span class="c1"># set timestamp for received value</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>                            <span class="c1"># topic is a queued_topic - queue all values and their timestamps</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">common_prefix</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a>                                <span class="n">values</span><span class="p">[</span><span class="n">common_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>                                <span class="n">timestamps</span><span class="p">[</span><span class="n">common_prefix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>                            <span class="n">values</span><span class="p">[</span><span class="n">common_prefix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>                            <span class="n">timestamps</span><span class="p">[</span><span class="n">common_prefix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_topics</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a>                            <span class="c1"># received a new value for each topic -&gt; call callback function</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>                            <span class="k">if</span> <span class="n">func_instance</span><span class="o">.</span><span class="n">timestamp_enabled</span><span class="p">:</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>                                <span class="c1"># append timestamps, if required</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>                                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a>                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a>                                    <span class="sa">f</span><span class="s2">&quot;- (DS): received all messages for function </span><span class="si">{</span><span class="n">func_instance</span><span class="si">}</span><span class="se">\n</span><span class="s2">   -&gt; CALLING function&quot;</span><span class="p">)</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">Service</span><span class="p">:</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a>                                <span class="c1"># NOTE workaround for publisher / subscriber without being an instance method</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>                                <span class="n">func_instance</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a>                            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>                                <span class="n">func_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a>                            <span class="c1"># reset values</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>                            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a>                            <span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a>                <span class="k">break</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;THREAD ERROR&quot;</span><span class="p">)</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>                <span class="kn">import</span> <span class="nn">traceback</span>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a>                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>        <span class="c1"># shutdown</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>        <span class="n">subscriber</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="o">=</span><span class="p">{},</span> <span class="n">pub_topic_domains</span><span class="o">=</span><span class="p">{},</span> <span class="n">ds_host_addr</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">sub_port</span><span class="o">=</span><span class="mi">65533</span><span class="p">,</span> <span class="n">pub_port</span><span class="o">=</span><span class="mi">65534</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s1">&#39;tcp&#39;</span><span class="p">,</span> <span class="n">debug_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.service.Service.__init__" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Create a new service instance <em>(call this super constructor from your inheriting classes!)</em>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Union[str, Domain]</code></td>
        <td><p>The domain(-name) of your service (or empty string, if domain-agnostic).
                         If a domain(-name) is set, it will automatically filter out all messages from other domains.
                         If no domain(-name) is set, messages from all domains will be received.</p></td>
        <td><code>&#39;&#39;</code></td>
      </tr>
      <tr>
        <td><code>sub_topic_domains</code></td>
        <td><code>Dict[str, str]</code></td>
        <td><p>change subscribed to topics to listen to a specific domain 
                                (e.g. 'erase'/append a domain for a specific topic)</p></td>
        <td><code>{}</code></td>
      </tr>
      <tr>
        <td><code>pub_topic_domains</code></td>
        <td><code>Dict[str, str]</code></td>
        <td><p>change published topics to a specific domain
                               (e.g. 'erase'/append a domain for a specific topic)</p></td>
        <td><code>{}</code></td>
      </tr>
      <tr>
        <td><code>ds_host_addr</code></td>
        <td><code>str</code></td>
        <td><p>IP-address of the parent <code>DialogSystem</code> (default: localhost)</p></td>
        <td><code>&#39;127.0.0.1&#39;</code></td>
      </tr>
      <tr>
        <td><code>sub_port</code></td>
        <td><code>int</code></td>
        <td><p>subscriber port following zmq's XSUB/XPUB pattern</p></td>
        <td><code>65533</code></td>
      </tr>
      <tr>
        <td><code>pub_port</code></td>
        <td><code>int</code></td>
        <td><p>publisher port following zmq's XSUB/XPUB pattern</p></td>
        <td><code>65534</code></td>
      </tr>
      <tr>
        <td><code>protocol</code></td>
        <td><code>string</code></td>
        <td><p>communication protocol with <code>DialogSystem</code> - has to match!
               Possible options: <code>tcp</code>, <code>inproc</code>, <code>ipc</code></p></td>
        <td><code>&#39;tcp&#39;</code></td>
      </tr>
      <tr>
        <td><code>debug_logger</code></td>
        <td><code>DiasysLogger</code></td>
        <td><p>If not <code>None</code>, all messags are printed to the logger, including send/receive events.
                         Can be useful for debugging because you can still see messages received by the <code>DialogSystem</code>
                         even if they are never forwarded (as expected) to your <code>Service</code>.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>identifier</code></td>
        <td><code>str</code></td>
        <td><p>Set this to a <em>UNIQUE</em> identifier per service to be run remotely.
              See <code>RemoteService</code> for more details.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Domain</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">pub_topic_domains</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">ds_host_addr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">sub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65533</span><span class="p">,</span> <span class="n">pub_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65534</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">debug_logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Create a new service instance *(call this super constructor from your inheriting classes!)*.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        domain (Union[str, Domain]): The domain(-name) of your service (or empty string, if domain-agnostic).</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">                                     If a domain(-name) is set, it will automatically filter out all messages from other domains.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">                                     If no domain(-name) is set, messages from all domains will be received.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        sub_topic_domains (Dict[str, str]): change subscribed to topics to listen to a specific domain </span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">                                            (e.g. &#39;erase&#39;/append a domain for a specific topic)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        pub_topic_domains (Dict[str, str]): change published topics to a specific domain</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">                                           (e.g. &#39;erase&#39;/append a domain for a specific topic)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">        ds_host_addr (str): IP-address of the parent `DialogSystem` (default: localhost)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">        sub_port (int): subscriber port following zmq&#39;s XSUB/XPUB pattern</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">        pub_port (int): publisher port following zmq&#39;s XSUB/XPUB pattern</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        protocol (string): communication protocol with `DialogSystem` - has to match!</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">                           Possible options: `tcp`, `inproc`, `ipc`</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">        debug_logger (DiasysLogger): If not `None`, all messags are printed to the logger, including send/receive events.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">                                     Can be useful for debugging because you can still see messages received by the `DialogSystem`</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">                                     even if they are never forwarded (as expected) to your `Service`.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">        identifier (str): Set this to a *UNIQUE* identifier per service to be run remotely.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">                          See `RemoteService` for more details.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="c1"># get domain name (gets appended to all sub/pub topics so that different domain topics don&#39;t get shared)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="k">if</span> <span class="n">domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_domain_name</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">Domain</span><span class="p">)</span> <span class="k">else</span> <span class="n">domain</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topic_domains</span> <span class="o">=</span> <span class="n">sub_topic_domains</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span> <span class="o">=</span> <span class="n">pub_topic_domains</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="c1"># socket information</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span> <span class="o">=</span> <span class="n">ds_host_addr</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_sub_port</span> <span class="o">=</span> <span class="n">sub_port</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pub_port</span> <span class="o">=</span> <span class="n">pub_port</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">protocol</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">identifier</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span> <span class="o">=</span> <span class="n">debug_logger</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_internal_start_topics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_internal_end_topics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_internal_terminate_topics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="c1"># NOTE: class name + memory pointer make topic unique (required, e.g. for running mutliple instances of same module!)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_start_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/START&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_end_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/END&quot;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/TERMINATE&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_train_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/TRAIN&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_eval_topic</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">/EVAL&quot;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.dialog_end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.dialog_end" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>This function is called after a dialog ended (Topics.DIALOG_END message was received).
You should overwrite this function to record dialog-level information. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; This function is called after a dialog ended (Topics.DIALOG_END message was received).</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        You should overwrite this function to record dialog-level information. &quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.dialog_exit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.dialog_exit" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>This function is called when the dialog system is shutting down.
You should overwrite this function to stop your threads and cleanup any open resources. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; This function is called when the dialog system is shutting down.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        You should overwrite this function to stop your threads and cleanup any open resources. &quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.dialog_start" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>This function is called before the first message to a new dialog is published.
You should overwrite this function to set/reset dialog-level variables. </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; This function is called before the first message to a new dialog is published.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        You should overwrite this function to set/reset dialog-level variables. &quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.eval" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.eval" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Sets module to eval mode </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Sets module to eval mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.get_all_published_topics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_all_published_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.get_all_published_topics" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>Set of all topics published to by this <code>Service</code> </p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_all_published_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        Set of all topics published to by this `Service` </span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.get_all_subscribed_topics" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_all_subscribed_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.get_all_subscribed_topics" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td></td>
      <td><p>Set of all topics subscribed to by this <code>Service</code></p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_all_subscribed_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        Set of all topics subscribed to by this `Service`</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.run_standalone" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_standalone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_reg_port</span><span class="o">=</span><span class="mi">65535</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.run_standalone" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Run this service as a standalone serivce (without a <code>DialogSystem</code>) on a remote node.
Use a <code>RemoteService</code> with <em>corresponding identifier</em> on the <code>DialogSystem</code> node to connect both.
Note: this call is blocking!</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>host_reg_port</code></td>
        <td><code>int</code></td>
        <td><p>The port on the <code>DialogSystem</code> node listening for <code>Service</code> register requests</p></td>
        <td><code>65535</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">run_standalone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_reg_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Run this service as a standalone serivce (without a `DialogSystem`) on a remote node.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Use a `RemoteService` with *corresponding identifier* on the `DialogSystem` node to connect both.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Note: this call is blocking!</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        host_reg_port (int): The port on the `DialogSystem` node listening for `Service` register requests</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;running a service on a remote node requires a unique identifier&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for dialog system host...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="c1"># send service info to dialog system node</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_init_pubsub</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">sync_endpoint</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host_addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">host_reg_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_topics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_topic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_topic</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                         <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_topic</span><span class="p">))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">((</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;REGISTER_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">),</span> <span class="n">data</span><span class="p">))</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="c1"># wait for registration confirmation</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">registered</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">while</span> <span class="ow">not</span> <span class="n">registered</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ACK_REGISTER_&quot;</span><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="n">remote_service_identifier</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;ACK_REGISTER_&quot;</span><span class="p">):]</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="k">if</span> <span class="n">remote_service_identifier</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_register_with_dialogsystem</span><span class="p">()</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                <span class="n">sync_endpoint</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                    <span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CONF_REGISTER_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">),</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="kc">True</span><span class="p">)))</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="n">registered</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="adviser.services.service.Service.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.service.Service.train" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Sets module to training mode </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Sets module to training mode &quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="adviser.services.service.PublishSubscribe" class="doc doc-heading">
<code class="highlight language-python"><span class="n">PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[],</span> <span class="n">queued_sub_topics</span><span class="o">=</span><span class="p">[])</span></code>


<a href="#adviser.services.service.PublishSubscribe" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>Decorator function for services.
To be able to publish / subscribe to / from topics,
your class is required to inherit from services.service.Service.
Then, decorate any function you like.</p>
<p>Your function will be called as soon as:
    * at least one message is received for each topic in sub_topics (only latest message will be forwarded, others dropped)
    * at least one message is received for each topic in queued_sub_topics (all messages since the previous function call will be forwarded as a list)</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>sub_topics(List[str</code></td>
        <td><code>or utils.topics.Topic]</code></td>
        <td><p>The topics you want to get the latest messages from.
                                         If multiple messages are received until your function is called,
                                         you will only receive the value of the latest message, previously received
                                         values will be discarded.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>pub_topics(List[str</code></td>
        <td><code>or utils.topics.Topic]</code></td>
        <td><p>The topics you want to publish messages to.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>queued_sub_topics(List[str</code></td>
        <td><code>or utils.topics.Topic]</code></td>
        <td><p>The topics you want to get all messages from.
                                                If multiple messages are received until your function is called,
                                                you will receive all values since the previous function call as a list.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>      <div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>Subscription topic names have to match your function keywords</li>
<li>Your function should return a dictionary with the keys matching your publish topics names 
  and the value being any arbitrary python object or primitive type you want to send</li>
<li>sub_topics and queued_sub_topics have to be disjoint!</li>
<li>If you need timestamps for your messages, specify a 'timestamps' argument in your subscribing function.
  It will be filled by a dictionary providing timestamps for each received value, indexed by name.</li>
</ul>
</div>
<p>Technical notes:
    * Data will be automatically pickled / unpickled during send / receive to reduce meassage size.
      However, some python objects are not serializable (e.g. database connections) for good reasons
      and will throw an error if you try to publish them.
    * The domain name of your service class will be appended to your publish topics.
      Subscription topics are prefix-matched, so you will receive all messages from 'topic/suffix'
      if you subscibe to 'topic'.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/service.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">pub_topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">queued_sub_topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Decorator function for services.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    To be able to publish / subscribe to / from topics,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    your class is required to inherit from services.service.Service.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Then, decorate any function you like.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Your function will be called as soon as:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        * at least one message is received for each topic in sub_topics (only latest message will be forwarded, others dropped)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        * at least one message is received for each topic in queued_sub_topics (all messages since the previous function call will be forwarded as a list)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        sub_topics(List[str or utils.topics.Topic]): The topics you want to get the latest messages from.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">                                                     If multiple messages are received until your function is called,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">                                                     you will only receive the value of the latest message, previously received</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">                                                     values will be discarded.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">        pub_topics(List[str or utils.topics.Topic]): The topics you want to publish messages to.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        queued_sub_topics(List[str or utils.topics.Topic]): The topics you want to get all messages from.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">                                                            If multiple messages are received until your function is called,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">                                                            you will receive all values since the previous function call as a list.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">    Notes:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">        * Subscription topic names have to match your function keywords</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">        * Your function should return a dictionary with the keys matching your publish topics names </span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">          and the value being any arbitrary python object or primitive type you want to send</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">        * sub_topics and queued_sub_topics have to be disjoint!</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">        * If you need timestamps for your messages, specify a &#39;timestamps&#39; argument in your subscribing function.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">          It will be filled by a dictionary providing timestamps for each received value, indexed by name.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">    Technical notes:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">        * Data will be automatically pickled / unpickled during send / receive to reduce meassage size.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">          However, some python objects are not serializable (e.g. database connections) for good reasons</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">          and will throw an error if you try to publish them.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">        * The domain name of your service class will be appended to your publish topics.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">          Subscription topics are prefix-matched, so you will receive all messages from &#39;topic/suffix&#39;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">          if you subscibe to &#39;topic&#39;.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>                <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>                <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>                <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>            <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>            <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>            <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>                <span class="c1"># publish messages</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>                <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>                <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>                    <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>                        <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>                        <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>                        <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>                            <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>                        <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>                                <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="c1"># declare function as publish / subscribe functions and attach the respective topics</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="n">delegate</span><span class="o">.</span><span class="n">pubsub</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="n">delegate</span><span class="o">.</span><span class="n">sub_topics</span> <span class="o">=</span> <span class="n">sub_topics</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="n">delegate</span><span class="o">.</span><span class="n">queued_sub_topics</span> <span class="o">=</span> <span class="n">queued_sub_topics</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="n">delegate</span><span class="o">.</span><span class="n">pub_topics</span> <span class="o">=</span> <span class="n">pub_topics</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="c1"># check arguments: is subsriber interested in timestamps?</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>        <span class="n">delegate</span><span class="o">.</span><span class="n">timestamp_enabled</span> <span class="o">=</span> <span class="s1">&#39;timestamps&#39;</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>        <span class="k">return</span> <span class="n">delegate</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.simulator" class="doc doc-heading">
        <code>simulator</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">

      <p>This package contains the handcrafted user simulatod and related services.</p>



  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.simulator.emotion_simulator" class="doc doc-heading">
        <code>emotion_simulator</code>



<a href="#adviser.services.simulator.emotion_simulator" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.simulator.emotion_simulator.EmotionSimulator" class="doc doc-heading">
        <code>
EmotionSimulator            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Class which generates user emotion/engagements. Currently outputs either a user defined
or random emotion/engagement level and was designed to test the affective services
work correctly. However, in the future it could be extended to be more realistic.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/emotion_simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">EmotionSimulator</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Class which generates user emotion/engagements. Currently outputs either a user defined</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        or random emotion/engagement level and was designed to test the affective services</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        work correctly. However, in the future it could be extended to be more realistic.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                 <span class="n">random</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">static_emotion</span><span class="p">:</span> <span class="n">EmotionType</span> <span class="o">=</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Neutral</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                 <span class="n">static_engagement</span><span class="p">:</span> <span class="n">EngagementType</span> <span class="o">=</span> <span class="n">EngagementType</span><span class="o">.</span><span class="n">High</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">random</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">engagement</span> <span class="o">=</span> <span class="n">static_engagement</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">emotion</span> <span class="o">=</span> <span class="n">static_emotion</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;emotion&quot;</span><span class="p">,</span> <span class="s2">&quot;engagement&quot;</span><span class="p">])</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">def</span> <span class="nf">send_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_acts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">            Publishes an emotion and engagement value for a turn</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">                user_acts (List[UserAct]): the useracts, needed to synchronize when emotion should</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">                                           be generated</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">                (dict): A dictionary representing the simulated user emotion and engagement. The keys are</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">                        &quot;emotion&quot; and &quot;engagement&quot; where &quot;emotion&quot; is a dictionary which currently only contains</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">                        emotion category information but could be expanded to include other emotion measures, and</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">                        &quot;engagement&quot; corresponds to and EngagementType object.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;emotion&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotion</span><span class="p">},</span> <span class="s2">&quot;engagement&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">engagement</span><span class="p">}</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="n">emotion</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">EmotionType</span><span class="p">])</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="n">engagement</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">EngagementType</span><span class="p">])</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;emotion&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">emotion</span><span class="p">},</span> <span class="s2">&quot;engagement&quot;</span><span class="p">:</span> <span class="n">engagement</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.emotion_simulator.EmotionSimulator.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">static_emotion</span><span class="o">=&lt;</span><span class="n">EmotionType</span><span class="o">.</span><span class="n">Neutral</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">static_engagement</span><span class="o">=&lt;</span><span class="n">EngagementType</span><span class="o">.</span><span class="n">High</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="o">&gt;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/emotion_simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">random</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">static_emotion</span><span class="p">:</span> <span class="n">EmotionType</span> <span class="o">=</span> <span class="n">EmotionType</span><span class="o">.</span><span class="n">Neutral</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">static_engagement</span><span class="p">:</span> <span class="n">EngagementType</span> <span class="o">=</span> <span class="n">EngagementType</span><span class="o">.</span><span class="n">High</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">random</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">engagement</span> <span class="o">=</span> <span class="n">static_engagement</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">emotion</span> <span class="o">=</span> <span class="n">static_emotion</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.emotion_simulator.EmotionSimulator.send_emotion" class="doc doc-heading">
<code class="highlight language-python"><span class="n">send_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.emotion_simulator.EmotionSimulator.send_emotion" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/emotion_simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.simulator.goal" class="doc doc-heading">
        <code>goal</code>



<a href="#adviser.services.simulator.goal" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This module provides the Goal class and related stuff.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.simulator.goal.Constraint" class="doc doc-heading">
        <code>
Constraint        </code>



<a href="#adviser.services.simulator.goal.Constraint" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Constraint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        The class for a constraint as used in the goal.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">            slot (str): The slot.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">            value (str): The value.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="sd">&quot;&quot;&quot;Constraint should be equal if the slot and value is the same.&quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Constraint</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">slot</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">raise</span> <span class="ne">TypeError</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="k">raise</span> <span class="ne">IndexError</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="k">return</span> <span class="s2">&quot;Constraint(slot=</span><span class="si">{}</span><span class="s2">, value=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span> <span class="o">*</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Constraint.__eq__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.goal.Constraint.__eq__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Constraint should be equal if the slot and value is the same.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Constraint should be equal if the slot and value is the same.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Constraint</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">slot</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Constraint.__getitem__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.goal.Constraint.__getitem__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="k">raise</span> <span class="ne">TypeError</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">raise</span> <span class="ne">IndexError</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Constraint.__hash__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.goal.Constraint.__hash__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span> <span class="o">*</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Constraint.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.goal.Constraint.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>The class for a constraint as used in the goal.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>slot</code></td>
        <td><code>str</code></td>
        <td><p>The slot.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>value</code></td>
        <td><code>str</code></td>
        <td><p>The value.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    The class for a constraint as used in the goal.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        slot (str): The slot.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        value (str): The value.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Constraint.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.goal.Constraint.__repr__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="s2">&quot;Constraint(slot=</span><span class="si">{}</span><span class="s2">, value=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="adviser.services.simulator.goal.Goal" class="doc doc-heading">
        <code>
Goal        </code>



<a href="#adviser.services.simulator.goal.Goal" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Goal</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        The class representing a goal, therefore containing requests and constraints.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">            domain (JSONLookupDomain): The domain for which the goal will be instantiated.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">                It will only work within this domain.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            parameters (dict): The parameters for the goal defined by a key=value mapping: &#39;MinVenues&#39;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">                (int) allows to set a minimum number of venues which fulfill the constraints of the goal,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">                &#39;MinConstraints&#39; (int) and &#39;MaxConstraints&#39; (int) set the minimum and maximum amount of</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">                constraints respectively, &#39;MinRequests&#39; (int) and &#39;MaxRequests&#39; (int) set the minimum and</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">                maximum amount of requests respectively and &#39;Reachable&#39; (float) allows to specify how many</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">                (in percent) of all generated goals are definitely fulfillable (i.e. there exists a venue</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">                for the current goal) or not (doesn&#39;t have to be fulfillable). Although the parameter</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">                &#39;Reachable&#39; equals 1.0 implicitly states that &#39;MinVenues&#39; equals 1 or more, the</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">                implementation looks different, is more efficient and takes all goals into consideration</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">                (since &#39;Reachable&#39; is a float (percentage of generated goals)). On the other hand, setting</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">                &#39;MinVenues&#39; to any number bigger than 0 forces every goal to be fulfillable.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="c1"># cache inform and request slots</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="c1"># make sure to copy the list (shallow is sufficient)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">())[:])</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="c1"># make sure that primary key is never a constraint</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">())</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="c1"># TODO sometimes ask for specific primary key with very small probability (instead of any other constraints?) # pylint: disable=line-too-long</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inf_slot_values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inf_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                <span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">)[:])</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">req_slots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">()[:])</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="c1"># self.req_slots_without_informables = sorted(list(</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="c1">#     set(self.req_slots).difference(self.inf_slots)))</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="c1"># make sure that primary key is never a request as it is added anyway</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_slots</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">req_slots</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">())</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_inf_slot_values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">missing_informs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_goal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requests</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">        Initializes a goal randomly OR using the given constraints and requests.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">            random_goal (bool): If True, a goal will be drawn randomly from available constraints</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">                and requests (considering the parameters given in the constructor, if any). However if</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">                constraints and requests are given and both don&#39;t equal None, this parameter is</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">                considered as False. If False, the given constraints and requests are used.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">            constraints (List[Constraint]): The constraints which will be used for the goal.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">            requests (Dict[str, Union[None,str]]): The requests which will be used for the goal.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="c1"># reset goal</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_inf_slot_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>                                         <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_slot_values</span><span class="p">}</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="c1"># TODO implement possibility to pass either constraints or requests as a parameter</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="k">if</span> <span class="n">random_goal</span> <span class="ow">and</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">requests</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_init_random_goal</span><span class="p">()</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_parameters</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="c1"># make sure that primary key is always requested</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">missing_informs</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>                                <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>    <span class="k">def</span> <span class="nf">_init_random_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="sd">&quot;&quot;&quot;Randomly sets the constraints and requests for the goal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>        <span class="n">num_venues</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>        <span class="c1"># check that there exist at least self.parameters[&#39;MinVenues&#39;] venues for this goal</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="k">if</span> <span class="s1">&#39;MinVenues&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>            <span class="n">min_venues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MinVenues&#39;</span><span class="p">]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>            <span class="n">min_venues</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># default is to not have any lower bound</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>        <span class="k">while</span> <span class="n">num_venues</span> <span class="o">&lt;</span> <span class="n">min_venues</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>            <span class="c1"># TODO exclude &#39;dontcare&#39; from goal</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>            <span class="c1"># TODO make sure that minconstraints and minrequests are a valid number for the current domain # pylint: disable=line-too-long</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>            <span class="k">if</span> <span class="s1">&#39;MaxConstraints&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>                <span class="n">num_constraints_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MaxConstraints&#39;</span><span class="p">]))</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>                <span class="c1"># NOTE could become pretty high</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>                <span class="n">num_constraints_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>            <span class="k">if</span> <span class="s1">&#39;MinConstraints&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>                <span class="n">num_constraints_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MinConstraints&#39;</span><span class="p">])</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>                <span class="n">num_constraints_min</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>            <span class="c1"># draw constraints uniformly</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>            <span class="n">num_constraints</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>                <span class="n">num_constraints_min</span><span class="p">,</span> <span class="n">num_constraints_max</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>            <span class="n">constraint_slots</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="p">,</span> <span class="n">num_constraints</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Reachable&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>                    <span class="ow">and</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Reachable&#39;</span><span class="p">]):</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>                <span class="c1"># pick entity from database and set constraints</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>                    <span class="n">constraints</span><span class="o">=</span><span class="p">{},</span> <span class="n">requested_slots</span><span class="o">=</span><span class="n">constraint_slots</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>                <span class="k">assert</span> <span class="n">results</span><span class="p">,</span> <span class="s2">&quot;Cannot receive entity from database,</span><span class="se">\</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a><span class="s2">                        probably because the database is empty.&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>                <span class="n">entity</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>                <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraint_slots</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>                        <span class="n">constraint</span><span class="p">,</span> <span class="n">entity</span><span class="p">[</span><span class="n">constraint</span><span class="p">]))</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>                <span class="c1"># pick random constraints</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>                <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraint_slots</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">inf_slot_values</span><span class="p">[</span><span class="n">constraint</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>            <span class="c1"># check if there are enough venues for the current goal</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>            <span class="n">num_venues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>                <span class="n">constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">:</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">}))</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>            <span class="n">possible_req_slots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>                <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_slots</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">constraint_slots</span><span class="p">)))</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>            <span class="k">if</span> <span class="s1">&#39;MaxRequests&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>                <span class="n">num_requests_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">possible_req_slots</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MaxRequests&#39;</span><span class="p">]))</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>                <span class="c1"># NOTE could become pretty high</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>                <span class="n">num_requests_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_req_slots</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>            <span class="k">if</span> <span class="s1">&#39;MinRequests&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>                <span class="n">num_requests_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MinRequests&#39;</span><span class="p">])</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>                <span class="n">num_requests_min</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># primary key is included anyway</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>            <span class="n">num_requests</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>                <span class="n">num_requests_min</span><span class="p">,</span> <span class="n">num_requests_max</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{</span><span class="n">slot</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>                <span class="n">possible_req_slots</span><span class="p">,</span> <span class="n">num_requests</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>            <span class="c1"># print(self.requests)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>            <span class="c1"># print(self.constraints)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>            <span class="c1"># TODO add some remaining informable slot as request with some probability</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>            <span class="c1"># add_req_slots_candidates = list(set(self.inf_slots).difference(constraint_slots))</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>    <span class="k">def</span> <span class="nf">_init_from_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">requests</span><span class="p">):</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>        <span class="sd">&quot;&quot;&quot;Converts the given constraints and requests to the goal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>        <span class="c1"># initialise goal with given constraints and requests</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>            <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Constraint</span><span class="p">):</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>                    <span class="c1"># assume tuples in list with strings (slot, value)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">Constraint</span><span class="p">(</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>                        <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">]</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">Constraint</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>                                <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>                <span class="s2">&quot;Given constraints for goal must be of type list or dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>                <span class="c1"># assume list of strings</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">requests</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a>        <span class="n">num_venues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>            <span class="n">constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">:</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">}))</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>        <span class="k">if</span> <span class="s1">&#39;MinVenues&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>            <span class="k">assert</span> <span class="n">num_venues</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;MinVenues&#39;</span><span class="p">],</span> <span class="s2">&quot;There are not enough venues for</span><span class="se">\</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="s2">                the given constraints in the database. Either change constraints or lower</span><span class="se">\</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a><span class="s2">                parameter Goal:MinVenues.&quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>        <span class="sd">&quot;&quot;&quot;Resets all requests of the goal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>        <span class="c1"># reset goal -&gt; empty all requests</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>        <span class="c1"># for slot in self.requests:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>        <span class="c1">#     self.requests[slot] = None</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>        <span class="k">return</span> <span class="s2">&quot;Goal(constraints=</span><span class="si">{}</span><span class="s2">, requests=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>    <span class="c1"># NOTE only checks if requests are fulfilled,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>    <span class="c1"># not whether the result from the system conforms to the constraints</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>    <span class="k">def</span> <span class="nf">is_fulfilled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a><span class="sd">        Checks whether all requests have been fulfilled.</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a><span class="sd">            bool: ``True`` if all requests have been fulfilled, ``False`` otherwise.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a><span class="sd">        .. note:: Does not check whether the venue (issued by the system) fulfills the constraints</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a><span class="sd">            since it&#39;s the system&#39;s task to give an appropriate venue by requesting the user&#39;s</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a><span class="sd">            constraints.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>        <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>            <span class="k">assert</span> <span class="n">slot</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span>  <span class="c1"># TODO remove later</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>    <span class="k">def</span> <span class="nf">fulfill_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a><span class="sd">        Fulfills a request, i.e. sets ``value`` for request ``slot``.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a><span class="sd">            slot (str): The request slot which will be filled.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a><span class="sd">            value (str): The value the request slot will be filled with.</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>        <span class="k">if</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>    <span class="c1"># does not consider &#39;dontcare&#39;s</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>    <span class="c1"># NOTE better use is_inconsistent_constraint or is_inconsistent_constraint_strict</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>    <span class="c1"># def contains_constraint(self, constraint):</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>    <span class="c1">#     if constraint in self.constraints:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>    <span class="c1">#         return True</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>    <span class="c1">#     return False</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a>    <span class="c1"># constraint is consistent with goal if values match or value in goal is &#39;dontcare&#39;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>    <span class="k">def</span> <span class="nf">is_inconsistent_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a><span class="sd">        Checks whether the given constraint is consistent with the goal. A constraint is also</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a><span class="sd">        consistent if it&#39;s value is &#39;dontcare&#39; in the current goal.</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a><span class="sd">            constraint (Constraint): The constraint which will be checked for consistency.</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a><span class="sd">            bool: True if values match or value in goal is &#39;dontcare&#39;, False otherwise.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>        <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a>            <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">constraint</span><span class="o">.</span><span class="n">slot</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span> \
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>                                                        <span class="ow">and</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">):</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a>    <span class="c1"># constraint is consistent with goal if values match</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>    <span class="c1"># (&#39;dontcare&#39; is considered as different value)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a>    <span class="k">def</span> <span class="nf">is_inconsistent_constraint_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a><span class="sd">        Checks whether the given constraint is strictly consistent with the goal, whereby</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a><span class="sd">        &#39;dontcare&#39; is treated as a different value (no match).</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a><span class="sd">            constraint (Constraint): The constraint which will be checked for consistency.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a><span class="sd">            bool: True if values match, False otherwise.</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a><span class="sd">        !!! seealso &quot;See Also&quot;</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a><span class="sd">            [`is_inconsistent_constraint`][adviser.services.simulator.goal.Goal.is_inconsistent_constraint]</span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>        <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>            <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">constraint</span><span class="o">.</span><span class="n">slot</span> <span class="ow">and</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>        <span class="c1"># here there are only two possibilities: the constraint is implicitly &#39;dontcare&#39; because</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>        <span class="c1"># it is not explicitly listed and the given constraint is either 1) &#39;dontcare&#39; or 2) not</span>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>        <span class="k">return</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>    <span class="k">def</span> <span class="nf">get_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a><span class="sd">        Gets the value for a given constraint ``slot``.</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a><span class="sd">            slot (str): The constraint ``slot`` which will be looked up.</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a><span class="sd">            bool: The constraint ``value``.</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>        <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>            <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>                <span class="k">return</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>        <span class="k">return</span> <span class="s1">&#39;dontcare&#39;</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>    <span class="c1"># update the constraint with the slot &#39;slot&#39; with &#39;value&#39;, assuming the constraints are unique</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>    <span class="k">def</span> <span class="nf">update_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a><span class="sd">        Update a given constraint ``slot`` with ``value``.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a><span class="sd">            slot (str): The constraint *slot* which will be updated.</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a><span class="sd">            value (str): The *value* with which the constraint will be updated.</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a><span class="sd">            bool: ``True`` if update was successful, i.e. the constraint ``slot`` is included in</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a><span class="sd">            the goal, ``False`` otherwise.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>        <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>            <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>                <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.goal.Goal.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>The class representing a goal, therefore containing requests and constraints.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>JSONLookupDomain</code></td>
        <td><p>The domain for which the goal will be instantiated.
It will only work within this domain.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>parameters</code></td>
        <td><code>dict</code></td>
        <td><p>The parameters for the goal defined by a key=value mapping: 'MinVenues'
(int) allows to set a minimum number of venues which fulfill the constraints of the goal,
'MinConstraints' (int) and 'MaxConstraints' (int) set the minimum and maximum amount of
constraints respectively, 'MinRequests' (int) and 'MaxRequests' (int) set the minimum and
maximum amount of requests respectively and 'Reachable' (float) allows to specify how many
(in percent) of all generated goals are definitely fulfillable (i.e. there exists a venue
for the current goal) or not (doesn't have to be fulfillable). Although the parameter
'Reachable' equals 1.0 implicitly states that 'MinVenues' equals 1 or more, the
implementation looks different, is more efficient and takes all goals into consideration
(since 'Reachable' is a float (percentage of generated goals)). On the other hand, setting
'MinVenues' to any number bigger than 0 forces every goal to be fulfillable.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    The class representing a goal, therefore containing requests and constraints.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        domain (JSONLookupDomain): The domain for which the goal will be instantiated.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">            It will only work within this domain.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        parameters (dict): The parameters for the goal defined by a key=value mapping: &#39;MinVenues&#39;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            (int) allows to set a minimum number of venues which fulfill the constraints of the goal,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">            &#39;MinConstraints&#39; (int) and &#39;MaxConstraints&#39; (int) set the minimum and maximum amount of</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">            constraints respectively, &#39;MinRequests&#39; (int) and &#39;MaxRequests&#39; (int) set the minimum and</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">            maximum amount of requests respectively and &#39;Reachable&#39; (float) allows to specify how many</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">            (in percent) of all generated goals are definitely fulfillable (i.e. there exists a venue</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">            for the current goal) or not (doesn&#39;t have to be fulfillable). Although the parameter</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">            &#39;Reachable&#39; equals 1.0 implicitly states that &#39;MinVenues&#39; equals 1 or more, the</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">            implementation looks different, is more efficient and takes all goals into consideration</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">            (since &#39;Reachable&#39; is a float (percentage of generated goals)). On the other hand, setting</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">            &#39;MinVenues&#39; to any number bigger than 0 forces every goal to be fulfillable.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span> <span class="ow">or</span> <span class="p">{}</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="c1"># cache inform and request slots</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="c1"># make sure to copy the list (shallow is sufficient)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">())[:])</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="c1"># make sure that primary key is never a constraint</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">())</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="c1"># TODO sometimes ask for specific primary key with very small probability (instead of any other constraints?) # pylint: disable=line-too-long</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">inf_slot_values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_slots</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inf_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="n">slot</span><span class="p">)[:])</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">req_slots</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">()[:])</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="c1"># self.req_slots_without_informables = sorted(list(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="c1">#     set(self.req_slots).difference(self.inf_slots)))</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="c1"># make sure that primary key is never a request as it is added anyway</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_slots</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">req_slots</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">())</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">excluded_inf_slot_values</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">missing_informs</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.goal.Goal.__repr__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="s2">&quot;Goal(constraints=</span><span class="si">{}</span><span class="s2">, requests=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.fulfill_request" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fulfill_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.fulfill_request" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Fulfills a request, i.e. sets <code>value</code> for request <code>slot</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>slot</code></td>
        <td><code>str</code></td>
        <td><p>The request slot which will be filled.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>value</code></td>
        <td><code>str</code></td>
        <td><p>The value the request slot will be filled with.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">fulfill_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Fulfills a request, i.e. sets ``value`` for request ``slot``.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        slot (str): The request slot which will be filled.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        value (str): The value the request slot will be filled with.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">if</span> <span class="n">slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.get_constraint" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.get_constraint" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Gets the value for a given constraint <code>slot</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>slot</code></td>
        <td><code>str</code></td>
        <td><p>The constraint <code>slot</code> which will be looked up.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>The constraint <code>value</code>.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Gets the value for a given constraint ``slot``.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        slot (str): The constraint ``slot`` which will be looked up.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        bool: The constraint ``value``.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="k">return</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">return</span> <span class="s1">&#39;dontcare&#39;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.init" class="doc doc-heading">
<code class="highlight language-python"><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_goal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requests</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.init" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Initializes a goal randomly OR using the given constraints and requests.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>random_goal</code></td>
        <td><code>bool</code></td>
        <td><p>If True, a goal will be drawn randomly from available constraints
and requests (considering the parameters given in the constructor, if any). However if
constraints and requests are given and both don't equal None, this parameter is
considered as False. If False, the given constraints and requests are used.</p></td>
        <td><code>True</code></td>
      </tr>
      <tr>
        <td><code>constraints</code></td>
        <td><code>List[Constraint]</code></td>
        <td><p>The constraints which will be used for the goal.</p></td>
        <td><code>None</code></td>
      </tr>
      <tr>
        <td><code>requests</code></td>
        <td><code>Dict[str, Union[None,str]]</code></td>
        <td><p>The requests which will be used for the goal.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_goal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requests</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Initializes a goal randomly OR using the given constraints and requests.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        random_goal (bool): If True, a goal will be drawn randomly from available constraints</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">            and requests (considering the parameters given in the constructor, if any). However if</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">            constraints and requests are given and both don&#39;t equal None, this parameter is</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">            considered as False. If False, the given constraints and requests are used.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        constraints (List[Constraint]): The constraints which will be used for the goal.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        requests (Dict[str, Union[None,str]]): The requests which will be used for the goal.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="c1"># reset goal</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">excluded_inf_slot_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                                     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_slot_values</span><span class="p">}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="c1"># TODO implement possibility to pass either constraints or requests as a parameter</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">if</span> <span class="n">random_goal</span> <span class="ow">and</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">requests</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_init_random_goal</span><span class="p">()</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_parameters</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="c1"># make sure that primary key is always requested</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">missing_informs</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                            <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.is_fulfilled" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_fulfilled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.is_fulfilled" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Checks whether all requests have been fulfilled.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p><code>True</code> if all requests have been fulfilled, <code>False</code> otherwise.</p></td>
    </tr>
  </tbody>
</table>      <p>.. note:: Does not check whether the venue (issued by the system) fulfills the constraints
    since it's the system's task to give an appropriate venue by requesting the user's
    constraints.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_fulfilled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Checks whether all requests have been fulfilled.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        bool: ``True`` if all requests have been fulfilled, ``False`` otherwise.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    .. note:: Does not check whether the venue (issued by the system) fulfills the constraints</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        since it&#39;s the system&#39;s task to give an appropriate venue by requesting the user&#39;s</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        constraints.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">assert</span> <span class="n">slot</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span>  <span class="c1"># TODO remove later</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.is_inconsistent_constraint" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_inconsistent_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.is_inconsistent_constraint" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Checks whether the given constraint is consistent with the goal. A constraint is also
consistent if it's value is 'dontcare' in the current goal.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>constraint</code></td>
        <td><code>Constraint</code></td>
        <td><p>The constraint which will be checked for consistency.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>True if values match or value in goal is 'dontcare', False otherwise.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_inconsistent_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Checks whether the given constraint is consistent with the goal. A constraint is also</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    consistent if it&#39;s value is &#39;dontcare&#39; in the current goal.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        constraint (Constraint): The constraint which will be checked for consistency.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        bool: True if values match or value in goal is &#39;dontcare&#39;, False otherwise.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">constraint</span><span class="o">.</span><span class="n">slot</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span> \
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                                                    <span class="ow">and</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.is_inconsistent_constraint_strict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_inconsistent_constraint_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.is_inconsistent_constraint_strict" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Checks whether the given constraint is strictly consistent with the goal, whereby
'dontcare' is treated as a different value (no match).</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>constraint</code></td>
        <td><code>Constraint</code></td>
        <td><p>The constraint which will be checked for consistency.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>True if values match, False otherwise.</p></td>
    </tr>
  </tbody>
</table>      <div class="admonition seealso">
<p class="admonition-title">See Also</p>
<p><a class="autorefs autorefs-internal" href="#adviser.services.simulator.goal.Goal.is_inconsistent_constraint"><code>is_inconsistent_constraint</code></a></p>
</div>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_inconsistent_constraint_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Checks whether the given constraint is strictly consistent with the goal, whereby</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &#39;dontcare&#39; is treated as a different value (no match).</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        constraint (Constraint): The constraint which will be checked for consistency.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        bool: True if values match, False otherwise.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    !!! seealso &quot;See Also&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        [`is_inconsistent_constraint`][adviser.services.simulator.goal.Goal.is_inconsistent_constraint]</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">constraint</span><span class="o">.</span><span class="n">slot</span> <span class="ow">and</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="c1"># here there are only two possibilities: the constraint is implicitly &#39;dontcare&#39; because</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="c1"># it is not explicitly listed and the given constraint is either 1) &#39;dontcare&#39; or 2) not</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">return</span> <span class="n">constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.reset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.reset" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Resets all requests of the goal.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Resets all requests of the goal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="c1"># reset goal -&gt; empty all requests</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="c1"># for slot in self.requests:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="c1">#     self.requests[slot] = None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.goal.Goal.update_constraint" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.goal.Goal.update_constraint" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Update a given constraint <code>slot</code> with <code>value</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>slot</code></td>
        <td><code>str</code></td>
        <td><p>The constraint <em>slot</em> which will be updated.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>value</code></td>
        <td><code>str</code></td>
        <td><p>The <em>value</em> with which the constraint will be updated.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p><code>True</code> if update was successful, i.e. the constraint <code>slot</code> is included in
the goal, <code>False</code> otherwise.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/goal.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">update_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Update a given constraint ``slot`` with ``value``.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        slot (str): The constraint *slot* which will be updated.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        value (str): The *value* with which the constraint will be updated.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        bool: ``True`` if update was successful, i.e. the constraint ``slot`` is included in</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        the goal, ``False`` otherwise.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">slot</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="adviser.services.simulator.simulator" class="doc doc-heading">
        <code>simulator</code>



<a href="#adviser.services.simulator.simulator" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">

      <p>This module provides the agenda-based user model for the handcrafted simulator.</p>



  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.simulator.simulator.Agenda" class="doc doc-heading">
        <code>
Agenda        </code>



<a href="#adviser.services.simulator.simulator.Agenda" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>A stack-like object representing an agenda. Actions can be pushed on and popped off the agenda.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Agenda</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    A stack-like object representing an agenda. Actions can be pushed on and popped off the agenda.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">        Initializes the agenda given a goal. For this purpose, inform actions for constraints in</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">        the goal and request actions for requests in the goal are added such that the informs are</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">        handled first followed by the requests.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">            goal (Goal): The goal for which the agenda will be initialized.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="c1"># populate agenda according to goal</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="c1"># NOTE don&#39;t push bye action here since bye action could be poppped with another (missing)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="c1"># request, but user should not end dialog before having the goal fulfilled</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="c1"># NOTE do not add requests to agenda since system can&#39;t handle inform and request action in</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>        <span class="c1"># same turn currently!</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="c1"># self.fill_with_requests(goal)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fill_with_constraints</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="sd">&quot;&quot;&quot;Pushes *item* onto the agenda.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">            item: The goal for which the agenda will be initialized.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">+=</span> <span class="n">item</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="k">def</span> <span class="nf">get_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_actions</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="sd">&quot;&quot;&quot;Retrieves *num_actions* actions from the agenda.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="sd">            num_actions (int): Amount of actions which will be retrieved from the agenda.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a><span class="sd">            (List[UserAct]): list of *num_actions* user actions.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="k">if</span> <span class="n">num_actions</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num_actions</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="n">num_actions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_actions</span><span class="p">)]</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="sd">&quot;&quot;&quot;Cleans the agenda, i.e. makes sure that actions are consistent with goal and in the</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="sd">        correct order.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a><span class="sd">            goal (Goal): The goal which is needed to determine the consistent actions.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="n">cleaned_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="c1"># reverse order since most recent actions are on top of agenda</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>            <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cleaned_stack</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>                <span class="c1"># NOTE sufficient if there is only one slot per (request) action</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>                <span class="c1"># remove accomplished requests</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>                        <span class="ow">or</span> <span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span> <span class="ow">and</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>                        <span class="ow">or</span> <span class="n">action</span><span class="o">.</span><span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">):</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>                    <span class="c1"># make sure to remove &quot;old&quot; inform actions</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>                    <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">goal</span><span class="o">.</span><span class="n">is_inconsistent_constraint</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>                                <span class="n">Constraint</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">value</span><span class="p">)):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>                            <span class="n">cleaned_stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>                        <span class="n">cleaned_stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">cleaned_stack</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="sd">&quot;&quot;&quot;Empties the agenda.&quot;&quot;&quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>        <span class="sd">&quot;&quot;&quot;Checks whether the agenda is empty.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a><span class="sd">            (bool): True if agenda is empty, False otherwise.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>    <span class="k">def</span> <span class="nf">contains_action_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">,</span> <span class="n">consider_dontcare</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>        <span class="sd">&quot;&quot;&quot;Checks whether agenda contains actions of a specific type.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a><span class="sd">            act_type (UserActionType): The action type (intent) for which the agenda will be checked.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a><span class="sd">            consider_dontcare (bool): If set to True also considers actions for which the value is</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a><span class="sd">                                     &#39;dontcare&#39;, and ignores them otherwise.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a><span class="sd">            (bool): True if agenda contains *act_type*, False otherwise.</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="k">for</span> <span class="n">_action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">consider_dontcare</span> <span class="ow">and</span> <span class="n">_action</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>                <span class="k">continue</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>            <span class="k">if</span> <span class="n">_action</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">act_type</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>    <span class="k">def</span> <span class="nf">get_actions_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">,</span> <span class="n">consider_dontcare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>        <span class="sd">&quot;&quot;&quot;Get actions of a specific type from the agenda.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a><span class="sd">            act_type (UserActionType): The action type (intent) for which the agenda will be checked.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a><span class="sd">            consider_dontcare (bool): If set to True also considers actions for which the value is</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a><span class="sd">                                     &#39;dontcare&#39;, and ignores them otherwise.</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a><span class="sd">            (Iterable[UserAct]): A list of user actions of the given type/intent.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>        <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">act_type</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>                      <span class="ow">and</span> <span class="p">(</span><span class="n">consider_dontcare</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>    <span class="k">def</span> <span class="nf">remove_actions_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">):</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>        <span class="sd">&quot;&quot;&quot;Removes actions of a specific type from the agenda.</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a><span class="sd">            act_type (UserActionType): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">act_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>    <span class="k">def</span> <span class="nf">remove_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>        <span class="sd">&quot;&quot;&quot;Removes actions of a specific type, slot and optionally value from the agenda. All</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a><span class="sd">        arguments (value only if given) have to match in conjunction.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a><span class="sd">            act_type (UserActionType): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a><span class="sd">            slot (str): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a><span class="sd">            value (str): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">act_type</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">act_type</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">slot</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>    <span class="k">def</span> <span class="nf">fill_with_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">,</span> <span class="n">exclude_name</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>        <span class="sd">&quot;&quot;&quot;Adds all request actions to the agenda necessary to fulfill the *goal*.</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a><span class="sd">            goal (Goal): The current goal of the (simulated) user for which actions will be pushed to the</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a><span class="sd">                         agenda.</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a><span class="sd">            exclude_name (bool): whehter or not to include an action to request an entities name.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>        <span class="c1"># add requests and make sure to add the name at the end (i.e. ask first for name)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;name&#39;</span> <span class="ow">and</span> <span class="n">exclude_name</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">exclude_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>                    <span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>    <span class="k">def</span> <span class="nf">fill_with_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a><span class="sd">        Adds all inform actions to the agenda necessary to fulfill the *goal*. Generally there is</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a><span class="sd">        no need to add all constraints from the goal to the agenda apart from the initialisation.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a><span class="sd">            goal (Goal): The current goal of the (simulated) user for which actions will be pushed to the agenda.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>        <span class="c1"># add informs from goal</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>                <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>                <span class="n">slot</span><span class="o">=</span><span class="n">constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>                <span class="n">value</span><span class="o">=</span><span class="n">constraint</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.__bool__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.Agenda.__bool__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.__contains__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.Agenda.__contains__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.Agenda.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.__iter__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.Agenda.__iter__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.__len__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.Agenda.__len__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.Agenda.__repr__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.__str__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.Agenda.__str__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.clean" class="doc doc-heading">
<code class="highlight language-python"><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.clean" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Cleans the agenda, i.e. makes sure that actions are consistent with goal and in the
correct order.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>goal</code></td>
        <td><code>Goal</code></td>
        <td><p>The goal which is needed to determine the consistent actions.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Cleans the agenda, i.e. makes sure that actions are consistent with goal and in the</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    correct order.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        goal (Goal): The goal which is needed to determine the consistent actions.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">cleaned_stack</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="c1"># reverse order since most recent actions are on top of agenda</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cleaned_stack</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="c1"># NOTE sufficient if there is only one slot per (request) action</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="c1"># remove accomplished requests</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>                    <span class="ow">or</span> <span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span> <span class="ow">and</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                    <span class="ow">or</span> <span class="n">action</span><span class="o">.</span><span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                <span class="c1"># make sure to remove &quot;old&quot; inform actions</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">goal</span><span class="o">.</span><span class="n">is_inconsistent_constraint</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                            <span class="n">Constraint</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">value</span><span class="p">)):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                        <span class="n">cleaned_stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                    <span class="n">cleaned_stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">cleaned_stack</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.clear" class="doc doc-heading">
<code class="highlight language-python"><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.clear" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Empties the agenda.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Empties the agenda.&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.contains_action_of_type" class="doc doc-heading">
<code class="highlight language-python"><span class="n">contains_action_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">,</span> <span class="n">consider_dontcare</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.contains_action_of_type" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Checks whether agenda contains actions of a specific type.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>act_type</code></td>
        <td><code>UserActionType</code></td>
        <td><p>The action type (intent) for which the agenda will be checked.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>consider_dontcare</code></td>
        <td><code>bool</code></td>
        <td><p>If set to True also considers actions for which the value is
                     'dontcare', and ignores them otherwise.</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(bool)</code></td>
      <td><p>True if agenda contains <em>act_type</em>, False otherwise.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">contains_action_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">,</span> <span class="n">consider_dontcare</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Checks whether agenda contains actions of a specific type.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        act_type (UserActionType): The action type (intent) for which the agenda will be checked.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        consider_dontcare (bool): If set to True also considers actions for which the value is</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                                 &#39;dontcare&#39;, and ignores them otherwise.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        (bool): True if agenda contains *act_type*, False otherwise.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">for</span> <span class="n">_action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">consider_dontcare</span> <span class="ow">and</span> <span class="n">_action</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="k">continue</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="k">if</span> <span class="n">_action</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">act_type</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.fill_with_constraints" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fill_with_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.fill_with_constraints" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Adds all inform actions to the agenda necessary to fulfill the <em>goal</em>. Generally there is
no need to add all constraints from the goal to the agenda apart from the initialisation.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>goal</code></td>
        <td><code>Goal</code></td>
        <td><p>The current goal of the (simulated) user for which actions will be pushed to the agenda.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">fill_with_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Adds all inform actions to the agenda necessary to fulfill the *goal*. Generally there is</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    no need to add all constraints from the goal to the agenda apart from the initialisation.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        goal (Goal): The current goal of the (simulated) user for which actions will be pushed to the agenda.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="c1"># add informs from goal</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="n">slot</span><span class="o">=</span><span class="n">constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="n">value</span><span class="o">=</span><span class="n">constraint</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.fill_with_requests" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fill_with_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">exclude_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.fill_with_requests" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Adds all request actions to the agenda necessary to fulfill the <em>goal</em>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>goal</code></td>
        <td><code>Goal</code></td>
        <td><p>The current goal of the (simulated) user for which actions will be pushed to the
         agenda.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>exclude_name</code></td>
        <td><code>bool</code></td>
        <td><p>whehter or not to include an action to request an entities name.</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">fill_with_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">,</span> <span class="n">exclude_name</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Adds all request actions to the agenda necessary to fulfill the *goal*.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        goal (Goal): The current goal of the (simulated) user for which actions will be pushed to the</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">                     agenda.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        exclude_name (bool): whehter or not to include an action to request an entities name.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="c1"># add requests and make sure to add the name at the end (i.e. ask first for name)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;name&#39;</span> <span class="ow">and</span> <span class="n">exclude_name</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">exclude_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                <span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.get_actions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_actions</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.get_actions" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Retrieves <em>num_actions</em> actions from the agenda.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>num_actions</code></td>
        <td><code>int</code></td>
        <td><p>Amount of actions which will be retrieved from the agenda.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(List[UserAct])</code></td>
      <td><p>list of <em>num_actions</em> user actions.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_actions</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Retrieves *num_actions* actions from the agenda.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        num_actions (int): Amount of actions which will be retrieved from the agenda.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        (List[UserAct]): list of *num_actions* user actions.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">if</span> <span class="n">num_actions</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num_actions</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="n">num_actions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_actions</span><span class="p">)]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.get_actions_of_type" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_actions_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">,</span> <span class="n">consider_dontcare</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.get_actions_of_type" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Get actions of a specific type from the agenda.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>act_type</code></td>
        <td><code>UserActionType</code></td>
        <td><p>The action type (intent) for which the agenda will be checked.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>consider_dontcare</code></td>
        <td><code>bool</code></td>
        <td><p>If set to True also considers actions for which the value is
                     'dontcare', and ignores them otherwise.</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(Iterable[UserAct])</code></td>
      <td><p>A list of user actions of the given type/intent.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_actions_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">,</span> <span class="n">consider_dontcare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Get actions of a specific type from the agenda.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        act_type (UserActionType): The action type (intent) for which the agenda will be checked.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        consider_dontcare (bool): If set to True also considers actions for which the value is</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                                 &#39;dontcare&#39;, and ignores them otherwise.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        (Iterable[UserAct]): A list of user actions of the given type/intent.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">act_type</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                  <span class="ow">and</span> <span class="p">(</span><span class="n">consider_dontcare</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.init" class="doc doc-heading">
<code class="highlight language-python"><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.init" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Initializes the agenda given a goal. For this purpose, inform actions for constraints in
the goal and request actions for requests in the goal are added such that the informs are
handled first followed by the requests.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>goal</code></td>
        <td><code>Goal</code></td>
        <td><p>The goal for which the agenda will be initialized.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Initializes the agenda given a goal. For this purpose, inform actions for constraints in</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    the goal and request actions for requests in the goal are added such that the informs are</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    handled first followed by the requests.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        goal (Goal): The goal for which the agenda will be initialized.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="c1"># populate agenda according to goal</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="c1"># NOTE don&#39;t push bye action here since bye action could be poppped with another (missing)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="c1"># request, but user should not end dialog before having the goal fulfilled</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="c1"># NOTE do not add requests to agenda since system can&#39;t handle inform and request action in</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="c1"># same turn currently!</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="c1"># self.fill_with_requests(goal)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fill_with_constraints</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.is_empty" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.is_empty" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Checks whether the agenda is empty.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(bool)</code></td>
      <td><p>True if agenda is empty, False otherwise.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Checks whether the agenda is empty.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        (bool): True if agenda is empty, False otherwise.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.push" class="doc doc-heading">
<code class="highlight language-python"><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.push" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Pushes <em>item</em> onto the agenda.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>item</code></td>
        <td></td>
        <td><p>The goal for which the agenda will be initialized.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Pushes *item* onto the agenda.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        item: The goal for which the agenda will be initialized.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">+=</span> <span class="n">item</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.remove_actions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">remove_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.remove_actions" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Removes actions of a specific type, slot and optionally value from the agenda. All
arguments (value only if given) have to match in conjunction.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>act_type</code></td>
        <td><code>UserActionType</code></td>
        <td><p>The action type (intent) which will be removed from the agenda.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>slot</code></td>
        <td><code>str</code></td>
        <td><p>The action type (intent) which will be removed from the agenda.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>value</code></td>
        <td><code>str</code></td>
        <td><p>The action type (intent) which will be removed from the agenda.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">remove_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Removes actions of a specific type, slot and optionally value from the agenda. All</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    arguments (value only if given) have to match in conjunction.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        act_type (UserActionType): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        slot (str): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        value (str): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">act_type</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">act_type</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">slot</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.Agenda.remove_actions_of_type" class="doc doc-heading">
<code class="highlight language-python"><span class="n">remove_actions_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.Agenda.remove_actions_of_type" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Removes actions of a specific type from the agenda.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>act_type</code></td>
        <td><code>UserActionType</code></td>
        <td><p>The action type (intent) which will be removed from the agenda.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">remove_actions_of_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act_type</span><span class="p">:</span> <span class="n">UserActionType</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Removes actions of a specific type from the agenda.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        act_type (UserActionType): The action type (intent) which will be removed from the agenda.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">act_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="adviser.services.simulator.simulator.HandcraftedUserSimulator" class="doc doc-heading">
        <code>
HandcraftedUserSimulator            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>The class for a handcrafted (agenda-based) user simulator.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>domain</code></td>
        <td><code>Domain</code></td>
        <td><p>The domain for which the user simulator will be instantiated. It will use</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedUserSimulator</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;The class for a handcrafted (agenda-based) user simulator.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        domain (Domain): The domain for which the user simulator will be instantiated. It will use</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        this domain to generate the goals.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">HandcraftedUserSimulator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="c1"># possible system actions</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">receive_options</span> <span class="o">=</span> <span class="p">{</span><span class="n">SysActionType</span><span class="o">.</span><span class="n">Welcome</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_welcome</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_informbyname</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">_receive_informbyalternatives</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_request</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">Confirm</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_confirm</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">Select</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_select</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_requestmore</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bad</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_bad</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                                <span class="n">SysActionType</span><span class="o">.</span><span class="n">ConfirmRequest</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_confirmrequest</span><span class="p">}</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="c1"># parse config file</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="n">inline_comment_prefixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">))</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s1">&#39;usermodel.cfg&#39;</span><span class="p">))</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="c1"># goal</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;goal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;goal&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goal&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;goal&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="c1"># usermodel</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;usermodel&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                <span class="s2">&quot;usermodel&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>                <span class="c1"># patience will be sampled on begin of each dialog</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                    <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))]</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                    <span class="c1"># value is a list to sample the probability from</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>                        <span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                    <span class="c1"># value is the probability</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="c1"># member declarations</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="c1"># member definitions</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">Goal</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;goal&#39;</span><span class="p">])</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span> <span class="o">=</span> <span class="n">Agenda</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="sd">&quot;&quot;&quot;Resets the user model at the beginning of a dialog, e.g. draws a new goal and populates</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a><span class="sd">        the agenda according to the goal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>        <span class="c1"># self.goal = Goal(self.domain, self.parameters[&#39;goal&#39;])</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>                <span class="s2">&quot;New goal has constraints </span><span class="si">{}</span><span class="s2"> and requests </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;New agenda initialized: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="p">))</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>        <span class="c1"># add hello action with some probability</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;Greeting&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="c1"># needed for possibility to reset patience</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">])</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_act&quot;</span><span class="p">,</span> <span class="s2">&quot;sys_turn_over&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_acts&quot;</span><span class="p">,</span> <span class="s2">&quot;sim_goal&quot;</span><span class="p">])</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>    <span class="k">def</span> <span class="nf">user_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sys_turn_over</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>            <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user_acts</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">],</span> <span class="n">sim_goal</span><span class="o">=</span><span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a><span class="sd">        Determines the next user actions based on the given system actions and the user simulator&#39;s own goal</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a><span class="sd">            sys_act (SysAct): The system action for which a user response will be retrieved.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a><span class="sd">            sys_turn_over (bool): signal to start the user turn</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a><span class="sd">            (dict): Dictionary including the user acts as a list and the current user&#39;s goal.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>        <span class="c1"># self.turn = dialog_graph.num_turns</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>        <span class="k">if</span> <span class="n">sys_act</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>            <span class="c1"># if self.goal.is_fulfilled():</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>            <span class="c1">#     self._finish_dialog()</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sim_goal&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">}</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>        <span class="k">if</span> <span class="n">sys_act</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>        <span class="n">user_acts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">respond</span><span class="p">()</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>        <span class="c1"># user_acts = [UserAct(text=&quot;Hi!&quot;, act_type=UserActionType.Hello, score=1.)]</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;User Action: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_acts</span><span class="p">))</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>        <span class="c1"># input()</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;user_acts&#39;</span><span class="p">:</span> <span class="n">user_acts</span><span class="p">}</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a><span class="sd">        This function makes sure that the agenda reflects all changes needed for the received</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a><span class="sd">        system action.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a><span class="sd">            sys_act (SysAct): The action the system took</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>            <span class="c1"># check whether system action is the same as before</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>            <span class="k">if</span> <span class="n">sys_act</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;resetPatience&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;User patience run out, ending dialog.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dialog</span><span class="p">(</span><span class="n">ungrateful</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>            <span class="n">ignored_requests</span><span class="p">,</span> <span class="n">ignored_requests_alt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_system_ignored_request</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>            <span class="c1"># first stage: push operations on top of agenda</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>            <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_options</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">receive_options</span><span class="p">[</span><span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="p">](</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>                <span class="c1"># handle missing requests</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>                <span class="k">if</span> <span class="n">ignored_requests</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>                    <span class="c1"># repeat unanswered requests from user from last turn</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">ignored_requests</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>                <span class="k">if</span> <span class="n">ignored_requests_alt</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">ignored_requests_alt</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>                    <span class="c1"># make sure to pick only the requestalt actions (should be 1)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ignored_requests_alt</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>                    <span class="c1"># make sure that old request actions verifying an offer are removed</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">remove_actions_of_type</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>                <span class="c1"># second stage: clean agenda</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>                <span class="c1"># agenda might be empty -&gt; add requests again</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_fulfilled</span><span class="p">():</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dialog</span><span class="p">()</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">fill_with_requests</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">exclude_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a>                    <span class="s2">&quot;System Action Type is </span><span class="si">{}</span><span class="s2">, but I don&#39;t know how to handle it!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>                        <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>    <span class="k">def</span> <span class="nf">_receive_welcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a><span class="sd">        Processes a welcome action from the system. In this case do nothing</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a><span class="sd">            sys_act (SysAct): the last system action</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>        <span class="c1"># do nothing as the first turn is already intercepted</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>        <span class="c1"># also, the &#39;welcome&#39; action is never used in reinforcement learning from the policy</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>        <span class="c1"># -&gt; will only, if at all, occur at first turn</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>    <span class="k">def</span> <span class="nf">_receive_informbyname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a><span class="sd">        Processes an informbyname action from the system; checks if the inform matches the</span>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a><span class="sd">        goal constraints and if yes, will add unanswered requests to the agenda </span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>        <span class="c1"># check all system informs for offer</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>        <span class="n">inform_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>        <span class="n">offers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>        <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value_list</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">value_list</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>                <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>                    <span class="n">offers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>                    <span class="n">inform_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>        <span class="c1"># check offer</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>        <span class="k">if</span> <span class="n">offers</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_offer</span><span class="p">(</span><span class="n">offers</span><span class="p">,</span> <span class="n">inform_list</span><span class="p">):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>                <span class="c1"># valid offer</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>                <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inform_list</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">fulfill_request</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>        <span class="c1"># needed to make sure that not informed constraints (which have been turned into requests)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>        <span class="c1"># will be asked first (before ending the dialog too early)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>        <span class="n">req_actions_not_in_goal</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">get_actions_of_type</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>            <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>                <span class="n">req_actions_not_in_goal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>        <span class="c1"># goal might be fulfilled now</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_fulfilled</span><span class="p">()</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">contains_action_of_type</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">req_actions_not_in_goal</span><span class="p">):</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dialog</span><span class="p">()</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a>    <span class="k">def</span> <span class="nf">_receive_informbyalternatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a><span class="sd">        Processes an informbyalternatives action from the system; this is treated like</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a><span class="sd">        an inform by name</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>        <span class="c1"># same as inform by name</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_receive_informbyname</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_last_actions</span><span class="p">()</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a>    <span class="k">def</span> <span class="nf">_receive_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a><span class="sd">        Processes a request action from the system by adding the corresponding answer based</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a><span class="sd">        on the current simulator goal.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a>        <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>                <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>                <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">get_constraint</span><span class="p">(</span><span class="n">slot</span><span class="p">),</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>                <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>    <span class="k">def</span> <span class="nf">_receive_confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a><span class="sd">        Processes a confirm action from the system based on information in the user goal</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>        <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">_value</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># there is always only one value</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_inconsistent_constraint_strict</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)):</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>                <span class="c1"># inform about correct value with some probability, otherwise deny value</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>                <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;InformOnConfirm&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>                        <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>                        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">get_constraint</span><span class="p">(</span><span class="n">slot</span><span class="p">),</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>                        <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>                        <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">NegativeInform</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>                <span class="c1"># NOTE using inform currently since NLU currently does not support Affirm here and</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>                <span class="c1"># NLU would tinker it into an Inform action anyway</span>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>                <span class="c1"># self.agenda.push(</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>                <span class="c1">#     UserAct(act_type=UserActionType.Affirm, score=1.0))</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>                    <span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>    <span class="k">def</span> <span class="nf">_receive_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a><span class="sd">        Processes a select action from the system based on the simulation goal</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>        <span class="c1"># handle as request</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>        <span class="n">value_in_goal</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>        <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>                <span class="c1"># do not consider &#39;dontcare&#39; as any value</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_inconsistent_constraint_strict</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)):</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>                    <span class="n">value_in_goal</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>        <span class="k">if</span> <span class="n">value_in_goal</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_receive_request</span><span class="p">(</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>                <span class="s2">&quot;There shall be only one slot in a select action.&quot;</span>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>            <span class="c1"># NOTE: currently we support only one slot for select action,</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>            <span class="c1"># but this could be changed in the future</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>            <span class="n">slot</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>            <span class="c1"># inform about correct value with some probability</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a>            <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;InformOnSelect&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a>                    <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>                    <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">get_constraint</span><span class="p">(</span><span class="n">slot</span><span class="p">),</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a>                    <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>            <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>                        <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">NegativeInform</span><span class="p">,</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>                        <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>                        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>    <span class="k">def</span> <span class="nf">_receive_requestmore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a><span class="sd">        Processes a requestmore action from the system.</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_fulfilled</span><span class="p">():</span>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>            <span class="c1"># end dialog</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dialog</span><span class="p">()</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">contains_action_of_type</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>              <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>            <span class="c1"># venue has been offered and all informs have been issued, but atleast one request slot</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>            <span class="c1"># is missing</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">fill_with_requests</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a>            <span class="c1"># make sure that dialog becomes longer</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_last_actions</span><span class="p">()</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a>    <span class="k">def</span> <span class="nf">_receive_bad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span><span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a><span class="sd">        Processes a bad action from the system; repeats the last user action</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>        <span class="c1"># NOTE repeat last action, should never occur on intention-level as long no noise is used</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_last_actions</span><span class="p">()</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>    <span class="k">def</span> <span class="nf">_receive_confirmrequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a><span class="sd">        Processes a confirmrequest action from the system.</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a><span class="sd">            sys_act (SysAct): the last system action        </span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>        <span class="c1"># first slot is confirm, second slot is request</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>        <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>                <span class="c1"># system&#39;s request action</span>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_receive_request</span><span class="p">(</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>                    <span class="n">SysAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">slot_values</span><span class="o">=</span><span class="p">{</span><span class="n">slot</span><span class="p">:</span> <span class="kc">None</span><span class="p">}))</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>                <span class="c1"># system&#39;s confirm action</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>                <span class="c1"># NOTE SysActionType Confirm has single value only</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_receive_confirm</span><span class="p">(</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>                    <span class="n">SysAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">SysActionType</span><span class="o">.</span><span class="n">Confirm</span><span class="p">,</span> <span class="n">slot_values</span><span class="o">=</span><span class="p">{</span><span class="n">slot</span><span class="p">:</span> <span class="p">[</span><span class="n">value</span><span class="p">]}))</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a><span class="sd">        Gets n actions from the agenda, where n is drawn depending on the agenda or a pdf.</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a>        <span class="c1"># get some actions from the agenda</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Agenda is empty, this must not happen at this point!&quot;</span>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a>            <span class="c1"># use and reset self.num_actions_next_turn if set</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a>            <span class="n">num_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bye</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>            <span class="c1"># pop all actions from agenda since agenda can only contain thanks (optional) and</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a>            <span class="c1"># bye action</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>            <span class="n">num_actions</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>            <span class="c1"># draw amount of actions</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a>            <span class="n">num_actions</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="p">),</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">.6</span><span class="p">,</span> <span class="mf">.3</span><span class="p">,</span> <span class="mf">.1</span><span class="p">]))</span>  <span class="c1"># hardcoded pdf</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>        <span class="c1"># get actions from agenda</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a>        <span class="n">user_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">get_actions</span><span class="p">(</span><span class="n">num_actions</span><span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>        <span class="c1"># copy needed for repeat action since they might be changed in other modules</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">user_actions</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a>        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">user_actions</span><span class="p">:</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>            <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a>                <span class="n">_constraint</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>                <span class="c1"># if _constraint in self.goal.constraints:</span>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a>                <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">missing_informs</span><span class="p">:</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">missing_informs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>        <span class="k">return</span> <span class="n">user_actions</span>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a>    <span class="k">def</span> <span class="nf">_finish_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ungrateful</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a><span class="sd">        Pushes a bye action ontop of the agenda in order to end a dialog. Depending on the user</span>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a><span class="sd">        model, a thankyou action might be added too.</span>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a><span class="sd">            ungrateful (bool): determines if the user should also say &quot;thanks&quot;; if the dialog ran</span>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a><span class="sd">                               too long or the user ran out of patience, ungrateful will be true</span>
<a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># empty agenda</span>
<a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a>        <span class="c1"># thank with some probability</span>
<a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a>        <span class="c1"># NOTE bye has to be the topmost action on the agenda since we check for it in the</span>
<a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>        <span class="c1"># respond() method</span>
<a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ungrateful</span> <span class="ow">and</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;Thank&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Thanks</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Bye</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a>    <span class="k">def</span> <span class="nf">_repeat_last_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a><span class="sd">        Pushes the last user actions ontop of the agenda.</span>
<a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437" href="#__codelineno-0-437"></a>    <span class="k">def</span> <span class="nf">_alter_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
<a id="__codelineno-0-438" name="__codelineno-0-438" href="#__codelineno-0-438"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-439" name="__codelineno-0-439" href="#__codelineno-0-439"></a><span class="sd">        Alters *count* constraints from the given constraints by choosing a new value</span>
<a id="__codelineno-0-440" name="__codelineno-0-440" href="#__codelineno-0-440"></a><span class="sd">        (could be also &#39;dontcare&#39;).</span>
<a id="__codelineno-0-441" name="__codelineno-0-441" href="#__codelineno-0-441"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442" href="#__codelineno-0-442"></a>        <span class="n">constraints_candidates</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[:]</span>  <span class="c1"># copy list</span>
<a id="__codelineno-0-443" name="__codelineno-0-443" href="#__codelineno-0-443"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">constraints_candidates</span><span class="p">:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444" href="#__codelineno-0-444"></a>            <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-445" name="__codelineno-0-445" href="#__codelineno-0-445"></a>                <span class="k">if</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
<a id="__codelineno-0-446" name="__codelineno-0-446" href="#__codelineno-0-446"></a>                    <span class="n">constraints_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-447" name="__codelineno-0-447" href="#__codelineno-0-447"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448" href="#__codelineno-0-448"></a>            <span class="c1"># any constraint from the current system actions has to be taken into consideration</span>
<a id="__codelineno-0-449" name="__codelineno-0-449" href="#__codelineno-0-449"></a>            <span class="c1"># make sure that constraints are part of the goal since noise could have influenced the</span>
<a id="__codelineno-0-450" name="__codelineno-0-450" href="#__codelineno-0-450"></a>            <span class="c1"># dialog -&gt; given constraints must conform to the current goal</span>
<a id="__codelineno-0-451" name="__codelineno-0-451" href="#__codelineno-0-451"></a>            <span class="n">constraints_candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
<a id="__codelineno-0-452" name="__codelineno-0-452" href="#__codelineno-0-452"></a>                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_inconsistent_constraint_strict</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<a id="__codelineno-0-453" name="__codelineno-0-453" href="#__codelineno-0-453"></a>                <span class="n">constraints_candidates</span><span class="p">))</span>
<a id="__codelineno-0-454" name="__codelineno-0-454" href="#__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455" href="#__codelineno-0-455"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">constraints_candidates</span><span class="p">:</span>
<a id="__codelineno-0-456" name="__codelineno-0-456" href="#__codelineno-0-456"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-457" name="__codelineno-0-457" href="#__codelineno-0-457"></a>
<a id="__codelineno-0-458" name="__codelineno-0-458" href="#__codelineno-0-458"></a>        <span class="n">constraints_to_alter</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-459" name="__codelineno-0-459" href="#__codelineno-0-459"></a>            <span class="n">constraints_candidates</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460" href="#__codelineno-0-460"></a>
<a id="__codelineno-0-461" name="__codelineno-0-461" href="#__codelineno-0-461"></a>        <span class="n">new_constraints</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-462" name="__codelineno-0-462" href="#__codelineno-0-462"></a>        <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="n">constraints_to_alter</span><span class="p">:</span>
<a id="__codelineno-0-463" name="__codelineno-0-463" href="#__codelineno-0-463"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">excluded_inf_slot_values</span><span class="p">[</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
<a id="__codelineno-0-464" name="__codelineno-0-464" href="#__codelineno-0-464"></a>                <span class="n">_constraint</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-465" name="__codelineno-0-465" href="#__codelineno-0-465"></a>            <span class="n">possible_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">inf_slot_values</span><span class="p">[</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">][:]</span>
<a id="__codelineno-0-466" name="__codelineno-0-466" href="#__codelineno-0-466"></a>            <span class="k">for</span> <span class="n">_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">excluded_inf_slot_values</span><span class="p">[</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">]:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467" href="#__codelineno-0-467"></a>                <span class="c1"># remove values which have been tried already</span>
<a id="__codelineno-0-468" name="__codelineno-0-468" href="#__codelineno-0-468"></a>                <span class="c1"># NOTE values in self.excluded_inf_slot_values should always be in possible_values</span>
<a id="__codelineno-0-469" name="__codelineno-0-469" href="#__codelineno-0-469"></a>                <span class="c1"># because the same source is used for both and to initialize the goal</span>
<a id="__codelineno-0-470" name="__codelineno-0-470" href="#__codelineno-0-470"></a>                <span class="n">possible_values</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_value</span><span class="p">)</span>
<a id="__codelineno-0-471" name="__codelineno-0-471" href="#__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472" href="#__codelineno-0-472"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">possible_values</span><span class="p">:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473" href="#__codelineno-0-473"></a>                <span class="c1"># add &#39;dontcare&#39; as last option</span>
<a id="__codelineno-0-474" name="__codelineno-0-474" href="#__codelineno-0-474"></a>                <span class="n">possible_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;dontcare&#39;</span><span class="p">)</span>
<a id="__codelineno-0-475" name="__codelineno-0-475" href="#__codelineno-0-475"></a>
<a id="__codelineno-0-476" name="__codelineno-0-476" href="#__codelineno-0-476"></a>            <span class="c1"># &#39;dontcare&#39; value with some probability</span>
<a id="__codelineno-0-477" name="__codelineno-0-477" href="#__codelineno-0-477"></a>            <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;DontcareIfNoVenue&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478" href="#__codelineno-0-478"></a>                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;dontcare&#39;</span>
<a id="__codelineno-0-479" name="__codelineno-0-479" href="#__codelineno-0-479"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-480" name="__codelineno-0-480" href="#__codelineno-0-480"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">possible_values</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481" href="#__codelineno-0-481"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">update_constraint</span><span class="p">(</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-482" name="__codelineno-0-482" href="#__codelineno-0-482"></a>                <span class="c1"># NOTE: this case should never happen!</span>
<a id="__codelineno-0-483" name="__codelineno-0-483" href="#__codelineno-0-483"></a>                <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-484" name="__codelineno-0-484" href="#__codelineno-0-484"></a>                    <span class="s2">&quot;The given constraints (probably by the system) are not part of the goal!&quot;</span><span class="p">)</span>
<a id="__codelineno-0-485" name="__codelineno-0-485" href="#__codelineno-0-485"></a>            <span class="n">new_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Constraint</span><span class="p">(</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-486" name="__codelineno-0-486" href="#__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487" href="#__codelineno-0-487"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span>
<a id="__codelineno-0-488" name="__codelineno-0-488" href="#__codelineno-0-488"></a>            <span class="s2">&quot;Goal altered! </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">constraints_to_alter</span><span class="p">,</span> <span class="n">new_constraints</span><span class="p">))</span>
<a id="__codelineno-0-489" name="__codelineno-0-489" href="#__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490" href="#__codelineno-0-490"></a>        <span class="k">return</span> <span class="n">new_constraints</span>
<a id="__codelineno-0-491" name="__codelineno-0-491" href="#__codelineno-0-491"></a>
<a id="__codelineno-0-492" name="__codelineno-0-492" href="#__codelineno-0-492"></a>    <span class="k">def</span> <span class="nf">_check_informs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">informed_constraints_by_system</span><span class="p">):</span>
<a id="__codelineno-0-493" name="__codelineno-0-493" href="#__codelineno-0-493"></a>        <span class="sd">&quot;&quot;&quot; Checks whether the informs by the system are consistent with the goal and pushes</span>
<a id="__codelineno-0-494" name="__codelineno-0-494" href="#__codelineno-0-494"></a><span class="sd">        appropriate actions onto the agenda for inconsistent constraints. &quot;&quot;&quot;</span>
<a id="__codelineno-0-495" name="__codelineno-0-495" href="#__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496" href="#__codelineno-0-496"></a>        <span class="c1"># check for inconsistent constraints and remove informs of consistent constraints from</span>
<a id="__codelineno-0-497" name="__codelineno-0-497" href="#__codelineno-0-497"></a>        <span class="c1"># agenda</span>
<a id="__codelineno-0-498" name="__codelineno-0-498" href="#__codelineno-0-498"></a>        <span class="n">consistent_with_goal</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-499" name="__codelineno-0-499" href="#__codelineno-0-499"></a>        <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="n">informed_constraints_by_system</span><span class="p">:</span>
<a id="__codelineno-0-500" name="__codelineno-0-500" href="#__codelineno-0-500"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_inconsistent_constraint</span><span class="p">(</span><span class="n">_constraint</span><span class="p">):</span>
<a id="__codelineno-0-501" name="__codelineno-0-501" href="#__codelineno-0-501"></a>                <span class="n">consistent_with_goal</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-502" name="__codelineno-0-502" href="#__codelineno-0-502"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-503" name="__codelineno-0-503" href="#__codelineno-0-503"></a>                    <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504" href="#__codelineno-0-504"></a>                    <span class="n">slot</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-505" name="__codelineno-0-505" href="#__codelineno-0-505"></a>                    <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">get_constraint</span><span class="p">(</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">),</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-506" name="__codelineno-0-506" href="#__codelineno-0-506"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-507" name="__codelineno-0-507" href="#__codelineno-0-507"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">remove_actions</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span> <span class="o">*</span><span class="n">_constraint</span><span class="p">)</span>
<a id="__codelineno-0-508" name="__codelineno-0-508" href="#__codelineno-0-508"></a>
<a id="__codelineno-0-509" name="__codelineno-0-509" href="#__codelineno-0-509"></a>        <span class="k">return</span> <span class="n">consistent_with_goal</span>
<a id="__codelineno-0-510" name="__codelineno-0-510" href="#__codelineno-0-510"></a>
<a id="__codelineno-0-511" name="__codelineno-0-511" href="#__codelineno-0-511"></a>    <span class="k">def</span> <span class="nf">_check_offer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offers</span><span class="p">,</span> <span class="n">informed_constraints_by_system</span><span class="p">):</span>
<a id="__codelineno-0-512" name="__codelineno-0-512" href="#__codelineno-0-512"></a>        <span class="sd">&quot;&quot;&quot; Checks for an offer and returns True if the offer is valid. &quot;&quot;&quot;</span>
<a id="__codelineno-0-513" name="__codelineno-0-513" href="#__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514" href="#__codelineno-0-514"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_informs</span><span class="p">(</span><span class="n">informed_constraints_by_system</span><span class="p">):</span>
<a id="__codelineno-0-515" name="__codelineno-0-515" href="#__codelineno-0-515"></a>            <span class="c1"># reset offer in goal since inconsistencies have been detected and covered</span>
<a id="__codelineno-0-516" name="__codelineno-0-516" href="#__codelineno-0-516"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-517" name="__codelineno-0-517" href="#__codelineno-0-517"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-518" name="__codelineno-0-518" href="#__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519" href="#__codelineno-0-519"></a>        <span class="c1"># TODO maybe check for current offer first since alternative with name=&#39;none&#39; by system</span>
<a id="__codelineno-0-520" name="__codelineno-0-520" href="#__codelineno-0-520"></a>        <span class="c1"># would trigger goal change -&gt; what is the correct action in this case?</span>
<a id="__codelineno-0-521" name="__codelineno-0-521" href="#__codelineno-0-521"></a>        <span class="k">if</span> <span class="n">offers</span><span class="p">:</span>
<a id="__codelineno-0-522" name="__codelineno-0-522" href="#__codelineno-0-522"></a>            <span class="k">if</span> <span class="s1">&#39;none&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">offers</span><span class="p">:</span>
<a id="__codelineno-0-523" name="__codelineno-0-523" href="#__codelineno-0-523"></a>                <span class="c1"># offer was given</span>
<a id="__codelineno-0-524" name="__codelineno-0-524" href="#__codelineno-0-524"></a>
<a id="__codelineno-0-525" name="__codelineno-0-525" href="#__codelineno-0-525"></a>                <span class="c1"># convert informs of values != &#39;dontcare&#39; to requests</span>
<a id="__codelineno-0-526" name="__codelineno-0-526" href="#__codelineno-0-526"></a>                <span class="n">actions_to_convert</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">get_actions_of_type</span><span class="p">(</span>
<a id="__codelineno-0-527" name="__codelineno-0-527" href="#__codelineno-0-527"></a>                    <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span> <span class="n">consider_dontcare</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-0-528" name="__codelineno-0-528" href="#__codelineno-0-528"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions_to_convert</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">):</span>
<a id="__codelineno-0-529" name="__codelineno-0-529" href="#__codelineno-0-529"></a>                    <span class="c1"># penalise too early offers</span>
<a id="__codelineno-0-530" name="__codelineno-0-530" href="#__codelineno-0-530"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_repeat_last_actions</span><span class="p">()</span>
<a id="__codelineno-0-531" name="__codelineno-0-531" href="#__codelineno-0-531"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span><span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532" href="#__codelineno-0-532"></a>                    <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-533" name="__codelineno-0-533" href="#__codelineno-0-533"></a>
<a id="__codelineno-0-534" name="__codelineno-0-534" href="#__codelineno-0-534"></a>                <span class="c1"># ask for values of remaining inform slots on agenda - this has two purposes:</span>
<a id="__codelineno-0-535" name="__codelineno-0-535" href="#__codelineno-0-535"></a>                <span class="c1">#   1. making sure that offer is consistent with goal</span>
<a id="__codelineno-0-536" name="__codelineno-0-536" href="#__codelineno-0-536"></a>                <span class="c1">#   2. making sure that inconsistent offers prolongate a dialog</span>
<a id="__codelineno-0-537" name="__codelineno-0-537" href="#__codelineno-0-537"></a>                <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions_to_convert</span><span class="p">:</span>
<a id="__codelineno-0-538" name="__codelineno-0-538" href="#__codelineno-0-538"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-539" name="__codelineno-0-539" href="#__codelineno-0-539"></a>                        <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
<a id="__codelineno-0-540" name="__codelineno-0-540" href="#__codelineno-0-540"></a>                        <span class="n">slot</span><span class="o">=</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-541" name="__codelineno-0-541" href="#__codelineno-0-541"></a>                        <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-542" name="__codelineno-0-542" href="#__codelineno-0-542"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">remove_actions_of_type</span><span class="p">(</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">)</span>
<a id="__codelineno-0-543" name="__codelineno-0-543" href="#__codelineno-0-543"></a>
<a id="__codelineno-0-544" name="__codelineno-0-544" href="#__codelineno-0-544"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-545" name="__codelineno-0-545" href="#__codelineno-0-545"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="ow">in</span> <span class="n">offers</span><span class="p">:</span>
<a id="__codelineno-0-546" name="__codelineno-0-546" href="#__codelineno-0-546"></a>                        <span class="c1"># offer is the same, don&#39;t change anything but treat offer as valid</span>
<a id="__codelineno-0-547" name="__codelineno-0-547" href="#__codelineno-0-547"></a>                        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-548" name="__codelineno-0-548" href="#__codelineno-0-548"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-549" name="__codelineno-0-549" href="#__codelineno-0-549"></a>                        <span class="c1"># offer is not the same, but did not request a new one</span>
<a id="__codelineno-0-550" name="__codelineno-0-550" href="#__codelineno-0-550"></a>                        <span class="c1"># NOTE with current bst do not (negative) inform about the offer, because</span>
<a id="__codelineno-0-551" name="__codelineno-0-551" href="#__codelineno-0-551"></a>                        <span class="c1"># it will only set the proability to zero -&gt; will not be excluded</span>
<a id="__codelineno-0-552" name="__codelineno-0-552" href="#__codelineno-0-552"></a>                        <span class="c1"># self.agenda.push(UserAct(act_type=UserActionType.NegativeInform,\</span>
<a id="__codelineno-0-553" name="__codelineno-0-553" href="#__codelineno-0-553"></a>                        <span class="c1">#     slot=self.domain.get_primary_key(), value=offers[0]))</span>
<a id="__codelineno-0-554" name="__codelineno-0-554" href="#__codelineno-0-554"></a>                        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-555" name="__codelineno-0-555" href="#__codelineno-0-555"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-556" name="__codelineno-0-556" href="#__codelineno-0-556"></a>                    <span class="k">for</span> <span class="n">_offer</span> <span class="ow">in</span> <span class="n">offers</span><span class="p">:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557" href="#__codelineno-0-557"></a>                        <span class="k">if</span> <span class="n">_offer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span><span class="p">:</span>
<a id="__codelineno-0-558" name="__codelineno-0-558" href="#__codelineno-0-558"></a>                            <span class="c1"># offer is not on the exclusion list (e.g. from reqalt action) and</span>
<a id="__codelineno-0-559" name="__codelineno-0-559" href="#__codelineno-0-559"></a>                            <span class="c1"># there is no current offer</span>
<a id="__codelineno-0-560" name="__codelineno-0-560" href="#__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561" href="#__codelineno-0-561"></a>                            <span class="c1"># sometimes ask for alternative</span>
<a id="__codelineno-0-562" name="__codelineno-0-562" href="#__codelineno-0-562"></a>                            <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;ReqAlt&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-563" name="__codelineno-0-563" href="#__codelineno-0-563"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">_request_alt</span><span class="p">(</span><span class="n">_offer</span><span class="p">)</span>
<a id="__codelineno-0-564" name="__codelineno-0-564" href="#__codelineno-0-564"></a>                                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-565" name="__codelineno-0-565" href="#__codelineno-0-565"></a>                            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566" href="#__codelineno-0-566"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="o">=</span> <span class="n">_offer</span>
<a id="__codelineno-0-567" name="__codelineno-0-567" href="#__codelineno-0-567"></a>                                <span class="k">for</span> <span class="n">_action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">missing_informs</span><span class="p">:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568" href="#__codelineno-0-568"></a>                                    <span class="c1"># informed constraints by system are definitely consistent with</span>
<a id="__codelineno-0-569" name="__codelineno-0-569" href="#__codelineno-0-569"></a>                                    <span class="c1"># goal at this point</span>
<a id="__codelineno-0-570" name="__codelineno-0-570" href="#__codelineno-0-570"></a>                                    <span class="k">if</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">_action</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">_action</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">informed_constraints_by_system</span><span class="p">:</span>
<a id="__codelineno-0-571" name="__codelineno-0-571" href="#__codelineno-0-571"></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-572" name="__codelineno-0-572" href="#__codelineno-0-572"></a>                                            <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573" href="#__codelineno-0-573"></a>                                            <span class="n">slot</span><span class="o">=</span><span class="n">_action</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574" href="#__codelineno-0-574"></a>                                            <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-0-575" name="__codelineno-0-575" href="#__codelineno-0-575"></a>                                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-576" name="__codelineno-0-576" href="#__codelineno-0-576"></a>
<a id="__codelineno-0-577" name="__codelineno-0-577" href="#__codelineno-0-577"></a>                    <span class="c1"># no valid offer was given</span>
<a id="__codelineno-0-578" name="__codelineno-0-578" href="#__codelineno-0-578"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_request_alt</span><span class="p">()</span>
<a id="__codelineno-0-579" name="__codelineno-0-579" href="#__codelineno-0-579"></a>                    <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-580" name="__codelineno-0-580" href="#__codelineno-0-580"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-581" name="__codelineno-0-581" href="#__codelineno-0-581"></a>                <span class="c1"># no offer was given</span>
<a id="__codelineno-0-582" name="__codelineno-0-582" href="#__codelineno-0-582"></a>                <span class="c1"># TODO add probability to choose number of alternations</span>
<a id="__codelineno-0-583" name="__codelineno-0-583" href="#__codelineno-0-583"></a>                <span class="n">altered_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alter_constraints</span><span class="p">(</span><span class="n">informed_constraints_by_system</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-584" name="__codelineno-0-584" href="#__codelineno-0-584"></a>                <span class="c1"># reset goal push new actions on top of agenda</span>
<a id="__codelineno-0-585" name="__codelineno-0-585" href="#__codelineno-0-585"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-586" name="__codelineno-0-586" href="#__codelineno-0-586"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">missing_informs</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-587" name="__codelineno-0-587" href="#__codelineno-0-587"></a>                    <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span>
<a id="__codelineno-0-588" name="__codelineno-0-588" href="#__codelineno-0-588"></a>                    <span class="n">slot</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-589" name="__codelineno-0-589" href="#__codelineno-0-589"></a>                    <span class="n">value</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span>
<a id="__codelineno-0-590" name="__codelineno-0-590" href="#__codelineno-0-590"></a>                <span class="k">for</span> <span class="n">_constraint</span> <span class="ow">in</span> <span class="n">altered_constraints</span><span class="p">:</span>
<a id="__codelineno-0-591" name="__codelineno-0-591" href="#__codelineno-0-591"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span>
<a id="__codelineno-0-592" name="__codelineno-0-592" href="#__codelineno-0-592"></a>                        <span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">,</span>
<a id="__codelineno-0-593" name="__codelineno-0-593" href="#__codelineno-0-593"></a>                        <span class="n">slot</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
<a id="__codelineno-0-594" name="__codelineno-0-594" href="#__codelineno-0-594"></a>                        <span class="n">value</span><span class="o">=</span><span class="n">_constraint</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-595" name="__codelineno-0-595" href="#__codelineno-0-595"></a>                        <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-596" name="__codelineno-0-596" href="#__codelineno-0-596"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597" href="#__codelineno-0-597"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-598" name="__codelineno-0-598" href="#__codelineno-0-598"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-599" name="__codelineno-0-599" href="#__codelineno-0-599"></a>
<a id="__codelineno-0-600" name="__codelineno-0-600" href="#__codelineno-0-600"></a>    <span class="k">def</span> <span class="nf">_request_alt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-601" name="__codelineno-0-601" href="#__codelineno-0-601"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-602" name="__codelineno-0-602" href="#__codelineno-0-602"></a><span class="sd">        Handles the case where a user might want to ask for an alternative offer</span>
<a id="__codelineno-0-603" name="__codelineno-0-603" href="#__codelineno-0-603"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-604" name="__codelineno-0-604" href="#__codelineno-0-604"></a>        <span class="c1"># add current offer to exclusion list, reset current offer and request alternative</span>
<a id="__codelineno-0-605" name="__codelineno-0-605" href="#__codelineno-0-605"></a>        <span class="k">if</span> <span class="n">offer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606" href="#__codelineno-0-606"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offer</span><span class="p">)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607" href="#__codelineno-0-607"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-608" name="__codelineno-0-608" href="#__codelineno-0-608"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()])</span>
<a id="__codelineno-0-609" name="__codelineno-0-609" href="#__codelineno-0-609"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-610" name="__codelineno-0-610" href="#__codelineno-0-610"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-611" name="__codelineno-0-611" href="#__codelineno-0-611"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">RequestAlternatives</span><span class="p">))</span>
<a id="__codelineno-0-612" name="__codelineno-0-612" href="#__codelineno-0-612"></a>
<a id="__codelineno-0-613" name="__codelineno-0-613" href="#__codelineno-0-613"></a>    <span class="k">def</span> <span class="nf">_check_system_ignored_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">],</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-614" name="__codelineno-0-614" href="#__codelineno-0-614"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-615" name="__codelineno-0-615" href="#__codelineno-0-615"></a><span class="sd">        Make sure that there are no unanswered requests/constraints that got turned into requests</span>
<a id="__codelineno-0-616" name="__codelineno-0-616" href="#__codelineno-0-616"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-617" name="__codelineno-0-617" href="#__codelineno-0-617"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_actions</span><span class="p">:</span>
<a id="__codelineno-0-618" name="__codelineno-0-618" href="#__codelineno-0-618"></a>            <span class="c1"># no user_actions -&gt; system ignored nothing</span>
<a id="__codelineno-0-619" name="__codelineno-0-619" href="#__codelineno-0-619"></a>            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-620" name="__codelineno-0-620" href="#__codelineno-0-620"></a>
<a id="__codelineno-0-621" name="__codelineno-0-621" href="#__codelineno-0-621"></a>        <span class="n">requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">user_actions</span> <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">]</span>
<a id="__codelineno-0-622" name="__codelineno-0-622" href="#__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623" href="#__codelineno-0-623"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">requests</span><span class="p">:</span>
<a id="__codelineno-0-624" name="__codelineno-0-624" href="#__codelineno-0-624"></a>            <span class="c1"># no requests -&gt; system ignored nothing</span>
<a id="__codelineno-0-625" name="__codelineno-0-625" href="#__codelineno-0-625"></a>            <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-626" name="__codelineno-0-626" href="#__codelineno-0-626"></a>
<a id="__codelineno-0-627" name="__codelineno-0-627" href="#__codelineno-0-627"></a>        <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span><span class="p">]:</span>
<a id="__codelineno-0-628" name="__codelineno-0-628" href="#__codelineno-0-628"></a>            <span class="n">requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">request</span> <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">slot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">]</span>
<a id="__codelineno-0-629" name="__codelineno-0-629" href="#__codelineno-0-629"></a>
<a id="__codelineno-0-630" name="__codelineno-0-630" href="#__codelineno-0-630"></a>        <span class="n">requests_alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">user_actions</span> <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">RequestAlternatives</span><span class="p">]</span>
<a id="__codelineno-0-631" name="__codelineno-0-631" href="#__codelineno-0-631"></a>        <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span><span class="p">:</span>
<a id="__codelineno-0-632" name="__codelineno-0-632" href="#__codelineno-0-632"></a>            <span class="n">offer</span> <span class="o">=</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()]</span>
<a id="__codelineno-0-633" name="__codelineno-0-633" href="#__codelineno-0-633"></a>
<a id="__codelineno-0-634" name="__codelineno-0-634" href="#__codelineno-0-634"></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">offer</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span><span class="p">)):</span>  <span class="c1"># and self.goal.requests[self.domain.get_primary_key()] is None:</span>
<a id="__codelineno-0-635" name="__codelineno-0-635" href="#__codelineno-0-635"></a>                <span class="n">requests_alt</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-636" name="__codelineno-0-636" href="#__codelineno-0-636"></a>
<a id="__codelineno-0-637" name="__codelineno-0-637" href="#__codelineno-0-637"></a>        <span class="k">return</span> <span class="n">requests</span><span class="p">,</span> <span class="n">requests_alt</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.HandcraftedUserSimulator.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">HandcraftedUserSimulator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="c1"># possible system actions</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">receive_options</span> <span class="o">=</span> <span class="p">{</span><span class="n">SysActionType</span><span class="o">.</span><span class="n">Welcome</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_welcome</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_informbyname</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">_receive_informbyalternatives</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_request</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">Confirm</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_confirm</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">Select</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_select</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_requestmore</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bad</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_bad</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                            <span class="n">SysActionType</span><span class="o">.</span><span class="n">ConfirmRequest</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_confirmrequest</span><span class="p">}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="c1"># parse config file</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">inline_comment_prefixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">))</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s1">&#39;usermodel.cfg&#39;</span><span class="p">))</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="c1"># goal</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;goal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;goal&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goal&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;goal&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="c1"># usermodel</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;usermodel&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="s2">&quot;usermodel&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;patience&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="c1"># patience will be sampled on begin of each dialog</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>                <span class="c1"># value is a list to sample the probability from</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                    <span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>                <span class="c1"># value is the probability</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>    <span class="c1"># member declarations</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>    <span class="c1"># member definitions</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">Goal</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;goal&#39;</span><span class="p">])</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span> <span class="o">=</span> <span class="n">Agenda</span><span class="p">()</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.HandcraftedUserSimulator.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Resets the user model at the beginning of a dialog, e.g. draws a new goal and populates
the agenda according to the goal.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;Resets the user model at the beginning of a dialog, e.g. draws a new goal and populates</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    the agenda according to the goal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="c1"># self.goal = Goal(self.domain, self.parameters[&#39;goal&#39;])</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="s2">&quot;New goal has constraints </span><span class="si">{}</span><span class="s2"> and requests </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;New agenda initialized: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="p">))</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="c1"># add hello action with some probability</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;Greeting&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">UserAct</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Hello</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="c1"># needed for possibility to reset patience</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;patience&#39;</span><span class="p">])</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">excluded_venues</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.HandcraftedUserSimulator.receive" class="doc doc-heading">
<code class="highlight language-python"><span class="n">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.receive" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>This function makes sure that the agenda reflects all changes needed for the received
system action.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>sys_act</code></td>
        <td><code>SysAct</code></td>
        <td><p>The action the system took</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    This function makes sure that the agenda reflects all changes needed for the received</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    system action.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        sys_act (SysAct): The action the system took</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="c1"># check whether system action is the same as before</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="k">if</span> <span class="n">sys_act</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;usermodel&#39;</span><span class="p">][</span><span class="s1">&#39;resetPatience&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_patience</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_system_action</span> <span class="o">=</span> <span class="n">sys_act</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;User patience run out, ending dialog.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dialog</span><span class="p">(</span><span class="n">ungrateful</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="n">ignored_requests</span><span class="p">,</span> <span class="n">ignored_requests_alt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_system_ignored_request</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="c1"># first stage: push operations on top of agenda</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_options</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">receive_options</span><span class="p">[</span><span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="p">](</span><span class="n">sys_act</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="c1"># handle missing requests</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="k">if</span> <span class="n">ignored_requests</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="c1"># repeat unanswered requests from user from last turn</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">ignored_requests</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>            <span class="k">if</span> <span class="n">ignored_requests_alt</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">ignored_requests_alt</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>                <span class="c1"># make sure to pick only the requestalt actions (should be 1)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ignored_requests_alt</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>                <span class="c1"># make sure that old request actions verifying an offer are removed</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">remove_actions_of_type</span><span class="p">(</span><span class="n">act_type</span><span class="o">=</span><span class="n">UserActionType</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="c1"># second stage: clean agenda</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>            <span class="c1"># agenda might be empty -&gt; add requests again</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">is_fulfilled</span><span class="p">():</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_finish_dialog</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">fill_with_requests</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span> <span class="n">exclude_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>                <span class="s2">&quot;System Action Type is </span><span class="si">{}</span><span class="s2">, but I don&#39;t know how to handle it!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                    <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.HandcraftedUserSimulator.respond" class="doc doc-heading">
<code class="highlight language-python"><span class="n">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.respond" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Gets n actions from the agenda, where n is drawn depending on the agenda or a pdf.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Gets n actions from the agenda, where n is drawn depending on the agenda or a pdf.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="c1"># get some actions from the agenda</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Agenda is empty, this must not happen at this point!&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="c1"># use and reset self.num_actions_next_turn if set</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">num_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_actions_next_turn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Bye</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># pop all actions from agenda since agenda can only contain thanks (optional) and</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="c1"># bye action</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="n">num_actions</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>        <span class="c1"># draw amount of actions</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="n">num_actions</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="p">),</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">.6</span><span class="p">,</span> <span class="mf">.3</span><span class="p">,</span> <span class="mf">.1</span><span class="p">]))</span>  <span class="c1"># hardcoded pdf</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="c1"># get actions from agenda</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">user_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agenda</span><span class="o">.</span><span class="n">get_actions</span><span class="p">(</span><span class="n">num_actions</span><span class="p">)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="c1"># copy needed for repeat action since they might be changed in other modules</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">last_user_actions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">user_actions</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">user_actions</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">UserActionType</span><span class="o">.</span><span class="n">Inform</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>            <span class="n">_constraint</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>            <span class="c1"># if _constraint in self.goal.constraints:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>            <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">missing_informs</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="o">.</span><span class="n">missing_informs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="k">return</span> <span class="n">user_actions</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.simulator.simulator.HandcraftedUserSimulator.user_turn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">user_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.simulator.simulator.HandcraftedUserSimulator.user_turn" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/simulator/simulator.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.stats" class="doc doc-heading">
        <code>stats</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.stats" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.stats.evaluation" class="doc doc-heading">
        <code>evaluation</code>



<a href="#adviser.services.stats.evaluation" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.stats.evaluation.ObjectiveReachedEvaluator" class="doc doc-heading">
        <code>
ObjectiveReachedEvaluator        </code>



<a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Evaluate single turns and complete dialog.</p>
<p>This class assigns a negative reward to each turn.
In case the user's goal could be satisfied (meaning a matching database
entry was found), a large final reward is returned.</p>
<p>Only needed when training against a simulator.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ObjectiveReachedEvaluator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Evaluate single turns and complete dialog.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">        This class assigns a negative reward to each turn.</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">        In case the user&#39;s goal could be satisfied (meaning a matching database</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        entry was found), a large final reward is returned.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        Only needed when training against a simulator.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>                 <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">assert</span> <span class="n">turn_reward</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;the turn reward should be negative&#39;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">turn_reward</span> <span class="o">=</span> <span class="n">turn_reward</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">success_reward</span> <span class="o">=</span> <span class="n">success_reward</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">def</span> <span class="nf">get_turn_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="sd">&quot;&quot;&quot; </span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">        Get the reward for one turn</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">            (int): the reward for the given turn</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn_reward</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="k">def</span> <span class="nf">get_final_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="sd">&quot;&quot;&quot; </span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">        Check whether the user&#39;s goal was completed.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="sd">            sim_goal (Goal): the simulation&#39;s goal</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">            logging (bool): whether or not the evaluation results should be logged</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">            float: Reward - the final reward (0 (unsuccessful) or 20 (successful))</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">            bool: Success</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="n">requests</span> <span class="o">=</span> <span class="n">sim_goal</span><span class="o">.</span><span class="n">requests</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="n">constraints</span> <span class="o">=</span> <span class="n">sim_goal</span><span class="o">.</span><span class="n">constraints</span>  <span class="c1"># list of constraints</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="c1"># self.logger.dialog_turn(&quot;User Goal &gt; &quot; + str(sim_goal.constraints))</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">requests</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">or</span> <span class="n">requests</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>            <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Fail with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="c1"># TODO think about this more? if goals not satisfiable,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>            <span class="c1"># should system take the blame? not fair</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>        <span class="c1"># print(requests[&#39;name&#39;])</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>        <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>            <span class="n">entity_id</span><span class="o">=</span><span class="n">requests</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>            <span class="n">requested_slots</span><span class="o">=</span><span class="p">[</span><span class="n">constraint</span><span class="o">.</span><span class="n">slot</span> <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">])</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="k">if</span> <span class="n">db_matches</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">db_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>            <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>                <span class="k">if</span> <span class="n">const</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">match</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="ow">and</span> <span class="n">const</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>                    <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Fail with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>                    <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>            <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Success with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>            <span class="k">return</span> <span class="mf">20.0</span><span class="p">,</span> <span class="kc">True</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Fail with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.ObjectiveReachedEvaluator.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">()):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">assert</span> <span class="n">turn_reward</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;the turn reward should be negative&#39;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">turn_reward</span> <span class="o">=</span> <span class="n">turn_reward</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">success_reward</span> <span class="o">=</span> <span class="n">success_reward</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_final_reward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_final_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_final_reward" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Check whether the user's goal was completed.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>sim_goal</code></td>
        <td><code>Goal</code></td>
        <td><p>the simulation's goal</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>logging</code></td>
        <td><code>bool</code></td>
        <td><p>whether or not the evaluation results should be logged</p></td>
        <td><code>True</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>float</code></td>
      <td><p>Reward - the final reward (0 (unsuccessful) or 20 (successful))
bool: Success</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_final_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; </span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Check whether the user&#39;s goal was completed.</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        sim_goal (Goal): the simulation&#39;s goal</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        logging (bool): whether or not the evaluation results should be logged</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        float: Reward - the final reward (0 (unsuccessful) or 20 (successful))</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        bool: Success</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">requests</span> <span class="o">=</span> <span class="n">sim_goal</span><span class="o">.</span><span class="n">requests</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">constraints</span> <span class="o">=</span> <span class="n">sim_goal</span><span class="o">.</span><span class="n">constraints</span>  <span class="c1"># list of constraints</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="c1"># self.logger.dialog_turn(&quot;User Goal &gt; &quot; + str(sim_goal.constraints))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">requests</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">or</span> <span class="n">requests</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>        <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Fail with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># TODO think about this more? if goals not satisfiable,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="c1"># should system take the blame? not fair</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="c1"># print(requests[&#39;name&#39;])</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">entity_id</span><span class="o">=</span><span class="n">requests</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="n">requested_slots</span><span class="o">=</span><span class="p">[</span><span class="n">constraint</span><span class="o">.</span><span class="n">slot</span> <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="k">if</span> <span class="n">db_matches</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">db_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>            <span class="k">if</span> <span class="n">const</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">match</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">slot</span><span class="p">]</span> <span class="ow">and</span> <span class="n">const</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>                <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Fail with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>                <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Success with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="k">return</span> <span class="mf">20.0</span><span class="p">,</span> <span class="kc">True</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="k">if</span> <span class="n">logging</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;Fail with user requests </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requests</span><span class="p">))</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_turn_reward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_turn_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.ObjectiveReachedEvaluator.get_turn_reward" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Get the reward for one turn</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>(int)</code></td>
      <td><p>the reward for the given turn</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">get_turn_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; </span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Get the reward for one turn</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        (int): the reward for the given turn</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn_reward</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="adviser.services.stats.evaluation.PolicyEvaluator" class="doc doc-heading">
        <code>
PolicyEvaluator            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.stats.evaluation.PolicyEvaluator" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>Policy evaluation module</p>
<p>Plug this module into the dialog graph (somewhere <em>after</em> the policy),
and policy metrics like success rate and reward will be recorded.</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">PolicyEvaluator</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot; Policy evaluation module</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    Plug this module into the dialog graph (somewhere *after* the policy),</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    and policy metrics like success rate and reward will be recorded.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">subgraph</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>                 <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>                 <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">summary_writer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        Keyword Arguments:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">            use_tensorboard {bool} -- [If true, metrics will be written to</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">                                       tensorboard in a *runs* directory]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">                                       (default: {False})</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">            experiment_name {str} -- [Name suffix for the log files]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">                                      (default: {&#39;&#39;})</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">            turn_reward {float} -- [Reward for one turn - usually negative to</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">                                    penalize dialog length] (default: {-1})</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">            success_reward {float} -- [Reward of the final transition if the</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">                                       dialog goal was reached] (default: {20})</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">PolicyEvaluator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">ObjectiveReachedEvaluator</span><span class="p">(</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>            <span class="n">domain</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=</span><span class="n">turn_reward</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="n">success_reward</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">summary_writer</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_eval_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sys_act&#39;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sys_turn_over&quot;</span><span class="p">])</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="k">def</span> <span class="nf">evaluate_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="sd">            Evaluates the reward for a given turn</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="sd">                sys_act (SysAct): the system action</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">                (bool): A signal representing the end of a complete dialog turn</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_turn_reward</span><span class="p">()</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_turns</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sys_turn_over&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_start</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">            Clears the state of the evaluator in preparation to start a new dialog</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_turns</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a><span class="sd">            sets the evaluator in train mode</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="sd">            sets teh evaluator in eval mode</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sim_goal&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dialog_end&quot;</span><span class="p">])</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>    <span class="k">def</span> <span class="nf">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a><span class="sd">            Method for handling the end of a dialog; calculates the the final reward.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a><span class="sd">                sim_goal (Goal): the simulation goal to evaluate against</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a><span class="sd">                (dict): a dictionary where the key is &quot;dialog_end&quot; and the value is true</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">total_eval_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="k">if</span> <span class="n">sim_goal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>            <span class="c1"># real user interaction, no simulator - don&#39;t have to evaluate</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>            <span class="c1"># anything, just reset counters</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dialog_end&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="n">final_reward</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_final_reward</span><span class="p">(</span><span class="n">sim_goal</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span> <span class="o">+=</span> <span class="n">final_reward</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_success</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">success</span><span class="p">))</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog_turns</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;train/episode_reward&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>                                       <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">success</span><span class="p">))</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog_turns</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;eval/episode_reward&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>                                       <span class="bp">self</span><span class="o">.</span><span class="n">total_eval_dialogs</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dialog_end&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>    <span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a><span class="sd">        Handles resetting variables between epochs</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="c1"># global statistics</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;###</span><span class="se">\n</span><span class="s2">### EPOCH&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ###</span><span class="se">\n</span><span class="s2">###&quot;</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>    <span class="k">def</span> <span class="nf">end_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a><span class="sd">        Handles calculating statistics at the end of an epoch        </span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot; ### Train ###&quot;</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Num Dialogs &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Turns &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Success &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_success</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Reward &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot; ### Eval ###&quot;</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Num Dialogs &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Turns &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Success &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Reward &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;num_dialogs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>                    <span class="s1">&#39;turns&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_success</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>                    <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">}</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;num_dialogs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>                    <span class="s1">&#39;turns&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>                    <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">subgraph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">experiment_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">logger</span><span class="o">=&lt;</span><span class="n">DiasysLogger</span> <span class="n">adviser</span> <span class="p">(</span><span class="n">NOTSET</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">summary_writer</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.stats.evaluation.PolicyEvaluator.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


<p><strong>Keyword arguments:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>use_tensorboard</code></td>
        <td><code>{bool} -- [If true, metrics will be written to
                       tensorboard in a *runs* directory]
                       (default</code></td>
        <td><p>{False})</p></td>
      </tr>
      <tr>
        <td><code>experiment_name</code></td>
        <td><code>{str} -- [Name suffix for the log files]
                      (default</code></td>
        <td><p>{''})</p></td>
      </tr>
      <tr>
        <td><code>turn_reward</code></td>
        <td><code>{float} -- [Reward for one turn - usually negative to
                    penalize dialog length] (default</code></td>
        <td><p>{-1})</p></td>
      </tr>
      <tr>
        <td><code>success_reward</code></td>
        <td><code>{float} -- [Reward of the final transition if the
                       dialog goal was reached] (default</code></td>
        <td><p>{20})</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">subgraph</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_tensorboard</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>             <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>             <span class="n">logger</span><span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span> <span class="n">DiasysLogger</span><span class="p">(),</span> <span class="n">summary_writer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="sd">    Keyword Arguments:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="sd">        use_tensorboard {bool} -- [If true, metrics will be written to</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">                                   tensorboard in a *runs* directory]</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">                                   (default: {False})</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        experiment_name {str} -- [Name suffix for the log files]</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">                                  (default: {&#39;&#39;})</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="sd">        turn_reward {float} -- [Reward for one turn - usually negative to</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="sd">                                penalize dialog length] (default: {-1})</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">        success_reward {float} -- [Reward of the final transition if the</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">                                   dialog goal was reached] (default: {20})</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">PolicyEvaluator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">ObjectiveReachedEvaluator</span><span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="n">domain</span><span class="p">,</span> <span class="n">turn_reward</span><span class="o">=</span><span class="n">turn_reward</span><span class="p">,</span> <span class="n">success_reward</span><span class="o">=</span><span class="n">success_reward</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">summary_writer</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">total_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">total_eval_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_start</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.PolicyEvaluator.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Clears the state of the evaluator in preparation to start a new dialog</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_start</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Clears the state of the evaluator in preparation to start a new dialog</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">dialog_reward</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">dialog_turns</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.end_dialog" class="doc doc-heading">
<code class="highlight language-python"><span class="n">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.PolicyEvaluator.end_dialog" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.end_epoch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">end_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.PolicyEvaluator.end_epoch" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Handles calculating statistics at the end of an epoch        </p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">end_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Handles calculating statistics at the end of an epoch        </span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot; ### Train ###&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Num Dialogs &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Turns &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Success &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_success</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Reward &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot; ### Eval ###&quot;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Num Dialogs &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Turns &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Success &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="s2">&quot;# Avg Reward &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">))</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;num_dialogs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>                <span class="s1">&#39;turns&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_success</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span><span class="p">}</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;num_dialogs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                <span class="s1">&#39;turns&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span><span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.eval" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.PolicyEvaluator.eval" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>sets teh evaluator in eval mode</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        sets teh evaluator in eval mode</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.evaluate_turn" class="doc doc-heading">
<code class="highlight language-python"><span class="n">evaluate_turn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.PolicyEvaluator.evaluate_turn" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.start_epoch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.PolicyEvaluator.start_epoch" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Handles resetting variables between epochs</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">start_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    Handles resetting variables between epochs</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="c1"># global statistics</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_train_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_eval_dialogs</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eval_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eval_success</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">eval_turns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;###</span><span class="se">\n</span><span class="s2">### EPOCH&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ###</span><span class="se">\n</span><span class="s2">###&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.stats.evaluation.PolicyEvaluator.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.stats.evaluation.PolicyEvaluator.train" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>sets the evaluator in train mode</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/stats/evaluation.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        sets the evaluator in train mode</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="adviser.services.ust" class="doc doc-heading">
        <code>ust</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.ust" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="adviser.services.ust.ust" class="doc doc-heading">
        <code>ust</code>



<a href="#adviser.services.ust.ust" class="headerlink" title="Permanent link">&para;</a></h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="adviser.services.ust.ust.HandcraftedUST" class="doc doc-heading">
        <code>
HandcraftedUST            (<span title="services.service.Service">Service</span>)
        </code>



<a href="#adviser.services.ust.ust.HandcraftedUST" class="headerlink" title="Permanent link">&para;</a></h4>

    <div class="doc doc-contents ">

      <p>A rule-based approach on user state tracking. Currently very minimalist</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/ust/ust.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span> <span class="nc">HandcraftedUST</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">    A rule-based approach on user state tracking. Currently very minimalist</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">us</span> <span class="o">=</span> <span class="n">UserState</span><span class="p">()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="nd">@PublishSubscribe</span><span class="p">(</span><span class="n">sub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;emotion&quot;</span><span class="p">,</span> <span class="s2">&quot;engagement&quot;</span><span class="p">],</span> <span class="n">pub_topics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;userstate&quot;</span><span class="p">])</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span> <span class="nf">update_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emotion</span><span class="p">:</span> <span class="n">EmotionType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">engagement</span><span class="p">:</span> <span class="n">EngagementType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>            <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">userstate</span><span class="o">=</span><span class="n">UserState</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="sd">            Function for updating the userstate (which tracks the system&#39;s knowledge about the</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">            user&#39;s emotions/engagement</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">            Args:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">                emotion (EmotionType): what emotion has been identified for the user</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">                engagement (list): a list of UserAct objects mapped from the user&#39;s last utterance</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">            Returns:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">                (dict): a dictionary with the key &quot;userstate&quot; and the value a UserState object</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="c1"># save last turn to memory</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="o">.</span><span class="n">start_new_turn</span><span class="p">()</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="p">[</span><span class="s2">&quot;engagement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">engagement</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="p">[</span><span class="s2">&quot;emotion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emotion</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;userstate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">us</span><span class="p">}</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">            Resets the user state so it is ready for a new dialog</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="c1"># initialize belief state</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">us</span> <span class="o">=</span> <span class="n">UserState</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h5 id="adviser.services.ust.ust.HandcraftedUST.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

<a href="#adviser.services.ust.ust.HandcraftedUST.__init__" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/ust/ust.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">Service</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">us</span> <span class="o">=</span> <span class="n">UserState</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.ust.ust.HandcraftedUST.dialog_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


<a href="#adviser.services.ust.ust.HandcraftedUST.dialog_start" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">

      <p>Resets the user state so it is ready for a new dialog</p>

        <details class="quote">
          <summary>Source code in <code>adviser/services/ust/ust.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">dialog_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sd">        Resets the user state so it is ready for a new dialog</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="c1"># initialize belief state</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">us</span> <span class="o">=</span> <span class="n">UserState</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="adviser.services.ust.ust.HandcraftedUST.update_emotion" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_emotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


<a href="#adviser.services.ust.ust.HandcraftedUST.update_emotion" class="headerlink" title="Permanent link">&para;</a></h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>adviser/services/ust/ust.py</code></summary>
          <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span> <span class="nf">delegate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">func_inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">callargs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">callargs</span><span class="p">:</span>    <span class="c1"># remove self when in *args, because already known to function</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">callargs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">callargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="c1"># fix! (user could have multiple &quot;/&quot; characters in topic - only use last one )</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="n">domains</span> <span class="o">=</span> <span class="p">{</span><span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">if</span> <span class="n">func_inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># not a publisher, just normal function</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publish_sockets</span><span class="p">[</span><span class="n">func_inst</span><span class="p">]</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_name</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="c1"># publish messages</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">pub_topics</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="c1"># for topic in result: # NOTE publish any returned value in dict with it&#39;s key as topic</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>            <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>                <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>                <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">domain</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>                    <span class="n">topic_domain_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pub_topic_domains</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="k">else</span> <span class="n">topic</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                <span class="n">_send_msg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">topic_domain_str</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">])</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="p">:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>                        <span class="sa">f</span><span class="s2">&quot;- (DS): sent message from </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to topic </span><span class="si">{</span><span class="n">topic_domain_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../../getting-started/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Getting Started" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Getting Started
            </div>
          </div>
        </a>
      
      
        
        <a href="../examples/" class="md-footer__link md-footer__link--next" aria-label="Next: Examples" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Examples
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
    
  </body>
</html>