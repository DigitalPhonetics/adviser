

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>modules.policy.policy_rl &mdash; ADvISER 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ADvISER
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../home.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start.html">Getting Started</a></li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../doc.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc.html#utils">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc.html#tools">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc.html#other">Other</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://digitalphonetics.github.io/adviser/tutorial.html#Implementing-your-own-modules">Implementing your Own Modules</a></li>
<li class="toctree-l1"><a class="reference external" href="https://digitalphonetics.github.io/adviser/tutorial.html#Creating-a-new-domain">Creating a New Domain</a></li>
<li class="toctree-l1"><a class="reference external" href="https://digitalphonetics.github.io/adviser/tutorial.html#Rule-based-Natural-Language-Understanding-(NLU)-through-Regexes">Rule-based NLU</a></li>
<li class="toctree-l1"><a class="reference external" href="https://digitalphonetics.github.io/adviser/tutorial.html#Training-a-reinforcement-learning-policy">Training a RL Policy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://digitalphonetics.github.io/adviser/tutorial.html#Handcrafted-Natural-Language-Generation-(NLG)-through-Sentence-Templates">Rule-based NLG</a></li>
</ul>
<p class="caption"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">General Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html#system-specific-information">System Specific Information</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ADvISER</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>modules.policy.policy_rl</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for modules.policy.policy_rl</h1><div class="highlight"><pre>
<span></span><span class="c1">###############################################################################</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2019, University of Stuttgart: Institute for Natural Language Processing (IMS)</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Adviser.</span>
<span class="c1"># Adviser is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3.</span>
<span class="c1">#</span>
<span class="c1"># Adviser is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with Adviser.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">###############################################################################</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">tensorboardX</span> <span class="k">import</span> <span class="n">SummaryWriter</span>

<span class="kn">from</span> <span class="nn">utils.domain.jsonlookupdomain</span> <span class="k">import</span> <span class="n">JSONLookupDomain</span>
<span class="kn">from</span> <span class="nn">utils.sysact</span> <span class="k">import</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">SysActionType</span>
<span class="kn">from</span> <span class="nn">modules.module</span> <span class="k">import</span> <span class="n">Module</span>
<span class="kn">from</span> <span class="nn">utils.beliefstate</span> <span class="k">import</span> <span class="n">BeliefState</span>
<span class="kn">from</span> <span class="nn">utils.useract</span> <span class="k">import</span> <span class="n">UserAct</span>
<span class="kn">from</span> <span class="nn">modules.policy.rl.common</span> <span class="k">import</span> <span class="n">DEVICE</span>
<span class="kn">from</span> <span class="nn">modules.policy.evaluation</span> <span class="k">import</span> <span class="n">ObjectiveReachedEvaluator</span>
<span class="kn">from</span> <span class="nn">modules.policy.rl.experience_buffer</span> <span class="k">import</span> <span class="n">UniformBuffer</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">Goal</span><span class="p">,</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">utils.logger</span> <span class="k">import</span> <span class="n">DiasysLogger</span>


<div class="viewcode-block" id="RLPolicy"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy">[docs]</a><span class="k">class</span> <span class="nc">RLPolicy</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class for Reinforcement Learning based policies.</span>

<span class="sd">    Functionality provided includes the setup of state- and action spaces,</span>
<span class="sd">    conversion of `BeliefState` objects into pytorch tensors,</span>
<span class="sd">    updating the last performed system actions and informed entities,</span>
<span class="sd">    populating the experience replay buffer,</span>
<span class="sd">    extraction of most probable user hypothesis and candidate action expansion.</span>
<span class="sd">    </span>
<span class="sd">    Output of an agent is a candidate action like</span>
<span class="sd">    ``inform_food`` </span>
<span class="sd">    which is then populated with the most probable slot/value pair from the</span>
<span class="sd">    beliefstate and database candidates by the `expand_system_action`-function to become</span>
<span class="sd">    ``inform(slot=food,value=italian)``.</span>

<span class="sd">    In order to create your own policy, you can inherit from this class.</span>
<span class="sd">    Make sure to call the `turn_end`-function after each system turn and the `end_dialog`-function </span>
<span class="sd">    after each completed dialog and to overwrite the `forward`-method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span> <span class="p">:</span> <span class="n">JSONLookupDomain</span><span class="p">,</span> <span class="n">subgraph</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">buffer_cls</span><span class="o">=</span><span class="n">UniformBuffer</span><span class="p">,</span>
                 <span class="n">buffer_size</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">discount_gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
                 <span class="n">include_confreq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span> <span class="p">:</span> <span class="n">DiasysLogger</span> <span class="o">=</span>  <span class="n">DiasysLogger</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Creates state- and action spaces, initializes experience replay </span>
<span class="sd">        buffers.</span>
<span class="sd">        </span>
<span class="sd">        Arguments:</span>
<span class="sd">            domain {domain.jsonlookupdomain.JSONLookupDomain} -- Domain</span>
<span class="sd">        </span>
<span class="sd">        Keyword Arguments:</span>
<span class="sd">            subgraph {[type]} -- [see modules.Module] (default: {None})</span>
<span class="sd">            buffer_cls {modules.policy.rl.experience_buffer.Buffer} </span>
<span class="sd">            -- [Experience replay buffer *class*, **not** an instance - will be</span>
<span class="sd">                initialized by this constructor!] (default: {UniformBuffer})</span>
<span class="sd">            buffer_size {int} -- [see modules.policy.rl.experience_buffer.</span>
<span class="sd">                                  Buffer] (default: {6000})</span>
<span class="sd">            batch_size {int} -- [see modules.policy.rl.experience_buffer.</span>
<span class="sd">                                  Buffer] (default: {64})</span>
<span class="sd">            discount_gamma {float} -- [Discount factor] (default: {0.99})</span>
<span class="sd">            include_confreq {bool} -- [Use confirm_request actions] </span>
<span class="sd">                                       (default: {False})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">RLPolicy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">subgraph</span><span class="o">=</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="c1"># setup evaluator for training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">ObjectiveReachedEvaluator</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discount_gamma</span> <span class="o">=</span> <span class="n">discount_gamma</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get state size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beliefstate_dict_to_vector</span><span class="p">(</span>
                                                <span class="n">BeliefState</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">_init_beliefstate</span><span class="p">())</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;state space dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">))</span>

        <span class="c1"># get system action list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;inform_byname&quot;</span><span class="p">,</span> <span class="c1"># TODO rename to &#39;bykey&#39;</span>
                        <span class="s2">&quot;inform_alternatives&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;reqmore&quot;</span><span class="p">]</span>
                        <span class="c1"># TODO badaction</span>
                        <span class="c1"># NOTE repeat not supported by user simulator</span>
        <span class="k">for</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;request#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;confirm#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;select#&#39;</span> <span class="o">+</span> <span class="n">req_slot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_confreq</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">conf_slot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_system_requestable_slots</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">req_slot</span> <span class="o">==</span> <span class="n">conf_slot</span><span class="p">:</span>
                        <span class="c1"># skip case where confirm slot = request slot</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;confreq#&#39;</span> <span class="o">+</span> <span class="n">conf_slot</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span>
                                                        <span class="n">req_slot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
        <span class="c1"># don&#39;t include closingmsg in learnable actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;closingmsg&#39;</span><span class="p">)</span>
        <span class="c1">#self.actions.append(&quot;closingmsg&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;action space dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_dim</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_primary_key</span><span class="p">()</span>

        <span class="c1"># init replay memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer_cls</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
                                 <span class="n">discount_gamma</span><span class="o">=</span><span class="n">discount_gamma</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="RLPolicy.action_name"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy.action_name">[docs]</a>    <span class="k">def</span> <span class="nf">action_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the action name for the specified action index &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">action_idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="RLPolicy.action_idx"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy.action_idx">[docs]</a>    <span class="k">def</span> <span class="nf">action_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the action index for the specified action name &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_recurseively_extend_beliefvector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot; Recurse through beliefstate dict and append probabilities to</span>
<span class="sd">            vector &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">beliefstate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_recurseively_extend_beliefvector</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">vector</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>


<div class="viewcode-block" id="RLPolicy.beliefstate_dict_to_vector"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy.beliefstate_dict_to_vector">[docs]</a>    <span class="k">def</span> <span class="nf">beliefstate_dict_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts the beliefstate dict to a torch tensor</span>

<span class="sd">        Args:</span>
<span class="sd">            beliefstate: dict of belief (with at least beliefs and system keys)</span>

<span class="sd">        Returns:</span>
<span class="sd">            belief tensor with dimension 1 x state_dim</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">belief_vec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># append belief state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recurseively_extend_beliefvector</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;beliefs&#39;</span><span class="p">],</span> <span class="n">belief_vec</span><span class="p">)</span>
        <span class="c1"># append system features</span>
        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastActionInformNone&#39;</span><span class="p">]))</span>
        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;offerHappened&#39;</span><span class="p">]))</span>
        <span class="n">candidate_count</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;db_matches&#39;</span><span class="p">]</span>
        <span class="c1"># buckets for match count: 0, 1, 2-4, &gt;4</span>
        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">candidate_count</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">candidate_count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">belief_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;discriminable&#39;</span><span class="p">]))</span>

        <span class="c1"># convert to torch tensor</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">belief_vec</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_remove_dontcare_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot_value_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a new dictionary without the slots set to dontcare &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">slot</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">slot_value_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">_get_slotnames_from_actionname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the slot names of an action of format &#39;action_slot1_slot2_...&#39; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">action_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>


    <span class="k">def</span> <span class="nf">_db_results_to_sysact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">,</span> <span class="n">constraints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">db_entity</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds values of db_entity to constraints of sys_act</span>
<span class="sd">            (primary key is always added).</span>
<span class="sd">            Omits values which are not available in database. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">constraint_slot</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">constraints</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dontcare&#39;</span> <span class="ow">and</span> \
               <span class="n">constraint_slot</span> <span class="ow">in</span> <span class="n">db_entity</span> <span class="ow">and</span> \
               <span class="n">db_entity</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;not available&#39;</span><span class="p">:</span>
                <span class="c1"># fill user dontcare with database value</span>
                <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">constraint_slot</span><span class="p">,</span> <span class="n">db_entity</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">constraint_slot</span> <span class="ow">in</span> <span class="n">db_entity</span><span class="p">:</span>
                    <span class="c1"># fill with database value</span>
                    <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">constraint_slot</span><span class="p">,</span>
                                      <span class="n">db_entity</span><span class="p">[</span><span class="n">constraint_slot</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># slot not in db entity -&gt; create warning</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Slot &quot;</span> <span class="o">+</span> <span class="n">constraint_slot</span> <span class="o">+</span>
                                   <span class="s2">&quot; not found in db entity &quot;</span> <span class="o">+</span>
                                   <span class="n">db_entity</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">])</span>
        <span class="c1"># ensure primary key is included</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
            <span class="n">sys_act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">db_entity</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_expand_byconstraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create inform act with an entity from the database, if any matches</span>
<span class="sd">            could be found for the constraints, otherwise will return an inform</span>
<span class="sd">            act with primary key=none &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Inform</span>

        <span class="c1"># get constraints and query db by them</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                                <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                                      
        <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">requested_slots</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
            <span class="c1"># no matching entity found -&gt; return inform with primary key=none</span>
            <span class="c1"># and other constraints</span>
            <span class="n">filtered_slot_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="n">filtered_slots</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                                  <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">filtered_slots</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">slot</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># match found -&gt; return its name</span>
            <span class="c1"># if &gt; 1 match and matches contain last informed entity,</span>
            <span class="c1"># stick to this</span>
            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">db_match</span> <span class="k">for</span> <span class="n">db_match</span> <span class="ow">in</span> <span class="n">db_matches</span>
                              <span class="k">if</span> <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span> <span class="o">==</span> \
                               <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="c1"># none matches last informed venue -&gt; pick first result</span>
                <span class="c1"># match = db_matches[0]</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">db_matches</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># fill act with values from db</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_results_to_sysact</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand request_*slot* action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span>
        <span class="n">req_slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand select_*slot* action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Select</span>
        <span class="n">sel_slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">most_likely_choice</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_sysreq_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                     <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">first_value</span> <span class="o">=</span> <span class="n">most_likely_choice</span><span class="p">[</span><span class="n">sel_slot</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">second_value</span> <span class="o">=</span> <span class="n">most_likely_choice</span><span class="p">[</span><span class="n">sel_slot</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">sel_slot</span><span class="p">,</span> <span class="n">first_value</span><span class="p">)</span>
        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">sel_slot</span><span class="p">,</span> <span class="n">second_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand confirm_*slot* action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Confirm</span>
        <span class="n">conf_slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                                               <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">conf_value</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">conf_slot</span><span class="p">]</span>
        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">conf_slot</span><span class="p">,</span> <span class="n">conf_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_confreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand confreq_*confirmslot*_*requestslot* action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">ConfirmRequest</span>
        <span class="c1"># first slot name is confirmation, second is request</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_slotnames_from_actionname</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>
        <span class="n">conf_slot</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">req_slot</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># get value that needs confirmation</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                                               <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">conf_value</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">conf_slot</span><span class="p">]</span>
        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">conf_slot</span><span class="p">,</span> <span class="n">conf_value</span><span class="p">)</span>
        <span class="c1"># add request slot</span>
        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_informbyname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand inform_byname action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByName</span>

        <span class="c1"># get most probable entity primary key</span>
        <span class="n">primkeyval</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;beliefs&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">primkeyval</span> <span class="o">==</span> <span class="s1">&#39;**NONE**&#39;</span><span class="p">:</span>
            <span class="c1"># try to use previously informed name instead</span>
            <span class="n">primkeyval</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span>
            <span class="c1"># TODO change behaviour from here, because primkeyval might be &quot;**NONE**&quot; and this might be an entity in the database</span>
        <span class="c1"># find db entry by primary key</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                                <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># db_matches = self.domain.find_info_about_entity(primkeyval, self.domain.get_requestable_slots())</span>
        <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">({</span><span class="o">**</span><span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span> <span class="n">primkeyval</span><span class="p">})</span>
        <span class="c1"># db_matches = om.query_db_byslotvalues(self.domain,</span>
        <span class="c1">#                                       {**constraints, self.primary_key: primkeyval})</span>
        <span class="c1"># NOTE usually not needed to give all constraints (shouldn&#39;t make a difference)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
            <span class="c1"># select random entity if none could be found</span>
            <span class="n">primkeyvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_possible_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
            <span class="n">primkeyval</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">primkeyvals</span><span class="p">)</span>
            <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">())</span> <span class="c1"># use knowledge from current belief state</span>
            <span class="c1"># db_matches = om.query_db_byslotvalues(self.domain, </span>
            <span class="c1">#                                     {self.primary_key: primkeyval})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
            <span class="c1"># no results found</span>
            <span class="n">filtered_slot_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                                 <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">act</span>

        <span class="c1"># select random match</span>
        <span class="n">db_match</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">db_matches</span><span class="p">)</span>
        <span class="n">db_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span><span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">],</span> <span class="n">requested_slots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get slots requested by user</span>
        <span class="n">usr_requests</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_requested_slots</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># remove primary key (to exlude from minimum number) since it is added anyway at the end</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">in</span> <span class="n">usr_requests</span><span class="p">:</span>
            <span class="n">usr_requests</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">usr_requests</span><span class="p">:</span>
            <span class="c1"># add user requested values into system act using db result</span>
            <span class="k">for</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">usr_requests</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">usr_requests</span><span class="p">)),</span> 
                                                       <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">req_slot</span> <span class="ow">in</span> <span class="n">db_match</span><span class="p">:</span>
                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">,</span> <span class="n">db_match</span><span class="p">[</span><span class="n">req_slot</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">req_slot</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">inform_slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> 
                                                          <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">db_match</span><span class="p">[</span><span class="n">inform_slot</span><span class="p">]</span>
                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">inform_slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># add random slot and value if no user request was detected</span>
                <span class="n">usr_requestable_slots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_requestable_slots</span><span class="p">())</span>
                <span class="n">usr_requestable_slots</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
                <span class="n">random_slot</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">usr_requestable_slots</span><span class="p">))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">db_match</span><span class="p">[</span><span class="n">random_slot</span><span class="p">]</span>
                <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">random_slot</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># ensure entity primary key is included</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">in</span> <span class="n">act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_informbyalternatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand inform_byalternatives action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">InformByAlternatives</span>
        <span class="c1"># get set of all previously informed primary key values</span>
        <span class="n">informedPrimKeyValsSinceNone</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                              <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">])</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">beliefstate</span><span class="o">.</span><span class="n">get_most_probable_inf_beliefs</span><span class="p">(</span><span class="n">consider_NONE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                               <span class="n">max_results</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">filtered_slot_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_dontcare_slots</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="c1"># query db by constraints</span>
        <span class="n">db_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_entities</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_matches</span><span class="p">:</span>
            <span class="c1"># no results found</span>
            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                                 <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
            <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">act</span>

        <span class="c1"># don&#39;t inform about already informed entities</span>
        <span class="c1"># -&gt; exclude primary key values from informedPrimKeyValsSinceNone</span>
        <span class="k">for</span> <span class="n">db_match</span> <span class="ow">in</span> <span class="n">db_matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">informedPrimKeyValsSinceNone</span><span class="p">:</span>
                <span class="c1"># new entity!</span>
                <span class="c1"># TODO move to _db_results_to_sysact method (including maximum inform slot-values)</span>
                <span class="c1"># get slots requested by user</span>
                <span class="c1"># usr_requests = beliefstate.get_requested_slots(threshold=0.0)</span>
                <span class="c1"># if self.primary_key in usr_requests:</span>
                <span class="c1">#     usr_requests.remove(self.primary_key)</span>
                <span class="c1"># if usr_requests:</span>
                <span class="c1">#     # add user requested values into system act using db result</span>
                <span class="c1">#     for req_slot in common.numpy.random.choice(usr_requests, min(4, </span>
                <span class="c1">#                                                 len(usr_requests)), replace=False):</span>
                <span class="c1">#         if req_slot in db_match:</span>
                <span class="c1">#             act.add_value(req_slot, db_match[req_slot])</span>
                <span class="c1">#         else:</span>
                <span class="c1">#             act.add_value(req_slot, &#39;none&#39;)</span>
                <span class="c1"># add slots for which the value != &#39;dontcare&#39;</span>
                <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> 
                          <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_slot_values</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">filtered_slot_values</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
                <span class="n">additional_constraints</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;dontcare&#39;</span><span class="p">:</span>
                        <span class="n">additional_constraints</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">db_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">find_info_about_entity</span><span class="p">(</span><span class="n">db_match</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">],</span> <span class="n">requested_slots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">get_informable_slots</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db_results_to_sysact</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">additional_constraints</span><span class="p">,</span> <span class="n">db_match</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="n">act</span>

        <span class="c1"># no alternatives found (that were not already mentioned)</span>
        <span class="n">act</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_bye</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand bye action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Bye</span>
        <span class="k">return</span> <span class="n">act</span>


    <span class="k">def</span> <span class="nf">_expand_reqmore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expand reqmore action &quot;&quot;&quot;</span>
        <span class="n">act</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">act</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">RequestMore</span>
        <span class="k">return</span> <span class="n">act</span>


<div class="viewcode-block" id="RLPolicy.expand_system_action"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy.expand_system_action">[docs]</a>    <span class="k">def</span> <span class="nf">expand_system_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Expands an action index to a real sytem act &quot;&quot;&quot;</span>

        <span class="n">action_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_name</span><span class="p">(</span><span class="n">action_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;request#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_request</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;select#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_select</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;confirm#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_confirm</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;confreq#&#39;</span> <span class="ow">in</span> <span class="n">action_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_confreq</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;inform_byname&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_informbyname</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;inform_alternatives&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_informbyalternatives</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;closingmsg&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_bye</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;repeat&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s1">&#39;reqmore&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_reqmore</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RL POLICY: system action not supported: &quot;</span> <span class="o">+</span>
                           <span class="n">action_name</span><span class="p">)</span>
        <span class="c1"># TODO restart: not supported by former systems</span>
        <span class="c1"># -&gt; check if user simulator supports this</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">_update_system_belief</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">,</span> <span class="n">sys_act</span><span class="p">:</span> <span class="n">SysAct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the system&#39;s belief state features &quot;&quot;&quot;</span>

        <span class="c1"># check if system informed an entity primary key vlaue this turn</span>
        <span class="c1"># (and remember it), otherwise, keep previous one</span>
        <span class="c1"># reset, if primary key value == none (found no matching entities)</span>
        <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastActionInformNone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;offerHappened&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">informed_names</span> <span class="o">=</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">informed_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;offerHappened&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastInformedPrimKeyVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastActionInformNone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;informedPrimKeyValsSinceNone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informed_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


        <span class="c1"># set last system request slot s.t. BST can infer &quot;this&quot; reference</span>
        <span class="c1"># from user simulator (where user inform omits primary key slot)</span>
        <span class="k">if</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Request</span> <span class="ow">or</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Select</span><span class="p">:</span>
            <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">ConfirmRequest</span><span class="p">:</span>
            <span class="n">req_slot</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">sys_act</span><span class="o">.</span><span class="n">slot_values</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys_act</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">req_slot</span> <span class="o">=</span> <span class="n">slot</span>
                    <span class="k">break</span>
            <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_slot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beliefstate</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">][</span><span class="s1">&#39;lastRequestSlot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="RLPolicy.turn_end"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy.turn_end">[docs]</a>    <span class="k">def</span> <span class="nf">turn_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span><span class="p">,</span> <span class="n">state_vector</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
                 <span class="n">sys_act_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call this function after a turn is done by the system &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_system_action</span><span class="p">(</span><span class="n">sys_act_idx</span><span class="p">,</span> <span class="n">beliefstate</span><span class="p">)</span>
        <span class="c1"># TODO COMPATIBILITY TO FORMER SYSTEM&#39;S USER SIMULATOR AND NLG CURRENTLY - REMOVE LATER</span>
        <span class="c1"># if self.last_sys_act.type == SysActionType.InformByName:</span>
        <span class="c1">#     self.last_sys_act.type = SysActionType.Inform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;system action &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_system_belief</span><span class="p">(</span><span class="n">beliefstate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span><span class="p">)</span>

        <span class="n">turn_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_turn_reward</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">state_vector</span><span class="p">,</span> <span class="n">sys_act_idx</span><span class="p">,</span> <span class="n">turn_reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_expand_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call this function when a dialog begins &quot;&quot;&quot;</span>

        <span class="n">hello_action</span> <span class="o">=</span> <span class="n">SysAct</span><span class="p">()</span>
        <span class="n">hello_action</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SysActionType</span><span class="o">.</span><span class="n">Welcome</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_sys_act</span> <span class="o">=</span> <span class="n">hello_action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">dialog_turn</span><span class="p">(</span><span class="s2">&quot;system action &gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hello_action</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sys_act&#39;</span><span class="p">:</span> <span class="n">hello_action</span><span class="p">}</span>


<div class="viewcode-block" id="RLPolicy.end_dialog"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy.end_dialog">[docs]</a>    <span class="k">def</span> <span class="nf">end_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_goal</span><span class="p">:</span> <span class="n">Goal</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call this function when a dialog ended &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sim_goal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># real user interaction, no simulator - don&#39;t have to evaluate</span>
            <span class="c1"># anything, just reset counters</span>
            <span class="k">return</span>

        <span class="n">final_reward</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">get_final_reward</span><span class="p">(</span><span class="n">sim_goal</span><span class="p">,</span> <span class="n">logging</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">final_reward</span><span class="p">,</span> <span class="n">terminal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

        <span class="c1"># if self.writer is not None:</span>
        <span class="c1">#     self.writer.add_scalar(&#39;buffer/items&#39;, len(self.buffer),</span>
        <span class="c1">#                     self.train + self.total_train_dialogs)</span>




<div class="viewcode-block" id="RLPolicy.forward"><a class="viewcode-back" href="../../../modules.policy.html#modules.policy.policy_rl.RLPolicy.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog_graph</span><span class="p">,</span> <span class="n">user_acts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserAct</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">beliefstate</span><span class="p">:</span> <span class="n">BeliefState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sim_goal</span> <span class="p">:</span> <span class="n">Goal</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">writer</span> <span class="p">:</span> <span class="n">SummaryWriter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sys_act</span><span class="o">=</span><span class="n">SysAct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Child classes have to overwrite this method &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">writer</span>
        <span class="k">return</span> <span class="p">{}</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, IMS

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>